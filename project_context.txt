Project Scan Root: C:\Users\lenovo\Downloads\GoSnow_android-main
==================================================

File: app\release\output-metadata.json
--------------------------------------------------
{
  "version": 3,
  "artifactType": {
    "type": "APK",
    "kind": "Directory"
  },
  "applicationId": "com.gosnow.app",
  "variantName": "release",
  "elements": [
    {
      "type": "SINGLE",
      "filters": [],
      "attributes": [],
      "versionCode": 1,
      "versionName": "1.0",
      "outputFile": "app-release.apk"
    }
  ],
  "elementType": "File",
  "baselineProfiles": [
    {
      "minApi": 28,
      "maxApi": 30,
      "baselineProfiles": [
        "baselineProfiles/1/app-release.dm"
      ]
    },
    {
      "minApi": 31,
      "maxApi": 2147483647,
      "baselineProfiles": [
        "baselineProfiles/0/app-release.dm"
      ]
    }
  ],
  "minSdkVersionForDexing": 31
}

==================================================

File: app\src\androidTest\java\com\gosnow\app\ExampleInstrumentedTest.kt
--------------------------------------------------
package com.gosnow.app

import androidx.test.platform.app.InstrumentationRegistry
import androidx.test.ext.junit.runners.AndroidJUnit4

import org.junit.Test
import org.junit.runner.RunWith

import org.junit.Assert.*

/**
 * Instrumented test, which will execute on an Android device.
 *
 * See [testing documentation](http://d.android.com/tools/testing).
 */
@RunWith(AndroidJUnit4::class)
class ExampleInstrumentedTest {
    @Test
    fun useAppContext() {
        // Context of the app under test.
        val appContext = InstrumentationRegistry.getInstrumentation().targetContext
        assertEquals("com.gosnow.app", appContext.packageName)
    }
}

==================================================

File: app\src\main\AndroidManifest.xml
--------------------------------------------------
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
    <!-- 前台服务 -->
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE"
        tools:ignore="ForegroundServicesPolicy" />
    <!-- Android 14+ 前台“定位”类型 -->
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_LOCATION"/>

    <!-- Android 13+ 通知权限（建议加，不然前台服务通知可能发不出来） -->
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>
    <application



        android:allowBackup="true"
        android:dataExtractionRules="@xml/data_extraction_rules"
        android:fullBackupContent="@xml/backup_rules"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.Gosnow"
        android:name=".GoSnowApplication"
        >

        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:label="@string/app_name"
            android:theme="@style/Theme.Gosnow">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />

                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
        <activity
            android:name=".ui.snowcircle.MainActivity"
            android:exported="false"
            android:label="Snow Circle" />


        <!-- ✅ 前台记录服务 -->
        <service
            android:name=".ui.record.service.ForegroundRecordingService"
            android:exported="false"
            android:foregroundServiceType="location"
            tools:ignore="MissingClass" />
    </application>

</manifest>

==================================================

File: app\src\main\java\com\gosnow\app\GoSnowApplication.kt
--------------------------------------------------
package com.gosnow.app

import android.app.Application
import coil.ImageLoader
import coil.ImageLoaderFactory
import coil.disk.DiskCache
import coil.memory.MemoryCache
import coil.request.CachePolicy
import com.gosnow.app.datasupabase.SupabaseClientProvider

// 实现 ImageLoaderFactory 接口
class GoSnowApplication : Application(), ImageLoaderFactory {

    override fun onCreate() {
        super.onCreate()
        SupabaseClientProvider.init(this)
        //SupabaseClientProvider.supabaseClient
    }

    // ✅ 配置全局 Coil 图片加载器
    override fun newImageLoader(): ImageLoader {
        return ImageLoader.Builder(this)
            .memoryCache {
                MemoryCache.Builder(this)
                    .maxSizePercent(0.25) // 使用 25% 的内存做图片缓存
                    .build()
            }
            .diskCache {
                DiskCache.Builder()
                    .directory(this.cacheDir.resolve("image_cache"))
                    .maxSizePercent(0.02) // 使用 2% 的磁盘空间做缓存
                    .build()
            }
            // 强制启用网络缓存策略
            .networkCachePolicy(CachePolicy.ENABLED)
            .diskCachePolicy(CachePolicy.ENABLED)
            .memoryCachePolicy(CachePolicy.ENABLED)
            .crossfade(true)
            .build()
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\MainActivity.kt
--------------------------------------------------
package com.gosnow.app

import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.enableEdgeToEdge
import com.gosnow.app.ui.app.GoSnowApp
import com.gosnow.app.ui.theme.GosnowTheme

class MainActivity : ComponentActivity() {

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        enableEdgeToEdge()

        setContent {
            GosnowTheme {
                GoSnowApp()
            }
        }
    }
}


==================================================

File: app\src\main\java\com\gosnow\app\data\auth\AuthRepository.kt
--------------------------------------------------
package com.gosnow.app.data.auth

import com.gosnow.app.datasupabase.CurrentUserStore
import io.github.jan.supabase.SupabaseClient
import io.github.jan.supabase.gotrue.OtpType
import io.github.jan.supabase.gotrue.auth
import io.github.jan.supabase.gotrue.providers.builtin.OTP
import io.github.jan.supabase.gotrue.user.UserInfo

class AuthRepository(private val supabaseClient: SupabaseClient) {

    suspend fun sendOtpToPhone(phone: String): Result<Unit> = runCatching {
        supabaseClient.auth.signInWith(OTP) {
            this.phone = phone
            createUser = true
        }
    }.map { }
        .mapErrorToUserMessage { mapSendOtpError(it) }

    suspend fun verifyOtpAndLogin(phone: String, code: String): Result<Unit> = runCatching {
        supabaseClient.auth.verifyPhoneOtp(
            phone = phone,
            token = code,
            type = OtpType.Phone.SMS
        )
        // 登录成功后再同步资料
        CurrentUserStore.refreshFromServer()
    }.map { }
        .mapErrorToUserMessage { mapVerifyOtpError(it) }

    suspend fun signOut(): Result<Unit> = runCatching {
        supabaseClient.auth.signOut()
    }

    suspend fun currentUser(): Result<UserInfo?> = runCatching {
        supabaseClient.auth.currentUserOrNull()
    }

    // ✅ 确保这里只有一个 hasActiveSession 函数
    suspend fun hasActiveSession(): Result<Boolean> = runCatching {
        // 尝试获取当前会话，如果不为空则说明已登录
        supabaseClient.auth.currentSessionOrNull() != null
    }

    // ------- 错误映射（核心） -------

    private fun mapSendOtpError(t: Throwable): String {
        val msg = t.message.orEmpty()
        val lower = msg.lowercase()

        return when {
            "rate" in lower || "too many" in lower || "429" in lower ->
                "发送太频繁了，请稍后再试"
            "phone" in lower && ("invalid" in lower || "format" in lower) ->
                "手机号格式不正确，请检查后重试"
            else ->
                "验证码发送失败，请稍后重试"
        }
    }

    private fun mapVerifyOtpError(t: Throwable): String {
        val msg = t.message.orEmpty()
        val lower = msg.lowercase()

        return when {
            ("token" in lower && "expired" in lower) || ("otp" in lower && "expired" in lower) ->
                "验证码已过期，请重新获取"
            ("token" in lower && "invalid" in lower) || ("otp" in lower && "invalid" in lower) ->
                "验证码不正确，请检查后重试"
            "used" in lower || "already" in lower ->
                "验证码已失效，请重新获取"
            "too many" in lower || "rate" in lower || "429" in lower ->
                "操作太频繁了，请稍后再试"
            else ->
                "登录失败，请稍后重试"
        }
    }
}

/** 把 Result.failure(Throwable) 统一替换成用户可读的 Throwable(message) */
private inline fun <T> Result<T>.mapErrorToUserMessage(
    mapper: (Throwable) -> String
): Result<T> {
    return fold(
        onSuccess = { Result.success(it) },
        onFailure = { Result.failure(IllegalStateException(mapper(it))) }
    )
}

==================================================

File: app\src\main\java\com\gosnow\app\data\auth\AuthSession.kt
--------------------------------------------------
package com.gosnow.app.data.auth

data class AuthSession(
    val accessToken: String,
    val refreshToken: String?,
    val userId: String,
    val email: String
)


==================================================

File: app\src\main\java\com\gosnow\app\data\party\PartyUserRepository.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.data.party

import com.gosnow.app.datasupabase.SupabaseClientProvider
import com.gosnow.app.ui.snowcircle.model.User
import io.github.jan.supabase.postgrest.from
import io.github.jan.supabase.postgrest.query.Columns
import kotlinx.coroutines.sync.Mutex
import kotlinx.coroutines.sync.withLock

object PartyUserRepository {
    private val cache = mutableMapOf<String, User>()
    private val mutex = Mutex()
    private val client get() = SupabaseClientProvider.supabaseClient

    suspend fun getUserInfo(userId: String): User? = mutex.withLock {
        // 1. 查缓存
        if (cache.containsKey(userId)) return cache[userId]

        // 2. 查 Supabase (确保 RLS 允许读取 Users 表)
        return try {
            val user = client.from("Users")
                .select(columns = Columns.raw("id, user_name, avatar_url")) {
                    filter { eq("id", userId) }
                }
                .decodeSingleOrNull<User>() // 假设你有 User 这个 @Serializable 类

            if (user != null) {
                cache[userId] = user
            }
            user
        } catch (e: Exception) {
            e.printStackTrace()
            null
        }
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\data\update\UpdateModel.kt
--------------------------------------------------
package com.gosnow.app.data.update

import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable

@Serializable
data class AppUpdateNotice(
    val id: String,
    val platform: String,
    @SerialName("is_active") val isActive: Boolean,
    val title: String,
    val message: String,
    @SerialName("banner_url") val bannerUrl: String?,
    @SerialName("appstore_url") val downloadUrl: String,
    @SerialName("is_force") val isForce: Boolean,
    @SerialName("min_build") val minBuild: Int?,
    @SerialName("latest_build") val latestBuild: Int?,
    @SerialName("created_at") val createdAt: String
)

==================================================

File: app\src\main\java\com\gosnow\app\data\update\UpdateRepository.kt
--------------------------------------------------
package com.gosnow.app.data.update

import com.gosnow.app.datasupabase.SupabaseClientProvider
import io.github.jan.supabase.postgrest.from
import io.github.jan.supabase.postgrest.query.Order
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext

object UpdateRepository {
    private val client get() = SupabaseClientProvider.supabaseClient

    suspend fun checkUpdate(): AppUpdateNotice? = withContext(Dispatchers.IO) {
        try {
            val result = client.from("app_update_notice")
                .select {
                    filter {
                        eq("platform", "android")
                        eq("is_active", true)
                    }
                    order("created_at", Order.DESCENDING)
                    limit(1)
                }
                .decodeList<AppUpdateNotice>()

            return@withContext result.firstOrNull()
        } catch (e: Exception) {
            e.printStackTrace()
            return@withContext null
        }
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\datasupabase\CurrentUserProfile.kt
--------------------------------------------------
package com.gosnow.app.datasupabase

import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable

/**
 * 映射 Supabase public."Users" 表的一条记录
 */
@Serializable
data class CurrentUserProfile(
    val id: String,
    @SerialName("user_name")
    val userName: String,
    @SerialName("avatar_url")
    val avatarUrl: String? = null
)




==================================================

File: app\src\main\java\com\gosnow\app\datasupabase\CurrentUserStore.kt
--------------------------------------------------
package com.gosnow.app.datasupabase

import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow

/**
 * 全局持有「当前登录用户」的昵称 + 头像，
 * 登录成功后拉一次，后面 Home / Settings / 雪圈都从这里读。
 */
object CurrentUserStore {

    // 用泛型显式指定成 CurrentUserProfile?，这样可以接受 null
    private val _profile = MutableStateFlow<CurrentUserProfile?>(null)
    val profile: StateFlow<CurrentUserProfile?> = _profile.asStateFlow()

    /**
     * 登录成功后调用：从后端拉（或创建）一条 Users 记录，填充到本地。
     */
    suspend fun refreshFromServer() {
        _profile.value = ProfileRepository.getOrCreateCurrentUserProfile()
    }

    /**
     * 本地更新（比如 EditProfile 改了昵称 / 头像，不想再打一次网络）。
     */
    fun updateLocalProfile(newName: String, newAvatarUrl: String?) {
        val current = _profile.value ?: return
        _profile.value = current.copy(
            userName = newName,
            avatarUrl = newAvatarUrl
        )
    }

    /**
     * 退出登录时调用。
     */
    fun clear() {
        _profile.value = null
    }
}


==================================================

File: app\src\main\java\com\gosnow\app\datasupabase\DiscoverRepository.kt
--------------------------------------------------
package com.gosnow.app.datasupabase

import io.github.jan.supabase.SupabaseClient
import io.github.jan.supabase.postgrest.from
import io.github.jan.supabase.postgrest.query.Columns
import io.github.jan.supabase.postgrest.query.Order
//import io.github.jan.supabase.postgrest.result.decodeList
import java.time.*
import java.time.format.DateTimeFormatter

// ============== DTO（对应数据库返回）==============

@kotlinx.serialization.Serializable
data class ResortRow(
    val id: Long,
    @kotlinx.serialization.SerialName("name_resort") val name: String? = null
)

@kotlinx.serialization.Serializable
data class LostAndFoundRow(
    val id: Long,
    @kotlinx.serialization.SerialName("created_at") val createdAt: String,
    @kotlinx.serialization.SerialName("resort_id") val resortId: Long? = null,
    @kotlinx.serialization.SerialName("item_description") val itemDescription: String? = null,
    @kotlinx.serialization.SerialName("contact_info") val contactInfo: String? = null,
    val type: String? = null,
    @kotlinx.serialization.SerialName("user_id") val userId: String? = null,
    @kotlinx.serialization.SerialName("image_url") val imageUrl: String? = null,
    @kotlinx.serialization.SerialName("Resorts_data") val resort: ResortRow? = null
)

@kotlinx.serialization.Serializable
data class CarpoolRow(
    val id: String, // uuid
    @kotlinx.serialization.SerialName("created_at") val createdAt: String,
    @kotlinx.serialization.SerialName("user_id") val userId: String? = null,
    @kotlinx.serialization.SerialName("resort_id") val resortId: Long? = null,
    @kotlinx.serialization.SerialName("depart_at") val departAt: String? = null,
    @kotlinx.serialization.SerialName("origin_text") val originText: String? = null,
    val note: String? = null,
    @kotlinx.serialization.SerialName("is_hidden") val isHidden: Boolean = false,
    @kotlinx.serialization.SerialName("canceled_at") val canceledAt: String? = null,
    @kotlinx.serialization.SerialName("Resorts_data") val resort: ResortRow? = null
)

@kotlinx.serialization.Serializable
data class RoommateRow(
    val id: String, // uuid
    @kotlinx.serialization.SerialName("created_at") val createdAt: String,
    @kotlinx.serialization.SerialName("user_id") val userId: String,
    @kotlinx.serialization.SerialName("resort_id") val resortId: Long,
    val content: String,
    @kotlinx.serialization.SerialName("is_hidden") val isHidden: Boolean = false,
    @kotlinx.serialization.SerialName("canceled_at") val canceledAt: String? = null,
    @kotlinx.serialization.SerialName("Resorts_data") val resort: ResortRow? = null
)

// ============== Insert Payload（写入数据库）==============

@kotlinx.serialization.Serializable
data class LostAndFoundInsert(
    @kotlinx.serialization.SerialName("resort_id") val resortId: Long?,
    @kotlinx.serialization.SerialName("item_description") val itemDescription: String,
    @kotlinx.serialization.SerialName("contact_info") val contactInfo: String,
    val type: String,
    @kotlinx.serialization.SerialName("user_id") val userId: String,
    @kotlinx.serialization.SerialName("image_url") val imageUrl: String? = null,
)

@kotlinx.serialization.Serializable
data class CarpoolInsert(
    @kotlinx.serialization.SerialName("user_id") val userId: String,
    @kotlinx.serialization.SerialName("resort_id") val resortId: Long,
    @kotlinx.serialization.SerialName("depart_at") val departAt: String,
    @kotlinx.serialization.SerialName("origin_text") val originText: String,
    val note: String,
    @kotlinx.serialization.SerialName("expires_at") val expiresAt: String,
    @kotlinx.serialization.SerialName("depart_date_utc") val departDateUtc: String,
)

@kotlinx.serialization.Serializable
data class RoommateInsert(
    @kotlinx.serialization.SerialName("user_id") val userId: String,
    @kotlinx.serialization.SerialName("resort_id") val resortId: Long,
    val content: String,
)

// ============== Domain（给 UI 用）==============

data class ResortRef(val id: Long, val name: String)

enum class LostFoundType { LOST, FOUND }

data class LostAndFoundItem(
    val id: Long,
    val resort: ResortRef?,
    val type: LostFoundType,
    val description: String,
    val contact: String,
    val createdAt: LocalDateTime
)

data class CarpoolItem(
    val id: String,
    val resort: ResortRef?,
    val departAt: LocalDateTime,
    val origin: String,
    val note: String,
    val isCanceled: Boolean
)

data class RoommateItem(
    val id: String,
    val resort: ResortRef?,
    val content: String,
    val createdAt: LocalDateTime,
    val isCanceled: Boolean
)

// ============== Repository ==============

class DiscoverRepository(
    private val supabase: SupabaseClient
) {
    private val isoOffset = DateTimeFormatter.ISO_OFFSET_DATE_TIME

    suspend fun fetchResorts(): List<ResortRef> {
        val rows = supabase.from("Resorts_data")
            .select(columns = Columns.list("id", "name_resort")) {
                order(column = "id", order = Order.ASCENDING)
            }
            .decodeList<ResortRow>()

        return rows.map { ResortRef(it.id, it.name.orEmpty()) }
    }

    // ---------- Lost & Found（公共列表）----------
    suspend fun listLostAndFound(
        resortId: Long?,
        date: LocalDate?,
        keyword: String,
        offset: Long,
        pageSize: Long
    ): List<LostAndFoundItem> {
        val columns = Columns.raw(
            """
            id, created_at, resort_id, item_description, contact_info, type, user_id, image_url,
            Resorts_data ( id, name_resort )
            """.trimIndent()
        )

        val from = offset
        val to = offset + pageSize - 1

        val rows = supabase.from("LostAndFoundItems")
            .select(columns = columns) {
                order(column = "created_at", order = Order.DESCENDING)
                range(from..to)

                filter {
                    resortId?.let { eq("resort_id", it) }

                    if (date != null) {
                        val (startIso, endIso) = dayRangeIso(date)
                        gte("created_at", startIso)
                        lt("created_at", endIso)
                    }

                    if (keyword.isNotBlank()) {
                        ilike("item_description", "%$keyword%")
                    }
                }
            }
            .decodeList<LostAndFoundRow>()

        return rows.map { it.toDomainLostAndFound() }
    }

    // ---------- Lost & Found（我的）----------
    suspend fun listMyLostAndFound(
        myUserId: String,
        offset: Long,
        pageSize: Long
    ): List<LostAndFoundItem> {
        val columns = Columns.raw(
            """
            id, created_at, resort_id, item_description, contact_info, type, user_id, image_url,
            Resorts_data ( id, name_resort )
            """.trimIndent()
        )

        val from = offset
        val to = offset + pageSize - 1

        val rows = supabase.from("LostAndFoundItems")
            .select(columns = columns) {
                order(column = "created_at", order = Order.DESCENDING)
                range(from..to)

                filter {
                    eq("user_id", myUserId)
                }
            }
            .decodeList<LostAndFoundRow>()

        return rows.map { it.toDomainLostAndFound() }
    }

    suspend fun publishLostAndFound(payload: LostAndFoundInsert) {
        supabase.from("LostAndFoundItems").insert(payload)
    }

    suspend fun deleteLostAndFound(id: Long, myUserId: String) {
        supabase.from("LostAndFoundItems").delete {
            filter {
                eq("id", id)
                eq("user_id", myUserId)
            }
        }
    }

    // ---------- Carpool（公共列表）----------
    suspend fun listCarpool(
        resortId: Long?,
        date: LocalDate?,
        offset: Long,
        pageSize: Long
    ): List<CarpoolItem> {
        val from = offset
        val to = offset + pageSize - 1

        // 你这里用显式 fk 名消歧义（保留你的写法）
        val columns = Columns.raw(
            """
            id, created_at, user_id, resort_id, depart_at, origin_text, note, is_hidden, canceled_at,
            Resorts_data!carpool_posts_resort_fkey ( id, name_resort )
            """.trimIndent()
        )

        val rows = supabase.from("carpool_posts")
            .select(columns = columns) {
                order(column = "depart_at", order = Order.ASCENDING)
                range(from..to)

                filter {
                    eq("is_hidden", false)
                    exact("canceled_at", null)

                    resortId?.let { eq("resort_id", it) }
                    date?.let { eq("depart_date_utc", it.toString()) }
                }
            }
            .decodeList<CarpoolRow>()

        return rows.mapNotNull { it.toDomainCarpoolOrNull() }
    }

    // ---------- Carpool（我的）----------
    suspend fun listMyCarpool(
        myUserId: String,
        offset: Long,
        pageSize: Long
    ): List<CarpoolItem> {
        val from = offset
        val to = offset + pageSize - 1

        val columns = Columns.raw(
            """
            id, created_at, user_id, resort_id, depart_at, origin_text, note, is_hidden, canceled_at,
            Resorts_data!carpool_posts_resort_fkey ( id, name_resort )
            """.trimIndent()
        )

        val rows = supabase.from("carpool_posts")
            .select(columns = columns) {
                order(column = "created_at", order = Order.DESCENDING)
                range(from..to)

                filter {
                    eq("user_id", myUserId)
                }
            }
            .decodeList<CarpoolRow>()

        return rows.mapNotNull { it.toDomainCarpoolOrNull() }
    }

    suspend fun publishCarpool(payload: CarpoolInsert) {
        supabase.from("carpool_posts").insert(payload)
    }

    suspend fun deleteCarpool(id: String, myUserId: String) {
        supabase.from("carpool_posts").delete {
            filter {
                eq("id", id)
                eq("user_id", myUserId)
            }
        }
    }

    // ---------- Roommate（公共列表）----------
    suspend fun listRoommate(
        resortId: Long?,
        offset: Long,
        pageSize: Long
    ): List<RoommateItem> {
        val from = offset
        val to = offset + pageSize - 1

        val columns = Columns.raw(
            """
            id, created_at, user_id, resort_id, content, is_hidden, canceled_at,
            Resorts_data ( id, name_resort )
            """.trimIndent()
        )

        val rows = supabase.from("roommate_posts")
            .select(columns = columns) {
                order(column = "created_at", order = Order.DESCENDING)
                range(from..to)

                filter {
                    eq("is_hidden", false)
                    exact("canceled_at", null)
                    resortId?.let { eq("resort_id", it) }
                }
            }
            .decodeList<RoommateRow>()

        return rows.map { it.toDomainRoommate() }
    }

    suspend fun listMyRoommate(
        myUserId: String,
        offset: Long,
        pageSize: Long
    ): List<RoommateItem> {
        val from = offset
        val to = offset + pageSize - 1

        val columns = Columns.raw(
            """
            id, created_at, user_id, resort_id, content, is_hidden, canceled_at,
            Resorts_data ( id, name_resort )
            """.trimIndent()
        )

        val rows = supabase.from("roommate_posts")
            .select(columns = columns) {
                order(column = "created_at", order = Order.DESCENDING)
                range(from..to)

                filter {
                    eq("user_id", myUserId)
                }
            }
            .decodeList<RoommateRow>()

        return rows.map { it.toDomainRoommate() }
    }

    suspend fun publishRoommate(payload: RoommateInsert) {
        supabase.from("roommate_posts").insert(payload)
    }

    suspend fun deleteRoommate(id: String, myUserId: String) {
        supabase.from("roommate_posts").delete {
            filter {
                eq("id", id)
                eq("user_id", myUserId)
            }
        }
    }

    // ----------- utils -----------

    private fun dayRangeIso(date: LocalDate): Pair<String, String> {
        val zone = ZoneId.systemDefault()
        val start = date.atStartOfDay(zone).toOffsetDateTime().format(isoOffset)
        val end = date.plusDays(1).atStartOfDay(zone).toOffsetDateTime().format(isoOffset)
        return start to end
    }

    private fun parseToLocalDateTime(iso: String): LocalDateTime {
        return OffsetDateTime.parse(iso).atZoneSameInstant(ZoneId.systemDefault()).toLocalDateTime()
    }

    private fun LostAndFoundRow.toDomainLostAndFound(): LostAndFoundItem {
        val t = when (type?.lowercase()) {
            "found" -> LostFoundType.FOUND
            "lost" -> LostFoundType.LOST
            else -> LostFoundType.LOST
        }
        return LostAndFoundItem(
            id = id,
            resort = resort?.let { ResortRef(it.id, it.name.orEmpty()) },
            type = t,
            description = itemDescription.orEmpty(),
            contact = contactInfo.orEmpty(),
            createdAt = parseToLocalDateTime(createdAt)
        )
    }

    private fun CarpoolRow.toDomainCarpoolOrNull(): CarpoolItem? {
        val departIso = departAt ?: return null
        return CarpoolItem(
            id = id,
            resort = resort?.let { ResortRef(it.id, it.name.orEmpty()) },
            departAt = parseToLocalDateTime(departIso),
            origin = originText.orEmpty(),
            note = note.orEmpty(),
            isCanceled = canceledAt != null
        )
    }

    private fun RoommateRow.toDomainRoommate(): RoommateItem {
        return RoommateItem(
            id = id,
            resort = resort?.let { ResortRef(it.id, it.name.orEmpty()) },
            content = content,
            createdAt = parseToLocalDateTime(createdAt),
            isCanceled = canceledAt != null
        )
    }
}


==================================================

File: app\src\main\java\com\gosnow\app\datasupabase\FeedbackRepository.kt
--------------------------------------------------
package com.gosnow.app.datasupabase

import io.github.jan.supabase.postgrest.postgrest
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable

object FeedbackRepository {

    private val client get() = SupabaseClientProvider.supabaseClient

    @Serializable
    private data class FeedbackInsertPayload(
        @SerialName("content") val content: String?,
        @SerialName("contact") val contact: String?
    )

    suspend fun submitFeedback(content: String, contact: String?) = withContext(Dispatchers.IO) {
        val payload = FeedbackInsertPayload(
            content = content.trim().ifBlank { null },
            contact = contact?.trim()?.ifBlank { null }
        )

        client.postgrest["FeedBackForUs"].insert(payload)
    }
}




==================================================

File: app\src\main\java\com\gosnow\app\datasupabase\ProfileRepository.kt
--------------------------------------------------
package com.gosnow.app.datasupabase

import com.gosnow.app.BuildConfig
import io.github.jan.supabase.gotrue.auth
import io.github.jan.supabase.storage.storage
import io.ktor.client.HttpClient
import io.ktor.client.call.body
import io.ktor.client.engine.android.Android
import io.ktor.client.plugins.contentnegotiation.ContentNegotiation
import io.ktor.client.plugins.defaultRequest
import io.ktor.client.request.get
import io.ktor.client.request.header
import io.ktor.client.request.parameter
import io.ktor.client.request.patch
import io.ktor.client.request.post
import io.ktor.client.request.setBody
import io.ktor.http.ContentType
import io.ktor.http.HttpHeaders
import io.ktor.serialization.kotlinx.json.json
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable
import kotlinx.serialization.json.Json

/**
 * 负责跟 Supabase "Users" 表 & 头像存储桶打交道。
 *
 * 注意：
 * - Auth & Storage 继续用 supabase-kt 2.4.0
 * - 对 Users 表的 CRUD 用 Ktor 直接打 REST（PostgREST），避免你之前那种序列化/插件差异问题。
 */
object ProfileRepository {

    // 复用全局 SupabaseClient
    private val supabaseClient get() = SupabaseClientProvider.supabaseClient

    // 你的头像桶名
    private const val AVATAR_BUCKET = "user"

    // PostgREST 路径：<SUPABASE_URL>/rest/v1/Users
    private const val USERS_TABLE_PATH = "/rest/v1/Users"

    private val baseUrl: String
        get() = BuildConfig.SUPABASE_URL.trimEnd('/')

    // Ktor HttpClient：只初始化一次
    private val httpClient by lazy {
        HttpClient(Android) {
            install(ContentNegotiation) {
                json(
                    Json {
                        ignoreUnknownKeys = true
                        isLenient = true
                        explicitNulls = false
                    }
                )
            }

            // ✅ 全局兜底：默认所有请求都带 JSON 头（避免 Content-Type: null）
            defaultRequest {
                header(HttpHeaders.Accept, ContentType.Application.Json.toString())
                // 注意：GET 请求不一定需要 Content-Type，但加了也无害；
                // 真正关键是 POST/PATCH 的 Content-Type 必须是 JSON。
                header(HttpHeaders.ContentType, ContentType.Application.Json.toString())
            }
        }
    }

    // ===== DTO =====

    @Serializable
    private data class UsersRow(
        val id: String,
        @SerialName("user_name") val userName: String? = null,
        @SerialName("avatar_url") val avatarUrl: String? = null
    )

    @Serializable
    private data class UsersInsert(
        val id: String,
        @SerialName("user_name") val userName: String,
        @SerialName("avatar_url") val avatarUrl: String? = null
    )

    @Serializable
    private data class UsersPatch(
        @SerialName("user_name") val userName: String,
        @SerialName("avatar_url") val avatarUrl: String?
    )

    // ------------ 1) 登录后获取 / 创建当前用户资料 ------------

    suspend fun getOrCreateCurrentUserProfile(): CurrentUserProfile =
        withContext(Dispatchers.IO) {

            val user = supabaseClient.auth.currentUserOrNull()
                ?: throw IllegalStateException("未登录，无法获取资料")

            val session = supabaseClient.auth.currentSessionOrNull()
                ?: throw IllegalStateException("当前没有有效登录会话")

            val userId = user.id
            val accessToken = session.accessToken

            // ① 先尝试从 Users 表读取
            val existing: List<UsersRow> =
                httpClient.get("$baseUrl$USERS_TABLE_PATH") {
                    header("apikey", BuildConfig.SUPABASE_ANON_KEY)
                    header(HttpHeaders.Authorization, "Bearer $accessToken")

                    parameter("id", "eq.$userId")
                    parameter("select", "id,user_name,avatar_url")
                    parameter("limit", 1)
                }.body()

            if (existing.isNotEmpty()) {
                val row = existing.first()
                return@withContext CurrentUserProfile(
                    id = row.id,
                    userName = row.userName ?: "雪友",
                    avatarUrl = row.avatarUrl
                )
            }

            // ② 不存在：插入默认昵称
            val defaultName = when {
                !user.phone.isNullOrBlank() -> "雪友${user.phone!!.takeLast(4)}"
                !user.email.isNullOrBlank() -> user.email!!.substringBefore("@")
                else -> "雪友"
            }

            val payload = UsersInsert(
                id = userId,
                userName = defaultName,
                avatarUrl = null
            )

            // PostgREST 插入：通常 body 要数组形式
            val inserted: List<UsersRow> =
                httpClient.post("$baseUrl$USERS_TABLE_PATH") {
                    header("apikey", BuildConfig.SUPABASE_ANON_KEY)
                    header(HttpHeaders.Authorization, "Bearer $accessToken")
                    header("Prefer", "return=representation")

                    // 可选：限制返回字段
                    parameter("select", "id,user_name,avatar_url")

                    // ✅ 关键：这里是 listOf(payload)，并且 Content-Type 已由 defaultRequest 设置为 JSON
                    setBody(listOf(payload))
                }.body()

            val created = inserted.firstOrNull()
            return@withContext CurrentUserProfile(
                id = created?.id ?: userId,
                userName = created?.userName ?: defaultName,
                avatarUrl = created?.avatarUrl
            )
        }

    // ------------ 2) 更新昵称 + 头像 ------------

    /**
     * @param nickname         新昵称
     * @param avatarBytes      新头像（压缩后的 jpeg 字节）；null 表示没改头像
     * @param currentAvatarUrl 当前头像 URL（没改头像时沿用）
     * @return 最终生效的头像 URL（可能为 null）
     */
    suspend fun updateProfile(
        nickname: String,
        avatarBytes: ByteArray?,
        currentAvatarUrl: String?
    ): String? = withContext(Dispatchers.IO) {

        val user = supabaseClient.auth.currentUserOrNull()
            ?: throw IllegalStateException("未登录，无法更新资料")

        val session = supabaseClient.auth.currentSessionOrNull()
            ?: throw IllegalStateException("当前没有有效登录会话")

        val userId = user.id
        val accessToken = session.accessToken

        var finalAvatarUrl = currentAvatarUrl

        // 1️⃣ 上传新头像（如果有）
        if (avatarBytes != null) {
            val bucket = supabaseClient.storage.from(AVATAR_BUCKET)
            val path = "user-$userId/avatar-${System.currentTimeMillis()}.jpg"

            bucket.upload(path, avatarBytes)
            finalAvatarUrl = bucket.publicUrl(path)
        }

        // 2️⃣ PATCH Users 表
        val patch = UsersPatch(
            userName = nickname,
            avatarUrl = finalAvatarUrl
        )

        httpClient.patch("$baseUrl$USERS_TABLE_PATH") {
            header("apikey", BuildConfig.SUPABASE_ANON_KEY)
            header(HttpHeaders.Authorization, "Bearer $accessToken")
            header("Prefer", "return=representation")

            parameter("id", "eq.$userId")

            // PATCH 的 body 必须是可序列化对象（这里就是 patch）
            setBody(patch)
        }.body<List<UsersRow>>() // 返回值你可以不使用

        return@withContext finalAvatarUrl
    }
}


==================================================

File: app\src\main\java\com\gosnow\app\datasupabase\SupabaseClientProvider.kt
--------------------------------------------------
package com.gosnow.app.datasupabase

import android.content.Context
import com.gosnow.app.BuildConfig
import io.github.jan.supabase.SupabaseClient
import io.github.jan.supabase.annotations.SupabaseInternal
import io.github.jan.supabase.createSupabaseClient
import io.github.jan.supabase.gotrue.Auth
import io.github.jan.supabase.postgrest.Postgrest
import io.github.jan.supabase.realtime.Realtime // ✅ 新增导入
import io.github.jan.supabase.storage.Storage
import io.ktor.client.engine.cio.CIO // ✅ 新增
import io.ktor.client.plugins.contentnegotiation.ContentNegotiation
import io.ktor.client.plugins.defaultRequest
import io.ktor.client.request.accept
import io.ktor.http.ContentType
import io.ktor.http.contentType
import io.ktor.serialization.kotlinx.json.json
import kotlinx.serialization.json.Json
import kotlin.time.Duration.Companion.seconds
import kotlin.time.DurationUnit

object SupabaseClientProvider {

    @Volatile
    private var _client: SupabaseClient? = null

    val supabaseClient: SupabaseClient
        get() = requireNotNull(_client) {
            "SupabaseClientProvider not initialized. Call SupabaseClientProvider.init(context) in Application.onCreate()."
        }

    @OptIn(SupabaseInternal::class)
    fun init(context: Context) {
        if (_client != null) return
        synchronized(this) {
            if (_client != null) return

            _client = createSupabaseClient(
                supabaseUrl = BuildConfig.SUPABASE_URL,
                supabaseKey = BuildConfig.SUPABASE_ANON_KEY
            ) {
                install(Auth) {
                    autoLoadFromStorage = true
                    alwaysAutoRefresh = true
                }
                install(Postgrest)
                install(Storage)

                // ✅ 核心修复：安装 Realtime 插件
                install(Realtime) {
                    // ✅ 大胆尝试：延长重连时间，并显式指定心跳
                    heartbeatInterval = 20.seconds
                    // 强制每次连接都尝试清理之前的残余 Session
                    disconnectOnSessionLoss = true
                }

                httpConfig {
                    install(ContentNegotiation) {
                        json(
                            Json {
                                ignoreUnknownKeys = true
                                isLenient = true
                                explicitNulls = false
                            }
                        )
                    }
                    defaultRequest {
                        contentType(ContentType.Application.Json)
                        accept(ContentType.Application.Json)
                    }
                }

                // ✅ 核心修改：将 httpEngine 改为 CIO
                httpEngine = CIO.create()
            }
        }
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\model\PartyModels.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.model

import kotlinx.serialization.Serializable

@Serializable
data class PartyLocationMessage(
    val user_id: String,
    val lat: Double,
    val lon: Double,
    val avatar_url: String? = null
)

data class PartyMember(
    val userId: String,
    val lat: Double,
    val lon: Double,
    val avatarUrl: String?,
    val userName: String? = null,
    val lastUpdate: Long = System.currentTimeMillis()
)

sealed class PartyState {
    data object Idle : PartyState()
    data class Joined(
        val code: String,
        val members: List<PartyMember>,
        val isHost: Boolean = false // ✅ 新增：标识当前用户是否为队长
    ) : PartyState()
}
@Serializable
data class MemberPresence(
    val user_id: String,
    val lat: Double,
    val lon: Double
)

==================================================

File: app\src\main\java\com\gosnow\app\ui\app\GoSnowApp.kt
--------------------------------------------------
package com.gosnow.app.ui.app

import android.content.Context
import android.content.Intent
import android.net.Uri
import android.provider.Settings
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.padding
import androidx.compose.material3.CircularProgressIndicator
import androidx.compose.material3.Icon
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.NavigationBar
import androidx.compose.material3.NavigationBarItem
import androidx.compose.material3.Scaffold
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.unit.dp
import androidx.lifecycle.viewmodel.compose.viewModel
import androidx.navigation.NavGraph.Companion.findStartDestination
import androidx.navigation.compose.NavHost
import androidx.navigation.compose.composable
import androidx.navigation.compose.currentBackStackEntryAsState
import androidx.navigation.compose.rememberNavController
import com.gosnow.app.datasupabase.CurrentUserStore
import com.gosnow.app.ui.discover.CarpoolPublishScreen
import com.gosnow.app.ui.discover.CarpoolScreen
import com.gosnow.app.ui.discover.DiscoverScreen
import com.gosnow.app.ui.discover.LostAndFoundPublishScreen
import com.gosnow.app.ui.discover.LostAndFoundScreen
import com.gosnow.app.ui.discover.MyCarpoolScreen
import com.gosnow.app.ui.discover.MyLostAndFoundScreen
import com.gosnow.app.ui.discover.MyRoommateScreen
import com.gosnow.app.ui.discover.RoommatePublishScreen
import com.gosnow.app.ui.discover.RoommateScreen
import com.gosnow.app.ui.home.BottomNavItem
import com.gosnow.app.ui.home.HomeScreen
import com.gosnow.app.ui.login.AuthViewModel
import com.gosnow.app.ui.login.PhoneLoginScreen
import com.gosnow.app.ui.login.TermsScreen
import com.gosnow.app.ui.login.WelcomeAuthIntroScreen
import com.gosnow.app.ui.record.RecordRoute
import com.gosnow.app.ui.settings.AboutScreen
import com.gosnow.app.ui.settings.AccountPrivacyScreen
import com.gosnow.app.ui.settings.EditProfileScreen
import com.gosnow.app.ui.settings.FeedbackScreen
import com.gosnow.app.ui.settings.ROUTE_ABOUT
import com.gosnow.app.ui.settings.ROUTE_ACCOUNT_PRIVACY
import com.gosnow.app.ui.settings.ROUTE_EDIT_PROFILE
import com.gosnow.app.ui.settings.ROUTE_FEEDBACK
import com.gosnow.app.ui.settings.SettingsScreen
import com.gosnow.app.ui.snowcircle.ui.SnowApp
import com.gosnow.app.ui.stats.StatsScreen
import com.gosnow.app.ui.update.UpdateNoticeDialog
import com.gosnow.app.ui.update.UpdateViewModel
import com.gosnow.app.ui.welcome.WelcomeFlowScreen

// 常量定义
private const val WELCOME_AUTH_ROUTE = "welcome_auth"
private const val PHONE_LOGIN_ROUTE = "phone_login"
private const val TERMS_ROUTE = "terms"
private const val MAIN_ROUTE = "main"

const val PROFILE_ROUTE = "profile"
const val LOST_AND_FOUND_ROUTE = "lost_and_found"
const val LOST_AND_FOUND_PUBLISH_ROUTE = "lost_and_found_publish"
const val CARPOOL_ROUTE = "carpool"
const val CARPOOL_PUBLISH_ROUTE = "carpool_publish"
const val MY_CARPOOL_ROUTE = "my_carpool"
const val ROOMMATE_ROUTE = "roommate"
const val ROOMMATE_PUBLISH_ROUTE = "roommate_publish"
const val MY_ROOMMATE_ROUTE = "my_roommate"
const val RECORD_ROUTE = "record"
const val WELCOME_FLOW_ROUTE = "welcome_flow"
const val LOST_AND_FOUND_MY_ROUTE = "lost_and_found_my"
const val STATS_ROUTE = "stats"

@Composable
fun GoSnowApp() {
    val authNavController = rememberNavController()
    val context = LocalContext.current
    val prefs = remember { context.getSharedPreferences("gosnow_prefs", Context.MODE_PRIVATE) }
    var hasSeenWelcome by remember { mutableStateOf(prefs.getBoolean("has_seen_welcome_v1", false)) }

    val authViewModel: AuthViewModel = viewModel(factory = AuthViewModel.provideFactory(context))
    val uiState by authViewModel.uiState.collectAsState()

    val updateViewModel: UpdateViewModel = viewModel()
    val updateNotice by updateViewModel.updateNotice.collectAsState()

    // 监听状态变化，处理登录过期等情况
    LaunchedEffect(uiState.isLoggedIn, hasSeenWelcome) {
        // 如果正在检查 Session，什么都不做，防止乱跳
        if (uiState.isCheckingSession) return@LaunchedEffect

        val targetRoute = when {
            !uiState.isLoggedIn -> WELCOME_AUTH_ROUTE
            !hasSeenWelcome -> WELCOME_FLOW_ROUTE
            else -> MAIN_ROUTE
        }

        // 只有当当前路由确实不匹配时才跳转，避免循环跳转
        val currentRoute = authNavController.currentDestination?.route
        if (currentRoute != null && currentRoute != targetRoute) {
            authNavController.navigate(targetRoute) {
                popUpTo(authNavController.graph.startDestinationId) { inclusive = true }
                launchSingleTop = true
            }
        }

        if (uiState.isLoggedIn) {
            updateViewModel.checkForUpdates()
        }
    }

    if (updateNotice != null) {
        UpdateNoticeDialog(
            notice = updateNotice!!,
            onDismiss = { updateViewModel.dismissUpdate() }
        )
    }

    // ✅ 核心修复 1：启动逻辑优化
    // 如果正在检查 Session，只显示一个黑色背景的 Loading
    // 这样用户就不会看到“登录页一闪而过”了
    if (uiState.isCheckingSession) {
        Box(
            modifier = Modifier
                .fillMaxSize()
                .background(Color.Black), // 黑色背景，看起来像启动屏的延续
            contentAlignment = Alignment.Center
        ) {
            CircularProgressIndicator(color = Color.White)
        }
    } else {
        // 检查完毕，决定起始页
        val startDest = when {
            !uiState.isLoggedIn -> WELCOME_AUTH_ROUTE
            !hasSeenWelcome -> WELCOME_FLOW_ROUTE
            else -> MAIN_ROUTE
        }

        NavHost(
            navController = authNavController,
            startDestination = startDest
        ) {
            composable(WELCOME_AUTH_ROUTE) {
                WelcomeAuthIntroScreen(
                    isCheckingSession = false,
                    onStartPhoneLogin = { authNavController.navigate(PHONE_LOGIN_ROUTE) },
                    onTermsClick = { authNavController.navigate(TERMS_ROUTE) }
                )
            }
            composable(PHONE_LOGIN_ROUTE) {
                PhoneLoginScreen(
                    uiState = uiState,
                    onPhoneChange = authViewModel::onPhoneChange,
                    onVerificationCodeChange = authViewModel::onVerificationCodeChange,
                    onSendCode = authViewModel::sendCode,
                    onLoginClick = authViewModel::verifyCodeAndLogin,
                    onBackClick = { authNavController.popBackStack() },
                    onTermsClick = { authNavController.navigate(TERMS_ROUTE) }
                )
            }
            composable(TERMS_ROUTE) {
                TermsScreen(onBackClick = { authNavController.popBackStack() })
            }
            composable(WELCOME_FLOW_ROUTE) {
                WelcomeFlowScreen(
                    onFinished = {
                        hasSeenWelcome = true
                        prefs.edit().putBoolean("has_seen_welcome_v1", true).apply()
                        authNavController.navigate(MAIN_ROUTE) {
                            popUpTo(authNavController.graph.startDestinationId) { inclusive = true }
                            launchSingleTop = true
                        }
                    }
                )
            }
            composable(MAIN_ROUTE) {
                GoSnowMainApp(
                    onLogout = {
                        authViewModel.logout()
                        hasSeenWelcome = prefs.getBoolean("has_seen_welcome_v1", false)
                        authNavController.navigate(WELCOME_AUTH_ROUTE) {
                            popUpTo(authNavController.graph.startDestinationId) { inclusive = true }
                            launchSingleTop = true
                        }
                    }
                )
            }
        }
    }
}

@Composable
fun GoSnowMainApp(
    onLogout: () -> Unit
) {
    val navController = rememberNavController()

    val items = listOf(
        BottomNavItem.Record,
        BottomNavItem.Community,
        BottomNavItem.Discover
    )

    val navBackStackEntry by navController.currentBackStackEntryAsState()
    val currentRoute = navBackStackEntry?.destination?.route

    val shouldShowBottomBar = currentRoute != RECORD_ROUTE

    Scaffold(
        bottomBar = {
            if (shouldShowBottomBar) {
                BottomNavigationBar(
                    items = items,
                    currentRoute = currentRoute.orEmpty(),
                    onItemSelected = { item ->
                        // ✅ 核心修复 2：底部导航点击逻辑

                        val isSelectingRecord = item.route == BottomNavItem.Record.route
                        val isCurrentlyAtRecordRoot = currentRoute == BottomNavItem.Record.route

                        // 逻辑解释：
                        // 如果点击的是“记录(Home)”图标，并且当前不在“记录”的根页面（例如正在“设置/Profile”页面），
                        // 我们需要强制【重置】回记录页，而不是【恢复】设置页的状态。
                        // 如果 restoreState 为 true，系统会把你带回 Settings 页，导致点击看起来没反应。

                        val shouldRestoreState = !(isSelectingRecord && !isCurrentlyAtRecordRoot)

                        navController.navigate(item.route) {
                            // 弹出到图谱的起始点
                            popUpTo(navController.graph.findStartDestination().id) {
                                saveState = true
                            }
                            launchSingleTop = true
                            restoreState = shouldRestoreState
                        }
                    }
                )
            }
        }
    ) { innerPadding ->
        NavHost(
            navController = navController,
            startDestination = BottomNavItem.Record.route,
            modifier = Modifier // 移除全局 padding，由各页面自行处理
        ) {
            // 1. 记录首页
            composable(BottomNavItem.Record.route) {
                Box(modifier = Modifier.padding(innerPadding)) {
                    HomeScreen(
                        onStartRecording = { navController.navigate(RECORD_ROUTE) },
                        onFeatureClick = { featureTitle ->
                            if (featureTitle == "滑行数据") {
                                navController.navigate(STATS_ROUTE)
                            }
                        },
                        onAvatarClick = { navController.navigate(PROFILE_ROUTE) },
                        onBottomNavSelected = { /* unused */ },
                        currentRoute = BottomNavItem.Record.route
                    )
                }
            }

            // 2. 统计页
            composable(STATS_ROUTE) {
                Box(modifier = Modifier.padding(innerPadding)) {
                    StatsScreen()
                }
            }

            // 3. 雪圈 - 仅底部 Padding，解决顶部白边
            composable(BottomNavItem.Community.route) {
                Box(
                    modifier = Modifier.padding(
                        top = 0.dp,
                        bottom = innerPadding.calculateBottomPadding()
                    )
                ) {
                    SnowApp()
                }
            }

            // 4. 发现 - 仅底部 Padding，解决顶部白边
            composable(BottomNavItem.Discover.route) {
                Box(
                    modifier = Modifier.padding(
                        top = 0.dp,
                        bottom = innerPadding.calculateBottomPadding()
                    )
                ) {
                    DiscoverScreen(
                        onLostAndFoundClick = { navController.navigate(LOST_AND_FOUND_ROUTE) },
                        onCarpoolClick = { navController.navigate(CARPOOL_ROUTE) },
                        onRoommateClick = { navController.navigate(ROOMMATE_ROUTE) },
                    )
                }
            }

            // 5. 设置主页 (Profile) - 仅底部 Padding
            composable(PROFILE_ROUTE) {
                Box(
                    modifier = Modifier.padding(
                        top = 0.dp,
                        bottom = innerPadding.calculateBottomPadding()
                    )
                ) {
                    SettingsScreen(
                        onBackClick = { navController.popBackStack() },
                        onEditProfileClick = { navController.navigate(ROUTE_EDIT_PROFILE) },
                        onFeedbackClick = { navController.navigate(ROUTE_FEEDBACK) },
                        onAccountPrivacyClick = { navController.navigate(ROUTE_ACCOUNT_PRIVACY) },
                        onAboutClick = { navController.navigate(ROUTE_ABOUT) },
                        onLogoutClick = { onLogout() }
                    )
                }
            }

            // 6. 全屏录制页 - 不加 padding
            composable(RECORD_ROUTE) {
                RecordRoute(onBack = { navController.popBackStack() })
            }

            // 7. 条款页
            composable(TERMS_ROUTE) {
                Box(modifier = Modifier.padding(innerPadding)) {
                    TermsScreen(onBackClick = { navController.popBackStack() })
                }
            }

            // --- 其他子页面 ---

            composable(ROUTE_ACCOUNT_PRIVACY) {
                val context = LocalContext.current
                Box(modifier = Modifier.padding(bottom = innerPadding.calculateBottomPadding())) {
                    AccountPrivacyScreen(
                        onBackClick = { navController.popBackStack() },
                        onOpenSystemSettingsClick = {
                            val intent = Intent(
                                Settings.ACTION_APPLICATION_DETAILS_SETTINGS,
                                Uri.fromParts("package", context.packageName, null)
                            ).addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                            context.startActivity(intent)
                        }
                    )
                }
            }

            composable(ROUTE_FEEDBACK) {
                Box(modifier = Modifier.padding(bottom = innerPadding.calculateBottomPadding())) {
                    FeedbackScreen(onBackClick = { navController.popBackStack() })
                }
            }

            composable(ROUTE_ABOUT) {
                Box(modifier = Modifier.padding(bottom = innerPadding.calculateBottomPadding())) {
                    AboutScreen(
                        onBackClick = { navController.popBackStack() },
                        onCommunityGuidelinesClick = { navController.navigate(TERMS_ROUTE) },
                        onPrivacyPolicyClick = { navController.navigate(TERMS_ROUTE) }
                    )
                }
            }

            composable(ROUTE_EDIT_PROFILE) {
                val currentProfile by CurrentUserStore.profile.collectAsState()
                val currentName = currentProfile?.userName ?: "雪友"
                val avatarUrl = currentProfile?.avatarUrl

                Box(modifier = Modifier.padding(bottom = innerPadding.calculateBottomPadding())) {
                    EditProfileScreen(
                        currentName = currentName,
                        avatarUrl = avatarUrl,
                        onBackClick = { navController.popBackStack() },
                        onSaveClick = { navController.popBackStack() }
                    )
                }
            }

            composable(LOST_AND_FOUND_ROUTE) {
                Box(modifier = Modifier.padding(bottom = innerPadding.calculateBottomPadding())) {
                    LostAndFoundScreen(
                        onBackClick = { navController.popBackStack() },
                        onPublishClick = { navController.navigate(LOST_AND_FOUND_PUBLISH_ROUTE) },
                        onMyLostAndFoundClick = { navController.navigate(LOST_AND_FOUND_MY_ROUTE) }
                    )
                }
            }
            composable(LOST_AND_FOUND_PUBLISH_ROUTE) {
                Box(modifier = Modifier.padding(bottom = innerPadding.calculateBottomPadding())) {
                    LostAndFoundPublishScreen(
                        onBackClick = { navController.popBackStack() },
                        onPublished = { navController.popBackStack() }
                    )
                }
            }
            composable(LOST_AND_FOUND_MY_ROUTE) {
                Box(modifier = Modifier.padding(bottom = innerPadding.calculateBottomPadding())) {
                    MyLostAndFoundScreen(onBackClick = { navController.popBackStack() })
                }
            }

            composable(CARPOOL_ROUTE) {
                Box(modifier = Modifier.padding(bottom = innerPadding.calculateBottomPadding())) {
                    CarpoolScreen(
                        onBackClick = { navController.popBackStack() },
                        onPublishClick = { navController.navigate(CARPOOL_PUBLISH_ROUTE) },
                        onMyCarpoolClick = { navController.navigate(MY_CARPOOL_ROUTE) }
                    )
                }
            }
            composable(CARPOOL_PUBLISH_ROUTE) {
                Box(modifier = Modifier.padding(bottom = innerPadding.calculateBottomPadding())) {
                    CarpoolPublishScreen(
                        onBackClick = { navController.popBackStack() },
                        onPublished = { navController.popBackStack() }
                    )
                }
            }
            composable(MY_CARPOOL_ROUTE) {
                Box(modifier = Modifier.padding(bottom = innerPadding.calculateBottomPadding())) {
                    MyCarpoolScreen(onBackClick = { navController.popBackStack() })
                }
            }

            composable(ROOMMATE_ROUTE) {
                Box(modifier = Modifier.padding(bottom = innerPadding.calculateBottomPadding())) {
                    RoommateScreen(
                        onBackClick = { navController.popBackStack() },
                        onPublishClick = { navController.navigate(ROOMMATE_PUBLISH_ROUTE) },
                        onMyRoommateClick = { navController.navigate(MY_ROOMMATE_ROUTE) }
                    )
                }
            }
            composable(ROOMMATE_PUBLISH_ROUTE) {
                Box(modifier = Modifier.padding(bottom = innerPadding.calculateBottomPadding())) {
                    RoommatePublishScreen(
                        onBackClick = { navController.popBackStack() },
                        onPublished = { navController.popBackStack() }
                    )
                }
            }
            composable(MY_ROOMMATE_ROUTE) {
                Box(modifier = Modifier.padding(bottom = innerPadding.calculateBottomPadding())) {
                    MyRoommateScreen(onBackClick = { navController.popBackStack() })
                }
            }
        }
    }
}

@Composable
fun BottomNavigationBar(
    items: List<BottomNavItem>,
    currentRoute: String,
    onItemSelected: (BottomNavItem) -> Unit
) {
    NavigationBar {
        items.forEach { item ->
            val selected = currentRoute == item.route

            NavigationBarItem(
                selected = selected,
                onClick = { onItemSelected(item) },
                icon = {
                    Icon(
                        imageVector = item.icon,
                        contentDescription = item.label
                    )
                },
                label = { Text(text = item.label) }
            )
        }
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\discover\DiscoverScreens.kt
--------------------------------------------------
package com.gosnow.app.ui.discover

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Add
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material.icons.filled.Article
import androidx.compose.material.icons.filled.CalendarToday
import androidx.compose.material.icons.filled.ChevronRight
import androidx.compose.material.icons.filled.Delete
import androidx.compose.material.icons.filled.DirectionsCar
import androidx.compose.material.icons.filled.Home
import androidx.compose.material.icons.filled.ListAlt
import androidx.compose.material.icons.filled.Phone
import androidx.compose.material.icons.filled.Place
import androidx.compose.material.icons.filled.Schedule
import androidx.compose.material.icons.filled.Search
import androidx.compose.material.icons.filled.Textsms
import androidx.compose.material3.AlertDialog
import androidx.compose.material3.AssistChip
import androidx.compose.material3.Button
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.CenterAlignedTopAppBar
import androidx.compose.material3.DatePicker
import androidx.compose.material3.DatePickerDialog
import androidx.compose.material3.ElevatedCard
import androidx.compose.material3.ExperimentalMaterial3Api
import androidx.compose.material3.FilterChip
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.OutlinedButton
import androidx.compose.material3.OutlinedTextField
import androidx.compose.material3.Scaffold
import androidx.compose.material3.SnackbarHost
import androidx.compose.material3.SnackbarHostState
import androidx.compose.material3.Text
import androidx.compose.material3.TextButton
import androidx.compose.material3.TimePicker
import androidx.compose.material3.TopAppBar
import androidx.compose.material3.rememberDatePickerState
import androidx.compose.material3.rememberTimePickerState
import androidx.compose.runtime.Composable
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.input.KeyboardCapitalization
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.lifecycle.compose.collectAsStateWithLifecycle
import androidx.lifecycle.viewmodel.compose.viewModel
import com.gosnow.app.datasupabase.CarpoolItem
import com.gosnow.app.datasupabase.LostAndFoundItem
import com.gosnow.app.datasupabase.LostFoundType
import com.gosnow.app.datasupabase.ResortRef
import com.gosnow.app.datasupabase.RoommateItem
import java.time.Instant
import java.time.LocalDate
import java.time.LocalDateTime
import java.time.LocalTime
import java.time.ZoneId
import java.time.format.DateTimeFormatter
import java.util.Locale
import kotlinx.coroutines.launch

private const val PAGE_SIZE = 10

/* =========================
 * Discover 首页入口
 * ========================= */
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun DiscoverScreen(
    onLostAndFoundClick: () -> Unit,
    onCarpoolClick: () -> Unit,
    onRoommateClick: () -> Unit,
) {
    Scaffold(
        topBar = {
            CenterAlignedTopAppBar(
                title = { Text(text = "发现", style = MaterialTheme.typography.titleLarge) }
            )
        },
        containerColor = Color(0xFFF5F5F7)
    ) { innerPadding ->
        Column(
            modifier = Modifier
                .padding(innerPadding)
                .padding(horizontal = 16.dp, vertical = 12.dp)
                .fillMaxSize()
                .verticalScroll(rememberScrollState()),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            DiscoverEntryCard(
                title = "失物招领",
                subtitle = "丢失？捡到？这里快速对接",
                icon = Icons.Default.Search,
                color = Color(0xFF5C6BC0),
                onClick = onLostAndFoundClick
            )
            DiscoverEntryCard(
                title = "顺风车",
                subtitle = "按雪场 / 日期找同行",
                icon = Icons.Default.DirectionsCar,
                color = Color(0xFF26A69A),
                onClick = onCarpoolClick
            )
            DiscoverEntryCard(
                title = "拼房合租",
                subtitle = "寻找合租雪友",
                icon = Icons.Default.Home,
                color = Color(0xFFF57C00),
                onClick = onRoommateClick
            )
        }
    }
}

@Composable
fun DiscoverEntryCard(
    title: String,
    subtitle: String,
    icon: ImageVector,
    color: Color,
    onClick: () -> Unit
) {
    ElevatedCard(
        onClick = onClick,
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.elevatedCardColors(containerColor = Color.White),
        shape = RoundedCornerShape(20.dp)
    ) {
        Row(
            modifier = Modifier.padding(16.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Box(
                modifier = Modifier
                    .size(48.dp)
                    .clip(CircleShape)
                    .background(color.copy(alpha = 0.12f)),
                contentAlignment = Alignment.Center
            ) {
                Icon(imageVector = icon, contentDescription = null, tint = color)
            }
            Column(
                modifier = Modifier
                    .weight(1f)
                    .padding(horizontal = 12.dp)
            ) {
                Text(
                    text = title,
                    style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.Bold)
                )
                Text(
                    text = subtitle,
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
            Icon(
                imageVector = Icons.Default.ChevronRight,
                contentDescription = null,
                tint = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
    }
}

/* =========================
 * 失物招领
 * ========================= */
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun LostAndFoundScreen(
    onBackClick: () -> Unit,
    onPublishClick: () -> Unit,
    onMyLostAndFoundClick: () -> Unit,
    vm: LostAndFoundVM = viewModel(factory = LostAndFoundVM.factory())
) {
    val resorts by vm.resorts.collectAsStateWithLifecycle()
    val selectedResort by vm.selectedResort.collectAsStateWithLifecycle()
    val selectedDate by vm.selectedDate.collectAsStateWithLifecycle()
    val keyword by vm.keyword.collectAsStateWithLifecycle()
    val state by vm.publicState.collectAsStateWithLifecycle()

    var showResortPicker by remember { mutableStateOf(false) }
    var showDatePicker by remember { mutableStateOf(false) }
    val datePickerState = rememberDatePickerState()

    val snackbarHostState = remember { SnackbarHostState() }
    val scope = rememberCoroutineScope()

    state.error?.let { err ->
        // 简单：每次错误出现就提示一次（你也可以做“只提示一次”的事件封装）
        scope.launch { snackbarHostState.showSnackbar(err) }
    }

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("失物招领") },
                navigationIcon = {
                    IconButton(onClick = onBackClick) {
                        Icon(Icons.Default.ArrowBack, contentDescription = "返回")
                    }
                },
                actions = {
                    IconButton(onClick = onMyLostAndFoundClick) {
                        Icon(Icons.Default.Article, contentDescription = "我的失物")
                    }
                    IconButton(onClick = onPublishClick) {
                        Icon(Icons.Default.Add, contentDescription = "发布")
                    }
                }
            )
        },
        snackbarHost = { SnackbarHost(hostState = snackbarHostState) }
    ) { innerPadding ->
        Column(
            modifier = Modifier
                .padding(innerPadding)
                .fillMaxSize()
                .background(Color(0xFFF5F5F7))
                .padding(horizontal = 16.dp, vertical = 12.dp)
        ) {
            Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {
                AssistChip(
                    onClick = { showResortPicker = true },
                    label = { Text(selectedResort?.name ?: "所有雪场") },
                    leadingIcon = {
                        Icon(Icons.Default.Place, contentDescription = null, tint = MaterialTheme.colorScheme.primary)
                    }
                )
                AssistChip(
                    onClick = { showDatePicker = true },
                    label = { Text(selectedDate?.formatShort() ?: "日期") },
                    leadingIcon = {
                        Icon(Icons.Default.CalendarToday, contentDescription = null, tint = MaterialTheme.colorScheme.primary)
                    }
                )
            }

            Spacer(modifier = Modifier.height(8.dp))

            OutlinedTextField(
                value = keyword,
                onValueChange = { vm.setKeyword(it) },
                modifier = Modifier.fillMaxWidth(),
                label = { Text("搜索物品关键词") },
                leadingIcon = { Icon(Icons.Default.Search, contentDescription = null) },
                singleLine = true
            )

            Spacer(modifier = Modifier.height(12.dp))

            when {
                state.isLoading && state.items.isEmpty() -> {
                    Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
                        Text("加载中...")
                    }
                }
                state.items.isEmpty() -> {
                    Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
                        Text("没有找到相关物品", color = MaterialTheme.colorScheme.onSurfaceVariant)
                    }
                }
                else -> {
                    LazyColumn(verticalArrangement = Arrangement.spacedBy(12.dp)) {
                        items(state.items, key = { it.id }) { item ->
                            LostAndFoundCard(item = item)
                        }
                        if (!state.endReached) {
                            item {
                                Spacer(modifier = Modifier.height(8.dp))
                                TextButton(
                                    onClick = { vm.loadMorePublic() },
                                    modifier = Modifier.align(Alignment.CenterHorizontally)
                                ) { Text(if (state.isLoading) "加载中..." else "加载更多") }
                            }
                        }
                    }
                }
            }
        }
    }

    if (showResortPicker) {
        ResortPickerDialog(
            allResorts = resorts,
            selectedResort = selectedResort,
            onDismissRequest = { showResortPicker = false },
            onResortSelected = {
                vm.selectResort(it)
                showResortPicker = false
            }
        )
    }

    if (showDatePicker) {
        DatePickerDialog(
            onDismissRequest = { showDatePicker = false },
            confirmButton = {
                TextButton(onClick = {
                    val millis = datePickerState.selectedDateMillis
                    vm.selectDate(millis?.toLocalDate())
                    showDatePicker = false
                }) { Text("确定") }
            },
            dismissButton = {
                TextButton(onClick = {
                    vm.selectDate(null)
                    showDatePicker = false
                }) { Text("清除") }
            }
        ) {
            DatePicker(state = datePickerState)
        }
    }
}

@Composable
fun LostAndFoundCard(item: LostAndFoundItem) {
    ElevatedCard(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.elevatedCardColors(containerColor = Color.White),
        shape = RoundedCornerShape(18.dp)
    ) {
        Column(modifier = Modifier.padding(16.dp)) {
            Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {
                FilterChip(
                    selected = false,
                    onClick = {},
                    label = { Text(if (item.type == LostFoundType.LOST) "丢失" else "拾到") }
                )
                item.resort?.let {
                    FilterChip(selected = false, onClick = {}, label = { Text(it.name) })
                }
                FilterChip(
                    selected = false,
                    onClick = {},
                    label = { Text(item.createdAt.formatShortDate()) }
                )
            }
            Spacer(modifier = Modifier.height(10.dp))
            Text(
                text = item.description,
                style = MaterialTheme.typography.bodyLarge.copy(fontWeight = FontWeight.SemiBold),
                maxLines = 3,
                overflow = TextOverflow.Ellipsis
            )
            Spacer(modifier = Modifier.height(12.dp))
            Row(verticalAlignment = Alignment.CenterVertically, horizontalArrangement = Arrangement.spacedBy(6.dp)) {
                Icon(Icons.Default.Phone, contentDescription = null, tint = MaterialTheme.colorScheme.primary)
                Text(text = item.contact, style = MaterialTheme.typography.bodyMedium)
            }
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun LostAndFoundPublishScreen(
    onBackClick: () -> Unit,
    onPublished: () -> Unit,
    vm: LostAndFoundVM = viewModel(factory = LostAndFoundVM.factory())
) {
    val resorts by vm.resorts.collectAsStateWithLifecycle()

    var selectedType by rememberSaveable { mutableStateOf(LostFoundType.LOST) }
    var description by rememberSaveable { mutableStateOf("") }
    var contact by rememberSaveable { mutableStateOf("") }
    var selectedResort by rememberSaveable { mutableStateOf<ResortRef?>(null) }
    var showResortPicker by remember { mutableStateOf(false) }

    val snackbarHostState = remember { SnackbarHostState() }
    val scope = rememberCoroutineScope()

    val isValid = description.isNotBlank() && contact.isNotBlank() && selectedResort != null

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("发布物品") },
                navigationIcon = {
                    IconButton(onClick = onBackClick) {
                        Icon(Icons.Default.ArrowBack, contentDescription = "返回")
                    }
                }
            )
        },
        snackbarHost = { SnackbarHost(hostState = snackbarHostState) }
    ) { innerPadding ->
        Column(
            modifier = Modifier
                .padding(innerPadding)
                .fillMaxSize()
                .verticalScroll(rememberScrollState())
                .padding(16.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {
                FilterChip(
                    selected = selectedType == LostFoundType.LOST,
                    onClick = { selectedType = LostFoundType.LOST },
                    label = { Text("丢失") }
                )
                FilterChip(
                    selected = selectedType == LostFoundType.FOUND,
                    onClick = { selectedType = LostFoundType.FOUND },
                    label = { Text("捡到") }
                )
            }

            OutlinedTextField(
                value = description,
                onValueChange = { description = it },
                modifier = Modifier.fillMaxWidth(),
                label = { Text("物品描述") },
                minLines = 3
            )

            OutlinedTextField(
                value = contact,
                onValueChange = { contact = it },
                modifier = Modifier.fillMaxWidth(),
                label = { Text("联系方式 (微信/电话)") },
                leadingIcon = { Icon(Icons.Default.Textsms, contentDescription = null) }
            )

            OutlinedButton(
                onClick = { showResortPicker = true },
                modifier = Modifier.fillMaxWidth(),
                shape = RoundedCornerShape(14.dp)
            ) {
                Icon(Icons.Default.Place, contentDescription = null)
                Spacer(modifier = Modifier.size(6.dp))
                Text(text = selectedResort?.name ?: "选择雪场")
            }

            Button(
                onClick = {
                    scope.launch {
                        val result = vm.publish(
                            type = selectedType,
                            description = description,
                            contact = contact,
                            resortId = selectedResort?.id
                        )
                        result.onSuccess {
                            snackbarHostState.showSnackbar("发布成功")
                            onPublished()
                        }.onFailure {
                            snackbarHostState.showSnackbar(it.message ?: "发布失败")
                        }
                    }
                },
                enabled = isValid,
                modifier = Modifier.fillMaxWidth(),
                shape = RoundedCornerShape(18.dp)
            ) {
                Text("发布")
            }
        }
    }

    if (showResortPicker) {
        ResortPickerDialog(
            allResorts = resorts,
            selectedResort = selectedResort,
            onDismissRequest = { showResortPicker = false },
            onResortSelected = {
                selectedResort = it
                showResortPicker = false
            }
        )
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun MyLostAndFoundScreen(
    onBackClick: () -> Unit,
    vm: LostAndFoundVM = viewModel(factory = LostAndFoundVM.factory())
) {
    val state by vm.myState.collectAsStateWithLifecycle()
    val snackbarHostState = remember { SnackbarHostState() }
    val scope = rememberCoroutineScope()

    var deleteTarget by remember { mutableStateOf<LostAndFoundItem?>(null) }

    // 进入页面时拉一次
    androidx.compose.runtime.LaunchedEffect(Unit) { vm.refreshMy() }

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("我的失物招领") },
                navigationIcon = {
                    IconButton(onClick = onBackClick) {
                        Icon(Icons.Default.ArrowBack, contentDescription = "返回")
                    }
                }
            )
        },
        snackbarHost = { SnackbarHost(hostState = snackbarHostState) }
    ) { innerPadding ->
        when {
            state.isLoading && state.items.isEmpty() -> {
                Box(modifier = Modifier.padding(innerPadding).fillMaxSize(), contentAlignment = Alignment.Center) {
                    Text("加载中...")
                }
            }
            state.items.isEmpty() -> {
                Box(modifier = Modifier.padding(innerPadding).fillMaxSize(), contentAlignment = Alignment.Center) {
                    Text(state.error ?: "暂无失物招领记录", color = MaterialTheme.colorScheme.onSurfaceVariant)
                }
            }
            else -> {
                LazyColumn(
                    modifier = Modifier
                        .padding(innerPadding)
                        .fillMaxSize()
                        .padding(16.dp),
                    verticalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    items(state.items, key = { it.id }) { item ->
                        ElevatedCard(
                            modifier = Modifier.fillMaxWidth(),
                            colors = CardDefaults.elevatedCardColors(containerColor = Color.White),
                            shape = RoundedCornerShape(18.dp)
                        ) {
                            Column(modifier = Modifier.padding(14.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {
                                Row(
                                    horizontalArrangement = Arrangement.SpaceBetween,
                                    modifier = Modifier.fillMaxWidth()
                                ) {
                                    Text(item.resort?.name ?: "未知雪场", style = MaterialTheme.typography.titleMedium)
                                    Text(item.createdAt.formatShortDate(), color = MaterialTheme.colorScheme.onSurfaceVariant)
                                }
                                Text(item.description, maxLines = 3, overflow = TextOverflow.Ellipsis)
                                Text(item.contact, style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.onSurfaceVariant)

                                Row(
                                    horizontalArrangement = Arrangement.End,
                                    verticalAlignment = Alignment.CenterVertically,
                                    modifier = Modifier.fillMaxWidth()
                                ) {
                                    IconButton(onClick = { deleteTarget = item }) {
                                        Icon(Icons.Default.Delete, contentDescription = "删除", tint = MaterialTheme.colorScheme.onSurfaceVariant)
                                    }
                                }
                            }
                        }
                    }

                    if (!state.endReached) {
                        item {
                            Box(
                                modifier = Modifier.fillMaxWidth(),
                                contentAlignment = Alignment.Center
                            ) {
                                TextButton(onClick = { vm.loadMorePublic() }) {
                                    Text(if (state.isLoading) "加载中..." else "加载更多")
                                }
                            }
                        }

                    }
                }
            }
        }
    }

    deleteTarget?.let { target ->
        AlertDialog(
            onDismissRequest = { deleteTarget = null },
            title = { Text("删除帖子") },
            text = { Text("删除后无法恢复，确认删除这条失物招领信息吗？") },
            confirmButton = {
                TextButton(onClick = {
                    scope.launch {
                        val result = vm.deleteMy(target.id)
                        result.onSuccess {
                            snackbarHostState.showSnackbar("已删除")
                        }.onFailure {
                            snackbarHostState.showSnackbar(it.message ?: "删除失败")
                        }
                        deleteTarget = null
                    }
                }) { Text("删除", color = MaterialTheme.colorScheme.error) }
            },
            dismissButton = {
                TextButton(onClick = { deleteTarget = null }) { Text("取消") }
            }
        )
    }
}

/* =========================
 * 顺风车
 * ========================= */
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun CarpoolScreen(
    onBackClick: () -> Unit,
    onPublishClick: () -> Unit,
    onMyCarpoolClick: () -> Unit,
    vm: CarpoolVM = viewModel(factory = CarpoolVM.factory())
) {
    val resorts by vm.resorts.collectAsStateWithLifecycle()
    val selectedResort by vm.selectedResort.collectAsStateWithLifecycle()
    val selectedDate by vm.selectedDate.collectAsStateWithLifecycle()
    val state by vm.publicState.collectAsStateWithLifecycle()

    var showResortPicker by remember { mutableStateOf(false) }
    var showDatePicker by remember { mutableStateOf(false) }
    val datePickerState = rememberDatePickerState()

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("顺风车") },
                navigationIcon = {
                    IconButton(onClick = onBackClick) {
                        Icon(Icons.Default.ArrowBack, contentDescription = "返回")
                    }
                },
                actions = {
                    IconButton(onClick = onMyCarpoolClick) {
                        Icon(Icons.Default.Article, contentDescription = "我的顺风车")
                    }
                    IconButton(onClick = onPublishClick) {
                        Icon(Icons.Default.Add, contentDescription = "发布")
                    }
                }
            )
        }
    ) { innerPadding ->
        Column(
            modifier = Modifier
                .padding(innerPadding)
                .fillMaxSize()
                .background(Color(0xFFF5F5F7))
                .padding(horizontal = 16.dp, vertical = 12.dp)
        ) {
            Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {
                AssistChip(
                    onClick = { showResortPicker = true },
                    label = { Text(selectedResort?.name ?: "所有雪场") },
                    leadingIcon = { Icon(Icons.Default.Place, contentDescription = null, tint = MaterialTheme.colorScheme.primary) }
                )
                AssistChip(
                    onClick = { showDatePicker = true },
                    label = { Text(selectedDate?.formatShort() ?: "日期") },
                    leadingIcon = { Icon(Icons.Default.CalendarToday, contentDescription = null, tint = MaterialTheme.colorScheme.primary) }
                )
            }
            Spacer(modifier = Modifier.height(12.dp))

            when {
                state.isLoading && state.items.isEmpty() -> {
                    Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) { Text("加载中...") }
                }
                state.items.isEmpty() -> {
                    Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
                        Text(state.error ?: "暂无顺风车信息", color = MaterialTheme.colorScheme.onSurfaceVariant)
                    }
                }
                else -> {
                    LazyColumn(verticalArrangement = Arrangement.spacedBy(12.dp)) {
                        items(state.items, key = { it.id }) { item ->
                            CarpoolCard(item = item)
                        }
                        if (!state.endReached) {
                            item {
                                Spacer(modifier = Modifier.height(8.dp))
                                TextButton(
                                    onClick = { vm.loadMorePublic() },
                                    modifier = Modifier.align(Alignment.CenterHorizontally)
                                ) { Text(if (state.isLoading) "加载中..." else "加载更多") }
                            }
                        }
                    }
                }
            }
        }
    }

    if (showResortPicker) {
        ResortPickerDialog(
            allResorts = resorts,
            selectedResort = selectedResort,
            onDismissRequest = { showResortPicker = false },
            onResortSelected = {
                vm.selectResort(it)
                showResortPicker = false
            }
        )
    }

    if (showDatePicker) {
        DatePickerDialog(
            onDismissRequest = { showDatePicker = false },
            confirmButton = {
                TextButton(onClick = {
                    val millis = datePickerState.selectedDateMillis
                    vm.selectDate(millis?.toLocalDate())
                    showDatePicker = false
                }) { Text("确定") }
            },
            dismissButton = {
                TextButton(onClick = {
                    vm.selectDate(null)
                    showDatePicker = false
                }) { Text("清除") }
            }
        ) {
            DatePicker(state = datePickerState)
        }
    }
}

@Composable
fun CarpoolCard(item: CarpoolItem) {
    ElevatedCard(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.elevatedCardColors(containerColor = Color.White),
        shape = RoundedCornerShape(18.dp)
    ) {
        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {
            Row(verticalAlignment = Alignment.CenterVertically, horizontalArrangement = Arrangement.spacedBy(6.dp)) {
                Icon(Icons.Default.Schedule, contentDescription = null, tint = MaterialTheme.colorScheme.primary)
                Text(item.departAt.formatFull(), style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.SemiBold))
            }
            Row(verticalAlignment = Alignment.CenterVertically, horizontalArrangement = Arrangement.spacedBy(6.dp)) {
                Icon(Icons.Default.Place, contentDescription = null, tint = Color(0xFF5C6BC0))
                Text("出发地：${item.origin}", style = MaterialTheme.typography.bodyMedium)
            }
            Row(verticalAlignment = Alignment.CenterVertically, horizontalArrangement = Arrangement.spacedBy(6.dp)) {
                Icon(Icons.Default.DirectionsCar, contentDescription = null, tint = Color(0xFF26A69A))
                Text("目的地：${item.resort?.name ?: "未知雪场"}", style = MaterialTheme.typography.bodyMedium)
            }
            Text(item.note, style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.onSurfaceVariant)
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun CarpoolPublishScreen(
    onBackClick: () -> Unit,
    onPublished: () -> Unit,
    vm: CarpoolVM = viewModel(factory = CarpoolVM.factory())
) {
    val resorts by vm.resorts.collectAsStateWithLifecycle()

    var selectedDate by rememberSaveable { mutableStateOf(LocalDate.now()) }
    var selectedTime by rememberSaveable { mutableStateOf(LocalTime.of(8, 30)) }
    var selectedResort by rememberSaveable { mutableStateOf<ResortRef?>(null) }
    var showResortPicker by remember { mutableStateOf(false) }
    var showDatePicker by remember { mutableStateOf(false) }
    var showTimePicker by remember { mutableStateOf(false) }

    var origin by rememberSaveable { mutableStateOf("") }
    var note by rememberSaveable { mutableStateOf("") }

    val datePickerState = rememberDatePickerState()
    val timePickerState = rememberTimePickerState(
        initialHour = selectedTime.hour,
        initialMinute = selectedTime.minute,
        is24Hour = true
    )

    val snackbarHostState = remember { SnackbarHostState() }
    val scope = rememberCoroutineScope()

    val isValid = origin.isNotBlank() && note.isNotBlank() && selectedResort != null

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("发布顺风车") },
                navigationIcon = {
                    IconButton(onClick = onBackClick) {
                        Icon(Icons.Default.ArrowBack, contentDescription = "返回")
                    }
                }
            )
        },
        snackbarHost = { SnackbarHost(hostState = snackbarHostState) }
    ) { innerPadding ->
        LazyColumn(
            modifier = Modifier
                .padding(innerPadding)
                .fillMaxSize()
                .padding(16.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            item {
                OutlinedButton(
                    onClick = { showDatePicker = true },
                    modifier = Modifier.fillMaxWidth(),
                    shape = RoundedCornerShape(14.dp)
                ) {
                    Icon(Icons.Default.CalendarToday, contentDescription = null)
                    Spacer(modifier = Modifier.size(6.dp))
                    Text(selectedDate.formatFullDate())
                }
            }
            item {
                OutlinedButton(
                    onClick = { showTimePicker = true },
                    modifier = Modifier.fillMaxWidth(),
                    shape = RoundedCornerShape(14.dp)
                ) {
                    Icon(Icons.Default.Schedule, contentDescription = null)
                    Spacer(modifier = Modifier.size(6.dp))
                    Text(selectedTime.formatTime())
                }
            }
            item {
                OutlinedButton(
                    onClick = { showResortPicker = true },
                    modifier = Modifier.fillMaxWidth(),
                    shape = RoundedCornerShape(14.dp)
                ) {
                    Icon(Icons.Default.DirectionsCar, contentDescription = null)
                    Spacer(modifier = Modifier.size(6.dp))
                    Text(selectedResort?.name ?: "选择目的地雪场")
                }
            }
            item {
                OutlinedTextField(
                    value = origin,
                    onValueChange = { origin = it },
                    modifier = Modifier.fillMaxWidth(),
                    label = { Text("出发地") },
                    leadingIcon = { Icon(Icons.Default.Place, contentDescription = null) }
                )
            }
            item {
                OutlinedTextField(
                    value = note,
                    onValueChange = { note = it },
                    modifier = Modifier.fillMaxWidth(),
                    label = { Text("备注/联系方式") },
                    leadingIcon = { Icon(Icons.Default.Textsms, contentDescription = null) },
                    minLines = 3
                )
            }
            item {
                Button(
                    onClick = {
                        scope.launch {
                            val r = vm.publish(
                                selectedDate = selectedDate,
                                selectedTime = selectedTime,
                                resortId = selectedResort!!.id,
                                origin = origin,
                                note = note
                            )
                            r.onSuccess {
                                snackbarHostState.showSnackbar("发布成功")
                                onPublished()
                            }.onFailure {
                                snackbarHostState.showSnackbar(it.message ?: "发布失败")
                            }
                        }
                    },
                    enabled = isValid,
                    modifier = Modifier.fillMaxWidth(),
                    shape = RoundedCornerShape(18.dp)
                ) { Text("发布") }
            }
        }
    }

    if (showResortPicker) {
        ResortPickerDialog(
            allResorts = resorts,
            selectedResort = selectedResort,
            onDismissRequest = { showResortPicker = false },
            onResortSelected = {
                selectedResort = it
                showResortPicker = false
            }
        )
    }

    if (showDatePicker) {
        DatePickerDialog(
            onDismissRequest = { showDatePicker = false },
            confirmButton = {
                TextButton(onClick = {
                    datePickerState.selectedDateMillis?.toLocalDate()?.let { selectedDate = it }
                    showDatePicker = false
                }) { Text("确定") }
            },
            dismissButton = { TextButton(onClick = { showDatePicker = false }) { Text("取消") } }
        ) { DatePicker(state = datePickerState) }
    }

    if (showTimePicker) {
        TimePickerDialog(
            onDismissRequest = { showTimePicker = false },
            onConfirm = {
                selectedTime = LocalTime.of(timePickerState.hour, timePickerState.minute)
                showTimePicker = false
            }
        ) { TimePicker(state = timePickerState) }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun MyCarpoolScreen(
    onBackClick: () -> Unit,
    vm: CarpoolVM = viewModel(factory = CarpoolVM.factory())
) {
    val state by vm.myState.collectAsStateWithLifecycle()
    val snackbarHostState = remember { SnackbarHostState() }
    val scope = rememberCoroutineScope()
    var deleteTarget by remember { mutableStateOf<CarpoolItem?>(null) }

    androidx.compose.runtime.LaunchedEffect(Unit) { vm.refreshMy() }

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("我的顺风车") },
                navigationIcon = {
                    IconButton(onClick = onBackClick) { Icon(Icons.Default.ArrowBack, contentDescription = "返回") }
                }
            )
        },
        snackbarHost = { SnackbarHost(hostState = snackbarHostState) }
    ) { innerPadding ->
        when {
            state.isLoading && state.items.isEmpty() -> {
                Box(modifier = Modifier.padding(innerPadding).fillMaxSize(), contentAlignment = Alignment.Center) {
                    Text("加载中...")
                }
            }
            state.items.isEmpty() -> {
                Box(modifier = Modifier.padding(innerPadding).fillMaxSize(), contentAlignment = Alignment.Center) {
                    Text(state.error ?: "暂无顺风车记录", color = MaterialTheme.colorScheme.onSurfaceVariant)
                }
            }
            else -> {
                LazyColumn(
                    modifier = Modifier
                        .padding(innerPadding)
                        .fillMaxSize()
                        .padding(16.dp),
                    verticalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    items(state.items, key = { it.id }) { item ->
                        ElevatedCard(
                            modifier = Modifier.fillMaxWidth(),
                            colors = CardDefaults.elevatedCardColors(containerColor = Color.White),
                            shape = RoundedCornerShape(18.dp)
                        ) {
                            Row(
                                modifier = Modifier.fillMaxWidth().padding(12.dp),
                                horizontalArrangement = Arrangement.SpaceBetween,
                                verticalAlignment = Alignment.CenterVertically
                            ) {
                                Column(verticalArrangement = Arrangement.spacedBy(6.dp)) {
                                    Text(item.departAt.formatFull(), style = MaterialTheme.typography.titleMedium)
                                    Text(item.resort?.name ?: "未知雪场", color = MaterialTheme.colorScheme.onSurfaceVariant)
                                    Text(item.note, maxLines = 2, overflow = TextOverflow.Ellipsis)
                                }
                                IconButton(onClick = { deleteTarget = item }) {
                                    Icon(Icons.Default.Delete, contentDescription = "删除", tint = MaterialTheme.colorScheme.onSurfaceVariant)
                                }
                            }
                        }
                    }

                    if (!state.endReached) {
                        item {
                            Box(
                                modifier = Modifier.fillMaxWidth(),
                                contentAlignment = Alignment.Center
                            ) {
                                TextButton(onClick = { vm.loadMorePublic() }) {
                                    Text(if (state.isLoading) "加载中..." else "加载更多")
                                }
                            }
                        }

                    }
                }
            }
        }
    }

    deleteTarget?.let { target ->
        AlertDialog(
            onDismissRequest = { deleteTarget = null },
            title = { Text("删除帖子") },
            text = { Text("删除后无法恢复，确认删除这条顺风车信息吗？") },
            confirmButton = {
                TextButton(onClick = {
                    scope.launch {
                        val r = vm.deleteMy(target.id)
                        r.onSuccess { snackbarHostState.showSnackbar("已删除") }
                            .onFailure { snackbarHostState.showSnackbar(it.message ?: "删除失败") }
                        deleteTarget = null
                    }
                }) { Text("删除", color = MaterialTheme.colorScheme.error) }
            },
            dismissButton = { TextButton(onClick = { deleteTarget = null }) { Text("取消") } }
        )
    }
}

/* =========================
 * 拼房合租
 * ========================= */
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun RoommateScreen(
    onBackClick: () -> Unit,
    onPublishClick: () -> Unit,
    onMyRoommateClick: () -> Unit,
    vm: RoommateVM = viewModel(factory = RoommateVM.factory())
) {
    val resorts by vm.resorts.collectAsStateWithLifecycle()
    val selectedResort by vm.selectedResort.collectAsStateWithLifecycle()
    val state by vm.publicState.collectAsStateWithLifecycle()

    var showResortPicker by remember { mutableStateOf(false) }

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("拼房合租") },
                navigationIcon = {
                    IconButton(onClick = onBackClick) { Icon(Icons.Default.ArrowBack, contentDescription = "返回") }
                },
                actions = {
                    IconButton(onClick = onMyRoommateClick) { Icon(Icons.Default.ListAlt, contentDescription = "我的拼房") }
                    IconButton(onClick = onPublishClick) { Icon(Icons.Default.Add, contentDescription = "发布") }
                }
            )
        }
    ) { innerPadding ->
        Column(
            modifier = Modifier.padding(innerPadding)
                .fillMaxSize()
                .background(Color(0xFFF5F5F7))
                .padding(16.dp)
        ) {
            AssistChip(
                onClick = { showResortPicker = true },
                label = { Text(selectedResort?.name ?: "所有雪场") },
                leadingIcon = { Icon(Icons.Default.Place, contentDescription = null, tint = MaterialTheme.colorScheme.primary) }
            )

            Spacer(modifier = Modifier.height(12.dp))

            when {
                state.isLoading && state.items.isEmpty() -> {
                    Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) { Text("加载中...") }
                }
                state.items.isEmpty() -> {
                    Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
                        Text(state.error ?: "暂无拼房信息", color = MaterialTheme.colorScheme.onSurfaceVariant)
                    }
                }
                else -> {
                    LazyColumn(verticalArrangement = Arrangement.spacedBy(10.dp)) {
                        items(state.items, key = { it.id }) { item ->
                            RoommateCard(item = item)
                        }
                        if (!state.endReached) {
                            item {
                                Spacer(modifier = Modifier.height(8.dp))
                                TextButton(
                                    onClick = { vm.loadMorePublic() },
                                    modifier = Modifier.align(Alignment.CenterHorizontally)
                                ) { Text(if (state.isLoading) "加载中..." else "加载更多") }
                            }
                        }
                    }
                }
            }
        }
    }

    if (showResortPicker) {
        ResortPickerDialog(
            allResorts = resorts,
            selectedResort = selectedResort,
            onDismissRequest = { showResortPicker = false },
            onResortSelected = {
                vm.selectResort(it)
                showResortPicker = false
            }
        )
    }
}

@Composable
fun RoommateCard(item: RoommateItem) {
    ElevatedCard(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.elevatedCardColors(containerColor = Color.White),
        shape = RoundedCornerShape(18.dp)
    ) {
        Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {
            Row(horizontalArrangement = Arrangement.SpaceBetween, modifier = Modifier.fillMaxWidth()) {
                Text(item.resort?.name ?: "未知雪场", style = MaterialTheme.typography.titleMedium)
                Text(item.createdAt.formatShortDate(), color = MaterialTheme.colorScheme.onSurfaceVariant)
            }
            Text(item.content, style = MaterialTheme.typography.bodyMedium, maxLines = 3, overflow = TextOverflow.Ellipsis)
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun RoommatePublishScreen(
    onBackClick: () -> Unit,
    onPublished: () -> Unit,
    vm: RoommateVM = viewModel(factory = RoommateVM.factory())
) {
    val resorts by vm.resorts.collectAsStateWithLifecycle()

    var selectedResort by rememberSaveable { mutableStateOf<ResortRef?>(null) }
    var showResortPicker by remember { mutableStateOf(false) }
    var content by rememberSaveable { mutableStateOf("") }

    val snackbarHostState = remember { SnackbarHostState() }
    val scope = rememberCoroutineScope()

    val isValid = content.isNotBlank() && selectedResort != null

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("发布拼房合租") },
                navigationIcon = {
                    IconButton(onClick = onBackClick) { Icon(Icons.Default.ArrowBack, contentDescription = "返回") }
                }
            )
        },
        snackbarHost = { SnackbarHost(hostState = snackbarHostState) }
    ) { innerPadding ->
        Column(
            modifier = Modifier.padding(innerPadding)
                .fillMaxSize()
                .verticalScroll(rememberScrollState())
                .padding(16.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            OutlinedButton(
                onClick = { showResortPicker = true },
                modifier = Modifier.fillMaxWidth(),
                shape = RoundedCornerShape(14.dp)
            ) {
                Icon(Icons.Default.Place, contentDescription = null)
                Spacer(modifier = Modifier.size(6.dp))
                Text(selectedResort?.name ?: "选择雪场")
            }

            OutlinedTextField(
                value = content,
                onValueChange = { content = it },
                modifier = Modifier.fillMaxWidth(),
                label = { Text("拼房内容") },
                minLines = 4,
                keyboardOptions = KeyboardOptions(capitalization = KeyboardCapitalization.Sentences)
            )

            Text("平台仅提供信息展示，线下交易请注意安全。", color = MaterialTheme.colorScheme.onSurfaceVariant, fontSize = 12.sp)

            Button(
                onClick = {
                    scope.launch {
                        val r = vm.publish(resortId = selectedResort!!.id, content = content)
                        r.onSuccess {
                            snackbarHostState.showSnackbar("发布成功")
                            onPublished()
                        }.onFailure {
                            snackbarHostState.showSnackbar(it.message ?: "发布失败")
                        }
                    }
                },
                enabled = isValid,
                modifier = Modifier.fillMaxWidth(),
                shape = RoundedCornerShape(18.dp)
            ) { Text("发布") }
        }
    }

    if (showResortPicker) {
        ResortPickerDialog(
            allResorts = resorts,
            selectedResort = selectedResort,
            onDismissRequest = { showResortPicker = false },
            onResortSelected = {
                selectedResort = it
                showResortPicker = false
            }
        )
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun MyRoommateScreen(
    onBackClick: () -> Unit,
    vm: RoommateVM = viewModel(factory = RoommateVM.factory())
) {
    val state by vm.myState.collectAsStateWithLifecycle()
    val snackbarHostState = remember { SnackbarHostState() }
    val scope = rememberCoroutineScope()
    var deleteTarget by remember { mutableStateOf<RoommateItem?>(null) }

    androidx.compose.runtime.LaunchedEffect(Unit) { vm.refreshMy() }

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("我的拼房") },
                navigationIcon = { IconButton(onClick = onBackClick) { Icon(Icons.Default.ArrowBack, contentDescription = "返回") } }
            )
        },
        snackbarHost = { SnackbarHost(hostState = snackbarHostState) }
    ) { innerPadding ->
        when {
            state.isLoading && state.items.isEmpty() -> {
                Box(modifier = Modifier.padding(innerPadding).fillMaxSize(), contentAlignment = Alignment.Center) { Text("加载中...") }
            }
            state.items.isEmpty() -> {
                Box(modifier = Modifier.padding(innerPadding).fillMaxSize(), contentAlignment = Alignment.Center) {
                    Text(state.error ?: "暂无拼房记录", color = MaterialTheme.colorScheme.onSurfaceVariant)
                }
            }
            else -> {
                LazyColumn(
                    modifier = Modifier.padding(innerPadding).fillMaxSize().padding(16.dp),
                    verticalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    items(state.items, key = { it.id }) { item ->
                        ElevatedCard(
                            modifier = Modifier.fillMaxWidth(),
                            colors = CardDefaults.elevatedCardColors(containerColor = Color.White),
                            shape = RoundedCornerShape(18.dp)
                        ) {
                            Column(modifier = Modifier.padding(14.dp), verticalArrangement = Arrangement.spacedBy(8.dp)) {
                                Row(horizontalArrangement = Arrangement.SpaceBetween, modifier = Modifier.fillMaxWidth()) {
                                    Text(item.resort?.name ?: "未知雪场", style = MaterialTheme.typography.titleMedium)
                                    Text(item.createdAt.formatShortDate(), color = MaterialTheme.colorScheme.onSurfaceVariant)
                                }
                                Text(item.content, maxLines = 3, overflow = TextOverflow.Ellipsis)

                                Row(
                                    horizontalArrangement = Arrangement.End,
                                    verticalAlignment = Alignment.CenterVertically,
                                    modifier = Modifier.fillMaxWidth()
                                ) {
                                    IconButton(onClick = { deleteTarget = item }) {
                                        Icon(Icons.Default.Delete, contentDescription = "删除", tint = MaterialTheme.colorScheme.onSurfaceVariant)
                                    }
                                }
                            }
                        }
                    }

                    if (!state.endReached) {
                        item {
                            Box(
                                modifier = Modifier.fillMaxWidth(),
                                contentAlignment = Alignment.Center
                            ) {
                                TextButton(onClick = { vm.loadMorePublic() }) {
                                    Text(if (state.isLoading) "加载中..." else "加载更多")
                                }
                            }
                        }

                    }
                }
            }
        }
    }

    deleteTarget?.let { target ->
        AlertDialog(
            onDismissRequest = { deleteTarget = null },
            title = { Text("删除帖子") },
            text = { Text("删除后无法恢复，确认删除这条拼房信息吗？") },
            confirmButton = {
                TextButton(onClick = {
                    scope.launch {
                        val r = vm.deleteMy(target.id)
                        r.onSuccess { snackbarHostState.showSnackbar("已删除") }
                            .onFailure { snackbarHostState.showSnackbar(it.message ?: "删除失败") }
                        deleteTarget = null
                    }
                }) { Text("删除", color = MaterialTheme.colorScheme.error) }
            },
            dismissButton = { TextButton(onClick = { deleteTarget = null }) { Text("取消") } }
        )
    }
}

/* =========================
 * 公共组件
 * ========================= */
@Composable
fun ResortPickerDialog(
    allResorts: List<ResortRef>,
    selectedResort: ResortRef?,
    onDismissRequest: () -> Unit,
    onResortSelected: (ResortRef?) -> Unit
) {
    var query by rememberSaveable { mutableStateOf("") }
    val filtered = allResorts.filter { it.name.contains(query, ignoreCase = true) }

    AlertDialog(
        onDismissRequest = onDismissRequest,
        confirmButton = {},
        text = {
            Column(verticalArrangement = Arrangement.spacedBy(12.dp)) {
                OutlinedTextField(
                    value = query,
                    onValueChange = { query = it },
                    modifier = Modifier.fillMaxWidth(),
                    label = { Text("搜索雪场") },
                    leadingIcon = { Icon(Icons.Default.Search, contentDescription = null) },
                    singleLine = true
                )

                LazyColumn(modifier = Modifier.height(260.dp)) {
                    item {
                        Row(
                            modifier = Modifier.fillMaxWidth()
                                .clickable {
                                    onResortSelected(null)
                                    onDismissRequest()
                                }
                                .padding(vertical = 10.dp),
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Text("所有雪场", fontWeight = FontWeight.SemiBold)
                        }
                    }

                    items(filtered) { resort ->
                        Row(
                            modifier = Modifier.fillMaxWidth()
                                .clickable {
                                    onResortSelected(resort)
                                    onDismissRequest()
                                }
                                .padding(vertical = 10.dp),
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            val isSelected = resort.id == selectedResort?.id
                            val bg = if (isSelected) MaterialTheme.colorScheme.primary.copy(alpha = 0.08f) else Color.Transparent
                            Box(
                                modifier = Modifier
                                    .clip(RoundedCornerShape(12.dp))
                                    .background(bg)
                                    .padding(8.dp)
                            ) {
                                Text(
                                    resort.name,
                                    color = if (isSelected) MaterialTheme.colorScheme.primary else MaterialTheme.colorScheme.onSurface
                                )
                            }
                        }
                    }
                }
            }
        }
    )
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun TimePickerDialog(
    onDismissRequest: () -> Unit,
    onConfirm: () -> Unit,
    content: @Composable () -> Unit
) {
    AlertDialog(
        onDismissRequest = onDismissRequest,
        confirmButton = { TextButton(onClick = onConfirm) { Text("确定") } },
        dismissButton = { TextButton(onClick = onDismissRequest) { Text("取消") } },
        text = content
    )
}

/* =========================
 * 工具方法
 * ========================= */
private fun Long.toLocalDate(): LocalDate =
    Instant.ofEpochMilli(this).atZone(ZoneId.systemDefault()).toLocalDate()

private fun LocalDate.formatShort(): String =
    DateTimeFormatter.ofPattern("MM/dd", Locale.getDefault()).format(this)

private fun LocalDate.formatFullDate(): String =
    DateTimeFormatter.ofPattern("yyyy年MM月dd日", Locale.getDefault()).format(this)

private fun LocalTime.formatTime(): String =
    DateTimeFormatter.ofPattern("HH:mm", Locale.getDefault()).format(this)

private fun LocalDateTime.formatShortDate(): String =
    DateTimeFormatter.ofPattern("MM/dd HH:mm", Locale.getDefault()).format(this)

private fun LocalDateTime.formatFull(): String =
    DateTimeFormatter.ofPattern("MM月dd日 HH:mm", Locale.getDefault()).format(this)


==================================================

File: app\src\main\java\com\gosnow\app\ui\discover\DiscoverViewModels.kt
--------------------------------------------------
package com.gosnow.app.ui.discover

import androidx.lifecycle.ViewModel
import androidx.lifecycle.ViewModelProvider
import androidx.lifecycle.viewModelScope
import com.gosnow.app.datasupabase.CarpoolInsert
import com.gosnow.app.datasupabase.CarpoolItem
import com.gosnow.app.datasupabase.DiscoverRepository
import com.gosnow.app.datasupabase.LostAndFoundInsert
import com.gosnow.app.datasupabase.LostAndFoundItem
import com.gosnow.app.datasupabase.LostFoundType
import com.gosnow.app.datasupabase.ResortRef
import com.gosnow.app.datasupabase.RoommateInsert
import com.gosnow.app.datasupabase.RoommateItem
import com.gosnow.app.datasupabase.SupabaseClientProvider
import io.github.jan.supabase.SupabaseClient
import io.github.jan.supabase.gotrue.auth
import kotlinx.coroutines.Job
import kotlinx.coroutines.delay
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.flow.update
import kotlinx.coroutines.launch
import java.time.LocalDate
import java.time.LocalDateTime
import java.time.LocalTime
import java.time.ZoneId
import java.time.ZoneOffset
import java.time.format.DateTimeFormatter

private const val DEFAULT_PAGE_SIZE = 10

data class PagedUiState<T>(
    val items: List<T> = emptyList(),
    val isLoading: Boolean = false,
    val endReached: Boolean = false,
    val error: String? = null
)

private fun SupabaseClient.currentUserIdOrNull(): String? {
    // 官方 Kotlin: currentSessionOrNull() 用来拿 session（user 在 session 里）
    return auth.currentSessionOrNull()?.user?.id
}

/* =========================
 * Lost & Found VM
 * ========================= */
class LostAndFoundVM(
    private val supabase: SupabaseClient,
    private val repo: DiscoverRepository,
    private val pageSize: Long = DEFAULT_PAGE_SIZE.toLong()
) : ViewModel() {

    private val _resorts = MutableStateFlow<List<ResortRef>>(emptyList())
    val resorts: StateFlow<List<ResortRef>> = _resorts.asStateFlow()

    private val _selectedResort = MutableStateFlow<ResortRef?>(null)
    val selectedResort: StateFlow<ResortRef?> = _selectedResort.asStateFlow()

    private val _selectedDate = MutableStateFlow<LocalDate?>(null)
    val selectedDate: StateFlow<LocalDate?> = _selectedDate.asStateFlow()

    private val _keyword = MutableStateFlow("")
    val keyword: StateFlow<String> = _keyword.asStateFlow()

    private val _publicState = MutableStateFlow(PagedUiState<LostAndFoundItem>())
    val publicState: StateFlow<PagedUiState<LostAndFoundItem>> = _publicState.asStateFlow()

    private val _myState = MutableStateFlow(PagedUiState<LostAndFoundItem>())
    val myState: StateFlow<PagedUiState<LostAndFoundItem>> = _myState.asStateFlow()

    private var keywordJob: Job? = null

    init {
        viewModelScope.launch {
            loadResortsIfNeeded()
            refreshPublic()
        }
    }

    fun selectResort(resort: ResortRef?) {
        _selectedResort.value = resort
        refreshPublic()
    }

    fun selectDate(date: LocalDate?) {
        _selectedDate.value = date
        refreshPublic()
    }

    fun setKeyword(text: String) {
        _keyword.value = text
        keywordJob?.cancel()
        keywordJob = viewModelScope.launch {
            delay(300)
            refreshPublic()
        }
    }

    fun refreshPublic() = viewModelScope.launch {
        _publicState.update { it.copy(isLoading = true, error = null) }
        runCatching {
            repo.listLostAndFound(
                resortId = _selectedResort.value?.id,
                date = _selectedDate.value,
                keyword = _keyword.value,
                offset = 0,
                pageSize = pageSize
            )
        }.onSuccess { list ->
            _publicState.value = PagedUiState(
                items = list,
                isLoading = false,
                endReached = list.size < pageSize.toInt(),
                error = null
            )
        }.onFailure { e ->
            _publicState.update { it.copy(isLoading = false, error = e.message ?: "加载失败") }
        }
    }

    fun loadMorePublic() = viewModelScope.launch {
        val cur = _publicState.value
        if (cur.isLoading || cur.endReached) return@launch
        _publicState.update { it.copy(isLoading = true, error = null) }

        val offset = cur.items.size.toLong()
        runCatching {
            repo.listLostAndFound(
                resortId = _selectedResort.value?.id,
                date = _selectedDate.value,
                keyword = _keyword.value,
                offset = offset,
                pageSize = pageSize
            )
        }.onSuccess { more ->
            val merged = cur.items + more
            _publicState.value = cur.copy(
                items = merged,
                isLoading = false,
                endReached = more.size < pageSize.toInt(),
                error = null
            )
        }.onFailure { e ->
            _publicState.update { it.copy(isLoading = false, error = e.message ?: "加载失败") }
        }
    }

    fun refreshMy() = viewModelScope.launch {
        val myUserId = supabase.currentUserIdOrNull()
        if (myUserId == null) {
            _myState.value = PagedUiState(items = emptyList(), isLoading = false, endReached = true, error = "请先登录")
            return@launch
        }

        _myState.update { it.copy(isLoading = true, error = null) }
        runCatching {
            repo.listMyLostAndFound(
                myUserId = myUserId,
                offset = 0,
                pageSize = pageSize
            )
        }.onSuccess { list ->
            _myState.value = PagedUiState(
                items = list,
                isLoading = false,
                endReached = list.size < pageSize.toInt(),
                error = null
            )
        }.onFailure { e ->
            _myState.update { it.copy(isLoading = false, error = e.message ?: "加载失败") }
        }
    }

    fun loadMoreMy() = viewModelScope.launch {
        val myUserId = supabase.currentUserIdOrNull() ?: run {
            _myState.update { it.copy(error = "请先登录") }
            return@launch
        }

        val cur = _myState.value
        if (cur.isLoading || cur.endReached) return@launch
        _myState.update { it.copy(isLoading = true, error = null) }

        val offset = cur.items.size.toLong()
        runCatching {
            repo.listMyLostAndFound(
                myUserId = myUserId,
                offset = offset,
                pageSize = pageSize
            )
        }.onSuccess { more ->
            val merged = cur.items + more
            _myState.value = cur.copy(
                items = merged,
                isLoading = false,
                endReached = more.size < pageSize.toInt(),
                error = null
            )
        }.onFailure { e ->
            _myState.update { it.copy(isLoading = false, error = e.message ?: "加载失败") }
        }
    }

    suspend fun publish(
        type: LostFoundType,
        description: String,
        contact: String,
        resortId: Long?
    ): Result<Unit> {
        val myUserId = supabase.currentUserIdOrNull() ?: return Result.failure(IllegalStateException("请先登录"))

        val payload = LostAndFoundInsert(
            resortId = resortId,
            itemDescription = description,
            contactInfo = contact,
            type = if (type == LostFoundType.LOST) "LOST" else "FOUND",
            userId = myUserId,
            imageUrl = null
        )

        return runCatching {
            repo.publishLostAndFound(payload)
        }
    }

    suspend fun deleteMy(itemId: Long): Result<Unit> {
        val myUserId = supabase.currentUserIdOrNull() ?: return Result.failure(IllegalStateException("请先登录"))
        return runCatching {
            repo.deleteLostAndFound(itemId, myUserId)
            _myState.update { it.copy(items = it.items.filterNot { x -> x.id == itemId }) }
        }
    }

    private suspend fun loadResortsIfNeeded() {
        if (_resorts.value.isNotEmpty()) return
        runCatching { repo.fetchResorts() }
            .onSuccess { _resorts.value = it }
            .onFailure { /* 不阻塞主流程 */ }
    }

    companion object {
        fun factory(): ViewModelProvider.Factory = object : ViewModelProvider.Factory {
            @Suppress("UNCHECKED_CAST")
            override fun <T : ViewModel> create(modelClass: Class<T>): T {
                val client = SupabaseClientProvider.supabaseClient
                return LostAndFoundVM(
                    supabase = client,
                    repo = DiscoverRepository(client)
                ) as T
            }
        }
    }
}

/* =========================
 * Carpool VM
 * ========================= */
class CarpoolVM(
    private val supabase: SupabaseClient,
    private val repo: DiscoverRepository,
    private val pageSize: Long = DEFAULT_PAGE_SIZE.toLong()
) : ViewModel() {

    private val isoOffset = DateTimeFormatter.ISO_OFFSET_DATE_TIME
    private val zone = ZoneId.systemDefault()

    private val _resorts = MutableStateFlow<List<ResortRef>>(emptyList())
    val resorts: StateFlow<List<ResortRef>> = _resorts.asStateFlow()

    private val _selectedResort = MutableStateFlow<ResortRef?>(null)
    val selectedResort: StateFlow<ResortRef?> = _selectedResort.asStateFlow()

    private val _selectedDate = MutableStateFlow<LocalDate?>(null)
    val selectedDate: StateFlow<LocalDate?> = _selectedDate.asStateFlow()

    private val _publicState = MutableStateFlow(PagedUiState<CarpoolItem>())
    val publicState: StateFlow<PagedUiState<CarpoolItem>> = _publicState.asStateFlow()

    private val _myState = MutableStateFlow(PagedUiState<CarpoolItem>())
    val myState: StateFlow<PagedUiState<CarpoolItem>> = _myState.asStateFlow()

    init {
        viewModelScope.launch {
            loadResortsIfNeeded()
            refreshPublic()
        }
    }

    fun selectResort(resort: ResortRef?) {
        _selectedResort.value = resort
        refreshPublic()
    }

    fun selectDate(date: LocalDate?) {
        _selectedDate.value = date
        refreshPublic()
    }

    fun refreshPublic() = viewModelScope.launch {
        _publicState.update { it.copy(isLoading = true, error = null) }

        runCatching {
            repo.listCarpool(
                resortId = _selectedResort.value?.id,
                date = _selectedDate.value,
                offset = 0,
                pageSize = pageSize
            )
        }.onSuccess { list ->
            _publicState.value = PagedUiState(
                items = list,
                isLoading = false,
                endReached = list.size < pageSize.toInt(),
                error = null
            )
        }.onFailure { e ->
            _publicState.update { it.copy(isLoading = false, error = e.message ?: "加载失败") }
        }
    }

    fun loadMorePublic() = viewModelScope.launch {
        val cur = _publicState.value
        if (cur.isLoading || cur.endReached) return@launch
        _publicState.update { it.copy(isLoading = true, error = null) }

        val offset = cur.items.size.toLong()
        runCatching {
            repo.listCarpool(
                resortId = _selectedResort.value?.id,
                date = _selectedDate.value,
                offset = offset,
                pageSize = pageSize
            )
        }.onSuccess { more ->
            val merged = cur.items + more
            _publicState.value = cur.copy(
                items = merged,
                isLoading = false,
                endReached = more.size < pageSize.toInt(),
                error = null
            )
        }.onFailure { e ->
            _publicState.update { it.copy(isLoading = false, error = e.message ?: "加载失败") }
        }
    }

    fun refreshMy() = viewModelScope.launch {
        val myUserId = supabase.currentUserIdOrNull()
        if (myUserId == null) {
            _myState.value = PagedUiState(items = emptyList(), isLoading = false, endReached = true, error = "请先登录")
            return@launch
        }

        _myState.update { it.copy(isLoading = true, error = null) }
        runCatching {
            repo.listMyCarpool(
                myUserId = myUserId,
                offset = 0,
                pageSize = pageSize
            )
        }.onSuccess { list ->
            _myState.value = PagedUiState(
                items = list,
                isLoading = false,
                endReached = list.size < pageSize.toInt(),
                error = null
            )
        }.onFailure { e ->
            _myState.update { it.copy(isLoading = false, error = e.message ?: "加载失败") }
        }
    }

    fun loadMoreMy() = viewModelScope.launch {
        val myUserId = supabase.currentUserIdOrNull() ?: run {
            _myState.update { it.copy(error = "请先登录") }
            return@launch
        }

        val cur = _myState.value
        if (cur.isLoading || cur.endReached) return@launch
        _myState.update { it.copy(isLoading = true, error = null) }

        val offset = cur.items.size.toLong()
        runCatching {
            repo.listMyCarpool(
                myUserId = myUserId,
                offset = offset,
                pageSize = pageSize
            )
        }.onSuccess { more ->
            val merged = cur.items + more
            _myState.value = cur.copy(
                items = merged,
                isLoading = false,
                endReached = more.size < pageSize.toInt(),
                error = null
            )
        }.onFailure { e ->
            _myState.update { it.copy(isLoading = false, error = e.message ?: "加载失败") }
        }
    }

    suspend fun publish(
        selectedDate: LocalDate,
        selectedTime: LocalTime,
        resortId: Long,
        origin: String,
        note: String
    ): Result<Unit> {
        val myUserId = supabase.currentUserIdOrNull() ?: return Result.failure(IllegalStateException("请先登录"))

        val departLdt = LocalDateTime.of(selectedDate, selectedTime)
        val departOdt = departLdt.atZone(zone).toOffsetDateTime()

        val departAt = departOdt.format(isoOffset)
        val departDateUtc = departOdt.withOffsetSameInstant(ZoneOffset.UTC).toLocalDate().toString()
        val expiresAt = departOdt.plusDays(1).format(isoOffset)

        val payload = CarpoolInsert(
            userId = myUserId,
            resortId = resortId,
            departAt = departAt,
            originText = origin,
            note = note,
            expiresAt = expiresAt,
            departDateUtc = departDateUtc
        )

        return runCatching {
            repo.publishCarpool(payload)
        }
    }

    suspend fun deleteMy(id: String): Result<Unit> {
        val myUserId = supabase.currentUserIdOrNull() ?: return Result.failure(IllegalStateException("请先登录"))
        return runCatching {
            repo.deleteCarpool(id, myUserId)
            _myState.update { it.copy(items = it.items.filterNot { x -> x.id == id }) }
        }
    }

    private suspend fun loadResortsIfNeeded() {
        if (_resorts.value.isNotEmpty()) return
        runCatching { repo.fetchResorts() }
            .onSuccess { _resorts.value = it }
            .onFailure { /* ignore */ }
    }

    companion object {
        fun factory(): ViewModelProvider.Factory = object : ViewModelProvider.Factory {
            @Suppress("UNCHECKED_CAST")
            override fun <T : ViewModel> create(modelClass: Class<T>): T {
                val client = SupabaseClientProvider.supabaseClient
                return CarpoolVM(
                    supabase = client,
                    repo = DiscoverRepository(client)
                ) as T
            }
        }
    }
}

/* =========================
 * Roommate VM
 * ========================= */
class RoommateVM(
    private val supabase: SupabaseClient,
    private val repo: DiscoverRepository,
    private val pageSize: Long = DEFAULT_PAGE_SIZE.toLong()
) : ViewModel() {

    private val _resorts = MutableStateFlow<List<ResortRef>>(emptyList())
    val resorts: StateFlow<List<ResortRef>> = _resorts.asStateFlow()

    private val _selectedResort = MutableStateFlow<ResortRef?>(null)
    val selectedResort: StateFlow<ResortRef?> = _selectedResort.asStateFlow()

    private val _publicState = MutableStateFlow(PagedUiState<RoommateItem>())
    val publicState: StateFlow<PagedUiState<RoommateItem>> = _publicState.asStateFlow()

    private val _myState = MutableStateFlow(PagedUiState<RoommateItem>())
    val myState: StateFlow<PagedUiState<RoommateItem>> = _myState.asStateFlow()

    init {
        viewModelScope.launch {
            loadResortsIfNeeded()
            refreshPublic()
        }
    }

    fun selectResort(resort: ResortRef?) {
        _selectedResort.value = resort
        refreshPublic()
    }

    fun refreshPublic() = viewModelScope.launch {
        _publicState.update { it.copy(isLoading = true, error = null) }

        runCatching {
            repo.listRoommate(
                resortId = _selectedResort.value?.id,
                offset = 0,
                pageSize = pageSize
            )
        }.onSuccess { list ->
            _publicState.value = PagedUiState(
                items = list,
                isLoading = false,
                endReached = list.size < pageSize.toInt(),
                error = null
            )
        }.onFailure { e ->
            _publicState.update { it.copy(isLoading = false, error = e.message ?: "加载失败") }
        }
    }

    fun loadMorePublic() = viewModelScope.launch {
        val cur = _publicState.value
        if (cur.isLoading || cur.endReached) return@launch
        _publicState.update { it.copy(isLoading = true, error = null) }

        val offset = cur.items.size.toLong()
        runCatching {
            repo.listRoommate(
                resortId = _selectedResort.value?.id,
                offset = offset,
                pageSize = pageSize
            )
        }.onSuccess { more ->
            val merged = cur.items + more
            _publicState.value = cur.copy(
                items = merged,
                isLoading = false,
                endReached = more.size < pageSize.toInt(),
                error = null
            )
        }.onFailure { e ->
            _publicState.update { it.copy(isLoading = false, error = e.message ?: "加载失败") }
        }
    }

    fun refreshMy() = viewModelScope.launch {
        val myUserId = supabase.currentUserIdOrNull()
        if (myUserId == null) {
            _myState.value = PagedUiState(items = emptyList(), isLoading = false, endReached = true, error = "请先登录")
            return@launch
        }

        _myState.update { it.copy(isLoading = true, error = null) }
        runCatching {
            repo.listMyRoommate(
                myUserId = myUserId,
                offset = 0,
                pageSize = pageSize
            )
        }.onSuccess { list ->
            _myState.value = PagedUiState(
                items = list,
                isLoading = false,
                endReached = list.size < pageSize.toInt(),
                error = null
            )
        }.onFailure { e ->
            _myState.update { it.copy(isLoading = false, error = e.message ?: "加载失败") }
        }
    }

    fun loadMoreMy() = viewModelScope.launch {
        val myUserId = supabase.currentUserIdOrNull() ?: run {
            _myState.update { it.copy(error = "请先登录") }
            return@launch
        }

        val cur = _myState.value
        if (cur.isLoading || cur.endReached) return@launch
        _myState.update { it.copy(isLoading = true, error = null) }

        val offset = cur.items.size.toLong()
        runCatching {
            repo.listMyRoommate(
                myUserId = myUserId,
                offset = offset,
                pageSize = pageSize
            )
        }.onSuccess { more ->
            val merged = cur.items + more
            _myState.value = cur.copy(
                items = merged,
                isLoading = false,
                endReached = more.size < pageSize.toInt(),
                error = null
            )
        }.onFailure { e ->
            _myState.update { it.copy(isLoading = false, error = e.message ?: "加载失败") }
        }
    }

    suspend fun publish(resortId: Long, content: String): Result<Unit> {
        val myUserId = supabase.currentUserIdOrNull() ?: return Result.failure(IllegalStateException("请先登录"))
        val payload = RoommateInsert(
            userId = myUserId,
            resortId = resortId,
            content = content
        )
        return runCatching { repo.publishRoommate(payload) }
    }

    suspend fun deleteMy(id: String): Result<Unit> {
        val myUserId = supabase.currentUserIdOrNull() ?: return Result.failure(IllegalStateException("请先登录"))
        return runCatching {
            repo.deleteRoommate(id, myUserId)
            _myState.update { it.copy(items = it.items.filterNot { x -> x.id == id }) }
        }
    }

    private suspend fun loadResortsIfNeeded() {
        if (_resorts.value.isNotEmpty()) return
        runCatching { repo.fetchResorts() }
            .onSuccess { _resorts.value = it }
            .onFailure { /* ignore */ }
    }

    companion object {
        fun factory(): ViewModelProvider.Factory = object : ViewModelProvider.Factory {
            @Suppress("UNCHECKED_CAST")
            override fun <T : ViewModel> create(modelClass: Class<T>): T {
                val client = SupabaseClientProvider.supabaseClient
                return RoommateVM(
                    supabase = client,
                    repo = DiscoverRepository(client)
                ) as T
            }
        }
    }
}




==================================================

File: app\src\main\java\com\gosnow\app\ui\home\HomeScreen.kt
--------------------------------------------------
package com.gosnow.app.ui.home

import android.content.Context
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyRow
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.lifecycle.ViewModel
import androidx.lifecycle.ViewModelProvider
import androidx.lifecycle.viewModelScope
import androidx.lifecycle.viewmodel.compose.viewModel
import coil.compose.AsyncImage
import com.gosnow.app.datasupabase.CurrentUserProfile
import com.gosnow.app.datasupabase.CurrentUserStore
import com.gosnow.app.datasupabase.SupabaseClientProvider
import com.gosnow.app.ui.record.storage.FileSessionStore
import com.gosnow.app.ui.record.storage.SupabaseSessionRepository
import com.gosnow.app.ui.record.SkiSession
import com.gosnow.app.ui.theme.GosnowTheme
import io.github.jan.supabase.gotrue.auth
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.update
import kotlinx.coroutines.launch
import java.time.Instant
import java.time.LocalDate
import java.time.ZoneId
import kotlin.math.abs

/**
 * UI state for the Home screen.
 */
data class HomeUiState(
    val todayDistanceKm: Double = 0.0,
    val totalDistanceKm: Double = 0.0,
    val totalDurationHours: Double = 0.0,
    val daysOnSnow: Int = 0,
    val deltaVsYesterdayKm: Double? = null
)

class HomeViewModel(
    private val store: FileSessionStore
) : ViewModel() {

    private val _uiState = MutableStateFlow(HomeUiState())
    val uiState: StateFlow<HomeUiState> = _uiState

    init {
        // 1. 先刷一次本地
        refresh()
        // 2. 触发云同步
        android.util.Log.d("SyncTest", "HomeViewModel Init: 启动同步程序")
        syncFromCloud()
    }

    fun refresh() {
        viewModelScope.launch {
            val sessions = store.loadSessions()

            val zone = ZoneId.systemDefault()
            fun sessionDate(millis: Long): LocalDate =
                Instant.ofEpochMilli(millis).atZone(zone).toLocalDate()

            val today = LocalDate.now(zone)
            val yesterday = today.minusDays(1)

            val todayDistance = sessions
                .filter { sessionDate(it.startAtMillis) == today }
                .sumOf { it.distanceKm }

            val yesterdayDistance = sessions
                .filter { sessionDate(it.startAtMillis) == yesterday }
                .sumOf { it.distanceKm }

            val totalDistance = sessions.sumOf { it.distanceKm }
            val totalDurationHours = sessions.sumOf { it.durationSec }.toDouble() / 3600.0

            val daysOnSnow = sessions
                .map { sessionDate(it.startAtMillis) }
                .distinct()
                .size

            val delta = if (sessions.any { sessionDate(it.startAtMillis) == yesterday }) {
                todayDistance - yesterdayDistance
            } else {
                null
            }

            _uiState.update {
                it.copy(
                    todayDistanceKm = todayDistance,
                    totalDistanceKm = totalDistance,
                    totalDurationHours = totalDurationHours,
                    daysOnSnow = daysOnSnow,
                    deltaVsYesterdayKm = delta
                )
            }
        }
    }

    // ✅ 新增：云同步逻辑
    private fun syncFromCloud() {
        viewModelScope.launch {
            val client = SupabaseClientProvider.supabaseClient

            // 等待 Auth 初始化，避免拿到 null
            var user = client.auth.currentUserOrNull()
            if (user == null) {
                kotlinx.coroutines.delay(1000) // 给 SDK 一秒钟加载 Session
                user = client.auth.currentUserOrNull()
            }

            if (user == null) {
                android.util.Log.e("SyncTest", "同步终止：当前没有登录用户")
                return@launch
            }

            val localSessions = store.loadSessions()
            if (localSessions.isEmpty()) {
                android.util.Log.d("SyncTest", "检测到本地数据为空，开始从云端拉取...")
                val repo = SupabaseSessionRepository(client)
                val remoteSessions = repo.fetchAllSessions(user.id)

                android.util.Log.d("SyncTest", "云端拉取成功，条数: ${remoteSessions.size}")

                if (remoteSessions.isNotEmpty()) {
                    remoteSessions.forEach { store.saveSession(it) }
                    refresh() // 重新刷新本地计算逻辑
                }
            } else {
                android.util.Log.d("SyncTest", "本地已有 ${localSessions.size} 条数据，跳过自动同步")
            }
        }
    }

    companion object {
        fun provideFactory(context: Context): ViewModelProvider.Factory =
            object : ViewModelProvider.Factory {
                @Suppress("UNCHECKED_CAST")
                override fun <T : ViewModel> create(modelClass: Class<T>): T {
                    val store = FileSessionStore(context.applicationContext)
                    return HomeViewModel(store) as T
                }
            }
    }
}

sealed class BottomNavItem(
    val route: String,
    val label: String,
    val icon: ImageVector
) {
    data object Record : BottomNavItem("home", "记录", Icons.Filled.RadioButtonChecked)
    data object Community : BottomNavItem("feed", "雪圈", Icons.Filled.Groups)
    data object Discover : BottomNavItem("discover", "发现", Icons.Filled.Explore)
}

@Composable
fun HomeScreen(
    onStartRecording: () -> Unit,
    onFeatureClick: (String) -> Unit,
    onAvatarClick: () -> Unit,
    onBottomNavSelected: (BottomNavItem) -> Unit,
    currentRoute: String,
    modifier: Modifier = Modifier
) {
    val context = LocalContext.current
    val viewModel: HomeViewModel = viewModel(
        factory = HomeViewModel.provideFactory(context)
    )

    val uiState by viewModel.uiState.collectAsState()
    val currentProfile by CurrentUserStore.profile.collectAsState()

    Scaffold(
        modifier = modifier
    ) { innerPadding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .background(MaterialTheme.colorScheme.background)
                .verticalScroll(rememberScrollState())
                .padding(innerPadding)
        ) {
            HeaderSection(
                profile = currentProfile,
                onAvatarClick = onAvatarClick
            )

            Spacer(modifier = Modifier.height(20.dp))
            TodayHeroCard(uiState)
            Spacer(modifier = Modifier.height(24.dp))
            LifetimeStatsSection(uiState)
            Spacer(modifier = Modifier.height(28.dp))
            FeaturedSection(onFeatureClick = onFeatureClick)
            Spacer(modifier = Modifier.height(32.dp))
            PrimaryActionButton(onStartRecording = onStartRecording)
            Spacer(modifier = Modifier.height(24.dp))
        }
    }
}

/* ------------------------ Header ------------------------ */
@Composable
private fun HeaderSection(
    profile: CurrentUserProfile?,
    onAvatarClick: () -> Unit
) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = 20.dp, vertical = 16.dp),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.CenterVertically
    ) {
        Text(
            text = "25–26 雪季",
            style = MaterialTheme.typography.headlineSmall.copy(
                fontWeight = FontWeight.SemiBold,
                fontSize = 24.sp
            ),
            color = Color(0xFF111111)
        )

        Box(
            modifier = Modifier
                .size(44.dp)
                .clip(CircleShape)
                .background(Color(0xFF111111))
                .clickable { onAvatarClick() },
            contentAlignment = Alignment.Center
        ) {
            when {
                !profile?.avatarUrl.isNullOrBlank() -> {
                    AsyncImage(
                        model = profile!!.avatarUrl,
                        contentDescription = "头像",
                        modifier = Modifier.fillMaxSize()
                    )
                }
                !profile?.userName.isNullOrBlank() -> {
                    val initial = profile!!.userName.first().uppercaseChar().toString()
                    Text(
                        text = initial,
                        color = Color.White,
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold
                    )
                }
                else -> {
                    Text(
                        text = "G",
                        color = Color.White,
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold
                    )
                }
            }
        }
    }
}

/* ------------------------ Today Hero Card ------------------------ */

@Composable
private fun TodayHeroCard(uiState: HomeUiState) {
    ElevatedCard(
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = 20.dp),
        shape = RoundedCornerShape(24.dp),
        colors = CardDefaults.elevatedCardColors(
            containerColor = Color.White
        )
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 20.dp, vertical = 22.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    text = "今日滑行",
                    style = MaterialTheme.typography.titleMedium,
                    color = Color(0xFF111111)
                )

                uiState.deltaVsYesterdayKm?.let { delta ->
                    if (delta != 0.0) {
                        TodayDeltaPill(deltaKm = delta)
                    }
                }
            }

            Row(
                verticalAlignment = Alignment.Bottom,
                horizontalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                Text(
                    text = String.format("%.1f", uiState.todayDistanceKm),
                    style = MaterialTheme.typography.displaySmall.copy(
                        fontWeight = FontWeight.ExtraBold,
                        fontSize = 52.sp
                    ),
                    color = Color(0xFF111111)
                )
                Text(
                    text = "km",
                    style = MaterialTheme.typography.titleLarge,
                    color = Color(0xFF3A3A3C)
                )
            }
        }
    }
}

@Composable
private fun TodayDeltaPill(deltaKm: Double) {
    val isPositive = deltaKm > 0
    val bgColor = if (isPositive) Color(0xFFE6F9EA) else Color(0xFFFFF2E8)
    val textColor = if (isPositive) Color(0xFF1A7F37) else Color(0xFFC23B00)
    val label = if (isPositive) "比昨天多" else "比昨天少"
    val valueText = String.format("%.1f km", abs(deltaKm))

    Surface(
        color = bgColor,
        shape = RoundedCornerShape(999.dp),
        tonalElevation = 0.dp
    ) {
        Row(
            modifier = Modifier.padding(horizontal = 10.dp, vertical = 4.dp),
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.spacedBy(4.dp)
        ) {
            Text(
                text = if (isPositive) "▲" else "▼",
                style = MaterialTheme.typography.labelMedium,
                color = textColor
            )
            Text(
                text = "$label $valueText",
                style = MaterialTheme.typography.labelMedium,
                color = textColor
            )
        }
    }
}

/* ------------------------ Lifetime Stats ------------------------ */

@Composable
private fun LifetimeStatsSection(uiState: HomeUiState) {
    Column(
        modifier = Modifier.padding(horizontal = 20.dp),
        verticalArrangement = Arrangement.spacedBy(12.dp)
    ) {
        Text(
            text = "生涯数据",
            style = MaterialTheme.typography.titleMedium,
            color = Color(0xFF111111)
        )

        Row(
            modifier = Modifier
                .fillMaxWidth()
                .height(IntrinsicSize.Min),
            horizontalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            DistanceStatCard(
                title = "总里程",
                value = String.format("%.1f", uiState.totalDistanceKm),
                icon = Icons.Filled.DownhillSkiing,
                iconTint = Color(0xFF0A84FF),
                modifier = Modifier
                    .weight(1f)
                    .fillMaxHeight()
            )

            Column(
                modifier = Modifier
                    .weight(1f)
                    .fillMaxHeight(),
                verticalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                StatCard(
                    title = "总时长",
                    value = String.format("%.1f 小时", uiState.totalDurationHours),
                    icon = Icons.Filled.AccessTime,
                    iconTint = Color(0xFFFF9F0A),
                    modifier = Modifier
                        .fillMaxWidth()
                        .weight(1f)
                )
                StatCard(
                    title = "在雪天数",
                    value = "${uiState.daysOnSnow} 天",
                    icon = Icons.Filled.AcUnit,
                    iconTint = Color(0xFF5E5CE6),
                    modifier = Modifier
                        .fillMaxWidth()
                        .weight(1f)
                )
            }
        }
    }
}

@Composable
private fun DistanceStatCard(
    title: String,
    value: String,
    icon: ImageVector,
    iconTint: Color,
    modifier: Modifier = Modifier
) {
    ElevatedCard(
        modifier = modifier,
        shape = RoundedCornerShape(20.dp),
        colors = CardDefaults.elevatedCardColors(
            containerColor = Color.White
        )
    ) {
        Box(
            modifier = Modifier
                .fillMaxSize()
                .padding(horizontal = 16.dp, vertical = 14.dp)
        ) {
            Row(
                modifier = Modifier.align(Alignment.TopStart),
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                Box(
                    modifier = Modifier
                        .size(32.dp)
                        .clip(CircleShape)
                        .background(iconTint.copy(alpha = 0.12f)),
                    contentAlignment = Alignment.Center
                ) {
                    Icon(
                        imageVector = icon,
                        contentDescription = title,
                        tint = iconTint,
                        modifier = Modifier.size(18.dp)
                    )
                }
                Text(
                    text = title,
                    style = MaterialTheme.typography.bodyMedium,
                    color = Color(0xFF6E6E73)
                )
            }

            Text(
                text = value,
                style = MaterialTheme.typography.displaySmall.copy(
                    fontWeight = FontWeight.SemiBold,
                    fontSize = 34.sp
                ),
                color = Color(0xFF111111),
                modifier = Modifier.align(Alignment.CenterStart)
            )

            Text(
                text = "km",
                style = MaterialTheme.typography.bodySmall,
                color = Color(0xFF6E6E73),
                modifier = Modifier.align(Alignment.BottomStart)
            )
        }
    }
}

@Composable
private fun StatCard(
    title: String,
    value: String,
    icon: ImageVector,
    iconTint: Color,
    modifier: Modifier = Modifier
) {
    ElevatedCard(
        modifier = modifier,
        shape = RoundedCornerShape(20.dp),
        colors = CardDefaults.elevatedCardColors(
            containerColor = Color.White
        )
    ) {
        Row(
            modifier = Modifier.padding(horizontal = 16.dp, vertical = 14.dp),
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            Box(
                modifier = Modifier
                    .size(32.dp)
                    .clip(CircleShape)
                    .background(iconTint.copy(alpha = 0.12f)),
                contentAlignment = Alignment.Center
            ) {
                Icon(
                    imageVector = icon,
                    contentDescription = title,
                    tint = iconTint,
                    modifier = Modifier.size(18.dp)
                )
            }

            Column(
                verticalArrangement = Arrangement.spacedBy(4.dp)
            ) {
                Text(
                    text = title,
                    style = MaterialTheme.typography.bodyMedium,
                    color = Color(0xFF6E6E73)
                )
                Text(
                    text = value,
                    style = MaterialTheme.typography.titleLarge.copy(fontWeight = FontWeight.SemiBold),
                    color = Color(0xFF111111)
                )
            }
        }
    }
}

/* ------------------------ Featured section ------------------------ */

@Composable
private fun FeaturedSection(onFeatureClick: (String) -> Unit) {
    Column(
        modifier = Modifier.padding(horizontal = 20.dp)
    ) {
        Text(
            text = "精选",
            style = MaterialTheme.typography.titleMedium,
            color = Color(0xFF111111),
            modifier = Modifier.padding(bottom = 12.dp)
        )
        LazyRow(horizontalArrangement = Arrangement.spacedBy(12.dp)) {
            items(featureItems) { item ->
                FeatureTile(
                    item = item,
                    onClick = { onFeatureClick(item.title) }
                )
            }
        }
    }
}

private val featureItems = listOf(
    FeatureTileData(
        title = "滑行数据",
        subtitle = "周 / 月 / 雪季趋势图表",
        icon = Icons.Filled.BarChart
    ),
    FeatureTileData(
        title = "更多功能",
        subtitle = "更多功能赶来中",
        icon = Icons.Filled.Explore
    )
)

@Composable
private fun FeatureTile(item: FeatureTileData, onClick: () -> Unit) {
    ElevatedCard(
        onClick = onClick,
        shape = RoundedCornerShape(20.dp),
        colors = CardDefaults.elevatedCardColors(
            containerColor = Color.White
        ),
        modifier = Modifier.width(220.dp)
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp, vertical = 18.dp),
            horizontalArrangement = Arrangement.spacedBy(12.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Surface(
                color = Color(0xFF111111),
                shape = CircleShape
            ) {
                Icon(
                    imageVector = item.icon,
                    contentDescription = item.title,
                    tint = Color.White,
                    modifier = Modifier.padding(10.dp)
                )
            }
            Column(
                modifier = Modifier.weight(1f),
                verticalArrangement = Arrangement.spacedBy(4.dp)
            ) {
                Text(
                    text = item.title,
                    style = MaterialTheme.typography.titleMedium,
                    color = Color(0xFF111111)
                )
                Text(
                    text = item.subtitle,
                    style = MaterialTheme.typography.bodySmall,
                    color = Color(0xFF6E6E73),
                    maxLines = 2,
                    overflow = TextOverflow.Ellipsis
                )
            }
        }
    }
}

private data class FeatureTileData(
    val title: String,
    val subtitle: String,
    val icon: ImageVector
)

/* ------------------------ Primary CTA button ------------------------ */

@Composable
private fun PrimaryActionButton(onStartRecording: () -> Unit) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = 20.dp),
        horizontalArrangement = Arrangement.Center
    ) {
        Button(
            onClick = onStartRecording,
            modifier = Modifier.fillMaxWidth(),
            shape = RoundedCornerShape(999.dp),
            colors = ButtonDefaults.buttonColors(
                containerColor = Color(0xFF111111),
                contentColor = Color.White
            )
        ) {
            Text(
                text = "开始记录",
                modifier = Modifier.padding(vertical = 6.dp),
                style = MaterialTheme.typography.titleMedium
            )
        }
    }
}

/* ------------------------ Preview ------------------------ */

@Preview(showBackground = true, showSystemUi = true)
@Composable
fun HomeScreenPreview() {
    GosnowTheme {
        HomeScreen(
            onStartRecording = {},
            onFeatureClick = { _ -> },
            onAvatarClick = {},
            onBottomNavSelected = {},
            currentRoute = "home"
        )
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\login\AuthViewModel.kt
--------------------------------------------------
package com.gosnow.app.ui.login

import android.content.Context
import androidx.lifecycle.ViewModel
import androidx.lifecycle.ViewModelProvider
import androidx.lifecycle.viewModelScope
import com.gosnow.app.data.auth.AuthRepository
import com.gosnow.app.datasupabase.CurrentUserStore
import com.gosnow.app.datasupabase.SupabaseClientProvider
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.update
import kotlinx.coroutines.launch
import io.github.jan.supabase.gotrue.auth

data class LoginUiState(
    val phoneNumber: String = "",
    val verificationCode: String = "",
    val isSendingCode: Boolean = false,
    val codeSent: Boolean = false,
    val isVerifyingCode: Boolean = false,
    val isLoggedIn: Boolean = false,
    val errorMessage: String? = null,
    val successMessage: String? = null,
    val isCheckingSession: Boolean = true
)

class AuthViewModel(
    private val repository: AuthRepository
) : ViewModel() {

    private val _uiState = MutableStateFlow(LoginUiState())
    val uiState: StateFlow<LoginUiState> = _uiState

    init {
        checkExistingSession()
    }

    private fun checkExistingSession() {
        viewModelScope.launch {
            val auth = SupabaseClientProvider.supabaseClient.auth

            // 1. 先尝试从本地存储拿现有的 Session（不联网）
            val currentSession = auth.currentSessionOrNull()

            if (currentSession != null) {
                // 如果本地有 Session，先假设它是有效的，让用户先进主页
                _uiState.update { it.copy(isLoggedIn = true, isCheckingSession = false) }

                // 后台异步刷新 Token，不干扰用户进入主页
                launch {
                    runCatching { auth.refreshCurrentSession() }.onFailure {
                        // 如果由于网络原因刷新失败，不要强制登出，等下次有网再说
                        // 如果是因为 Token 彻底非法（401），则在拦截器层面处理
                    }
                }

                // 同步用户信息
                runCatching { CurrentUserStore.refreshFromServer() }

            } else {
                // 2. 如果本地彻底没有 Session，才尝试强制刷新一次
                val refreshedSession = runCatching {
                    auth.refreshCurrentSession()
                    auth.currentSessionOrNull()
                }.getOrNull()

                _uiState.update {
                    it.copy(
                        isLoggedIn = refreshedSession != null,
                        isCheckingSession = false
                    )
                }
            }
        }
    }



    fun onPhoneChange(value: String) {
        _uiState.update { it.copy(phoneNumber = value, errorMessage = null, successMessage = null) }
    }

    fun onVerificationCodeChange(value: String) {
        _uiState.update { it.copy(verificationCode = value, errorMessage = null, successMessage = null) }
    }

    fun sendCode() {
        val normalizedPhone = normalizePhoneNumber(_uiState.value.phoneNumber)
        if (normalizedPhone == null) {
            _uiState.update { it.copy(errorMessage = "请输入有效的手机号（仅支持中国大陆 11 位手机号）") }
            return
        }

        viewModelScope.launch {
            _uiState.update { it.copy(isSendingCode = true, errorMessage = null, successMessage = null) }
            repository.sendOtpToPhone(normalizedPhone)
                .onSuccess {
                    _uiState.update {
                        it.copy(
                            isSendingCode = false,
                            codeSent = true,
                            successMessage = "验证码已发送，请查收",
                            errorMessage = null
                        )
                    }
                }
                .onFailure { throwable ->
                    _uiState.update {
                        it.copy(
                            isSendingCode = false,
                            codeSent = false,
                            errorMessage = throwable.message ?: "验证码发送失败，请稍后重试"
                        )
                    }
                }
        }
    }

    fun verifyCodeAndLogin() {
        val normalizedPhone = normalizePhoneNumber(_uiState.value.phoneNumber)
        if (normalizedPhone == null) {
            _uiState.update { it.copy(errorMessage = "请输入有效的手机号") }
            return
        }

        val codeDigits = _uiState.value.verificationCode.filter { it.isDigit() }
        if (codeDigits.length != 6) {
            _uiState.update { it.copy(errorMessage = "请输入短信中的 6 位验证码") }
            return
        }

        viewModelScope.launch {
            _uiState.update { it.copy(isVerifyingCode = true, errorMessage = null, successMessage = null) }
            repository.verifyOtpAndLogin(normalizedPhone, codeDigits)
                .onSuccess {
                    _uiState.update {
                        it.copy(
                            isVerifyingCode = false,
                            isLoggedIn = true,
                            successMessage = "登录成功",
                            errorMessage = null
                        )
                    }
                }
                .onFailure { throwable ->
                    _uiState.update {
                        it.copy(
                            isVerifyingCode = false,
                            isLoggedIn = false,
                            errorMessage = throwable.message ?: "登录失败，请稍后重试"
                        )
                    }
                }
        }
    }

    fun logout() {
        viewModelScope.launch {
            repository.signOut()
            CurrentUserStore.clear()
            _uiState.update { LoginUiState(isCheckingSession = false,isLoggedIn = false) }
        }
    }


    private fun normalizePhoneNumber(raw: String): String? {
        val trimmed = raw.trim()
        if (trimmed.isBlank()) return null

        val digitsOnly = trimmed.filter { it.isDigit() }

        return when {
            trimmed.startsWith("+") && digitsOnly.length in 10..15 -> trimmed
            digitsOnly.length == 11 -> "+86$digitsOnly"
            digitsOnly.length in 10..15 -> "+$digitsOnly"
            else -> null
        }
    }

    companion object {
        fun provideFactory(@Suppress("UNUSED_PARAMETER") context: Context): ViewModelProvider.Factory =
            object : ViewModelProvider.Factory {
                override fun <T : ViewModel> create(modelClass: Class<T>): T {
                    val repository = AuthRepository(SupabaseClientProvider.supabaseClient)
                    @Suppress("UNCHECKED_CAST")
                    return AuthViewModel(repository) as T
                }
            }
    }
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\login\LoginScreen.kt
--------------------------------------------------
package com.gosnow.app.ui.login

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.ClickableText
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.ArrowBack
import androidx.compose.material.icons.filled.Key
import androidx.compose.material.icons.filled.PhoneAndroid
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.CircularProgressIndicator
import androidx.compose.material3.ExperimentalMaterial3Api
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Scaffold
import androidx.compose.material3.Surface
import androidx.compose.material3.Text
import androidx.compose.material3.TopAppBar
import androidx.compose.material3.TopAppBarDefaults
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableIntStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.AnnotatedString
import androidx.compose.ui.text.SpanStyle
import androidx.compose.ui.text.buildAnnotatedString
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.text.withStyle
import androidx.compose.ui.unit.dp
import kotlinx.coroutines.delay
import android.net.Uri
import android.widget.VideoView
import androidx.compose.foundation.layout.aspectRatio
import androidx.compose.foundation.layout.heightIn
import androidx.compose.foundation.layout.offset
import androidx.compose.foundation.layout.widthIn
import androidx.compose.runtime.mutableStateOf
import androidx.compose.ui.platform.LocalConfiguration
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.viewinterop.AndroidView
import com.gosnow.app.R
import androidx.compose.material3.TextFieldDefaults


// ====== 公共样式 & 常量 ======

private val AccentBlue = Color(0xFF4A90E2)
private const val TERMS_TAG = "terms"

private const val APP_NAME = "上雪"
private const val SUPPORT_EMAIL = "gosnow.serviceteam@gmail.com"
private const val TERMS_LAST_UPDATED = "2025-10-17"

// iOS 同款逻辑：手机号 11 位，验证码 6 位
private fun canSendOtp(phone: String): Boolean =
    phone.filter { it.isDigit() }.length == 11

private fun canVerify(phone: String, code: String): Boolean =
    canSendOtp(phone) && code.filter { it.isDigit() }.length == 6

// ====== 欢迎页：顶部视频预留 + 底部黑色卡片 ======
//WelcomeAuthIntroScreen//
@Composable
fun WelcomeAuthIntroScreen(
    isCheckingSession: Boolean,
    onStartPhoneLogin: () -> Unit,
    onTermsClick: () -> Unit
) {
    if (isCheckingSession) {
        // 保持原来的 loading 样式
        Box(
            modifier = Modifier
                .fillMaxSize()
                .background(Color.Black),
            contentAlignment = Alignment.Center
        ) {
            Column(horizontalAlignment = Alignment.CenterHorizontally) {
                CircularProgressIndicator(color = Color.White)
                Spacer(modifier = Modifier.height(12.dp))
                Text(text = "正在检查登录状态…", color = Color.White)
            }
        }
        return
    }

    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(Color.Black)
    ) {
        // 顶部：视频贴在最上方，宽度铺满，高度你可以继续用自适应版本
        IntroVideoPlayer(
            modifier = Modifier
                .align(Alignment.TopCenter)
                .fillMaxWidth()
        )

        // 底部：黑色卡片贴着底部，不再占满整个剩余高度
        Surface(
            modifier = Modifier
                .align(Alignment.BottomCenter)
                .fillMaxWidth()
                .offset(y = (-80).dp),   // ★ 往上抬 32dp，减少中间黑块
            color = Color.Black,
            shape = RoundedCornerShape(topStart = 24.dp, topEnd = 24.dp)
        ) {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(horizontal = 20.dp, vertical = 16.dp), // ★ 原来是 24.dp，缩小顶部空白
                verticalArrangement = Arrangement.spacedBy(16.dp),
                horizontalAlignment = Alignment.Start
            ) {
                Text(
                    text = "登录以继续",
                    style = MaterialTheme.typography.titleMedium.copy(
                        fontWeight = FontWeight.Bold,
                        color = Color.White
                    )
                )

                Text(
                    text = "使用手机号登录，继续你的体验。",
                    style = MaterialTheme.typography.bodyMedium,
                    color = Color.White.copy(alpha = 0.7f)
                )

                Spacer(modifier = Modifier.height(20.dp))

                Button(
                    onClick = onStartPhoneLogin,
                    modifier = Modifier.fillMaxWidth(),
                    colors = ButtonDefaults.buttonColors(containerColor = Color.White),
                    shape = RoundedCornerShape(16.dp)
                ) {
                    Text(
                        text = "使用手机号登录",
                        style = MaterialTheme.typography.titleSmall,
                        color = Color.Black
                    )
                }

                Spacer(modifier = Modifier.height(12.dp))


            }
        }

    }

}

@Composable
fun IntroVideoPlayer(
    modifier: Modifier = Modifier
) {
    val context = LocalContext.current
    val configuration = LocalConfiguration.current
    val maxHeight = (configuration.screenHeightDp / 2f).dp   // 最多占屏幕一半高度

    var videoAspect by remember { mutableStateOf<Float?>(null) }

    // 按是否拿到宽高比来自适应 + 限制最大高度
    val sizedModifier = modifier
        .then(
            if (videoAspect != null) {
                Modifier.aspectRatio(videoAspect!!)
            } else {
                Modifier.height(240.dp)   // 首帧占位高度
            }
        )
        .heightIn(max = maxHeight)        // 关键：限制最大高度

    AndroidView(
        modifier = sizedModifier,
        factory = { ctx ->
            VideoView(ctx).apply {
                val uri = Uri.parse("android.resource://${ctx.packageName}/${R.raw.login_intro_top}")
                setVideoURI(uri)

                setOnPreparedListener { mp ->
                    val w = mp.videoWidth
                    val h = mp.videoHeight
                    if (w > 0 && h > 0) {
                        // 自动按原始宽高比自适应
                        videoAspect = w.toFloat() / h.toFloat()
                    }
                    mp.isLooping = true
                    mp.setVolume(0f, 0f)
                    start()
                }

                setOnCompletionListener {
                    start()
                }
            }
        },
        update = { videoView ->
            if (!videoView.isPlaying) {
                videoView.start()
            }
        }
    )
}



// ====== 登录页：手机号 + 验证码 ======

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun PhoneLoginScreen(
    uiState: LoginUiState,
    onPhoneChange: (String) -> Unit,
    onVerificationCodeChange: (String) -> Unit,
    onSendCode: () -> Unit,
    onLoginClick: () -> Unit,
    onBackClick: () -> Unit,
    onTermsClick: () -> Unit
) {
    var countdownSeconds by rememberSaveable { mutableIntStateOf(0) }

    // 发送成功后启动 60s 倒计时（对应 iOS resendSeconds）
    LaunchedEffect(uiState.codeSent) {
        if (uiState.codeSent) {
            countdownSeconds = 60
        }
    }

    LaunchedEffect(countdownSeconds) {
        if (countdownSeconds > 0) {
            delay(1000)
            countdownSeconds -= 1
        }
    }

    val termsText = remember { loginTermsAnnotatedString() }

    val phoneDigits = uiState.phoneNumber.filter { it.isDigit() }
    val codeDigits = uiState.verificationCode.filter { it.isDigit() }

    val canSend = canSendOtp(phoneDigits) && !uiState.isSendingCode && countdownSeconds == 0
    val canLogin = canVerify(phoneDigits, codeDigits) && !uiState.isVerifyingCode

    Scaffold(
        topBar = {
            TopAppBar(
                title = {},
                navigationIcon = {
                    IconButton(onClick = onBackClick) {
                        Icon(
                            imageVector = Icons.AutoMirrored.Filled.ArrowBack,
                            contentDescription = "返回",
                            tint = Color.White
                        )
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = Color.Transparent,
                    navigationIconContentColor = Color.White
                )
            )
        },
        containerColor = Color.Black
    ) { innerPadding ->
        Box(
            modifier = Modifier
                .fillMaxSize()
                .padding(innerPadding)
                .background(Color.Black)
        ) {
            if (uiState.isCheckingSession) {
                Column(
                    modifier = Modifier
                        .fillMaxSize()
                        .padding(24.dp),
                    verticalArrangement = Arrangement.Center,
                    horizontalAlignment = Alignment.CenterHorizontally
                ) {
                    CircularProgressIndicator(color = Color.White)
                    Spacer(modifier = Modifier.height(12.dp))
                    Text(
                        text = "正在检查登录状态…",
                        color = Color.White,
                        style = MaterialTheme.typography.bodyMedium
                    )
                }
            } else {
                // 大黑卡片 + 滚动表单，仿 iOS LoginView
                Surface(
                    modifier = Modifier
                        .fillMaxSize()
                        .clip(
                            RoundedCornerShape(
                                topStart = 24.dp,
                                topEnd = 24.dp
                            )
                        ),
                    color = Color.Black
                ) {
                    Column(
                        modifier = Modifier
                            .fillMaxSize()
                            .verticalScroll(rememberScrollState())
                            .padding(horizontal = 20.dp, vertical = 20.dp),
                        verticalArrangement = Arrangement.spacedBy(18.dp)
                    ) {
                        // 标题
                        Text(
                            text = "手机号登录",
                            style = MaterialTheme.typography.titleMedium.copy(
                                fontWeight = FontWeight.Bold
                            ),
                            color = Color.White
                        )
                        Text(
                            text = "新用户点击登录将自动创建账号",
                            style = MaterialTheme.typography.bodyMedium,
                            color = Color.White.copy(alpha = 0.7f)
                        )

                        // 手机号
                        Column(
                            verticalArrangement = Arrangement.spacedBy(8.dp)
                        ) {
                            Text(
                                text = "手机号",
                                style = MaterialTheme.typography.labelLarge,
                                color = Color.White.copy(alpha = 0.7f)
                            )
                            androidx.compose.material3.OutlinedTextField(
                                value = uiState.phoneNumber,
                                onValueChange = { raw ->
                                    val cleaned = raw.filter { it.isDigit() }.take(11)
                                    onPhoneChange(cleaned)
                                },
                                modifier = Modifier.fillMaxWidth(),
                                placeholder = { Text("输入 11 位手机号") },
                                singleLine = true,
                                keyboardOptions = KeyboardOptions(
                                    keyboardType = KeyboardType.Phone
                                ),
                                shape = RoundedCornerShape(16.dp),
                                colors = TextFieldDefaults.colors(
                                    focusedContainerColor = Color(0xFF111111),
                                    unfocusedContainerColor = Color(0xFF111111),
                                    disabledContainerColor = Color(0xFF111111),
                                    cursorColor = Color.White,
                                    focusedIndicatorColor = Color.White.copy(alpha = 0.8f),
                                    unfocusedIndicatorColor = Color.White.copy(alpha = 0.3f),
                                    focusedTextColor = Color.White,
                                    unfocusedTextColor = Color.White,
                                    focusedPlaceholderColor = Color.White.copy(alpha = 0.5f),
                                    unfocusedPlaceholderColor = Color.White.copy(alpha = 0.5f)
                                )
                            )



                        }

                        // 验证码 + 发送按钮
                        Column(
                            verticalArrangement = Arrangement.spacedBy(8.dp)
                        ) {
                            Text(
                                text = "验证码",
                                style = MaterialTheme.typography.labelLarge,
                                color = Color.White.copy(alpha = 0.7f)
                            )

                            Row(
                                verticalAlignment = Alignment.CenterVertically
                            ) {
                                androidx.compose.material3.OutlinedTextField(
                                    value = uiState.verificationCode,
                                    onValueChange = { raw ->
                                        val cleaned = raw.filter { it.isDigit() }.take(6)
                                        onVerificationCodeChange(cleaned)
                                    },
                                    modifier = Modifier.weight(1f),
                                    placeholder = { Text("输入 6 位验证码") },
                                    singleLine = true,
                                    keyboardOptions = KeyboardOptions(
                                        keyboardType = KeyboardType.Number
                                    ),
                                    shape = RoundedCornerShape(16.dp),
                                    colors = TextFieldDefaults.colors(
                                        focusedContainerColor = Color(0xFF111111),
                                        unfocusedContainerColor = Color(0xFF111111),
                                        disabledContainerColor = Color(0xFF111111),
                                        cursorColor = Color.White,
                                        focusedIndicatorColor = Color.White.copy(alpha = 0.8f),
                                        unfocusedIndicatorColor = Color.White.copy(alpha = 0.3f),
                                        focusedTextColor = Color.White,
                                        unfocusedTextColor = Color.White,
                                        focusedPlaceholderColor = Color.White.copy(alpha = 0.5f),
                                        unfocusedPlaceholderColor = Color.White.copy(alpha = 0.5f)
                                    )
                                )



                                Spacer(modifier = Modifier.width(12.dp))

                                Button(
                                    onClick = onSendCode,
                                    enabled = canSend,
                                    modifier = Modifier.widthIn(min = 110.dp),
                                    colors = ButtonDefaults.buttonColors(
                                        containerColor = Color.White,                               // 可用：白底
                                        contentColor = Color.Black,                                 // 可用：黑字
                                        disabledContainerColor = Color.White.copy(alpha = 0.18f),   // 禁用：淡一点
                                        disabledContentColor = Color.Black.copy(alpha = 0.45f)
                                    ),
                                    shape = RoundedCornerShape(12.dp)
                                ) {
                                    when {
                                        uiState.isSendingCode -> {
                                            CircularProgressIndicator(
                                                modifier = Modifier.size(18.dp),
                                                strokeWidth = 2.dp,
                                                color = Color.Black
                                            )
                                        }
                                        countdownSeconds > 0 -> {
                                            Text(text = "重发(${countdownSeconds}s)")
                                        }
                                        uiState.codeSent -> {
                                            Text(text = "重新发送")
                                        }
                                        else -> {
                                            Text(text = "发送验证码")
                                        }
                                    }
                                }

                            }
                        }

                        // 错误提示
                        if (!uiState.errorMessage.isNullOrEmpty()) {
                            Text(
                                text = uiState.errorMessage,
                                color = MaterialTheme.colorScheme.error,
                                style = MaterialTheme.typography.bodySmall
                            )
                        }

                        // 登录按钮（白底黑字，仿 iOS）
                        Button(
                            onClick = onLoginClick,
                            modifier = Modifier.fillMaxWidth(),
                            enabled = canLogin,
                            colors = ButtonDefaults.buttonColors(
                                containerColor = Color.White,                         // 可用：纯白底
                                contentColor = Color.Black,                           // 可用：黑字
                                disabledContainerColor = Color.White.copy(alpha = 0.14f), // 禁用：略淡的白
                                disabledContentColor = Color.Black.copy(alpha = 0.35f)    // 禁用：略淡的黑
                            ),
                            shape = RoundedCornerShape(16.dp)
                        ) {
                            if (uiState.isVerifyingCode) {
                                CircularProgressIndicator(
                                    modifier = Modifier.size(18.dp),
                                    strokeWidth = 2.dp,
                                    color = Color.Black
                                )
                            } else {
                                Text(
                                    text = "登录",
                                    style = MaterialTheme.typography.bodyLarge.copy(
                                        fontWeight = FontWeight.SemiBold
                                    )
                                )
                            }
                        }


                        // 协议文案
                        ClickableText(
                            text = termsText,
                            style = MaterialTheme.typography.bodySmall.copy(
                                color = Color.White.copy(alpha = 0.6f),
                                textAlign = TextAlign.Center
                            ),
                            modifier = Modifier
                                .fillMaxWidth()
                                .padding(top = 6.dp, bottom = 8.dp),
                        ) { offset ->
                            termsText
                                .getStringAnnotations(
                                    tag = TERMS_TAG,
                                    start = offset,
                                    end = offset
                                )
                                .firstOrNull()
                                ?.let { onTermsClick() }
                        }

                        Spacer(modifier = Modifier.height(12.dp))
                    }
                }
            }
        }
    }
}

private fun loginTermsAnnotatedString(): AnnotatedString {
    return buildAnnotatedString {
        append("登录即表示你同意")
        pushStringAnnotation(tag = TERMS_TAG, annotation = "terms")
        withStyle(
            SpanStyle(
                color = AccentBlue,
                fontWeight = FontWeight.SemiBold
            )
        ) {
            append("《服务条款与隐私》")
        }
        pop()
    }
}

// ====== 服务条款页 ======

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun TermsScreen(
    onBackClick: () -> Unit
) {
    Scaffold(
        topBar = {
            TopAppBar(
                title = {
                    Text(
                        text = "服务条款与隐私",
                        style = MaterialTheme.typography.titleMedium
                    )
                },
                navigationIcon = {
                    IconButton(onClick = onBackClick) {
                        Icon(
                            imageVector = Icons.AutoMirrored.Filled.ArrowBack,
                            contentDescription = "返回"
                        )
                    }
                }
            )
        }
    ) { innerPadding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .verticalScroll(rememberScrollState())
                .padding(innerPadding)
                .padding(horizontal = 20.dp, vertical = 16.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // 标题与更新时间
            Column(
                verticalArrangement = Arrangement.spacedBy(6.dp)
            ) {
                Text(
                    text = "$APP_NAME 服务条款与隐私摘要",
                    style = MaterialTheme.typography.titleLarge.copy(
                        fontWeight = FontWeight.Bold
                    )
                )
                Text(
                    text = "最后更新：$TERMS_LAST_UPDATED",
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }

            Text(
                text = "请在使用本应用前仔细阅读。本页面为要点摘要，完整条款与隐私政策以我们在应用内或官方网站公布的正式版本为准。继续使用即表示你同意这些条款及其后续修订。",
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )

            TermsSection(
                title = "一、适用范围与变更",
                bullets = listOf(
                    "本条款约束你对 $APP_NAME 应用及相关服务（“服务”）的访问与使用。",
                    "我们可能不时更新条款与隐私政策；更新后在应用内生效并替代旧版本。",
                    "我们可在不通知的情况下改进或变更产品与功能，或临时/永久地变更、暂停或终止服务的全部或部分。"
                )
            )

            TermsSection(
                title = "二、账户与安全",
                bullets = listOf(
                    "你负责妥善保管账户与密码，并对账户下的所有活动负责。",
                    "我们采取合理安全措施，但无法保证绝对安全。若发现未授权使用或安全问题，请立即联系我们。",
                    "13 岁以下儿童不应使用本应用。"
                )
            )

            TermsSection(
                title = "三、可接受的使用（AUP）",
                bullets = listOf(
                    "不得上传或传播违法、侵权、辱骂、仇恨、低俗或其他令人反感的内容。",
                    "不得冒充他人、散布垃圾信息/广告、上传恶意代码、破坏/干扰服务或网络。",
                    "不得以自动化方式（脚本、爬虫、机器人等）未经授权访问服务。",
                    "不得违反适用的法律法规及第三方平台规则。",
                    "如违反 AUP，$APP_NAME 可采取包括限制/终止账户在内的措施。"
                )
            )

            TermsSection(
                title = "四、用户内容与授权",
                bullets = listOf(
                    "你对自己上传/发布的内容承担全部责任。",
                    "你授予 $APP_NAME 全球范围、不可撤销、免版税的许可，以为提供与推广服务之目的而使用、复制、修改、展示、分发该等内容（在法律允许范围内）。",
                    "地图、徽标及第三方受版权保护的信息归其权利人所有；应权利人要求，我们可删除相关内容。",
                    "应用内的度假村/场地信息仅供参考，你应自行核验。"
                )
            )

            TermsSection(
                title = "五、软件与知识产权",
                bullets = listOf(
                    "服务及其中的软件与内容受知识产权保护。除法律允许外，不得对其进行复制、修改、反向工程或衍生利用。",
                    "$APP_NAME 授予你个人、不可转让、非独占的访问与使用许可；不得通过非官方接口访问服务。",
                    "我们保留本协议未明确授予的全部权利。"
                )
            )

            TermsSection(
                title = "六、隐私摘要",
                bullets = listOf(
                    "我们依据隐私政策收集与处理必要信息（如账户信息、设备与使用数据）。",
                    "在符合法律的前提下，我们可能为合规、保障安全、履行合同、客服支持等目的访问、保存或披露必要信息。",
                    "完整内容请查看《隐私政策》正式文本。"
                )
            )

            TermsSection(
                title = "七、免责声明与责任限制",
                bullets = listOf(
                    "服务按“现状/可用”提供，我们不对其满足你的特定需求、不间断、无错误或结果完全准确作出保证。",
                    "在法律允许范围内，我们不对因使用或无法使用服务而导致的任何直接或间接损失承担责任。"
                )
            )

            TermsSection(
                title = "八、医疗免责声明（如适用）",
                bullets = listOf(
                    "$APP_NAME 不提供医疗建议，应用内内容不能替代专业医疗指导。若有健康问题请咨询专业医生；紧急情况请拨打当地急救电话。"
                )
            )

            TermsSection(
                title = "九、终止",
                bullets = listOf(
                    "在以下情形下，我们可在不事先通知的情况下立即终止或限制你对服务的访问：违反本条款、执法/监管要求、长时间不活跃、技术/安全问题、欠费等。",
                    "终止后可能删除与账户相关的信息并限制再次使用服务。"
                )
            )

            TermsSection(
                title = "十、沟通与电子通知",
                bullets = listOf(
                    "你同意我们以电子方式向你提供通知、披露与其他通信，并视为满足书面形式要求。",
                    "应用内的论坛/群聊等属公开交流环境，请谨慎发布内容。"
                )
            )

            TermsSection(
                title = "十一、第三方设备与材料",
                bullets = listOf(
                    "使用服务可能需要第三方设备或材料。我们不对第三方设备/材料的兼容性、可用性或无错误性作保证。"
                )
            )

            TermsSection(
                title = "十二、支持与联系",
                bullets = listOf(
                    "我们通过电子邮件提供支持：$SUPPORT_EMAIL"
                )
            )

            Text(
                text = "如你不同意上述条款，请停止使用本应用。继续使用即表示你同意本条款及其后续修订。",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant,
                modifier = Modifier.padding(top = 4.dp, bottom = 12.dp)
            )
        }
    }
}

@Composable
private fun TermsSection(
    title: String,
    bullets: List<String>
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        shape = RoundedCornerShape(14.dp),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surfaceVariant
        )
    ) {
        Column(
            modifier = Modifier.padding(horizontal = 14.dp, vertical = 12.dp),
            verticalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            Text(
                text = title,
                style = MaterialTheme.typography.titleSmall.copy(
                    fontWeight = FontWeight.SemiBold
                )
            )
            bullets.forEach { text ->
                TermsBullet(text)
            }
        }
    }
}

@Composable
private fun TermsBullet(text: String) {
    Row(
        verticalAlignment = Alignment.Top,
        horizontalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        Text(
            text = "•",
            style = MaterialTheme.typography.bodyMedium,
        )
        Text(
            text = text,
            style = MaterialTheme.typography.bodyMedium,
            color = MaterialTheme.colorScheme.onSurface
        )
    }
}





==================================================

File: app\src\main\java\com\gosnow\app\ui\login\TermsScreen.kt
--------------------------------------------------

/*
package com.gosnow.app.ui.login

import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.ExperimentalMaterial3Api
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Scaffold
import androidx.compose.material3.Text
import androidx.compose.material3.TopAppBar
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun TermsScreen(onBackClick: () -> Unit) {
    val scrollState = rememberScrollState()

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text(text = "服务条款与隐私") },
                navigationIcon = {
                    IconButton(onClick = onBackClick) {
                        Icon(imageVector = Icons.Filled.ArrowBack, contentDescription = "返回")
                    }
                }
            )
        }
    ) { innerPadding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(innerPadding)
                .padding(horizontal = 20.dp, vertical = 16.dp)
                .verticalScroll(scrollState),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            termsSections.forEach { section ->
                TermsCard(section = section)
            }
            Text(
                text = "感谢你阅读本《服务条款与隐私》，继续使用即表示你已理解并同意以上内容。",
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant,
                modifier = Modifier.fillMaxWidth()
            )
            Spacer(modifier = Modifier.height(12.dp))
        }
    }
}

@Composable
private fun TermsCard(section: TermsSection) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
        shape = CardDefaults.shape,
        elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
    ) {
        Column(
            modifier = Modifier.padding(horizontal = 16.dp, vertical = 14.dp),
            verticalArrangement = Arrangement.spacedBy(10.dp)
        ) {
            Text(
                text = section.title,
                style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.Bold)
            )
            section.paragraphs.forEach { paragraph ->
                Text(
                    text = paragraph,
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        }
    }
}

data class TermsSection(
    val title: String,
    val paragraphs: List<String>
)

private val termsSections = listOf(
    TermsSection(
        title = "一、适用范围与变更",
        paragraphs = listOf(
            "本条款适用于 GoSnow 提供的所有产品与服务，涵盖登录、账号管理及后续使用过程中的权利与义务。",
            "根据业务或法律变化，平台可能对条款进行更新，最新版本将以应用内展示为准，请及时留意。"
        )
    ),
    TermsSection(
        title = "二、账户与安全",
        paragraphs = listOf(
            "你需使用本人手机号进行登录并妥善保管验证码，不得将账号转让或出租给他人。",
            "如发现异常登录或安全风险，请及时修改登录方式或联系我们，避免损失。"
        )
    ),
    TermsSection(
        title = "三、注册与登录",
        paragraphs = listOf(
            "输入手机号并完成验证码校验后，将自动创建或登录你的 GoSnow 账号。",
            "请确保提供的手机号真实有效，验证码仅用于身份验证，不得用于其他目的。"
        )
    ),
    TermsSection(
        title = "四、用户信息与隐私",
        paragraphs = listOf(
            "平台会按必要原则收集登录所需的手机号、验证码等信息，用于身份核验与安全风控。",
            "你的信息将按照隐私政策进行存储和保护，未经授权不会向第三方披露，法律法规另有规定的除外。"
        )
    ),
    TermsSection(
        title = "五、授权与使用",
        paragraphs = listOf(
            "登录后即表示你授权平台在提供核心功能时使用必要的账号信息，以完成会话维持与服务推送。",
            "你应合理使用产品功能，不得通过技术手段干扰或破坏平台正常运行。"
        )
    ),
    TermsSection(
        title = "六、内容规范",
        paragraphs = listOf(
            "在社区或互动场景中发布的内容应遵守法律法规，尊重他人权益，不得包含违法、侵权、骚扰或其他不当信息。",
            "平台有权基于合规或安全原因对违规内容进行限制、屏蔽或处理。"
        )
    ),
    TermsSection(
        title = "七、服务变更与中止",
        paragraphs = listOf(
            "平台可能因系统维护、业务调整或不可抗力对部分功能进行变更、中止或终止，并尽可能提前告知。",
            "若因不可抗力导致服务中断，将在合理范围内协助用户恢复或提供补救措施。"
        )
    ),
    TermsSection(
        title = "八、免责声明",
        paragraphs = listOf(
            "在法律允许范围内，因网络、设备故障或第三方原因导致的服务不可用，平台不承担由此产生的间接损失。",
            "用户应自行确保设备与网络环境的安全，避免因个人原因引发的账号风险。"
        )
    ),
    TermsSection(
        title = "九、终止与注销",
        paragraphs = listOf(
            "如用户严重违反条款或相关法律法规，平台有权暂停或终止提供服务，并视情况限制账号使用。",
            "你可依据应用提供的路径退出登录或申请注销，注销后相关数据将按法律及政策要求处理。"
        )
    ),
    TermsSection(
        title = "十、未成年人保护",
        paragraphs = listOf(
            "若你为未成年人，应在监护人同意与指导下使用本产品，理性安排使用时间。",
            "监护人应加强对未成年人上网与信息安全的教育与监督。"
        )
    ),
    TermsSection(
        title = "十一、法律适用与争议解决",
        paragraphs = listOf(
            "本条款适用相关法律法规。如有争议，应先友好协商解决，协商不成的，提交有管辖权的法院处理。",
            "条款部分无效不影响其他条款的效力，平台可根据需要对无效条款进行调整。"
        )
    ),
    TermsSection(
        title = "十二、支持与联系",
        paragraphs = listOf(
            "如在使用过程中有疑问或需要支持，可通过应用内的反馈入口与我们联系。",
            "我们将尽力提供帮助，并在合理时间内回应你的问题或建议。"
        )
    )
)
*/

==================================================

File: app\src\main\java\com\gosnow\app\ui\profile\ProfileScreen.kt
--------------------------------------------------
package com.gosnow.app.ui.profile

import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.material3.Button
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier

@Composable
fun ProfileScreen(
    modifier: Modifier = Modifier,
    onLogout: () -> Unit
) {
    Column(
        modifier = modifier.fillMaxSize(),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center
    ) {
        Text(text = "Profile 页面占位 — TODO: 对齐 iOS 用户中心")
        Button(onClick = onLogout) {
            Text(text = "退出登录")
        }
    }
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\record\BasicMetricsComputer.kt
--------------------------------------------------
package com.gosnow.app.ui.record.storage

import android.location.Location
import kotlin.math.abs
import kotlin.math.max
import kotlin.math.min
import kotlin.math.roundToInt

/**
 * 标准规范版：速度/里程/最高速/累计落差
 * - 可接入气压计高度：altitudeOverrideM（更稳的落差）
 * - 可切 “缆车/静止” 模式：liftMode=true 时不计里程、不刷新最高速，落差也更保守
 */
class BasicMetricsComputer(
    private val cfg: MetricsConfig = MetricsConfig()
) {
    // --- public state ---
    var distanceKm: Double = 0.0
        private set

    var currentSpeedKmh: Double = 0.0
        private set

    var topSpeedKmh: Double = 0.0
        private set

    var verticalDropM: Int = 0
        private set

    // --- internal ---
    private var lastLocation: Location? = null
    private var lastAltitudeM: Double? = null
    private var verticalDropAccumM: Double = 0.0

    private val speedWindow: ArrayDeque<Double> = ArrayDeque()
    private var lastSmoothSpeedKmh: Double = 0.0

    private var liftMode: Boolean = false

    fun setLiftMode(enabled: Boolean) {
        liftMode = enabled
    }

    fun reset() {
        distanceKm = 0.0
        currentSpeedKmh = 0.0
        topSpeedKmh = 0.0
        verticalDropM = 0

        lastLocation = null
        lastAltitudeM = null
        verticalDropAccumM = 0.0

        speedWindow.clear()
        lastSmoothSpeedKmh = 0.0

        liftMode = false
    }

    /**
     * @param altitudeOverrideM 传气压计“相对高度”（m），不传则用 GPS altitude
     */
    fun consumeSample(loc: Location, altitudeOverrideM: Double? = null) {
        // 0) 基本合法性
        if (loc.latitude.isNaN() || loc.longitude.isNaN()) return

        // 1) 精度过滤（水平精度太差直接丢）
        val accM = if (loc.hasAccuracy()) loc.accuracy.toDouble() else null
        if (accM != null) {
            if (accM <= 0.0) return
            if (accM > cfg.maxHorizontalAccuracyM) return
        }

        val prev = lastLocation
        val dtSec = if (prev != null) ((loc.time - prev.time) / 1000.0) else 0.0
        if (prev != null && dtSec < cfg.minDtSec) return

        // 2) 点间距离
        val dm = if (prev != null) prev.distanceTo(loc).toDouble() else 0.0

        // 3) 跳点剔除：基于 maxSpeed 推导 + hard cap
        if (prev != null && dtSec > 0.0) {
            val maxBySpeedM = (cfg.maxSpeedKmh / 3.6) * dtSec * cfg.jumpPointOvershootRatio
            val allowedM = min(maxBySpeedM, cfg.hardMaxStepDistanceM)

            // 精度越差允许距离越小（更严格）
            val accPenalty = accM?.let { (it / cfg.maxHorizontalAccuracyM).coerceAtLeast(1.0) } ?: 1.0
            val finalAllowedM = allowedM / accPenalty

            if (dm > finalAllowedM) {
                // 丢弃跳点，但更新 lastLocation 防止卡住
                lastLocation = loc
                return
            }
        }

        // 4) 速度：优先系统 speed，否则 vDelta
        val rawSpeedKmh: Double? =
            if (loc.hasSpeed() && loc.speed.isFinite() && loc.speed >= 0f) (loc.speed * 3.6).toDouble() else null

        val vDeltaKmh: Double? =
            if (prev != null && dtSec > 0.0) ((dm / 1000.0) / (dtSec / 3600.0)) else null

        val observed = (rawSpeedKmh ?: vDeltaKmh ?: 0.0).coerceIn(0.0, cfg.maxSpeedKmh)

        // 5) 平滑：median + low-pass
        val median = pushAndMedian(observed)
        val smooth = lowPass(lastSmoothSpeedKmh, median, cfg.lowPassAlpha)
        lastSmoothSpeedKmh = smooth
        currentSpeedKmh = smooth

        // 6) 最高速：缆车/静止不刷新（更符合成熟 app）
        if (!liftMode) {
            if (smooth > topSpeedKmh && smooth >= cfg.topSpeedMinCandidateKmh) {
                topSpeedKmh = smooth
            }
        }

        // 7) 落差：优先气压计高度，否则 GPS altitude
        val alt = altitudeOverrideM ?: loc.altitude.takeIf { it.isFinite() }
        if (alt != null) {
            val lastAlt = lastAltitudeM
            if (lastAlt != null) {
                val dAlt = alt - lastAlt

                // 只统计向下；抖动 < minVerticalChangeM 不算
                if (dAlt < -cfg.minVerticalChangeM) {
                    // 缆车/静止更保守：再加一道门槛
                    val gate = if (liftMode) cfg.minVerticalChangeM * 1.5 else cfg.minVerticalChangeM
                    if (dAlt < -gate) {
                        verticalDropAccumM += -dAlt
                        verticalDropM = verticalDropAccumM.roundToInt()
                    }
                }
            }
            lastAltitudeM = alt
        }

        // 8) 里程：缆车/静止不计；低速不计
        if (!liftMode && prev != null && dtSec > 0.0 && smooth >= cfg.minSpeedForDistanceKmh) {
            if (dm >= cfg.minDistanceStepM){
                val stepKm = dm / 1000.0

                // 用 smooth 推导一个上限，防止偶发速度异常导致距离暴增
                val maxBySmoothKm = (smooth / 3600.0) * dtSec * cfg.clampOvershootRatio
                distanceKm += min(stepKm, maxBySmoothKm)
            }

        }

        lastLocation = loc
    }

    private fun pushAndMedian(v: Double): Double {
        val w = max(3, cfg.medianWindow).let { if (it % 2 == 0) it + 1 else it }
        speedWindow.addLast(v)
        while (speedWindow.size > w) speedWindow.removeFirst()
        val sorted = speedWindow.sorted()
        return sorted[sorted.size / 2]
    }

    private fun lowPass(prev: Double, current: Double, alpha: Double): Double {
        return alpha * prev + (1.0 - alpha) * current
    }
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\record\BasicSessionRecorder.kt
--------------------------------------------------
package com.gosnow.app.ui.record

import com.gosnow.app.ui.record.LocationManager.LocationService
import com.gosnow.app.ui.record.LocationManager.SamplingMode
import com.gosnow.app.ui.record.classifier.LiftRideClassifier
import com.gosnow.app.ui.record.classifier.MotionMode
import com.gosnow.app.ui.record.sensors.BarometerAltimeter
import com.gosnow.app.ui.record.storage.BasicMetricsComputer

class BasicSessionRecorder(
    private val locationService: LocationService,
    private val metrics: BasicMetricsComputer,
    private val barometer: BarometerAltimeter? = null,
    private val classifier: LiftRideClassifier = LiftRideClassifier()
) : SessionRecorder {

    private var _state: RecordingState = RecordingState.Idle
    override val state: RecordingState get() = _state

    override val currentSpeedKmh: Double get() = metrics.currentSpeedKmh
    override val distanceKm: Double get() = metrics.distanceKm
    override val topSpeedKmh: Double get() = metrics.topSpeedKmh
    override val verticalDropM: Int get() = metrics.verticalDropM

    private var _motionMode: MotionMode = MotionMode.ACTIVE
    override val motionMode: MotionMode get() = _motionMode

    private var sessionStartMillis: Long = 0L
    private var lastSamplingMode: SamplingMode? = null

    init {
        locationService.onLocationSample = { loc ->
            val altOverride = barometer?.altitudeM?.toDouble()

            // 1) 自动识别（高度优先用气压计）
            val mode = classifier.consume(loc, altOverride)
            _motionMode = mode

            // 2) 缆车/静止时：更保守（不刷最高速、不计里程、落差更严）
            metrics.setLiftMode(mode == MotionMode.LIFT || mode == MotionMode.IDLE)

            // 3) 自动切采样频率
            val desired = if (mode == MotionMode.ACTIVE) SamplingMode.Active else SamplingMode.Idle
            if (desired != lastSamplingMode) {
                locationService.setSamplingMode(desired)
                lastSamplingMode = desired
            }

            // 4) 喂给统计（落差优先气压计高度）
            metrics.consumeSample(loc, altitudeOverrideM = altOverride)
        }
    }

    override fun start() {
        if (_state != RecordingState.Idle) return

        metrics.reset()
        sessionStartMillis = System.currentTimeMillis()

        if (barometer?.isAvailable() == true) barometer.start()

        lastSamplingMode = SamplingMode.Active
        locationService.setSamplingMode(SamplingMode.Active)
        locationService.start()

        _motionMode = MotionMode.ACTIVE
        _state = RecordingState.Recording
    }

    override fun stop(): SkiSession? {
        if (_state != RecordingState.Recording) return null

        locationService.stop()
        barometer?.stop()

        val end = System.currentTimeMillis()
        _state = RecordingState.Idle

        val durationSec = ((end - sessionStartMillis) / 1000L).toInt().coerceAtLeast(0)
        val distance = metrics.distanceKm
        val topSpeed = metrics.topSpeedKmh
        val vertical = metrics.verticalDropM
        val avgSpeed = if (durationSec > 0) distance / (durationSec / 3600.0) else 0.0

        return SkiSession(
            startAtMillis = sessionStartMillis,
            endAtMillis = end,
            durationSec = durationSec,
            distanceKm = distance,
            topSpeedKmh = topSpeed,
            avgSpeedKmh = avgSpeed,
            verticalDropM = vertical
        )
    }
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\record\MetricsConfig.kt
--------------------------------------------------
package com.gosnow.app.ui.record.storage

data class MetricsConfig(
    // 精度过滤
    val maxHorizontalAccuracyM: Double = 30.0,
    val minDtSec: Double = 0.2,

    // 速度边界
    val maxSpeedKmh: Double = 150.0,

    // 平滑
    val medianWindow: Int = 5,
    val lowPassAlpha: Double = 0.80,

    // 距离上限 clamp
    val clampOvershootRatio: Double = 1.5,

    // 里程累加阈值
    val minSpeedForDistanceKmh: Double = 2.5,

    // ✅ 核心修改 2：新增最小位移阈值
    // 如果两点之间距离小于 2 米，视为误差，不计入里程
    val minDistanceStepM: Double = 2.0,

    // 落差抖动阈值
    val minVerticalChangeM: Double = 2.0,

    // 跳点剔除
    val jumpPointOvershootRatio: Double = 2.0,
    val hardMaxStepDistanceM: Double = 200.0,

    // 最高速候选阈值
    val topSpeedMinCandidateKmh: Double = 10.0
)


==================================================

File: app\src\main\java\com\gosnow\app\ui\record\RecordingState.kt
--------------------------------------------------
package com.gosnow.app.ui.record

enum class RecordingState {
    Idle,
    Recording
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\record\RecordingViewModel.kt
--------------------------------------------------
package com.gosnow.app.ui.record

import android.app.Application
import android.content.*
import android.os.IBinder
import android.util.Log
import androidx.compose.runtime.*
import androidx.core.content.ContextCompat
import androidx.lifecycle.AndroidViewModel
import androidx.lifecycle.viewModelScope
import com.gosnow.app.ui.record.classifier.MotionMode
import com.gosnow.app.ui.record.service.ForegroundRecordingService
import com.gosnow.app.ui.record.party.PartyRideManager
import com.gosnow.app.ui.record.track.LiveTrackController
import com.gosnow.app.ui.record.track.StaticTrackGenerator
import kotlinx.coroutines.Job
import kotlinx.coroutines.launch
import java.util.UUID
import com.gosnow.app.ui.snowcircle.model.PartyState // 👈 添加这一行

// ...

class RecordingViewModel(app: Application) : AndroidViewModel(app) {

    var isRecording by mutableStateOf(false)
        private set
    var durationText by mutableStateOf("00:00")
        private set
    var distanceKm by mutableStateOf(0.0)
        private set
    var maxSpeedKmh by mutableStateOf(0.0)
        private set
    var verticalDropM by mutableStateOf(0)
        private set
    var motionMode by mutableStateOf(MotionMode.ACTIVE)
        private set

    // ✅ 新增：用于强行触发地图 UI 刷新的计数器
    var trackUpdateTick by mutableIntStateOf(0)
        private set

    val partyManager = PartyRideManager(viewModelScope)
    val partyState = partyManager.state
    val trackController = LiveTrackController()

    private var service: ForegroundRecordingService? = null
    private var collectJob: Job? = null
    private var bound = false

    private val conn = object : ServiceConnection {
        override fun onServiceConnected(name: ComponentName?, binder: IBinder?) {
            val b = binder as? ForegroundRecordingService.LocalBinder ?: return
            val srv = b.getService()
            service = srv
            bound = true

            collectJob?.cancel()
            collectJob = viewModelScope.launch {
                srv.stateFlow.collect { s ->
                    isRecording = s.isRecording
                    distanceKm = s.distanceKm
                    maxSpeedKmh = s.topSpeedKmh
                    verticalDropM = s.verticalDropM
                    motionMode = s.motionMode
                    durationText = formatDuration(s.durationSec)
                }
            }

            srv.onLocationUpdate = { loc, speedKmh ->
                // 🔴 调试点：看位置有没有流到这一步
                Log.d("TrackDebug", "收到Service位置: ${loc.latitude}, 录制中: ${srv.stateFlow.value.isRecording}")
                if (srv.stateFlow.value.isRecording) {
                    // 1. 喂给轨迹引擎
                    trackController.addPoint(loc, speedKmh)

                    // 2. ✅ 核心修正：增加计数，强制让 UI 看到变化
                    trackUpdateTick++

                    // 3. 喂给小队
                    partyManager.onMyLocationUpdate(loc)

                    // 4. 强制打印日志，方便你在 Logcat 验证
                    Log.d("TrackDebug", "收到位置 [${trackUpdateTick}]: ${loc.latitude}, ${loc.longitude}")
                }
            }
        }

        override fun onServiceDisconnected(name: ComponentName?) {
            bound = false
            service = null
            collectJob?.cancel()
        }
    }

    fun bindService() {
        if (bound) return
        val ctx = getApplication<Application>()
        val intent = Intent(ctx, ForegroundRecordingService::class.java)
        ctx.bindService(intent, conn, Context.BIND_AUTO_CREATE)
    }

    fun unbindService() {
        if (!bound) return
        val ctx = getApplication<Application>()
        runCatching { ctx.unbindService(conn) }
        bound = false
        service = null
        collectJob?.cancel()
    }

    fun onToggleRecording() {
        if (!isRecording) startRecording() else stopRecording()
    }

    fun startRecording() {
        //trackController.reset()
        trackUpdateTick = 0
        val ctx = getApplication<Application>()
        val intent = Intent(ctx, ForegroundRecordingService::class.java).apply {
            action = ForegroundRecordingService.ACTION_START
        }
        ContextCompat.startForegroundService(ctx, intent)
    }

    fun stopRecording() {
        val sessionId = UUID.randomUUID().toString()
        val segments = trackController.getSegmentsSnapshot()
        val ctx = getApplication<Application>()
        val intent = Intent(ctx, ForegroundRecordingService::class.java).apply {
            action = ForegroundRecordingService.ACTION_STOP
        }
        ctx.startService(intent)
        if (segments.isNotEmpty()) {
            viewModelScope.launch {
                StaticTrackGenerator.generateAndSave(getApplication(), sessionId, segments)
            }
        }
    }

    private fun formatDuration(sec: Int): String {
        val h = sec / 3600; val m = (sec % 3600) / 60; val s = sec % 60
        return if (h > 0) String.format("%d:%02d:%02d", h, m, s) else String.format("%02d:%02d", m, s)
    }

    init {
        viewModelScope.launch {
            partyState.collect { state ->
                if (state is PartyState.Joined) {
                    // 当刚加入小队时，如果我有最近的位置，强制广播一次
                    // 这里需要 access 到当前的 location，或者等待下一次 location update
                    // 由于 Service 每秒都在回调，通常这个问题只要你在动就能解决。
                    // 为了稳妥，可以在 Service 连接时缓存 lastLocation
                }
            }
        }
    }

    override fun onCleared() {
        super.onCleared()
        unbindService()
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\record\RecordScreen.kt
--------------------------------------------------
package com.gosnow.app.ui.record

import androidx.compose.material.icons.filled.ContentCopy
import android.Manifest
import androidx.compose.material.icons.filled.PersonAdd
import android.content.pm.PackageManager
import android.os.Build
import android.widget.Toast
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.ArrowBack
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.viewinterop.AndroidView
import androidx.core.content.ContextCompat
import androidx.lifecycle.viewmodel.compose.viewModel
import androidx.compose.material.icons.outlined.Landscape
// 2. 导入 BottomSheet 组件
import androidx.compose.material3.ModalBottomSheet
import androidx.compose.material3.rememberModalBottomSheetState
import androidx.compose.material3.BottomSheetDefaults
import androidx.compose.material3.OutlinedTextFieldDefaults
import androidx.compose.ui.draw.clip
import com.gosnow.app.ui.record.classifier.MotionMode
import com.gosnow.app.ui.snowcircle.model.PartyState
import com.mapbox.maps.MapView
import com.mapbox.maps.Style
import com.mapbox.maps.plugin.locationcomponent.location
import com.mapbox.maps.plugin.viewport.viewport
import com.mapbox.maps.extension.style.layers.addLayer
import com.mapbox.maps.extension.style.layers.generated.lineLayer
import com.mapbox.maps.extension.style.layers.properties.generated.LineCap
import com.mapbox.maps.extension.style.layers.properties.generated.LineJoin
import com.mapbox.maps.extension.style.sources.addSource
import com.mapbox.maps.extension.style.sources.generated.geoJsonSource
// ✅ Mapbox v11 ViewAnnotation 核心导入
import com.mapbox.geojson.Point
// ✅ 引入 DSL 构建函数
// 建议删除旧的 viewannotation 相关引用，只保留下面这些：
import com.mapbox.maps.viewannotation.viewAnnotationOptions // DSL构建函数
import com.mapbox.maps.viewannotation.geometry             // DSL属性
import coil.transform.CircleCropTransformation // 图片裁剪
import android.widget.ImageView
import com.gosnow.app.R
import coil.load
import androidx.compose.foundation.shape.CircleShape
import android.view.ViewGroup
import android.widget.FrameLayout
// ✅ Mapbox 核心 ViewAnnotation 导入
import com.mapbox.maps.viewannotation.viewAnnotationOptions
import com.mapbox.maps.ViewAnnotationAnchor// 👈 确保这个类能被索引到
import com.mapbox.maps.viewannotation.geometry
import com.mapbox.maps.viewannotation.annotationAnchor // 👈 v11 的 DSL 扩展名是这个


// 以及其他原有导入

@Composable
@OptIn(ExperimentalMaterial3Api::class)
fun RecordRoute(onBack: () -> Unit) {
    val context = LocalContext.current
    val vm: RecordingViewModel = viewModel()

    DisposableEffect(Unit) {
        vm.bindService()
        onDispose { vm.unbindService() }
    }

    var hasLocationPermission by remember { mutableStateOf(false) }
    var hasFineLocation by remember { mutableStateOf(false) }
    var hasNotificationPermission by remember { mutableStateOf(true) }

    fun checkPermissions() {
        hasFineLocation = ContextCompat.checkSelfPermission(context, Manifest.permission.ACCESS_FINE_LOCATION) == PackageManager.PERMISSION_GRANTED
        hasLocationPermission = hasFineLocation || ContextCompat.checkSelfPermission(context, Manifest.permission.ACCESS_COARSE_LOCATION) == PackageManager.PERMISSION_GRANTED
        hasNotificationPermission = if (Build.VERSION.SDK_INT >= 33) {
            ContextCompat.checkSelfPermission(context, Manifest.permission.POST_NOTIFICATIONS) == PackageManager.PERMISSION_GRANTED
        } else true
    }

    val permissionLauncher = rememberLauncherForActivityResult(ActivityResultContracts.RequestMultiplePermissions()) { checkPermissions() }

    LaunchedEffect(Unit) {
        checkPermissions()
        val toRequest = mutableListOf<String>()
        if (!hasLocationPermission) {
            toRequest.add(Manifest.permission.ACCESS_FINE_LOCATION)
            toRequest.add(Manifest.permission.ACCESS_COARSE_LOCATION)
        }
        if (Build.VERSION.SDK_INT >= 33 && !hasNotificationPermission) toRequest.add(Manifest.permission.POST_NOTIFICATIONS)
        if (toRequest.isNotEmpty()) permissionLauncher.launch(toRequest.toTypedArray())
    }

    RecordScreen(vm, onBack, hasLocationPermission, hasFineLocation, hasNotificationPermission) {
        permissionLauncher.launch(arrayOf(Manifest.permission.ACCESS_FINE_LOCATION, Manifest.permission.POST_NOTIFICATIONS))
    }
}

@Composable
@OptIn(ExperimentalMaterial3Api::class)
fun RecordScreen(
    viewModel: RecordingViewModel,
    onBack: () -> Unit,
    hasLocationPermission: Boolean,
    hasFineLocation: Boolean,
    hasNotificationPermission: Boolean,
    requestPermissions: () -> Unit
) {
    val context = LocalContext.current
    var showPartySheet by remember { mutableStateOf(false) }
    val partyState by viewModel.partyState.collectAsState()

    // 调试日志：直接在 UI 上打印当前队友数量，确认数据层是否工作
    val debugMemberCount = (partyState as? PartyState.Joined)?.members?.size ?: 0
    val debugMembers = (partyState as? PartyState.Joined)?.members ?: emptyList()

    // 缓存 ViewAnnotation 对应的 View，避免重复创建
    val markerViews = remember { mutableMapOf<String, android.view.View>() }

    Box(modifier = Modifier.fillMaxSize()) {
        if (!hasLocationPermission) {
            Box(modifier = Modifier.fillMaxSize().background(Color(0xFFF2F2F7)), contentAlignment = Alignment.Center) {
                Text("需要定位权限以显示地图", color = Color.Gray)
            }
        } else {
            AndroidView(
                modifier = Modifier.fillMaxSize(),
                factory = { ctx ->
                    MapView(ctx).apply {
                        // 你的 Style URL
                        mapboxMap.loadStyle("mapbox://styles/gosnow/cmikjh06p00ys01s68fmy9nor") { style ->
                            location.updateSettings { enabled = true; pulsingEnabled = true }
                            viewport.transitionTo(viewport.makeFollowPuckViewportState(), viewport.makeImmediateViewportTransition())
                            setupTrackLayers(style)
                        }
                    }
                },
                update = { mapView ->
                    // 强制刷新标记
                    val tick = viewModel.trackUpdateTick
                    val vaManager = mapView.viewAnnotationManager
                    val currentState = partyState

                    if (currentState is PartyState.Joined) {
                        val currentMembers = currentState.members
                        val currentIds = currentMembers.map { it.userId }.toSet()

                        // 1. 删除已离开的队友
                        val iterator = markerViews.entries.iterator()
                        while (iterator.hasNext()) {
                            val entry = iterator.next()
                            if (!currentIds.contains(entry.key)) {
                                vaManager.removeViewAnnotation(entry.value)
                                iterator.remove()
                            }
                        }

                        // 2. 添加或更新队友
                        currentMembers.forEach { member ->
                            // 过滤非法坐标 (0,0 在非洲，显示出来也没用)
                            if (member.lat != 0.0 && member.lon != 0.0) {
                                val existingView = markerViews[member.userId]
                                val point = Point.fromLngLat(member.lon, member.lat)

                                if (existingView == null) {
                                    // --- 创建新 View ---
                                    // 使用 FrameLayout 包裹圆形图片，更容易控制大小
                                    val container = FrameLayout(context).apply {
                                        layoutParams = ViewGroup.LayoutParams(80, 80) // 确保有大小！

                                        clipToOutline = true
                                    }

                                    val imageView = ImageView(context).apply {
                                        layoutParams = FrameLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT)
                                        scaleType = ImageView.ScaleType.CENTER_CROP
                                        load(member.avatarUrl) {
                                            crossfade(true)
                                            placeholder(R.drawable.ic_launcher_foreground)
                                            error(R.drawable.ic_launcher_foreground) // 错误时显示
                                            transformations(CircleCropTransformation())
                                        }
                                    }
                                    container.addView(imageView)

                                    // 添加到地图
                                    val options = viewAnnotationOptions {
                                        geometry(point)
                                        allowOverlap(true) // 允许重叠，防止被自己的位置遮挡
                                        // ✅ v11 使用 annotationAnchor
                                        annotationAnchor {
                                            anchor(ViewAnnotationAnchor.CENTER)
                                        }
                                        // 或者简写版（取决于具体扩展包版本）：
                                        // annotationAnchor(ViewAnnotationAnchor.CENTER)
                                    }
                                    vaManager.addViewAnnotation(container, options)
                                    markerViews[member.userId] = container
                                } else {
                                    // --- 更新位置 ---
                                    val options = viewAnnotationOptions {
                                        geometry(point)
                                    }
                                    vaManager.updateViewAnnotation(existingView, options)
                                }
                            }
                        }
                    } else {
                        if (markerViews.isNotEmpty()) {
                            vaManager.removeAllViewAnnotations()
                            markerViews.clear()
                        }
                    }
                }
            )
        }



        // --- 右侧按钮栏 ---
        Column(
            modifier = Modifier
                .align(Alignment.CenterEnd)
                .padding(end = 16.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            FloatingActionButton(
                onClick = { showPartySheet = true },
                containerColor = if (partyState is PartyState.Joined) Color(0xFFC6FF3F) else Color(0xCC000000),
                contentColor = if (partyState is PartyState.Joined) Color.Black else Color.White,
                shape = CircleShape,
                modifier = Modifier.size(48.dp)
            ) {
                Icon(
                    imageVector = if (partyState is PartyState.Joined) Icons.Default.Groups else Icons.Default.PersonAdd,
                    contentDescription = "小队",
                    modifier = Modifier.size(24.dp)
                )
            }
        }

        // --- 下方：返回按钮、数据面板等 (保持原样) ---
        IconButton(
            onClick = onBack,
            modifier = Modifier.padding(16.dp).align(Alignment.TopStart).background(Color(0x66000000), RoundedCornerShape(999.dp))
        ) { Icon(Icons.AutoMirrored.Filled.ArrowBack, "返回", tint = Color.White) }

        MotionModeBadge(viewModel.isRecording, viewModel.motionMode, hasLocationPermission, hasFineLocation, Modifier.padding(top = 16.dp, end = 16.dp).align(Alignment.TopEnd))

        // 底部数据面板 (简写，保持原样)
        Surface(modifier = Modifier.align(Alignment.BottomCenter).fillMaxWidth().shadow(16.dp), color = Color.White, shape = RoundedCornerShape(topStart = 24.dp, topEnd = 24.dp)) {
            // ... (复制你之前的 StatCard 内容，这里省略以节省空间，只展示逻辑) ...
            Column(modifier = Modifier.fillMaxWidth().padding(horizontal = 24.dp, vertical = 24.dp)) {
                Column(horizontalAlignment = Alignment.CenterHorizontally, modifier = Modifier.fillMaxWidth()) {
                    Icon(Icons.Filled.AccessTime, null, tint = Color(0xFF8E8E93))
                    Spacer(Modifier.height(8.dp))
                    Text(viewModel.durationText, fontSize = 44.sp, fontWeight = FontWeight.Bold, color = Color.Black)
                }
                Spacer(Modifier.height(24.dp))
                Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {
                    StatCard(Modifier.weight(1f), "滑行里程", String.format("%.1f km", viewModel.distanceKm), Icons.Filled.TrendingUp)
                    StatCard(Modifier.weight(1f), "最高速度", String.format("%.0f km/h", viewModel.maxSpeedKmh), Icons.Filled.Speed)
                }
                Spacer(Modifier.height(12.dp))
                Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {
                    StatCard(Modifier.weight(1f), "累计落差", "${viewModel.verticalDropM} m", Icons.Outlined.Landscape)
                    val cardColor = if (viewModel.isRecording) Color(0xFFC6FF3F) else Color(0xFF1C1C1E)
                    val contentColor = if (viewModel.isRecording) Color.Black else Color.White
                    Column(modifier = Modifier.weight(1f).height(88.dp).background(cardColor, RoundedCornerShape(20.dp)).clickable { if (!hasLocationPermission || !hasFineLocation) requestPermissions() else viewModel.onToggleRecording() }.padding(horizontal = 16.dp), verticalArrangement = Arrangement.Center, horizontalAlignment = Alignment.CenterHorizontally) {
                        Row(verticalAlignment = Alignment.CenterVertically, horizontalArrangement = Arrangement.spacedBy(8.dp)) {
                            Icon(if (viewModel.isRecording) Icons.Filled.Stop else Icons.Filled.PlayArrow, null, tint = contentColor)
                            Text(if (viewModel.isRecording) "结束" else "开始", color = contentColor, style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold)
                        }
                    }
                }
            }
        }

        // --- Bottom Sheet ---
        val sheetState = rememberModalBottomSheetState()
        if (showPartySheet) {
            ModalBottomSheet(
                onDismissRequest = { showPartySheet = false },
                sheetState = sheetState,
                containerColor = Color(0xFF1C1C1E)
            ) {
                PartySheetContent(
                    viewModel = viewModel,
                    onDismiss = { showPartySheet = false }
                )
            }
        }
    }
}

// 辅助组件：图层设置
private fun setupTrackLayers(style: Style) {
    style.addSource(geoJsonSource("source-green"))
    style.addLayer(lineLayer("layer-green-casing", "source-green") { lineColor("black"); lineWidth(6.0); lineOpacity(0.55); lineCap(LineCap.ROUND); lineJoin(LineJoin.ROUND) })
    style.addLayer(lineLayer("layer-green-main", "source-green") { lineColor("#00C853"); lineWidth(3.5); lineOpacity(0.95); lineCap(LineCap.ROUND); lineJoin(LineJoin.ROUND) })
    style.addSource(geoJsonSource("source-orange"))
    style.addLayer(lineLayer("layer-orange-casing", "source-orange") { lineColor("black"); lineWidth(6.0); lineOpacity(0.55); lineCap(LineCap.ROUND); lineJoin(LineJoin.ROUND) })
    style.addLayer(lineLayer("layer-orange-main", "source-orange") { lineColor("#FF9500"); lineWidth(3.5); lineOpacity(0.95); lineCap(LineCap.ROUND); lineJoin(LineJoin.ROUND) })
}

@Composable
private fun StatCard(modifier: Modifier, title: String, value: String, icon: androidx.compose.ui.graphics.vector.ImageVector) {
    Column(modifier.height(88.dp).background(Color(0xFFF5F5F7), RoundedCornerShape(20.dp)).padding(16.dp, 12.dp), verticalArrangement = Arrangement.SpaceBetween) {
        Row(verticalAlignment = Alignment.CenterVertically) {
            Icon(icon, null, tint = Color.Black, modifier = Modifier.size(18.dp))
            Spacer(Modifier.width(6.dp))
            Text(title, color = Color(0xFF6E6E73), style = MaterialTheme.typography.bodySmall, fontWeight = FontWeight.Medium)
        }
        Text(value, color = Color.Black, style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.SemiBold)
    }
}

@Composable
private fun MotionModeBadge(isRecording: Boolean, mode: MotionMode, hasPerm: Boolean, hasFine: Boolean, modifier: Modifier) {
    val (text, bg) = when {
        !hasPerm -> "无权限" to Color(0xFFFF3B30)
        !hasFine -> "弱定位" to Color(0xFFFF9500)
        !isRecording -> "准备" to Color(0xFF8E8E93)
        mode == MotionMode.LIFT -> "缆车" to Color(0xFF5856D6)
        mode == MotionMode.IDLE -> "静止" to Color(0xFFFF9500)
        else -> "滑行" to Color(0xFF34C759)
    }
    Surface(modifier, color = bg, shape = RoundedCornerShape(999.dp)) {
        Text(text, color = Color.White, fontSize = 13.sp, fontWeight = FontWeight.Bold, modifier = Modifier.padding(12.dp, 6.dp))
    }
}

@Composable
fun PartySheetContent(
    viewModel: RecordingViewModel,
    onDismiss: () -> Unit
) {
    val context = LocalContext.current
    val clipboardManager = androidx.compose.ui.platform.LocalClipboardManager.current
    val partyState by viewModel.partyState.collectAsState()
    var joinCodeInput by remember { mutableStateOf("") }

    Column(
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = 24.dp)
            .padding(bottom = 40.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        when (val s = partyState) {
            is PartyState.Idle -> {
                Text("尚未加入小队", color = Color.White, style = MaterialTheme.typography.titleMedium)
                Spacer(Modifier.height(24.dp))

                // 创建按钮
                Button(
                    onClick = { viewModel.partyManager.createParty() },
                    modifier = Modifier.fillMaxWidth(),
                    colors = ButtonDefaults.buttonColors(containerColor = Color.White),
                    shape = RoundedCornerShape(12.dp)
                ) {
                    Text("创建新小队", color = Color.Black)
                }

                Spacer(Modifier.height(16.dp))
                Text("或", color = Color.Gray, fontSize = 12.sp)
                Spacer(Modifier.height(16.dp))

                // 加入输入框
                OutlinedTextField(
                    value = joinCodeInput,
                    onValueChange = { if (it.length <= 4 && it.all { c -> c.isDigit() }) joinCodeInput = it },
                    label = { Text("输入4位邀请码", color = Color.Gray) },
                    modifier = Modifier.fillMaxWidth(),
                    keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Number),
                    singleLine = true,
                    colors = OutlinedTextFieldDefaults.colors(
                        focusedTextColor = Color.White,
                        unfocusedTextColor = Color.White,
                        focusedBorderColor = Color.White,
                        unfocusedBorderColor = Color.DarkGray
                    )
                )

                Spacer(Modifier.height(12.dp))

                Button(
                    onClick = { if (joinCodeInput.length == 4) viewModel.partyManager.joinParty(joinCodeInput) },
                    enabled = joinCodeInput.length == 4,
                    modifier = Modifier.fillMaxWidth(),
                    shape = RoundedCornerShape(12.dp)
                ) {
                    Text("加入小队")
                }
            }
            is PartyState.Joined -> {
                // 已加入状态：显示邀请码和成员
                Text("小队邀请码", color = Color.Gray, fontSize = 12.sp)
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.Center,
                    modifier = Modifier.clickable {
                        clipboardManager.setText(androidx.compose.ui.text.AnnotatedString(s.code))
                        Toast.makeText(context, "邀请码已复制", Toast.LENGTH_SHORT).show()
                    }
                ) {
                    Text(s.code, color = Color.White, fontSize = 48.sp, fontWeight = FontWeight.Bold)
                    Spacer(Modifier.width(8.dp))
                    Icon(Icons.Default.ContentCopy, null, tint = Color.Gray, modifier = Modifier.size(20.dp))
                }

                Spacer(Modifier.height(24.dp))
                Divider(color = Color.DarkGray)
                Spacer(Modifier.height(16.dp))

                Text("在线成员 (${s.members.size + 1})", modifier = Modifier.align(Alignment.Start), color = Color.Gray, fontSize = 12.sp)

                // 成员列表
                Column(modifier = Modifier.fillMaxWidth().padding(top = 12.dp), verticalArrangement = Arrangement.spacedBy(12.dp)) {
                    // 自己
                    MemberRow(name = "我 (自己)", avatar = null, isMe = true)
                    // 队友
                    s.members.forEach { member ->
                        MemberRow(name = member.userName ?: "雪友", avatar = member.avatarUrl, isMe = false)
                    }
                }

                Spacer(Modifier.height(32.dp))

                // 退出/结束按钮
                TextButton(
                    onClick = { viewModel.partyManager.leaveParty() },
                    modifier = Modifier.fillMaxWidth()
                ) {
                    Text(if (s.isHost) "结束并离开小队" else "退出当前小队", color = Color.Red)
                }
            }
        }
    }
}
@Composable
fun MemberRow(
    name: String,
    avatar: String?,
    isMe: Boolean
) {
    Row(
        verticalAlignment = Alignment.CenterVertically,
        modifier = Modifier
            .fillMaxWidth()
            .padding(vertical = 4.dp)
    ) {
        // 头像预览/点位标记颜色
        Box(
            modifier = Modifier
                .size(32.dp)
                .clip(CircleShape)
                .background(if (isMe) Color(0xFFC6FF3F) else Color(0xFF00C853)), // 自己用黄绿，队友用纯绿
            contentAlignment = Alignment.Center
        ) {
            if (!avatar.isNullOrBlank()) {
                coil.compose.AsyncImage(
                    model = avatar,
                    contentDescription = null,
                    modifier = Modifier.fillMaxSize().clip(CircleShape),
                    contentScale = androidx.compose.ui.layout.ContentScale.Crop
                )
            } else {
                // 无头像显示名字首字母
                Text(
                    text = name.take(1).uppercase(),
                    color = Color.Black,
                    style = MaterialTheme.typography.labelSmall,
                    fontWeight = FontWeight.Bold
                )
            }
        }

        Spacer(modifier = Modifier.width(12.dp))

        Text(
            text = name,
            color = Color.White,
            style = MaterialTheme.typography.bodyMedium,
            maxLines = 1,
            overflow = androidx.compose.ui.text.style.TextOverflow.Ellipsis
        )
    }
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\record\SessionRecorder.kt
--------------------------------------------------
package com.gosnow.app.ui.record

import com.gosnow.app.ui.record.classifier.MotionMode

interface SessionRecorder {
    val currentSpeedKmh: Double
    val distanceKm: Double
    val topSpeedKmh: Double
    val verticalDropM: Int
    val motionMode: MotionMode
    val state: RecordingState

    fun start()
    fun stop(): SkiSession?
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\record\SessionSummary.kt
--------------------------------------------------
package com.gosnow.app.ui.record

data class SessionSummary(
    val distanceKm: Double,
    val avgSpeedKmh: Double,
    val topSpeedKmh: Double,
    val verticalDropM: Int,
    val durationSec: Int
) {
    val durationText: String
        get() {
            val h = durationSec / 3600
            val m = (durationSec % 3600) / 60
            val s = durationSec % 60
            return if (h > 0) {
                String.format("%d:%02d:%02d", h, m, s)
            } else {
                String.format("%02d:%02d", m, s)
            }
        }
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\record\SkiSession.kt
--------------------------------------------------
package com.gosnow.app.ui.record

import kotlinx.serialization.Serializable
import java.util.UUID

@Serializable
data class SkiSession(
    val id: String = UUID.randomUUID().toString(),
    val startAtMillis: Long,
    val endAtMillis: Long,
    val durationSec: Int,
    val distanceKm: Double,
    val topSpeedKmh: Double,
    val avgSpeedKmh: Double,
    val verticalDropM: Int,
    val resortId: Long? = null
)


==================================================

File: app\src\main\java\com\gosnow\app\ui\record\classifier\LiftRideClassifier.kt
--------------------------------------------------
package com.gosnow.app.ui.record.classifier

import android.location.Location
import kotlin.math.max
import kotlin.math.min

enum class MotionMode { ACTIVE, IDLE, LIFT }

data class AutoDetectConfig(
    val windowSec: Double = 25.0,

    // —— 静止判断 ——
    val idleEnterSpeedKmh: Double = 1.2,
    val idleExitSpeedKmh: Double = 2.5,
    val idleHoldSec: Double = 12.0,

    // —— 缆车判断（上升）——
    val liftEnterMinSpeedKmh: Double = 4.0,
    val liftEnterMaxSpeedKmh: Double = 28.0,
    val liftEnterMinAltGainM: Double = 12.0,
    val liftEnterMinUpRateMps: Double = 0.30,
    val liftHoldSec: Double = 10.0,

    // 离开缆车
    val liftExitDownRateMps: Double = -0.20,
    val liftExitSpeedHighKmh: Double = 35.0,
    val liftExitSpeedLowKmh: Double = 3.0
)

private data class Sample(
    val tMs: Long,
    val speedKmh: Double,
    val altM: Double?
)

class LiftRideClassifier(
    private val cfg: AutoDetectConfig = AutoDetectConfig()
) {
    private val buf = ArrayDeque<Sample>()
    private var lastLoc: Location? = null

    private var mode: MotionMode = MotionMode.ACTIVE
    fun currentMode(): MotionMode = mode

    /**
     * altitudeOverrideM：你传气压计“相对高度”（更稳）；没传就用 GPS altitude
     */
    fun consume(loc: Location, altitudeOverrideM: Double? = null): MotionMode {
        val now = loc.time.takeIf { it > 0 } ?: System.currentTimeMillis()

        val speedKmh = computeSpeedKmh(loc)
        val alt = altitudeOverrideM ?: loc.altitude.takeIf { it.isFinite() }

        buf.addLast(Sample(now, speedKmh, alt))
        prune(now)

        val window = getWindowStats()
        if (window == null) {
            lastLoc = loc
            return mode
        }

        val medianSpeed = window.medianSpeedKmh
        val upRate = window.upRateMps
        val downRate = window.downRateMps
        val altGain = window.altGainM
        val windowSec = window.windowSec

        val idleCandidate =
            windowSec >= cfg.idleHoldSec && medianSpeed <= cfg.idleEnterSpeedKmh

        val liftCandidate =
            windowSec >= cfg.liftHoldSec &&
                    medianSpeed in cfg.liftEnterMinSpeedKmh..cfg.liftEnterMaxSpeedKmh &&
                    altGain >= cfg.liftEnterMinAltGainM &&
                    upRate >= cfg.liftEnterMinUpRateMps

        when (mode) {
            MotionMode.ACTIVE -> {
                when {
                    liftCandidate -> mode = MotionMode.LIFT
                    idleCandidate -> mode = MotionMode.IDLE
                }
            }

            MotionMode.IDLE -> {
                when {
                    liftCandidate -> mode = MotionMode.LIFT
                    medianSpeed >= cfg.idleExitSpeedKmh -> mode = MotionMode.ACTIVE
                }
            }

            MotionMode.LIFT -> {
                val shouldExitLift =
                    downRate <= cfg.liftExitDownRateMps ||
                            medianSpeed >= cfg.liftExitSpeedHighKmh ||
                            medianSpeed <= cfg.liftExitSpeedLowKmh

                if (shouldExitLift) {
                    mode = if (medianSpeed >= cfg.idleExitSpeedKmh) MotionMode.ACTIVE else MotionMode.IDLE
                }
            }
        }

        lastLoc = loc
        return mode
    }

    private data class WindowStats(
        val windowSec: Double,
        val medianSpeedKmh: Double,
        val altGainM: Double,
        val upRateMps: Double,
        val downRateMps: Double
    )

    private fun getWindowStats(): WindowStats? {
        if (buf.size < 4) return null

        val first = buf.first()
        val last = buf.last()
        val dtSec = max(0.5, (last.tMs - first.tMs) / 1000.0)

        // median speed
        val speeds = buf.map { it.speedKmh }.sorted()
        val median = speeds[speeds.size / 2]

        // 用循环找第一个/最后一个非空高度（避免 firstNotNullOfOrNull/lastNotNullOfOrNull）
        val firstAlt: Double? = run {
            for (s in buf) {
                val a = s.altM
                if (a != null) return@run a
            }
            null
        }

        val lastAlt: Double? = run {
            var lastNonNull: Double? = null
            for (s in buf) {
                val a = s.altM
                if (a != null) lastNonNull = a
            }
            lastNonNull
        }

        if (firstAlt == null || lastAlt == null) {
            // 没有高度：只做 idle/active，不判 lift（避免误判）
            return WindowStats(
                windowSec = dtSec,
                medianSpeedKmh = median,
                altGainM = 0.0,
                upRateMps = 0.0,
                downRateMps = 0.0
            )
        }

        val altDelta: Double = lastAlt - firstAlt
        val upRate = max(0.0, altDelta / dtSec)
        val downRate = min(0.0, altDelta / dtSec)

        return WindowStats(
            windowSec = dtSec,
            medianSpeedKmh = median,
            altGainM = max(0.0, altDelta),
            upRateMps = upRate,
            downRateMps = downRate
        )
    }

    private fun prune(nowMs: Long) {
        val maxAgeMs = (cfg.windowSec * 1000.0).toLong()
        while (buf.isNotEmpty() && nowMs - buf.first().tMs > maxAgeMs) {
            buf.removeFirst()
        }
    }

    private fun computeSpeedKmh(loc: Location): Double {
        // 优先用系统 speed
        if (loc.hasSpeed()) {
            val v = loc.speed
            if (!v.isNaN() && !v.isInfinite() && v >= 0f) return (v * 3.6).toDouble()
        }

        val prev = lastLoc ?: return 0.0
        val dt = (loc.time - prev.time) / 1000.0
        if (dt <= 0) return 0.0
        val dm = prev.distanceTo(loc).toDouble()
        return (dm / 1000.0) / (dt / 3600.0)
    }
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\record\LocationManager\LocationService.kt
--------------------------------------------------
package com.gosnow.app.ui.record.LocationManager

import android.Manifest
import android.content.Context
import android.content.pm.PackageManager
import android.location.Location
import android.location.LocationListener
import android.location.LocationManager
import android.os.Bundle
import android.os.Looper
import android.util.Log
import androidx.core.app.ActivityCompat

enum class SamplingMode { Active, Idle }

interface LocationService {
    var onLocationSample: ((Location) -> Unit)?
    fun start()
    fun stop()
    fun setSamplingMode(mode: SamplingMode)
}
class SystemLocationService(
    private val context: Context
) : LocationService {

    override var onLocationSample: ((Location) -> Unit)? = null

    private val lm: LocationManager =
        context.getSystemService(Context.LOCATION_SERVICE) as LocationManager

    private var isStarted = false

    // 轨迹记录建议用 GPS_PROVIDER（要精确定位权限）
    private val provider = LocationManager.GPS_PROVIDER

    private var currentMode: SamplingMode = SamplingMode.Active

    private val listener = object : LocationListener {
        override fun onLocationChanged(location: Location) {
            Log.w("GoSnowLoc", "onLocationChanged: lat=${location.latitude}, lon=${location.longitude}, provider=${location.provider}")
            onLocationSample?.invoke(location)
        }

        @Deprecated("Deprecated in API 29")
        override fun onStatusChanged(provider: String?, status: Int, extras: Bundle?) {}

        override fun onProviderEnabled(provider: String) {}
        override fun onProviderDisabled(provider: String) {}
    }

    override fun start() {
        if (isStarted) return
        if (!hasFineLocationPermission()) return
        isStarted = true
        requestUpdates(currentMode)
    }

    override fun stop() {
        if (!isStarted) return
        runCatching { lm.removeUpdates(listener) }
        isStarted = false
    }

    override fun setSamplingMode(mode: SamplingMode) {
        currentMode = mode
        if (!isStarted) return
        if (!hasFineLocationPermission()) return
        requestUpdates(mode)
    }

    private fun requestUpdates(mode: SamplingMode) {
        val (minTime, minDistance) = when (mode) {
            SamplingMode.Active -> 1000L to 5f      // 1s / 5m
            SamplingMode.Idle -> 5000L to 25f       // 5s / 25m
        }

        try {
            lm.removeUpdates(listener)
            lm.requestLocationUpdates(
                provider,
                minTime,
                minDistance,
                listener,
                Looper.getMainLooper()
            )
        } catch (e: SecurityException) {
            e.printStackTrace()
        }
    }

    private fun hasFineLocationPermission(): Boolean {
        return ActivityCompat.checkSelfPermission(
            context, Manifest.permission.ACCESS_FINE_LOCATION
        ) == PackageManager.PERMISSION_GRANTED
    }
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\record\party\PartyRepository.kt
--------------------------------------------------
package com.gosnow.app.ui.record.party

import com.gosnow.app.datasupabase.SupabaseClientProvider
import com.gosnow.app.ui.snowcircle.data.supabase.PartyInsert
import com.gosnow.app.ui.snowcircle.data.supabase.PartyMemberInsert
import com.gosnow.app.ui.snowcircle.data.supabase.PartyRow
import io.github.jan.supabase.postgrest.from
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext

object PartyRepository {
    private val client get() = SupabaseClientProvider.supabaseClient

    /**
     * 1. 在 Party 表创建新队伍
     * 2. 将创建者作为 host 加入 party_member 表
     */
    suspend fun createPartyInDb(hostId: String, code: String): String = withContext(Dispatchers.IO) {
        // 插入 Party 表
        val party = client.from("party")
            .insert(PartyInsert(code = code, hostId = hostId)) { select() }
            .decodeSingle<PartyRow>()

        // 插入 Member 表 (自己是 Host)
        joinPartyDb(party.id, hostId, "host")

        return@withContext party.id
    }

    /**
     * 根据 4 位验证码查找 Party ID
     */
    suspend fun findPartyIdByCode(code: String): String? = withContext(Dispatchers.IO) {
        val result = client.from("party")
            .select {
                filter { eq("join_code", code) }
                limit(1)
            }
            .decodeList<PartyRow>()
        return@withContext result.firstOrNull()?.id
    }

    /**
     * 将用户写入 party_member 表
     */
    suspend fun joinPartyDb(partyId: String, userId: String, role: String = "member") = withContext(Dispatchers.IO) {
        // upsert 避免重复加入报错，依赖 onConflict 策略 (party_id, user_id)
        client.from("party_member")
            .upsert(
                PartyMemberInsert(partyId = partyId, userId = userId, role = role),
                onConflict = "party_id, user_id"
            )
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\record\party\PartyRideManager.kt
--------------------------------------------------
package com.gosnow.app.ui.record.party

import android.location.Location
import android.util.Log
import com.gosnow.app.datasupabase.CurrentUserStore
import com.gosnow.app.datasupabase.SupabaseClientProvider
import com.gosnow.app.ui.snowcircle.data.party.PartyUserRepository
import com.gosnow.app.ui.snowcircle.model.PartyMember
import com.gosnow.app.ui.snowcircle.model.PartyState
import io.github.jan.supabase.gotrue.auth
import io.github.jan.supabase.realtime.*
import kotlinx.coroutines.*
import kotlinx.coroutines.flow.*
import kotlinx.serialization.json.*

class PartyRideManager(private val scope: CoroutineScope) {
    private val client get() = SupabaseClientProvider.supabaseClient
    private val myUserId get() = client.auth.currentUserOrNull()?.id ?: ""

    private val _state = MutableStateFlow<PartyState>(PartyState.Idle)
    val state = _state.asStateFlow()

    private val _statusEvent = MutableSharedFlow<String>(replay = 0)
    val statusEvent = _statusEvent.asSharedFlow()

    private var channel: RealtimeChannel? = null
    private var isConnecting = false

    // 心跳任务
    private var heartbeatJob: Job? = null
    private var lastKnownLocation: Pair<Double, Double>? = null

    // 本地缓存：userId -> Member
    private val memberCache = mutableMapOf<String, PartyMember>()

    companion object {
        private const val TAG = "PartyDebug"
    }

    fun createParty() {
        val code = String.format("%04d", (0..9999).random())
        joinParty(code, isCreating = true)
    }

    fun joinParty(code: String, isCreating: Boolean = false) {
        if (isConnecting) return
        val currentId = myUserId
        if (currentId.isEmpty()) {
            emitStatus("未登录，无法加入")
            return
        }

        isConnecting = true
        scope.launch {
            try {
                Log.d(TAG, "=== 开始加入流程: $code ===")
                emitStatus(if (isCreating) "正在创建..." else "正在加入...")

                // 1. 数据库操作
                if (isCreating) {
                    PartyRepository.createPartyInDb(currentId, code)
                } else {
                    val partyId = PartyRepository.findPartyIdByCode(code)
                        ?: throw IllegalStateException("无效的邀请码")
                    PartyRepository.joinPartyDb(partyId, currentId)
                }

                // 2. 清理旧状态
                cleanup()

                // 3. 更新 UI
                _state.value = PartyState.Joined(code, emptyList(), isHost = isCreating)

                // 4. 连接 Realtime
                connectRealtime(code, currentId)

                emitStatus("加入成功，等待队友...")

            } catch (e: Exception) {
                e.printStackTrace()
                Log.e(TAG, "加入失败: ${e.message}")
                emitStatus("操作失败: ${e.message}")
                _state.value = PartyState.Idle
            } finally {
                isConnecting = false
            }
        }
    }

    private suspend fun connectRealtime(code: String, myId: String) {
        val ch = client.realtime.channel("room_$code")
        channel = ch

        // A. 监听队友状态变化
        scope.launch {
            ch.presenceChangeFlow().collect { action ->
                handlePresenceAction(action)
            }
        }

        // B. 监听连接状态
        scope.launch {
            ch.status.collect { status ->
                Log.d(TAG, "通道状态变更: $status")
            }
        }

        // C. 订阅并等待连接成功
        Log.d(TAG, "正在订阅通道...")
        ch.subscribe()

        try {
            // 阻塞等待直到状态变为 SUBSCRIBED
            withTimeout(10000L) {
                ch.status.filter { it == RealtimeChannel.Status.SUBSCRIBED }.first()
            }
            Log.d(TAG, "通道已连接 (SUBSCRIBED)，开始发送心跳")

            // D. 连接成功后，立即启动心跳广播
            startHeartbeat(myId)

        } catch (e: TimeoutCancellationException) {
            Log.e(TAG, "连接超时！Realtime 可能未开启或网络受限")
            emitStatus("连接超时，请重试")
        }
    }

    private fun startHeartbeat(myId: String) {
        heartbeatJob?.cancel()
        heartbeatJob = scope.launch {
            Log.d(TAG, "心跳任务启动")
            // 立即发第一次
            val (lat, lon) = lastKnownLocation ?: (0.0 to 0.0)
            broadcastLocation(myId, lat, lon, isInit = true)

            while (isActive) {
                delay(3000) // 每3秒一次
                val (currLat, currLon) = lastKnownLocation ?: (0.0 to 0.0)
                broadcastLocation(myId, currLat, currLon)
            }
        }
    }

    fun onMyLocationUpdate(location: Location) {
        val myId = myUserId
        if (_state.value !is PartyState.Joined || myId.isEmpty()) return

        lastKnownLocation = location.latitude to location.longitude

        // 有位置移动时，立即广播
        scope.launch(Dispatchers.IO) {
            broadcastLocation(myId, location.latitude, location.longitude)
        }
    }

    // ✅ 这就是你报错缺失的函数
    private suspend fun broadcastLocation(userId: String, lat: Double, lon: Double, isInit: Boolean = false) {
        val activeChannel = channel ?: return

        if (activeChannel.status.value != RealtimeChannel.Status.SUBSCRIBED) {
            return
        }

        val profile = CurrentUserStore.profile.value
        val name = profile?.userName ?: "雪友${userId.take(4)}"
        val avatar = profile?.avatarUrl ?: ""

        try {
            activeChannel.track(buildJsonObject {
                put("u", userId)
                put("lat", lat)
                put("lon", lon)
                put("n", name)
                put("a", avatar)
                if (isInit) put("init", true)
                put("ts", System.currentTimeMillis())
            })
        } catch (e: Exception) {
            Log.e(TAG, "广播失败: ${e.message}")
        }
    }

    // =========================================================
    // ✅ 核心修复：防止加入后立马退出的逻辑
    // =========================================================
    private suspend fun handlePresenceAction(action: PresenceAction) {
        val myId = myUserId

        Log.d(TAG, "收到 Presence 事件! Joins: ${action.joins.size}, Leaves: ${action.leaves.size}")

        // 1. 先收集这一波 "Joins" (正在更新/加入) 的所有用户 ID
        val joiningUserIds = mutableSetOf<String>()

        action.joins.values.forEach { presence ->
            val userId = parseAndCachePresence(presence, myId)
            if (userId != null) {
                joiningUserIds.add(userId)
            }
        }

        // 2. 处理离开
        action.leaves.values.forEach { presence ->
            try {
                val json = presence.state.jsonObject
                val userId = json["u"]?.jsonPrimitive?.content
                    ?: json["userId"]?.jsonPrimitive?.content

                // ✅ 只有当这个 userId 不在 joiningUserIds 集合里时，才说明是真的退出了
                if (userId != null && !joiningUserIds.contains(userId)) {
                    Log.d(TAG, "用户彻底离开: $userId")
                    memberCache.remove(userId)
                }
            } catch (e: Exception) {
                e.printStackTrace()
            }
        }

        // 3. 刷新 UI
        val newList = memberCache.values.toList()
        Log.d(TAG, "刷新 UI 列表，当前队友数: ${newList.size}")

        _state.update { s ->
            if (s is PartyState.Joined) s.copy(members = newList) else s
        }
    }

    private fun parseAndCachePresence(presence: Presence, myId: String): String? {
        try {
            val json = presence.state.jsonObject
            val userId = json["u"]?.jsonPrimitive?.content
                ?: json["userId"]?.jsonPrimitive?.content

            if (userId == null) return null
            if (userId == myId) return userId // 返回自己的ID但不存缓存

            val lat = json["lat"]?.jsonPrimitive?.doubleOrNull ?: 0.0
            val lon = json["lon"]?.jsonPrimitive?.doubleOrNull ?: 0.0
            val name = json["n"]?.jsonPrimitive?.content ?: "队友"
            val avatar = json["a"]?.jsonPrimitive?.content

            val member = PartyMember(userId, lat, lon, avatar, name)
            memberCache[userId] = member

            return userId
        } catch (e: Exception) {
            Log.e(TAG, "解析 Presence JSON 出错: ${e.message}")
            return null
        }
    }

    fun leaveParty() {
        scope.launch {
            cleanup()
            _state.value = PartyState.Idle
            emitStatus("已离开")
        }
    }

    private suspend fun cleanup() {
        heartbeatJob?.cancel()
        try { channel?.unsubscribe() } catch (_: Exception) {}
        channel = null
        memberCache.clear()
        lastKnownLocation = null
    }

    private fun emitStatus(msg: String) {
        scope.launch { _statusEvent.emit(msg) }
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\record\sensors\BarometerAltimeter.kt
--------------------------------------------------
package com.gosnow.app.ui.record.sensors

import android.content.Context
import android.hardware.Sensor
import android.hardware.SensorEvent
import android.hardware.SensorEventListener
import android.hardware.SensorManager
import kotlin.math.pow

class BarometerAltimeter(
    context: Context,
    private val smoothAlpha: Float = 0.85f
) : SensorEventListener {

    private val sm = context.getSystemService(Context.SENSOR_SERVICE) as SensorManager
    private val pressureSensor: Sensor? = sm.getDefaultSensor(Sensor.TYPE_PRESSURE)

    private var p0: Float? = null
    private var _altitudeM: Float? = null

    val altitudeM: Float?
        get() = _altitudeM

    fun isAvailable(): Boolean = pressureSensor != null

    fun start() {
        p0 = null
        _altitudeM = null
        pressureSensor?.let {
            sm.registerListener(this, it, SensorManager.SENSOR_DELAY_GAME)
        }
    }

    fun stop() {
        sm.unregisterListener(this)
    }

    override fun onSensorChanged(event: SensorEvent) {
        if (event.sensor.type != Sensor.TYPE_PRESSURE) return
        val p = event.values.firstOrNull() ?: return
        if (p <= 0f) return

        val base = p0 ?: run {
            p0 = p
            p
        }

        val rawAlt = 44330f * (1f - (p / base).pow(0.1903f))
        val prev = _altitudeM

        _altitudeM = if (prev == null) rawAlt else smoothAlpha * prev + (1f - smoothAlpha) * rawAlt
    }

    override fun onAccuracyChanged(sensor: Sensor?, accuracy: Int) {}
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\record\service\ForegroundRecordingService.kt
--------------------------------------------------
package com.gosnow.app.ui.record.service

import android.app.*
import android.content.Intent
import android.location.Location
import android.os.Binder
import android.os.Build
import android.os.IBinder
import androidx.core.app.NotificationCompat
import com.gosnow.app.R
import com.gosnow.app.MainActivity
import com.gosnow.app.ui.record.LocationManager.SamplingMode
import com.gosnow.app.ui.record.LocationManager.SystemLocationService
import com.gosnow.app.ui.record.SkiSession
import com.gosnow.app.ui.record.classifier.LiftRideClassifier
import com.gosnow.app.ui.record.classifier.MotionMode
import com.gosnow.app.ui.record.sensors.BarometerAltimeter
import com.gosnow.app.ui.record.storage.BasicMetricsComputer
import com.gosnow.app.ui.record.storage.FileSessionStore
import com.gosnow.app.ui.record.storage.SupabaseSessionRepository // 确保有这个
import com.gosnow.app.datasupabase.SupabaseClientProvider
import io.github.jan.supabase.gotrue.auth
import kotlinx.coroutines.*
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow

data class RecordingLiveState(
    val isRecording: Boolean = false,
    val durationSec: Int = 0,
    val distanceKm: Double = 0.0,
    val topSpeedKmh: Double = 0.0,
    val verticalDropM: Int = 0,
    val motionMode: MotionMode = MotionMode.ACTIVE
)

class ForegroundRecordingService : Service() {

    companion object {
        const val ACTION_START = "com.gosnow.app.action.RECORD_START"
        const val ACTION_STOP = "com.gosnow.app.action.RECORD_STOP"
        private const val CHANNEL_ID = "recording_channel"
        private const val NOTIF_ID = 1001
    }

    inner class LocalBinder : Binder() {
        fun getService(): ForegroundRecordingService = this@ForegroundRecordingService
    }

    private val binder = LocalBinder()
    private val _state = MutableStateFlow(RecordingLiveState())
    val stateFlow: StateFlow<RecordingLiveState> = _state
    private val serviceScope = CoroutineScope(SupervisorJob() + Dispatchers.Main.immediate)

    // ✅ 新增：高频位置回调，供 ViewModel 连接 Party 和 Track 模块
    // 参数：Location, Speed (km/h)
    var onLocationUpdate: ((Location, Double) -> Unit)? = null

    private lateinit var locationService: SystemLocationService
    private lateinit var metrics: BasicMetricsComputer
    private lateinit var classifier: LiftRideClassifier
    private var barometer: BarometerAltimeter? = null
    private lateinit var store: FileSessionStore

    private var sessionStartMillis: Long = 0L
    private var lastSamplingMode: SamplingMode? = null
    private var tickerJob: Job? = null

    override fun onCreate() {
        super.onCreate()
        createChannel()

        locationService = SystemLocationService(applicationContext)
        metrics = BasicMetricsComputer()
        classifier = LiftRideClassifier()
        store = FileSessionStore(applicationContext)

        val b = BarometerAltimeter(applicationContext)
        barometer = if (b.isAvailable()) b else null

        locationService.onLocationSample = { loc ->
            val altOverride = barometer?.altitudeM?.toDouble()
            val mode = classifier.consume(loc, altOverride)
            metrics.setLiftMode(mode == MotionMode.LIFT || mode == MotionMode.IDLE)

            val desired = if (mode == MotionMode.ACTIVE) SamplingMode.Active else SamplingMode.Idle
            if (desired != lastSamplingMode) {
                locationService.setSamplingMode(desired)
                lastSamplingMode = desired
            }

            metrics.consumeSample(loc, altitudeOverrideM = altOverride)

            // ✅ 核心修改：触发回调，把原始 Location 传给 ViewModel
            val speedKmh = metrics.currentSpeedKmh
            onLocationUpdate?.invoke(loc, speedKmh)

            if (_state.value.isRecording) {
                val dur = ((System.currentTimeMillis() - sessionStartMillis) / 1000L).toInt().coerceAtLeast(0)
                _state.value = _state.value.copy(
                    durationSec = dur,
                    distanceKm = metrics.distanceKm,
                    topSpeedKmh = metrics.topSpeedKmh,
                    verticalDropM = metrics.verticalDropM,
                    motionMode = mode
                )
            }
        }
    }

    override fun onBind(intent: Intent?): IBinder = binder

    override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
        when (intent?.action) {
            ACTION_START -> startRecording()
            ACTION_STOP -> stopRecording()
        }
        return START_STICKY
    }

    private fun startRecording() {
        if (_state.value.isRecording) return
        sessionStartMillis = System.currentTimeMillis()
        metrics.reset()
        barometer?.start()
        lastSamplingMode = SamplingMode.Active
        locationService.setSamplingMode(SamplingMode.Active)
        locationService.start()

        _state.value = RecordingLiveState(
            isRecording = true,
            durationSec = 0, distanceKm = 0.0, topSpeedKmh = 0.0, verticalDropM = 0, motionMode = MotionMode.ACTIVE
        )
        startForeground(NOTIF_ID, buildNotification(_state.value))

        tickerJob?.cancel()
        tickerJob = serviceScope.launch {
            while (isActive && _state.value.isRecording) {
                val dur = ((System.currentTimeMillis() - sessionStartMillis) / 1000L).toInt().coerceAtLeast(0)
                _state.value = _state.value.copy(durationSec = dur)
                updateNotification(_state.value)
                delay(1000L)
            }
        }
    }

    private fun stopRecording() {
        if (!_state.value.isRecording) {
            stopSelf()
            return
        }
        locationService.stop()
        barometer?.stop()

        val end = System.currentTimeMillis()
        val durationSec = ((end - sessionStartMillis) / 1000L).toInt().coerceAtLeast(0)

        val session = SkiSession(
            startAtMillis = sessionStartMillis,
            endAtMillis = end,
            durationSec = durationSec,
            distanceKm = metrics.distanceKm,
            topSpeedKmh = metrics.topSpeedKmh,
            avgSpeedKmh = if (durationSec > 0) metrics.distanceKm / (durationSec / 3600.0) else 0.0,
            verticalDropM = metrics.verticalDropM
        )

        serviceScope.launch(Dispatchers.IO) {
            // 1. 存本地
            runCatching { store.saveSession(session) }

            // 2. 传云端
            val client = SupabaseClientProvider.supabaseClient
            val user = client.auth.currentUserOrNull()
            if (user != null) {
                runCatching {
                    SupabaseSessionRepository(client).uploadSession(session, user.id)
                }
            }
        }

        tickerJob?.cancel()
        tickerJob = null
        _state.value = _state.value.copy(isRecording = false)
        stopForeground(STOP_FOREGROUND_REMOVE)
        stopSelf()
    }

    private fun buildNotification(s: RecordingLiveState): Notification {
        val openIntent = Intent(this, MainActivity::class.java)
        val openPI = PendingIntent.getActivity(this, 0, openIntent, PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE)
        val stopIntent = Intent(this, ForegroundRecordingService::class.java).apply { action = ACTION_STOP }
        val stopPI = PendingIntent.getService(this, 1, stopIntent, PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE)
        val content = "用时 ${formatDuration(s.durationSec)} · ${String.format("%.1f", s.distanceKm)} km · ${statusText(s)}"
        return NotificationCompat.Builder(this, CHANNEL_ID)
            .setSmallIcon(R.drawable.ic_launcher_foreground)
            .setContentTitle("正在记录滑雪")
            .setContentText(content)
            .setContentIntent(openPI)
            .setOngoing(true)
            .setOnlyAlertOnce(true)
            .addAction(0, "结束", stopPI)
            .build()
    }

    private fun updateNotification(s: RecordingLiveState) {
        val nm = getSystemService(NOTIFICATION_SERVICE) as NotificationManager
        nm.notify(NOTIF_ID, buildNotification(s))
    }

    private fun statusText(s: RecordingLiveState): String {
        if (!s.isRecording) return "未开始"
        return when (s.motionMode) {
            MotionMode.LIFT -> "缆车中"
            MotionMode.IDLE -> "静止中"
            MotionMode.ACTIVE -> "滑行中"
        }
    }

    private fun formatDuration(sec: Int): String {
        val h = sec / 3600
        val m = (sec % 3600) / 60
        val s = sec % 60
        return if (h > 0) String.format("%d:%02d:%02d", h, m, s) else String.format("%02d:%02d", m, s)
    }

    private fun createChannel() {
        if (Build.VERSION.SDK_INT < 26) return
        val nm = getSystemService(NOTIFICATION_SERVICE) as NotificationManager
        val ch = NotificationChannel(CHANNEL_ID, "滑雪记录", NotificationManager.IMPORTANCE_LOW)
        nm.createNotificationChannel(ch)
    }

    override fun onDestroy() {
        super.onDestroy()
        tickerJob?.cancel()
        serviceScope.cancel()
        runCatching { locationService.stop() }
        runCatching { barometer?.stop() }
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\record\storage\FileSessionStore.kt
--------------------------------------------------
package com.gosnow.app.ui.record.storage

import android.content.Context
import com.gosnow.app.ui.record.SkiSession
import com.google.gson.Gson
import com.google.gson.GsonBuilder
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
import java.io.File

private const val MAX_SESSIONS = 10000

class FileSessionStore(
    context: Context
) : SessionStore {

    private val dir: File = File(context.filesDir, "sessions").apply {
        if (!exists()) mkdirs()
    }

    private val gson: Gson = GsonBuilder().setLenient().create()

    override suspend fun saveSession(session: SkiSession) {
        withContext(Dispatchers.IO) {
            val json = gson.toJson(session)
            val file = File(dir, "${session.id}.json")
            file.writeText(json, Charsets.UTF_8)
            pruneToLimit(MAX_SESSIONS)
        }
    }

    override suspend fun loadSessions(): List<SkiSession> {
        return withContext(Dispatchers.IO) {
            val files = dir.listFiles { f -> f.extension == "json" } ?: emptyArray()
            files.mapNotNull { f ->
                runCatching {
                    val text = f.readText(Charsets.UTF_8)
                    gson.fromJson(text, SkiSession::class.java)
                }.getOrNull()
            }.sortedByDescending { it.startAtMillis }
        }
    }

    private fun pruneToLimit(max: Int) {
        if (max <= 0) return
        val files = dir.listFiles { f -> f.extension == "json" } ?: return
        if (files.size <= max) return

        val sessionsWithFile = files.mapNotNull { f ->
            runCatching {
                val text = f.readText(Charsets.UTF_8)
                val s = gson.fromJson(text, SkiSession::class.java)
                s to f
            }.getOrNull()
        }.sortedBy { it.first.startAtMillis }

        val toDelete = sessionsWithFile.take(sessionsWithFile.size - max)
        toDelete.forEach { (_, file) -> runCatching { file.delete() } }
    }
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\record\storage\SessionStore.kt
--------------------------------------------------
package com.gosnow.app.ui.record.storage

import com.gosnow.app.ui.record.SkiSession

interface SessionStore {
    suspend fun saveSession(session: SkiSession)
    suspend fun loadSessions(): List<SkiSession>
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\record\storage\SupabaseSessionRepository.kt
--------------------------------------------------
package com.gosnow.app.ui.record.storage

import com.gosnow.app.ui.record.SkiSession
import io.github.jan.supabase.SupabaseClient
import io.github.jan.supabase.postgrest.from
import io.github.jan.supabase.postgrest.query.Order
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable
import java.time.Instant

@Serializable
data class SkiSessionInsert(
    val id: String,
    @SerialName("user_id") val userId: String,
    @SerialName("start_at") val startAt: String,
    @SerialName("end_at") val endAt: String,
    @SerialName("duration_sec") val durationSec: Int,
    @SerialName("distance_km") val distanceKm: Double,
    @SerialName("top_speed_kmh") val topSpeedKmh: Double,
    @SerialName("avg_speed_kmh") val avgSpeedKmh: Double,
    @SerialName("vertical_drop_m") val verticalDropM: Int
)

class SupabaseSessionRepository(
    private val supabase: SupabaseClient
) {
    suspend fun uploadSession(session: SkiSession, userId: String) = withContext(Dispatchers.IO) {
        val payload = SkiSessionInsert(
            id = session.id,
            userId = userId,
            startAt = Instant.ofEpochMilli(session.startAtMillis).toString(),
            endAt = Instant.ofEpochMilli(session.endAtMillis).toString(),
            durationSec = session.durationSec,
            distanceKm = session.distanceKm,
            topSpeedKmh = session.topSpeedKmh,
            avgSpeedKmh = session.avgSpeedKmh,
            verticalDropM = session.verticalDropM
        )
        supabase.from("ski_sessions").insert(payload)
    }

    // ✅ 新增：从云端拉取该用户的所有滑行记录
    suspend fun fetchAllSessions(userId: String): List<SkiSession> = withContext(Dispatchers.IO) {
        try {
            val results = supabase.from("ski_sessions")
                .select {
                    filter { eq("user_id", userId) }
                    order("start_at", Order.DESCENDING)
                }
                .decodeList<SkiSessionInsert>()

            results.map { dto ->
                SkiSession(
                    id = dto.id,
                    startAtMillis = Instant.parse(dto.startAt).toEpochMilli(),
                    endAtMillis = Instant.parse(dto.endAt).toEpochMilli(),
                    durationSec = dto.durationSec,
                    distanceKm = dto.distanceKm,
                    topSpeedKmh = dto.topSpeedKmh,
                    avgSpeedKmh = dto.avgSpeedKmh,
                    verticalDropM = dto.verticalDropM
                )
            }
        } catch (e: Exception) {
            e.printStackTrace()
            emptyList()
        }
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\record\track\LiveTrackController.kt
--------------------------------------------------
package com.gosnow.app.ui.record.track

import android.location.Location
import com.mapbox.geojson.Feature
import com.mapbox.geojson.FeatureCollection
import com.mapbox.geojson.LineString
import com.mapbox.geojson.Point

data class TrackSegment(
    val points: MutableList<Point>,
    val isFast: Boolean // false=green, true=orange
)

class LiveTrackController {
    private val segments = mutableListOf<TrackSegment>()
    private var lastAcceptedLocation: Location? = null

    // 状态机参数
    private val MIN_DISTANCE_M = 3.0f
    private val ORANGE_ON_KMH = 50.0
    private val ORANGE_OFF_KMH = 48.0

    // 状态机内部状态
    private var isFastMode = false
    private var stateChangeStartTime = 0L
    private val DWELL_ON_MS = 2000L // 2s
    private val DWELL_OFF_MS = 1000L // 1s

    fun reset() {
        segments.clear()
        lastAcceptedLocation = null
        isFastMode = false
    }

    fun addPoint(location: Location, speedKmh: Double) {
        // 1. 采样过滤
        if (lastAcceptedLocation != null) {
            if (location.distanceTo(lastAcceptedLocation!!) < MIN_DISTANCE_M) return
        }
        lastAcceptedLocation = location

        // 2. 速度状态机 (滞回)
        val now = System.currentTimeMillis()
        if (!isFastMode) {
            if (speedKmh >= ORANGE_ON_KMH) {
                if (stateChangeStartTime == 0L) stateChangeStartTime = now
                if (now - stateChangeStartTime >= DWELL_ON_MS) {
                    isFastMode = true
                    stateChangeStartTime = 0L // reset
                }
            } else {
                stateChangeStartTime = 0L
            }
        } else {
            if (speedKmh <= ORANGE_OFF_KMH) {
                if (stateChangeStartTime == 0L) stateChangeStartTime = now
                if (now - stateChangeStartTime >= DWELL_OFF_MS) {
                    isFastMode = false
                    stateChangeStartTime = 0L
                }
            } else {
                stateChangeStartTime = 0L
            }
        }

        // 3. 构造 Segment
        val newPoint = Point.fromLngLat(location.longitude, location.latitude)

        if (segments.isEmpty()) {
            segments.add(TrackSegment(mutableListOf(newPoint), isFastMode))
        } else {
            val lastSeg = segments.last()
            if (lastSeg.isFast == isFastMode) {
                // 状态相同，追加
                lastSeg.points.add(newPoint)
            } else {
                // 状态不同，新建 Segment，连接点是上一个点
                val prevPoint = lastSeg.points.last()
                segments.add(TrackSegment(mutableListOf(prevPoint, newPoint), isFastMode))
            }
        }
    }

    // 获取用于 Mapbox 更新的 GeoJSON
    fun getGeoJsonData(): Pair<FeatureCollection, FeatureCollection> {
        val greenFeatures = segments.filter { !it.isFast }.map {
            Feature.fromGeometry(LineString.fromLngLats(it.points))
        }
        val orangeFeatures = segments.filter { it.isFast }.map {
            Feature.fromGeometry(LineString.fromLngLats(it.points))
        }

        return Pair(
            FeatureCollection.fromFeatures(greenFeatures),
            FeatureCollection.fromFeatures(orangeFeatures)
        )
    }

    // 获取原始数据用于生成静态图
    fun getSegmentsSnapshot(): List<TrackSegment> = segments.toList()
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\record\track\StaticTrackGenerator.kt
--------------------------------------------------
package com.gosnow.app.ui.record.track

import android.content.Context
import android.graphics.Bitmap
import android.graphics.Canvas
import android.graphics.Color
import android.graphics.Paint
import android.graphics.Path
import android.graphics.RectF
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
import java.io.File
import java.io.FileOutputStream
import kotlin.math.max
import kotlin.math.min

object StaticTrackGenerator {

    suspend fun generateAndSave(
        context: Context,
        sessionId: String,
        segments: List<TrackSegment>
    ): File? = withContext(Dispatchers.Default) {
        if (segments.isEmpty()) return@withContext null

        val width = 900
        val height = 900
        val padding = 70f

        // 1. 找边界
        var minLat = 90.0
        var maxLat = -90.0
        var minLon = 180.0
        var maxLon = -180.0

        segments.forEach { seg ->
            seg.points.forEach { p ->
                minLat = min(minLat, p.latitude())
                maxLat = max(maxLat, p.latitude())
                minLon = min(minLon, p.longitude())
                maxLon = max(maxLon, p.longitude())
            }
        }

        // 避免单点导致除0
        if (minLat == maxLat || minLon == maxLon) return@withContext null

        // 2. 准备画布
        val bitmap = Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888)
        val canvas = Canvas(bitmap)
        // 背景透明或者深色，看需求
        // canvas.drawColor(Color.TRANSPARENT)

        // 3. 画笔设置
        val casingPaint = Paint().apply {
            color = Color.BLACK
            alpha = 140 // ~0.55
            strokeWidth = 12f // 稍微粗一点因为 bitmap 比较大
            style = Paint.Style.STROKE
            strokeJoin = Paint.Join.ROUND
            strokeCap = Paint.Cap.ROUND
            isAntiAlias = true
        }

        val greenPaint = Paint().apply {
            color = Color.parseColor("#00C853") // Green
            alpha = 242 // ~0.95
            strokeWidth = 7f
            style = Paint.Style.STROKE
            strokeJoin = Paint.Join.ROUND
            strokeCap = Paint.Cap.ROUND
            isAntiAlias = true
        }

        val orangePaint = Paint().apply {
            color = Color.parseColor("#FF9500") // Orange
            alpha = 242
            strokeWidth = 7f
            style = Paint.Style.STROKE
            strokeJoin = Paint.Join.ROUND
            strokeCap = Paint.Cap.ROUND
            isAntiAlias = true
        }

        // 4. 坐标映射函数
        val usableW = width - padding * 2
        val usableH = height - padding * 2
        val latSpan = maxLat - minLat
        val lonSpan = maxLon - minLon

        // 保持比例
        val scaleX = usableW / lonSpan
        val scaleY = usableH / latSpan
        val scale = min(scaleX, scaleY)

        // 居中偏移
        val offsetX = (width - lonSpan * scale) / 2
        val offsetY = (height - latSpan * scale) / 2

        fun mapX(lon: Double): Float = ((lon - minLon) * scale + offsetX).toFloat()
        fun mapY(lat: Double): Float = (height - ((lat - minLat) * scale + offsetY)).toFloat() // Y轴反转

        // 5. 绘制 (两遍：先描边，再主线)

        // Pass 1: Casing
        segments.forEach { seg ->
            if (seg.points.size < 2) return@forEach
            val path = Path()
            path.moveTo(mapX(seg.points[0].longitude()), mapY(seg.points[0].latitude()))
            for (i in 1 until seg.points.size) {
                path.lineTo(mapX(seg.points[i].longitude()), mapY(seg.points[i].latitude()))
            }
            canvas.drawPath(path, casingPaint)
        }

        // Pass 2: Main Line
        segments.forEach { seg ->
            if (seg.points.size < 2) return@forEach
            val path = Path()
            path.moveTo(mapX(seg.points[0].longitude()), mapY(seg.points[0].latitude()))
            for (i in 1 until seg.points.size) {
                path.lineTo(mapX(seg.points[i].longitude()), mapY(seg.points[i].latitude()))
            }
            val paint = if (seg.isFast) orangePaint else greenPaint
            canvas.drawPath(path, paint)
        }

        // 6. 保存到文件
        val file = File(context.filesDir, "track_$sessionId.png")
        FileOutputStream(file).use { out ->
            bitmap.compress(Bitmap.CompressFormat.PNG, 100, out)
        }

        return@withContext file
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\settings\SettingsScreens.kt
--------------------------------------------------
package com.gosnow.app.ui.settings

import android.net.Uri
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.PickVisualMediaRequest
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material.icons.filled.ArrowForward
import androidx.compose.material.icons.filled.CheckCircle
import androidx.compose.material.icons.filled.DeleteForever
import androidx.compose.material.icons.filled.Email
import androidx.compose.material.icons.filled.Feedback
import androidx.compose.material.icons.filled.Info
import androidx.compose.material.icons.filled.Lock
import androidx.compose.material.icons.filled.Logout
import androidx.compose.material.icons.filled.ManageAccounts
import androidx.compose.material.icons.filled.Star
import androidx.compose.material3.AlertDialog
import androidx.compose.material3.Button
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.CircularProgressIndicator
import androidx.compose.material3.Divider
import androidx.compose.material3.ElevatedCard
import androidx.compose.material3.ExperimentalMaterial3Api
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.OutlinedTextField
import androidx.compose.material3.Scaffold
import androidx.compose.material3.SnackbarHost
import androidx.compose.material3.SnackbarHostState
import androidx.compose.material3.Text
import androidx.compose.material3.TextButton
import androidx.compose.material3.TopAppBar
import androidx.compose.runtime.Composable
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalUriHandler
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import coil.compose.AsyncImage
import com.gosnow.app.datasupabase.CurrentUserStore
import com.gosnow.app.datasupabase.FeedbackRepository
import com.gosnow.app.datasupabase.ProfileRepository
import com.gosnow.app.ui.theme.GosnowTheme
import com.gosnow.app.util.loadAndCompressImage
import kotlinx.coroutines.launch

const val ROUTE_SETTINGS = "settings"

const val ROUTE_FEEDBACK = "settings_feedback"
const val ROUTE_ABOUT = "settings_about"
const val ROUTE_EDIT_PROFILE = "settings_edit_profile"

const val ROUTE_ACCOUNT_PRIVACY = "settings_account_privacy"


/* ---------------- 设置主页 ---------------- */

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun SettingsScreen(
    onBackClick: () -> Unit,
    onEditProfileClick: () -> Unit,
    onAccountPrivacyClick: () -> Unit,
    onFeedbackClick: () -> Unit,
    onAboutClick: () -> Unit,
    onLogoutClick: () -> Unit
) {
    val scrollState = rememberScrollState()

    val currentProfile by CurrentUserStore.profile.collectAsState()
    val userName = currentProfile?.userName ?: "雪友"
    val avatarUrl = currentProfile?.avatarUrl
    var showLogoutDialog by remember { mutableStateOf(false) }

    Scaffold(
        topBar = {
            TopAppBar(
                title = {
                    Text(
                        text = "账户与设置",
                        style = MaterialTheme.typography.titleLarge.copy(fontWeight = FontWeight.Bold)
                    )
                },
                navigationIcon = {
                    IconButton(onClick = onBackClick) {
                        Icon(imageVector = Icons.Filled.ArrowBack, contentDescription = "返回")
                    }
                }
            )
        }
    ) { innerPadding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .background(MaterialTheme.colorScheme.background)
                .padding(innerPadding)
                .verticalScroll(scrollState),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            Spacer(modifier = Modifier.height(4.dp))

            UserInfoCard(
                userName = userName,
                avatarUrl = avatarUrl,
                onEditProfileClick = onEditProfileClick,
                modifier = Modifier.padding(horizontal = 16.dp)
            )

            Text(
                text = "通用",
                style = MaterialTheme.typography.labelMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant,
                modifier = Modifier.padding(horizontal = 20.dp)
            )

            ElevatedCard(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(horizontal = 16.dp),
                shape = RoundedCornerShape(20.dp),
                colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
                elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
            ) {
                SettingsItemRow(
                    icon = Icons.Filled.ManageAccounts,
                    iconBackground = MaterialTheme.colorScheme.primaryContainer,
                    iconTint = MaterialTheme.colorScheme.onPrimaryContainer,
                    title = "账户与隐私",
                    onClick = onAccountPrivacyClick
                )
                Divider(color = MaterialTheme.colorScheme.outlineVariant.copy(alpha = 0.4f))
                SettingsItemRow(
                    icon = Icons.Filled.Feedback,
                    iconBackground = MaterialTheme.colorScheme.secondaryContainer,
                    iconTint = MaterialTheme.colorScheme.onSecondaryContainer,
                    title = "用户反馈",
                    onClick = onFeedbackClick
                )
                Divider(color = MaterialTheme.colorScheme.outlineVariant.copy(alpha = 0.4f))
                SettingsItemRow(
                    icon = Icons.Filled.Info,
                    iconBackground = MaterialTheme.colorScheme.tertiaryContainer,
                    iconTint = MaterialTheme.colorScheme.onTertiaryContainer,
                    title = "关于我们",
                    onClick = onAboutClick
                )
            }

            ElevatedCard(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(horizontal = 16.dp),
                shape = RoundedCornerShape(20.dp),
                colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
                elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
            ) {
                SettingsItemRow(
                    icon = Icons.Filled.Logout,
                    iconBackground = MaterialTheme.colorScheme.errorContainer,
                    iconTint = MaterialTheme.colorScheme.onErrorContainer,
                    title = "退出登录",
                    titleColor = MaterialTheme.colorScheme.error,
                    onClick = { showLogoutDialog = true }
                )
            }

            Spacer(modifier = Modifier.height(20.dp))
        }
    }
    if (showLogoutDialog) {
        AlertDialog(
            onDismissRequest = { showLogoutDialog = false },
            title = { Text("退出登录") },
            text = { Text("确定要退出当前账号吗？本地缓存的未同步数据可能会丢失。") },
            confirmButton = {
                TextButton(onClick = {
                    showLogoutDialog = false
                    onLogoutClick() // <--- 这里才是真正的退出逻辑
                }) {
                    Text("退出", color = MaterialTheme.colorScheme.error)
                }
            },
            dismissButton = {
                TextButton(onClick = { showLogoutDialog = false }) {
                    Text("取消")
                }
            }
        )
    }
}


@Composable
private fun UserInfoCard(
    userName: String,
    avatarUrl: String?,
    onEditProfileClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
        shape = RoundedCornerShape(24.dp),
        elevation = CardDefaults.cardElevation(defaultElevation = 3.dp)
    ) {
        Row(
            modifier = Modifier.padding(20.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Box(
                modifier = Modifier
                    .size(64.dp)
                    .clip(CircleShape)
                    .background(MaterialTheme.colorScheme.primaryContainer),
                contentAlignment = Alignment.Center
            ) {
                when {
                    !avatarUrl.isNullOrBlank() -> {
                        AsyncImage(
                            model = avatarUrl,
                            contentDescription = "头像",
                            modifier = Modifier.fillMaxSize()
                        )
                    }

                    else -> {
                        val initial = userName.firstOrNull()?.uppercaseChar()?.toString() ?: "雪"
                        Text(
                            text = initial,
                            style = MaterialTheme.typography.titleLarge.copy(fontWeight = FontWeight.Bold),
                            color = MaterialTheme.colorScheme.onPrimaryContainer
                        )
                    }
                }
            }

            Spacer(modifier = Modifier.width(14.dp))

            Column(
                modifier = Modifier.weight(1f),
                verticalArrangement = Arrangement.spacedBy(6.dp)
            ) {
                Text(
                    text = userName,
                    style = MaterialTheme.typography.titleLarge.copy(fontWeight = FontWeight.Bold),
                    maxLines = 1,
                    overflow = TextOverflow.Ellipsis
                )
                Row(verticalAlignment = Alignment.CenterVertically) {
                    Icon(
                        imageVector = Icons.Filled.CheckCircle,
                        contentDescription = null,
                        tint = MaterialTheme.colorScheme.primary,
                        modifier = Modifier.size(18.dp)
                    )
                    Spacer(modifier = Modifier.width(4.dp))
                    Text(
                        text = "已登录",
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }

            TextButton(onClick = onEditProfileClick) {
                Text(text = "编辑资料")
            }
        }
    }
}

@Composable
private fun SettingsItemRow(
    icon: ImageVector,
    iconBackground: Color,
    iconTint: Color,
    title: String,
    modifier: Modifier = Modifier,
    titleColor: Color = MaterialTheme.colorScheme.onSurface,
    subtitle: String? = null,
    onClick: () -> Unit
) {
    Row(
        modifier = modifier
            .fillMaxWidth()
            .clickable(onClick = onClick)
            .padding(horizontal = 16.dp, vertical = 14.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        Box(
            modifier = Modifier
                .size(44.dp)
                .clip(RoundedCornerShape(12.dp))
                .background(iconBackground),
            contentAlignment = Alignment.Center
        ) {
            Icon(imageVector = icon, contentDescription = null, tint = iconTint)
        }

        Spacer(modifier = Modifier.width(14.dp))

        Column(modifier = Modifier.weight(1f)) {
            Text(
                text = title,
                style = MaterialTheme.typography.titleMedium.copy(fontWeight = FontWeight.Medium),
                color = titleColor
            )
            if (subtitle != null) {
                Spacer(modifier = Modifier.height(2.dp))
                Text(
                    text = subtitle,
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        }

        Icon(
            imageVector = Icons.Filled.ArrowForward,
            contentDescription = null,
            tint = MaterialTheme.colorScheme.onSurfaceVariant
        )
    }
}

/* ---------------- 子页面：账户与隐私 ---------------- */

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun AccountPrivacyScreen(
    onBackClick: () -> Unit,
    onOpenSystemSettingsClick: () -> Unit
) {
    Scaffold(
        topBar = {
            TopAppBar(
                title = {
                    Text(
                        text = "账户与隐私",
                        style = MaterialTheme.typography.titleLarge.copy(fontWeight = FontWeight.Bold)
                    )
                },
                navigationIcon = {
                    IconButton(onClick = onBackClick) {
                        Icon(imageVector = Icons.Filled.ArrowBack, contentDescription = "返回")
                    }
                }
            )
        }
    ) { innerPadding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .background(MaterialTheme.colorScheme.background)
                .padding(innerPadding)
                .padding(16.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            ElevatedCard(
                modifier = Modifier.fillMaxWidth(),
                shape = RoundedCornerShape(20.dp),
                colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
                elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
            ) {
                SettingsItemRow(
                    icon = Icons.Filled.Lock,
                    iconBackground = MaterialTheme.colorScheme.primaryContainer,
                    iconTint = MaterialTheme.colorScheme.onPrimaryContainer,
                    title = "权限管理",
                    subtitle = "前往系统设置管理应用权限",
                    onClick = onOpenSystemSettingsClick
                )
            }
        }
    }
}


/* ---------------- 子页面：用户反馈（写入 Supabase FeedBackForUs） ---------------- */

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun FeedbackScreen(
    onBackClick: () -> Unit
) {
    val scrollState = rememberScrollState()
    val snackbarHostState = remember { SnackbarHostState() }
    var content by remember { mutableStateOf("") }
    var contact by remember { mutableStateOf("") }
    val scope = rememberCoroutineScope()
    var isSubmitting by remember { mutableStateOf(false) }

    Scaffold(
        topBar = {
            TopAppBar(
                title = {
                    Text(
                        text = "用户反馈",
                        style = MaterialTheme.typography.titleLarge.copy(fontWeight = FontWeight.Bold)
                    )
                },
                navigationIcon = {
                    IconButton(onClick = onBackClick) {
                        Icon(imageVector = Icons.Filled.ArrowBack, contentDescription = "返回")
                    }
                }
            )
        },
        snackbarHost = { SnackbarHost(hostState = snackbarHostState) }
    ) { innerPadding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .background(MaterialTheme.colorScheme.background)
                .padding(innerPadding)
                .verticalScroll(scrollState),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            Spacer(modifier = Modifier.height(4.dp))

            ElevatedCard(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(horizontal = 16.dp),
                shape = RoundedCornerShape(20.dp),
                colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
                elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
            ) {
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(horizontal = 16.dp, vertical = 18.dp),
                    verticalArrangement = Arrangement.spacedBy(14.dp)
                ) {
                    OutlinedTextField(
                        value = content,
                        onValueChange = { content = it },
                        modifier = Modifier.fillMaxWidth(),
                        label = { Text("请描述你遇到的问题或建议…") },
                        minLines = 6,
                        enabled = !isSubmitting
                    )

                    OutlinedTextField(
                        value = contact,
                        onValueChange = { contact = it },
                        modifier = Modifier.fillMaxWidth(),
                        singleLine = true,
                        label = { Text("联系方式（可选）") },
                        leadingIcon = {
                            Icon(imageVector = Icons.Filled.Email, contentDescription = null)
                        },
                        enabled = !isSubmitting
                    )

                    Button(
                        onClick = {
                            val trimmedContent = content.trim()
                            if (trimmedContent.isEmpty()) {
                                scope.launch { snackbarHostState.showSnackbar("内容不能为空") }
                                return@Button
                            }

                            scope.launch {
                                try {
                                    isSubmitting = true
                                    FeedbackRepository.submitFeedback(
                                        content = trimmedContent,
                                        contact = contact
                                    )
                                    content = ""
                                    contact = ""
                                    snackbarHostState.showSnackbar("反馈已提交，感谢你！")
                                } catch (e: Exception) {
                                    e.printStackTrace()
                                    snackbarHostState.showSnackbar("提交失败：${e.message ?: "请稍后重试"}")
                                } finally {
                                    isSubmitting = false
                                }
                            }
                        },
                        modifier = Modifier.fillMaxWidth(),
                        shape = RoundedCornerShape(14.dp),
                        enabled = !isSubmitting
                    ) {
                        Text(text = if (isSubmitting) "提交中…" else "提交反馈")
                    }
                }
            }

            Spacer(modifier = Modifier.height(20.dp))
        }
    }
}

/* ---------------- 子页面：关于我们（只保留两项） ---------------- */

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun AboutScreen(
    onBackClick: () -> Unit,
    onCommunityGuidelinesClick: () -> Unit,
    onPrivacyPolicyClick: () -> Unit
) {
    val uriHandler = LocalUriHandler.current

    Scaffold(
        topBar = {
            TopAppBar(
                title = {
                    Text(
                        text = "关于我们",
                        style = MaterialTheme.typography.titleLarge.copy(fontWeight = FontWeight.Bold)
                    )
                },
                navigationIcon = {
                    IconButton(onClick = onBackClick) {
                        Icon(imageVector = Icons.Filled.ArrowBack, contentDescription = "返回")
                    }
                }
            )
        }
    ) { innerPadding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .background(MaterialTheme.colorScheme.background)
                .padding(innerPadding)
                .padding(16.dp),
            verticalArrangement = Arrangement.spacedBy(14.dp)
        ) {
            ElevatedCard(
                modifier = Modifier.fillMaxWidth(),
                shape = RoundedCornerShape(20.dp),
                colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
                elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
            ) {
                SettingsItemRow(
                    icon = Icons.Filled.Star,
                    iconBackground = MaterialTheme.colorScheme.primaryContainer,
                    iconTint = MaterialTheme.colorScheme.onPrimaryContainer,
                    title = "社区准则",
                    onClick = { onCommunityGuidelinesClick() }
                )
                Divider(color = MaterialTheme.colorScheme.outlineVariant.copy(alpha = 0.4f))
                SettingsItemRow(
                    icon = Icons.Filled.Info,
                    iconBackground = MaterialTheme.colorScheme.secondaryContainer,
                    iconTint = MaterialTheme.colorScheme.onSecondaryContainer,
                    title = "隐私政策",
                    onClick = { onPrivacyPolicyClick() }
                )
            }
        }
    }
}

/* ---------------- 子页面：编辑资料（保持你现有逻辑） ---------------- */

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun EditProfileScreen(
    currentName: String,
    avatarUrl: String?,
    onBackClick: () -> Unit,
    onSaveClick: (String) -> Unit
) {
    val context = LocalContext.current
    var name by remember { mutableStateOf(currentName) }
    val snackbarHostState = remember { SnackbarHostState() }
    val scope = rememberCoroutineScope()

    var selectedImageUri by remember { mutableStateOf<Uri?>(null) }
    var isSaving by remember { mutableStateOf(false) }

    val imagePickerLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.PickVisualMedia()
    ) { uri ->
        selectedImageUri = uri
    }

    val hasChanges by remember(name, selectedImageUri) {
        mutableStateOf(name.trim() != currentName.trim() || selectedImageUri != null)
    }

    Scaffold(
        topBar = {
            TopAppBar(
                title = {
                    Text(
                        text = "编辑资料",
                        style = MaterialTheme.typography.titleLarge.copy(fontWeight = FontWeight.Bold)
                    )
                },
                navigationIcon = {
                    IconButton(onClick = onBackClick) {
                        Icon(imageVector = Icons.Filled.ArrowBack, contentDescription = "返回")
                    }
                }
            )
        },
        snackbarHost = { SnackbarHost(hostState = snackbarHostState) }
    ) { innerPadding ->
        // ✅ 根布局使用 Box 以支持 Loading 遮罩覆盖
        Box(
            modifier = Modifier
                .padding(innerPadding)
                .fillMaxSize()
        ) {
            // 原有的表单内容
            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .background(MaterialTheme.colorScheme.background)
                    .padding(16.dp),
                verticalArrangement = Arrangement.spacedBy(16.dp),
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                ElevatedCard(
                    modifier = Modifier.fillMaxWidth(),
                    shape = RoundedCornerShape(20.dp),
                    colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
                    elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
                ) {
                    Column(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(vertical = 24.dp, horizontal = 20.dp),
                        verticalArrangement = Arrangement.spacedBy(16.dp),
                        horizontalAlignment = Alignment.CenterHorizontally
                    ) {
                        Box(
                            modifier = Modifier
                                .size(96.dp)
                                .clip(CircleShape)
                                .background(MaterialTheme.colorScheme.secondaryContainer),
                            contentAlignment = Alignment.Center
                        ) {
                            when {
                                selectedImageUri != null -> {
                                    AsyncImage(
                                        model = selectedImageUri,
                                        contentDescription = "新头像预览",
                                        modifier = Modifier.fillMaxSize()
                                    )
                                }
                                !avatarUrl.isNullOrBlank() -> {
                                    AsyncImage(
                                        model = avatarUrl,
                                        contentDescription = "当前头像",
                                        modifier = Modifier.fillMaxSize()
                                    )
                                }
                                else -> {
                                    val initial = name.firstOrNull()?.uppercaseChar()?.toString() ?: "雪"
                                    Text(
                                        text = initial,
                                        style = MaterialTheme.typography.headlineMedium.copy(fontWeight = FontWeight.Bold),
                                        color = MaterialTheme.colorScheme.onSecondaryContainer
                                    )
                                }
                            }
                        }

                        TextButton(
                            onClick = {
                                imagePickerLauncher.launch(
                                    PickVisualMediaRequest(ActivityResultContracts.PickVisualMedia.ImageOnly)
                                )
                            },
                            enabled = !isSaving
                        ) {
                            Text(text = "更换头像")
                        }

                        OutlinedTextField(
                            value = name,
                            onValueChange = { name = it },
                            modifier = Modifier.fillMaxWidth(),
                            label = { Text("昵称") },
                            singleLine = true,
                            enabled = !isSaving
                        )

                        Button(
                            onClick = {
                                val trimmed = name.trim()
                                if (trimmed.isEmpty()) {
                                    scope.launch { snackbarHostState.showSnackbar("昵称不能为空") }
                                    return@Button
                                }

                                scope.launch {
                                    try {
                                        isSaving = true
                                        val avatarBytes = selectedImageUri?.let { uri ->
                                            loadAndCompressImage(context, uri)
                                        }
                                        val newAvatarUrl = ProfileRepository.updateProfile(
                                            nickname = trimmed,
                                            avatarBytes = avatarBytes,
                                            currentAvatarUrl = avatarUrl
                                        )
                                        CurrentUserStore.updateLocalProfile(
                                            newName = trimmed,
                                            newAvatarUrl = newAvatarUrl
                                        )
                                        onSaveClick(trimmed)
                                        snackbarHostState.showSnackbar("已保存")
                                    } catch (e: Exception) {
                                        e.printStackTrace()
                                        snackbarHostState.showSnackbar("保存失败：${e.message ?: "请稍后重试"}")
                                    } finally {
                                        isSaving = false
                                    }
                                }
                            },
                            modifier = Modifier.fillMaxWidth(),
                            shape = RoundedCornerShape(14.dp),
                            enabled = hasChanges && !isSaving
                        ) {
                            Text(text = if (isSaving) "保存中…" else "保存")
                        }
                    }
                }
            }

            // ✅ Loading 遮罩 (这就是之前缺失 CircularProgressIndicator 的地方)
            if (isSaving) {
                Box(
                    modifier = Modifier
                        .fillMaxSize()
                        .background(Color.Black.copy(alpha = 0.3f))
                        .clickable(enabled = false) {}, // 拦截点击
                    contentAlignment = Alignment.Center
                ) {
                    CircularProgressIndicator(color = MaterialTheme.colorScheme.primary)
                }
            }
        }
    }
}

/* ---------------- Preview ---------------- */

@Preview(showBackground = true)
@Composable
private fun SettingsScreenPreview() {
    GosnowTheme {
        SettingsScreen(
            onBackClick = {},
            onEditProfileClick = {},
            onAccountPrivacyClick = {},
            onFeedbackClick = {},
            onAboutClick = {},
            onLogoutClick = {}
        )
    }
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\MainActivity.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle

import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.enableEdgeToEdge
import com.gosnow.app.ui.snowcircle.ui.SnowApp

class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        enableEdgeToEdge()
        setContent {
            SnowApp()
        }
    }
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\data\CommentRepository.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.data

import com.gosnow.app.ui.snowcircle.model.Comment
import com.gosnow.app.ui.snowcircle.model.User

interface CommentRepository {
    suspend fun getCommentsForPost(postId: String): List<Comment>
    suspend fun addComment(postId: String, body: String, parentId: String?, currentUser: User): Comment
    suspend fun deleteComment(commentId: String, currentUserId: String)
    suspend fun toggleCommentLike(commentId: String, currentUserId: String): Comment?
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\data\InMemoryRepositories.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.data

import com.gosnow.app.ui.snowcircle.model.Comment
import com.gosnow.app.ui.snowcircle.model.NotificationItem
import com.gosnow.app.ui.snowcircle.model.NotificationType
import com.gosnow.app.ui.snowcircle.model.Post
import com.gosnow.app.ui.snowcircle.model.User
import kotlinx.coroutines.delay
import kotlinx.coroutines.sync.Mutex
import kotlinx.coroutines.sync.withLock
import kotlin.random.Random

private const val currentUserId = "me"

class InMemoryPostRepository : PostRepository {
    private val mutex = Mutex()
    private val users = listOf(
        User("me", "Me", "https://i.pravatar.cc/150?img=3"),
        User("u1", "Ada", "https://i.pravatar.cc/150?img=1"),
        User("u2", "Ben", "https://i.pravatar.cc/150?img=2"),
        User("u3", "Cindy", "https://i.pravatar.cc/150?img=4")
    )

    private val posts = mutableListOf(
        Post(
            id = "p1",
            author = users[1],
            resortName = "Niseko",
            createdAt = "2h ago",
            content = "Bluebird day in Niseko! Powder is insane.",
            imageUrls = listOf(
                "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee",
                "https://images.unsplash.com/photo-1489515217757-5fd1be406fef",
                "https://images.unsplash.com/photo-1500048993953-d23a436266cf"
            ),
            likeCount = 24,
            commentCount = 6,
            isLikedByMe = false
        ),
        Post(
            id = "p2",
            author = users[0],
            resortName = "Hakuba",
            createdAt = "5h ago",
            content = "Finally landed my first 360 today!",
            imageUrls = listOf("https://images.unsplash.com/photo-1489515217757-5fd1be406fef"),
            likeCount = 12,
            commentCount = 3,
            isLikedByMe = true,
            canDelete = true
        ),
        Post(
            id = "p3",
            author = users[2],
            resortName = "Whistler",
            createdAt = "1d ago",
            content = "Anyone riding tomorrow? Looking for buddies.",
            imageUrls = emptyList(),
            likeCount = 5,
            commentCount = 1,
            isLikedByMe = false
        ),
        Post(
            id = "p4",
            author = users[3],
            resortName = "Zermatt",
            createdAt = "3d ago",
            content = "Sunset laps with the crew ✨",
            imageUrls = listOf(
                "https://images.unsplash.com/photo-1500534314209-a25ddb2bd429",
                "https://images.unsplash.com/photo-1469474968028-56623f02e42e",
                "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee",
                "https://images.unsplash.com/photo-1489515217757-5fd1be406fef"
            ),
            likeCount = 30,
            commentCount = 10,
            isLikedByMe = false
        )
    )

    override suspend fun getFeedPosts(resortFilter: String?): List<Post> {
        delay(300)
        return mutex.withLock {
            val filtered = resortFilter?.let { res ->
                posts.filter { it.resortName?.contains(res, ignoreCase = true) == true }
            } ?: posts.toList()
            filtered
        }
    }

    override suspend fun getMyPosts(currentUserId: String): List<Post> {
        delay(200)
        return mutex.withLock { posts.filter { it.author.id == currentUserId } }
    }

    override suspend fun getPostById(postId: String): Post? {
        delay(150)
        return mutex.withLock { posts.find { it.id == postId } }
    }

    override suspend fun toggleLike(postId: String, currentUserId: String): Post? {
        delay(150)
        return mutex.withLock {
            val idx = posts.indexOfFirst { it.id == postId }
            if (idx == -1) return@withLock null
            val post = posts[idx]
            val liked = !post.isLikedByMe
            val updated = post.copy(
                isLikedByMe = liked,
                likeCount = if (liked) post.likeCount + 1 else post.likeCount - 1
            )
            posts[idx] = updated
            updated
        }
    }

    override suspend fun deletePost(postId: String, currentUserId: String) {
        delay(100)
        mutex.withLock { posts.removeAll { it.id == postId && it.author.id == currentUserId } }
    }

    override suspend fun createPost(content: String, resortName: String?, images: List<String>, currentUser: User): Post {
        delay(200)
        return mutex.withLock {
            val newPost = Post(
                id = "p${Random.nextInt(1000, 9999)}",
                author = currentUser,
                resortName = resortName,
                createdAt = "just now",
                content = content,
                imageUrls = images,
                likeCount = 0,
                commentCount = 0,
                isLikedByMe = false,
                canDelete = true
            )
            posts.add(0, newPost)
            newPost
        }
    }
}

class InMemoryCommentRepository : CommentRepository {
    private val mutex = Mutex()
    private val comments = mutableListOf(
        Comment("c1", "p1", null, User("u2", "Ben", "https://i.pravatar.cc/150?img=2"), "1h ago", "Looks amazing!", 3, false),
        Comment("c2", "p1", "c1", User("u1", "Ada", "https://i.pravatar.cc/150?img=1"), "55m ago", "Come join tomorrow?", 1, false),
        Comment("c3", "p1", null, User("u3", "Cindy", "https://i.pravatar.cc/150?img=4"), "30m ago", "Niseko on my bucket list", 0, false),
        Comment("c4", "p2", null, User("me", "Me", "https://i.pravatar.cc/150?img=3"), "20m ago", "Thanks for the stoke!", 2, true, canDelete = true)
    )

    override suspend fun getCommentsForPost(postId: String): List<Comment> {
        delay(250)
        return mutex.withLock { comments.filter { it.postId == postId } }
    }

    override suspend fun addComment(postId: String, body: String, parentId: String?, currentUser: User): Comment {
        delay(200)
        return mutex.withLock {
            val newComment = Comment(
                id = "c${Random.nextInt(10000, 99999)}",
                postId = postId,
                parentId = parentId,
                author = currentUser,
                createdAt = "just now",
                body = body,
                likeCount = 0,
                isLikedByMe = false,
                canDelete = true
            )
            comments.add(newComment)
            newComment
        }
    }

    override suspend fun deleteComment(commentId: String, currentUserId: String) {
        delay(150)
        mutex.withLock { comments.removeAll { it.id == commentId && it.author.id == currentUserId } }
    }

    override suspend fun toggleCommentLike(commentId: String, currentUserId: String): Comment? {
        delay(120)
        return mutex.withLock {
            val idx = comments.indexOfFirst { it.id == commentId }
            if (idx == -1) return@withLock null
            val comment = comments[idx]
            val liked = !comment.isLikedByMe
            val updated = comment.copy(
                isLikedByMe = liked,
                likeCount = if (liked) comment.likeCount + 1 else comment.likeCount - 1
            )
            comments[idx] = updated
            updated
        }
    }
}

class InMemoryNotificationsRepository : NotificationsRepository {
    private val mutex = Mutex()
    private val users = listOf(
        User("u1", "Ada", "https://i.pravatar.cc/150?img=1"),
        User("u2", "Ben", "https://i.pravatar.cc/150?img=2"),
        User("u3", "Cindy", "https://i.pravatar.cc/150?img=4")
    )
    private val notifications = mutableListOf(
        NotificationItem(1, NotificationType.LIKE_POST, "2h ago", "p2", null, users[0], false),
        NotificationItem(2, NotificationType.COMMENT_POST, "5h ago", "p1", "c1", users[1], true),
        NotificationItem(3, NotificationType.REPLY_COMMENT, "1d ago", "p1", "c2", users[2], false)
    )

    override suspend fun getNotifications(currentUserId: String): List<NotificationItem> {
        delay(200)
        return mutex.withLock { notifications.toList() }
    }

    override suspend fun markAllRead(currentUserId: String) {
        delay(100)
        mutex.withLock {
            repeat(notifications.size) { index ->
                notifications[index] = notifications[index].copy(isRead = true)
            }
        }
    }

    override suspend fun markRead(notificationId: Long) {
        delay(80)
        mutex.withLock {
            val idx = notifications.indexOfFirst { it.id == notificationId }
            if (idx != -1) notifications[idx] = notifications[idx].copy(isRead = true)
        }
    }
}

fun currentUser(): User = User(currentUserId, "Me", "https://i.pravatar.cc/150?img=3")


==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\data\NotificationsRepository.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.data

import com.gosnow.app.ui.snowcircle.model.NotificationItem

interface NotificationsRepository {
    suspend fun getNotifications(currentUserId: String): List<NotificationItem>
    suspend fun markAllRead(currentUserId: String)
    suspend fun markRead(notificationId: Long)
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\data\PostRepository.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.data

import com.gosnow.app.ui.snowcircle.model.Post
import com.gosnow.app.ui.snowcircle.model.User

interface PostRepository {
    suspend fun getFeedPosts(resortFilter: String? = null): List<Post>
    suspend fun getMyPosts(currentUserId: String): List<Post>
    suspend fun getPostById(postId: String): Post?
    suspend fun toggleLike(postId: String, currentUserId: String): Post?
    suspend fun deletePost(postId: String, currentUserId: String)
    suspend fun createPost(content: String, resortName: String?, images: List<String>, currentUser: User): Post
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\data\supabase\SupabasePartyDtos.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.data.supabase

import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable

/**
 * 对应数据库表 public.party
 * 假设表结构为: id(uuid), code(text), host_id(uuid)
 */
@Serializable
data class PartyRow(
    val id: String,

    @SerialName("join_code") val code: String,
    @SerialName("host_id") val hostId: String
)

/**
 * 用于向 public.party 插入数据
 */
@Serializable
data class PartyInsert(

    @SerialName("join_code") val code: String,
    @SerialName("host_id") val hostId: String
)

/**
 * 对应数据库表 public.party_member (根据你的截图定义)
 * 字段: party_id, user_id, role
 */
@Serializable
data class PartyMemberInsert(
    @SerialName("party_id") val partyId: String,
    @SerialName("user_id") val userId: String,
    val role: String = "member"
)

==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\data\supabase\SupabaseResortsCommentRepository.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.data.supabase

import com.gosnow.app.ui.snowcircle.data.CommentRepository
import com.gosnow.app.ui.snowcircle.model.Comment
import com.gosnow.app.ui.snowcircle.model.User
import io.github.jan.supabase.SupabaseClient
import io.github.jan.supabase.gotrue.auth
import io.github.jan.supabase.postgrest.from
import io.github.jan.supabase.postgrest.query.Columns
import io.github.jan.supabase.postgrest.query.Order

class SupabaseResortsCommentRepository(
    private val supabase: SupabaseClient
) : CommentRepository {

    override suspend fun getCommentsForPost(postId: String): List<Comment> {
        val myId = supabase.auth.currentUserOrNull()?.id

        val rows = supabase.from("resorts_post_comments")
            .select(Columns.Companion.raw("id, post_id, user_id, parent_comment_id, body, created_at")) {
                filter { eq("post_id", postId) }
                order("created_at", Order.DESCENDING)
                limit(200)
            }.decodeList<PostCommentRow>()

        if (rows.isEmpty()) return emptyList()

        val userIds = rows.map { it.user_id }.distinct()
        val users = supabase.from("Users")
            .select(Columns.Companion.raw("id, user_name, avatar_url")) {
                filter { isIn("id", userIds) }
            }.decodeList<UserRow>()
            .associateBy { it.id }

        val commentIds = rows.map { it.id }
        val likes = supabase.from("resorts_comment_likes")
            .select(Columns.Companion.raw("comment_id, user_id")) {
                filter { isIn("comment_id", commentIds) }
            }.decodeList<CommentLikeRow>()

        val likeCountMap = likes.groupingBy { it.comment_id }.eachCount()
        val likedByMeSet = myId?.let { me ->
            likes.filter { it.user_id == me }.map { it.comment_id }.toSet()
        } ?: emptySet()

        return rows.map { r ->
            val u = users[r.user_id]
            val author = User(
                id = r.user_id,
                displayName = u?.user_name ?: "Unknown",
                avatarUrl = u?.avatar_url
            )
            Comment(
                id = r.id,
                postId = r.post_id,
                parentId = r.parent_comment_id,
                author = author,
                createdAt = timeAgo(r.created_at),
                body = r.body,
                likeCount = likeCountMap[r.id] ?: 0,
                isLikedByMe = likedByMeSet.contains(r.id),
                canDelete = (myId != null && r.user_id == myId)
            )
        }
    }

    override suspend fun addComment(
        postId: String,
        body: String,
        parentId: String?,
        currentUser: User
    ): Comment {
        val trimmed = body.trim()
        if (trimmed.isBlank()) error("评论不能为空")

        val inserted = supabase.from("resorts_post_comments")
            .insert(
                PostCommentInsert(
                    post_id = postId,
                    user_id = currentUser.id,
                    parent_comment_id = parentId,
                    body = trimmed
                )
            ) { select() }
            .decodeSingle<PostCommentRow>()

        return Comment(
            id = inserted.id,
            postId = inserted.post_id,
            parentId = inserted.parent_comment_id,
            author = currentUser,
            createdAt = timeAgo(inserted.created_at),
            body = inserted.body,
            likeCount = 0,
            isLikedByMe = false,
            canDelete = true
        )
    }

    override suspend fun deleteComment(commentId: String, currentUserId: String) {
        supabase.from("resorts_post_comments").delete {
            filter {
                eq("id", commentId)
                eq("user_id", currentUserId)
            }
        }
    }

    override suspend fun toggleCommentLike(commentId: String, currentUserId: String): Comment? {
        val exists = supabase.from("resorts_comment_likes")
            .select(Columns.Companion.raw("comment_id, user_id")) {
                filter {
                    eq("comment_id", commentId)
                    eq("user_id", currentUserId)
                }
                limit(1)
            }.decodeList<CommentLikeRow>()
            .isNotEmpty()

        if (!exists) {
            supabase.from("resorts_comment_likes")
                .insert(mapOf("comment_id" to commentId, "user_id" to currentUserId))
        } else {
            supabase.from("resorts_comment_likes")
                .delete {
                    filter {
                        eq("comment_id", commentId)
                        eq("user_id", currentUserId)
                    }
                }
        }

        // 返回 updated comment：简单粗暴再拉一次该帖评论（你也可以写一个 getCommentById 精简）
        val commentRow = supabase.from("resorts_post_comments")
            .select(Columns.Companion.raw("id, post_id, user_id, parent_comment_id, body, created_at")) {
                filter { eq("id", commentId) }
                limit(1)
            }.decodeList<PostCommentRow>()
            .firstOrNull() ?: return null

        val list = getCommentsForPost(commentRow.post_id)
        return list.firstOrNull { it.id == commentId }
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\data\supabase\SupabaseResortsDtos.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.data.supabase

import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable

@Serializable
data class ResortPostRow(
    val id: String,                 // uuid
    val created_at: String,         // timestamptz -> string
    val author_id: String? = null,
    val resort_id: Long? = null,
    val title: String? = null,
    val body: String? = null,
    val rating: Int? = null,
)

@Serializable
data class UserRow(
    val id: String,
    val user_name: String,
    val avatar_url: String? = null
)

@Serializable
data class ResortRow(
    val id: Long,
    @SerialName("name_resort")
    val name: String
)

@Serializable
data class PostImageRow(
    val id: Long,
    val post_id: String,
    val user_id: String? = null,
    val url: String? = null
)

@Serializable
data class PostLikeRow(
    val post_id: String,
    val author_id: String,
)

@Serializable
data class PostCommentRow(
    val id: String,
    val post_id: String,
    val user_id: String,
    val parent_comment_id: String? = null,
    val body: String,
    val created_at: String? = null,
)

@Serializable
data class CommentLikeRow(
    val comment_id: String,
    val user_id: String
)

@Serializable
data class ResortNotificationRow(
    val id: Long,
    val recipient_user_id: String,
    val actor_user_id: String,
    val type: String,          // notification_type enum 的文本值：like_post / like_comment / comment_post / reply_comment
    val post_id: String? = null,
    val comment_id: String? = null,
    val created_at: String? = null,
    val read_at: String? = null
)

// insert payloads
@Serializable
data class ResortPostInsert(
    val resort_id: Long,
    val body: String,
    val title: String? = null,
    val rating: Int = 0
)

@Serializable
data class PostImageInsert(
    val post_id: String,
    val user_id: String,
    val url: String
)

@Serializable
data class PostCommentInsert(
    val post_id: String,
    val user_id: String,
    val parent_comment_id: String? = null,
    val body: String
)

@Serializable
data class MarkReadPatch(
    val read_at: String
)



==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\data\supabase\SupabaseResortsNotificationsRepository.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.data.supabase

import com.gosnow.app.ui.snowcircle.data.NotificationsRepository
import com.gosnow.app.ui.snowcircle.model.NotificationItem
import com.gosnow.app.ui.snowcircle.model.NotificationType
import com.gosnow.app.ui.snowcircle.model.User
import io.github.jan.supabase.SupabaseClient
import io.github.jan.supabase.postgrest.from
import io.github.jan.supabase.postgrest.query.Columns
import io.github.jan.supabase.postgrest.query.Order
import java.time.Instant
import java.util.Objects.isNull

class SupabaseResortsNotificationsRepository(
    private val supabase: SupabaseClient
) : NotificationsRepository {

    override suspend fun getNotifications(currentUserId: String): List<NotificationItem> {
        val rows = supabase.from("resorts_notifications")
            .select(Columns.raw("id, recipient_user_id, actor_user_id, type, post_id, comment_id, created_at, read_at")) {
                filter { eq("recipient_user_id", currentUserId) }
                order("created_at", Order.DESCENDING)
                limit(100)
            }.decodeList<ResortNotificationRow>()

        if (rows.isEmpty()) return emptyList()

        val actorIds = rows.map { it.actor_user_id }.distinct()
        val users = supabase.from("Users")
            .select(Columns.raw("id, user_name, avatar_url")) {
                filter { isIn("id", actorIds) }
            }.decodeList<UserRow>()
            .associateBy { it.id }

        return rows.map { r ->
            val u = users[r.actor_user_id]
            val actor = User(
                id = r.actor_user_id,
                displayName = u?.user_name ?: "Unknown",
                avatarUrl = u?.avatar_url
            )
            NotificationItem(
                id = r.id,
                type = mapType(r.type),
                createdAt = timeAgo(r.created_at),
                postId = r.post_id,
                commentId = r.comment_id,
                actor = actor,
                isRead = (r.read_at != null)
            )
        }
    }

    override suspend fun markAllRead(currentUserId: String) {
        val now = Instant.now().toString()
        supabase.from("resorts_notifications")
            .update(MarkReadPatch(read_at = now)) {
                filter {
                    eq("recipient_user_id", currentUserId)
                    isNull("read_at")
                }
            }
    }

    override suspend fun markRead(notificationId: Long) {
        val now = Instant.now().toString()
        supabase.from("resorts_notifications")
            .update(MarkReadPatch(read_at = now)) {
                filter { eq("id", notificationId) }
            }
    }

    private fun mapType(db: String): NotificationType = when (db) {
        "like_post" -> NotificationType.LIKE_POST
        "like_comment" -> NotificationType.LIKE_COMMENT
        "comment_post" -> NotificationType.COMMENT_POST
        "reply_comment" -> NotificationType.REPLY_COMMENT
        else -> NotificationType.COMMENT_POST
    }
}




==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\data\supabase\SupabaseResortsPostRepository.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.data.supabase

import android.content.Context
import android.net.Uri
import android.webkit.MimeTypeMap
import com.gosnow.app.ui.snowcircle.data.PostRepository
import com.gosnow.app.ui.snowcircle.model.Post
import com.gosnow.app.ui.snowcircle.model.User
import io.github.jan.supabase.SupabaseClient
import io.github.jan.supabase.gotrue.auth
import io.github.jan.supabase.postgrest.from
import io.github.jan.supabase.postgrest.query.Columns
import io.github.jan.supabase.postgrest.query.Order
import io.github.jan.supabase.storage.storage
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
import com.gosnow.app.util.loadAndCompressImage



class SupabaseResortsPostRepository(
    private val context: Context,
    private val supabase: SupabaseClient,
    private val postMediaBucket: String = "post-media",
    // 如果你的 bucket 是 public：用这个拼 public url（最省事）
    private val publicStorageBaseUrl: String = "" // 例如：https://xxxx.baseapi.memfiredb.com/storage/v1/object/public
) : PostRepository {

    override suspend fun getFeedPosts(resortFilter: String?): List<Post> {
        val myId = supabase.auth.currentUserOrNull()?.id
        val resortIds: List<Long>? = resortFilter?.takeIf { it.isNotBlank() }?.let { query ->
            val matched = supabase.from("Resorts_data")
                .select(Columns.Companion.raw("id, name_resort")) {
                    // 模糊搜索：name ilike %query%
                    // supabase-kt 用 ilike("name", "%xxx%")，这里为了稳就用 eq/like 你也可以换成 ilike
                    // 如果你已经在项目里用过 ilike，就把下面一行替换成 ilike("name", "%$query%")
                    filter { ilike("name_resort", "%$query%") }
                    limit(30)
                }.decodeList<ResortRow>()
            matched.map { it.id }
        }

        if (resortFilter != null && resortFilter.isNotBlank() && resortIds != null && resortIds.isEmpty()) {
            return emptyList()
        }

        val posts = supabase.from("resorts_post")
            .select(Columns.Companion.raw("id, created_at, author_id, resort_id, title, body, rating")) {
                if (resortIds != null) {
                    filter { isIn("resort_id", resortIds) }
                }
                order("created_at", Order.DESCENDING)
                limit(50)
            }.decodeList<ResortPostRow>()

        return enrichPosts(posts, myId)
    }

    override suspend fun getMyPosts(currentUserId: String): List<Post> {
        val posts = supabase.from("resorts_post")
            .select(Columns.Companion.raw("id, created_at, author_id, resort_id, title, body, rating")) {
                filter { eq("author_id", currentUserId) }
                order("created_at", Order.DESCENDING)
                limit(50)
            }.decodeList<ResortPostRow>()

        return enrichPosts(posts, currentUserId)
    }

    override suspend fun getPostById(postId: String): Post? {
        val myId = supabase.auth.currentUserOrNull()?.id
        val row = supabase.from("resorts_post")
            .select(Columns.Companion.raw("id, created_at, author_id, resort_id, title, body, rating")) {
                filter { eq("id", postId) }
                limit(1)
            }.decodeList<ResortPostRow>()
            .firstOrNull() ?: return null

        return enrichPosts(listOf(row), myId).firstOrNull()
    }

    override suspend fun toggleLike(postId: String, currentUserId: String): Post? {
        val existing = supabase.from("resorts_post_likes")
            .select(Columns.Companion.raw("post_id, author_id")) {
                filter {
                    eq("post_id", postId)
                    eq("author_id", currentUserId)
                }
                limit(1)
            }.decodeList<PostLikeRow>()

        if (existing.isEmpty()) {
            // like
            supabase.from("resorts_post_likes")
                .insert(mapOf("post_id" to postId, "author_id" to currentUserId))
        } else {
            // unlike
            supabase.from("resorts_post_likes")
                .delete {
                    filter {
                        eq("post_id", postId)
                        eq("author_id", currentUserId)
                    }
                }
        }
        return getPostById(postId)
    }

    override suspend fun deletePost(postId: String, currentUserId: String) {
        // 依赖 RLS + 这里再加一层 author_id 限制
        supabase.from("resorts_post").delete {
            filter {
                eq("id", postId)
                eq("author_id", currentUserId)
            }
        }
        // images / likes / comments 都是 cascade 或外键删除，不用你手动删
    }

    override suspend fun createPost(
        content: String,
        resortName: String?,
        images: List<String>,
        currentUser: User
    ): Post {
        val name = resortName?.trim().orEmpty()
        if (name.isBlank()) error("必须选择雪场")
        if (content.isBlank()) error("正文不能为空")

        // 1) resortName -> resort_id
        val resort = supabase.from("Resorts_data")
            .select(Columns.Companion.raw("id, name_resort")) {
                filter { ilike("name_resort", "%$name%") }
                limit(1)
            }.decodeList<ResortRow>()
            .firstOrNull() ?: error("没找到该雪场：$name")

        // 2) insert post
        val inserted = supabase.from("resorts_post")
            .insert(
                ResortPostInsert(
                    resort_id = resort.id,
                    body = content
                )
            ) { select() }
            .decodeSingle<ResortPostRow>()

        // 3) upload images + insert resorts_post_images
        val uris = images.mapNotNull { runCatching { Uri.parse(it) }.getOrNull() }.take(4)
        if (uris.isNotEmpty()) {
            val rows = mutableListOf<PostImageInsert>()
            uris.forEachIndexed { index, uri ->
                val ext = "jpg" // 压缩后统一变成 jpg
                val path = "${currentUser.id}/${inserted.id}/${System.currentTimeMillis()}_${index}.${ext}"
                val bytes = loadAndCompressImage(context, uri, maxSize = 1080)
                // upload
                supabase.storage.from(postMediaBucket).upload(path, bytes, upsert = true)
                val url = buildPublicUrl(path)
                rows += PostImageInsert(
                    post_id = inserted.id,
                    user_id = currentUser.id,
                    url = url
                )
            }
            supabase.from("resorts_post_images").insert(rows)
        }

        return getPostById(inserted.id) ?: error("发布成功但读取失败")
    }

    // ---------------- helpers ----------------

    private suspend fun enrichPosts(rows: List<ResortPostRow>, myId: String?): List<Post> {
        if (rows.isEmpty()) return emptyList()

        val postIds = rows.map { it.id }
        val authorIds = rows.mapNotNull { it.author_id }.distinct()
        val resortIds = rows.mapNotNull { it.resort_id }.distinct()

        val usersMap = if (authorIds.isEmpty()) emptyMap() else {
            supabase.from("Users")
                .select(Columns.Companion.raw("id, user_name, avatar_url")) {
                    filter { isIn("id", authorIds) }
                }.decodeList<UserRow>()
                .associateBy { it.id }
        }

        val resortsMap = if (resortIds.isEmpty()) emptyMap() else {
            supabase.from("Resorts_data")
                .select(Columns.Companion.raw("id, name_resort")) {
                    filter { isIn("id", resortIds) }
                }.decodeList<ResortRow>()
                .associateBy { it.id }
        }

        val imagesMap = supabase.from("resorts_post_images")
            .select(Columns.Companion.raw("id, post_id, url")) {
                filter { isIn("post_id", postIds) }   // 批量 in 查询 :contentReference[oaicite:1]{index=1}
            }.decodeList<PostImageRow>()
            .groupBy { it.post_id }

        val likes = supabase.from("resorts_post_likes")
            .select(Columns.Companion.raw("post_id, author_id")) {
                filter { isIn("post_id", postIds) }
            }.decodeList<PostLikeRow>()

        val likeCountMap = likes.groupingBy { it.post_id }.eachCount()
        val likedByMeSet = myId?.let { me ->
            likes.filter { it.author_id == me }.map { it.post_id }.toSet()
        } ?: emptySet()

        val comments = supabase.from("resorts_post_comments")
            .select(Columns.Companion.raw("id, post_id")) {
                filter { isIn("post_id", postIds) }
            }.decodeList<Map<String, String>>() // 只要 post_id 就行，简单点
        val commentCountMap = comments.groupingBy { it["post_id"].orEmpty() }.eachCount()

        return rows.map { r ->
            val authorRow = r.author_id?.let { usersMap[it] }
            val author = User(
                id = r.author_id ?: "",
                displayName = authorRow?.user_name ?: "Unknown",
                avatarUrl = authorRow?.avatar_url
            )
            val resortName = r.resort_id?.let { resortsMap[it]?.name }
            val imageUrls = imagesMap[r.id].orEmpty().mapNotNull { it.url }

            Post(
                id = r.id,
                author = author,
                resortName = resortName,
                createdAt = timeAgo(r.created_at),
                content = r.body ?: "",
                imageUrls = imageUrls,
                likeCount = likeCountMap[r.id] ?: 0,
                commentCount = commentCountMap[r.id] ?: 0,
                isLikedByMe = likedByMeSet.contains(r.id),
                canDelete = (myId != null && r.author_id == myId)
            )
        }
    }

    private fun buildPublicUrl(path: String): String {
        // 你如果 bucket 是 public：publicStorageBaseUrl = "${SUPABASE_URL}/storage/v1/object/public"
        // 返回：{publicStorageBaseUrl}/{bucket}/{path}
        return if (publicStorageBaseUrl.isNotBlank()) {
            "${publicStorageBaseUrl.trimEnd('/')}/${postMediaBucket}/${path}"
        } else {
            // 兜底：只存 path（不推荐）。你也可以这里 error 强制传 baseUrl
            path
        }
    }

    private suspend fun readBytes(uri: Uri): ByteArray = withContext(Dispatchers.IO) {
        val resolver = context.contentResolver
        resolver.openInputStream(uri)?.use { it.readBytes() } ?: error("读取图片失败")
    }

    private fun guessExt(uri: Uri): String {
        val resolver = context.contentResolver
        val type = resolver.getType(uri) ?: return "jpg"
        return MimeTypeMap.getSingleton().getExtensionFromMimeType(type) ?: "jpg"
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\data\supabase\TimeAgo.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.data.supabase

import java.time.Duration
import java.time.Instant
import java.time.OffsetDateTime

fun timeAgo(iso: String?): String {
    if (iso.isNullOrBlank()) return ""
    val instant = runCatching { OffsetDateTime.parse(iso).toInstant() }.getOrNull() ?: return ""
    val now = Instant.now()
    val d = Duration.between(instant, now)
    val minutes = d.toMinutes()
    val hours = d.toHours()
    val days = d.toDays()
    return when {
        minutes < 1 -> "刚刚"
        minutes < 60 -> "${minutes}m ago"
        hours < 24 -> "${hours}h ago"
        days < 7 -> "${days}d ago"
        else -> iso.take(10)
    }
}




==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\model\Models.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.model

data class User(
    val id: String,
    val displayName: String,
    val avatarUrl: String?
)

data class Post(
    val id: String,
    val author: User,
    val resortName: String?,
    val createdAt: String,
    val content: String,
    val imageUrls: List<String>,
    val likeCount: Int,
    val commentCount: Int,
    val isLikedByMe: Boolean,
    val canDelete: Boolean = false
)

data class Comment(
    val id: String,
    val postId: String,
    val parentId: String?,
    val author: User,
    val createdAt: String,
    val body: String,
    val likeCount: Int,
    val isLikedByMe: Boolean,
    val canDelete: Boolean = false
)

data class NotificationItem(
    val id: Long,
    val type: NotificationType,
    val createdAt: String,
    val postId: String?,
    val commentId: String?,
    val actor: User,
    val isRead: Boolean
)

enum class NotificationType {
    LIKE_POST, LIKE_COMMENT, COMMENT_POST, REPLY_COMMENT
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\ui\SnowApp.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.ui

import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Surface
import androidx.compose.runtime.Composable
import androidx.compose.runtime.remember
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewmodel.compose.viewModel
import androidx.navigation.compose.NavHost
import androidx.navigation.compose.composable
import androidx.navigation.compose.rememberNavController
import com.gosnow.app.ui.snowcircle.data.CommentRepository
import com.gosnow.app.ui.snowcircle.data.InMemoryCommentRepository
import com.gosnow.app.ui.snowcircle.data.InMemoryNotificationsRepository
import com.gosnow.app.ui.snowcircle.data.InMemoryPostRepository
import com.gosnow.app.ui.snowcircle.data.NotificationsRepository
import com.gosnow.app.ui.snowcircle.data.PostRepository
import com.gosnow.app.ui.snowcircle.data.currentUser
import com.gosnow.app.ui.snowcircle.ui.compose.ComposePostScreen
import com.gosnow.app.ui.snowcircle.ui.compose.ComposePostViewModel
import com.gosnow.app.ui.snowcircle.ui.detail.PostDetailScreen
import com.gosnow.app.ui.snowcircle.ui.detail.PostDetailViewModel
import com.gosnow.app.ui.snowcircle.ui.feed.FeedScreen
import com.gosnow.app.ui.snowcircle.ui.feed.FeedViewModel
import androidx.compose.runtime.collectAsState
import com.gosnow.app.ui.snowcircle.ui.myposts.MyPostsScreen
import com.gosnow.app.ui.snowcircle.ui.myposts.MyPostsViewModel
import com.gosnow.app.ui.snowcircle.ui.notifications.NotificationsScreen
import com.gosnow.app.ui.snowcircle.ui.notifications.NotificationsViewModel
import com.gosnow.app.ui.snowcircle.ui.theme.SnowTheme
import com.gosnow.app.ui.snowcircle.ui.viewer.ImageViewerScreen
import androidx.compose.ui.platform.LocalContext
import com.gosnow.app.datasupabase.SupabaseClientProvider
import android.content.Context

import com.gosnow.app.BuildConfig


import com.gosnow.app.ui.snowcircle.data.supabase.SupabaseResortsCommentRepository
import com.gosnow.app.ui.snowcircle.data.supabase.SupabaseResortsNotificationsRepository
import com.gosnow.app.ui.snowcircle.data.supabase.SupabaseResortsPostRepository
import com.gosnow.app.ui.snowcircle.model.User
import io.github.jan.supabase.SupabaseClient
import io.github.jan.supabase.gotrue.auth

// ... imports 保持不变

@Composable
fun SnowApp() {
    SnowTheme {
        Surface(color = MaterialTheme.colorScheme.background) {
            val navController = rememberNavController()
            val appContext = LocalContext.current.applicationContext
            val container = remember { SnowContainer(context = appContext, useMock = false) }

            NavHost(navController = navController, startDestination = "feed") {
                composable("feed") {
                    val vm: FeedViewModel = viewModel(factory = container.factory { FeedViewModel(container.postRepository, container.notificationsRepository, container.currentUser.id) })
                    FeedScreen(viewModel = vm, navController = navController)
                }

                // ... my_posts, notifications 路由保持不变 ...
                composable("my_posts") {
                    val vm: MyPostsViewModel = viewModel(factory = container.factory { MyPostsViewModel(container.postRepository, container.currentUser.id) })
                    MyPostsScreen(viewModel = vm, navController = navController)
                }
                composable("notifications") {
                    val vm: NotificationsViewModel = viewModel(factory = container.factory { NotificationsViewModel(container.notificationsRepository, container.currentUser.id) })
                    NotificationsScreen(viewModel = vm, navController = navController)
                }

                // ✅ 修改：传入 onPublished 回调，设置刷新标志
                composable("compose_post") {
                    val vm: ComposePostViewModel = viewModel(factory = container.factory { ComposePostViewModel(container.postRepository, container.currentUser) })
                    ComposePostScreen(
                        navController = navController,
                        viewModel = vm,
                        onPublished = {
                            // 设置 flag，让上一个页面（feed）知道需要刷新
                            navController.previousBackStackEntry
                                ?.savedStateHandle
                                ?.set("refresh_feed", true)

                            navController.popBackStack()
                        }
                    )
                }

                // ... post_detail, image_viewer 路由保持不变 ...
                composable("post_detail/{postId}") { backStackEntry ->
                    val postId = backStackEntry.arguments?.getString("postId") ?: return@composable
                    val vm: PostDetailViewModel = viewModel(factory = container.factory { PostDetailViewModel(postId, container.postRepository, container.commentRepository, container.currentUser.id) })
                    PostDetailScreen(viewModel = vm, navController = navController)
                }
                composable("image_viewer/{postId}/{startIndex}") { backStackEntry ->
                    val postId = backStackEntry.arguments?.getString("postId") ?: return@composable
                    val startIndex = backStackEntry.arguments?.getString("startIndex")?.toIntOrNull() ?: 0
                    val vm: PostDetailViewModel = viewModel(factory = container.factory { PostDetailViewModel(postId, container.postRepository, container.commentRepository, container.currentUser.id) })
                    val post = vm.uiState.collectAsState().value.post
                    val urls = post?.imageUrls ?: emptyList()
                    if (urls.isNotEmpty()) {
                        ImageViewerScreen(urls = urls, startIndex = startIndex, onBack = { navController.popBackStack() })
                    }
                }
            }
        }
    }
}

// ... SnowContainer 类保持不变




class SnowContainer(
    context: Context,
    private val useMock: Boolean = false
) {
    private val appContext = context.applicationContext
    private val supabase: SupabaseClient = SupabaseClientProvider.supabaseClient

    private val authedUserId: String? = supabase.auth.currentUserOrNull()?.id

    // 1) 当前用户：真实环境用 auth 的 uuid；mock 继续用你原来的 currentUser()
    val currentUser: User =
        if (useMock) currentUser()
        else User(
            id = authedUserId ?: error("未登录：supabase.auth.currentUserOrNull() == null"),
            displayName = "我",
            avatarUrl = null
        )

    // 2) Repository：mock / supabase 切换
    val postRepository: PostRepository =
        if (useMock) InMemoryPostRepository()
        else SupabaseResortsPostRepository(
            context = appContext,
            supabase = supabase,
            postMediaBucket = "post-media",
            publicStorageBaseUrl = "${BuildConfig.SUPABASE_URL.trimEnd('/')}/storage/v1/object/public"
        )

    val commentRepository: CommentRepository =
        if (useMock) InMemoryCommentRepository()
        else SupabaseResortsCommentRepository(supabase)

    val notificationsRepository: NotificationsRepository =
        if (useMock) InMemoryNotificationsRepository()
        else SupabaseResortsNotificationsRepository(supabase)

    fun <T : ViewModel> factory(create: () -> T): androidx.lifecycle.ViewModelProvider.Factory =
        object : androidx.lifecycle.ViewModelProvider.Factory {
            override fun <T : ViewModel> create(modelClass: Class<T>): T = create() as T
        }
}





==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\ui\components\CommentRow.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.ui.components

import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.MoreVert
import androidx.compose.material.icons.filled.ThumbUp
import androidx.compose.material.icons.outlined.ThumbUp
import androidx.compose.material3.DropdownMenu
import androidx.compose.material3.DropdownMenuItem
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.unit.dp
import coil.compose.AsyncImage
import coil.request.ImageRequest
import com.gosnow.app.ui.snowcircle.model.Comment
import com.gosnow.app.util.getResizedImageUrl

@Composable
fun CommentRow(
    comment: Comment,
    onReply: (Comment) -> Unit,
    onLike: (Comment) -> Unit,
    onDelete: (Comment) -> Unit,
    onReport: (Comment) -> Unit,
    modifier: Modifier = Modifier
) {
    // ✅ 修改：为了避免命名冲突，直接在这里获取 LocalContext.current
    // 或者将变量名改为 ctx/localContext，这里直接使用 LocalContext.current 传给 Coil
    val localContext = LocalContext.current

    Row(
        modifier = modifier
            .fillMaxWidth()
            .clickable { onReply(comment) }
            .padding(vertical = 8.dp),
        verticalAlignment = Alignment.Top
    ) {
        // 头像
        AsyncImage(
            // ✅ 修复：这里使用 localContext，避免编译器混淆
            model = ImageRequest.Builder(localContext)
                .data(getResizedImageUrl(comment.author.avatarUrl, width = 80) ?: comment.author.avatarUrl)
                .crossfade(true)
                .placeholder(android.R.color.darker_gray)
                .build(),
            contentDescription = null,
            modifier = Modifier
                .size(36.dp)
                .clip(CircleShape),
            contentScale = ContentScale.Crop
        )

        Spacer(modifier = Modifier.width(8.dp))

        Column(modifier = Modifier.weight(1f)) {
            Row(verticalAlignment = Alignment.CenterVertically) {
                Text(
                    text = comment.author.displayName,
                    style = MaterialTheme.typography.titleMedium
                )
                Spacer(modifier = Modifier.weight(1f))

                val expanded = remember { mutableStateOf(false) }
                Box {
                    IconButton(onClick = { expanded.value = true }) {
                        Icon(Icons.Filled.MoreVert, contentDescription = null)
                    }
                    DropdownMenu(
                        expanded = expanded.value,
                        onDismissRequest = { expanded.value = false }
                    ) {
                        DropdownMenuItem(
                            text = { Text("举报") },
                            onClick = {
                                expanded.value = false
                                onReport(comment)
                            }
                        )
                        if (comment.canDelete) {
                            DropdownMenuItem(
                                text = { Text("删除") },
                                onClick = {
                                    expanded.value = false
                                    onDelete(comment)
                                }
                            )
                        }
                    }
                }
            }

            Text(
                text = comment.body,
                style = MaterialTheme.typography.bodyMedium
            )

            Row(
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                Text(
                    text = comment.createdAt,
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )

                Text(
                    text = "回复",
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant,
                    modifier = Modifier.clickable { onReply(comment) }
                )

                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    modifier = Modifier.clickable { onLike(comment) }
                ) {
                    Icon(
                        imageVector = if (comment.isLikedByMe) Icons.Filled.ThumbUp else Icons.Outlined.ThumbUp,
                        contentDescription = null,
                        tint = if (comment.isLikedByMe)
                            MaterialTheme.colorScheme.primary
                        else
                            MaterialTheme.colorScheme.onSurfaceVariant,
                        modifier = Modifier.size(18.dp)
                    )
                    Spacer(modifier = Modifier.width(4.dp))
                    Text(
                        text = "${comment.likeCount}",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }
        }
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\ui\components\PostCard.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.ui.components

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.aspectRatio
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.MoreVert
import androidx.compose.material.icons.filled.ThumbUp
import androidx.compose.material.icons.outlined.Comment
import androidx.compose.material.icons.outlined.ThumbUp
import androidx.compose.material3.DropdownMenu
import androidx.compose.material3.DropdownMenuItem
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import coil.compose.AsyncImage
import coil.request.ImageRequest
import androidx.compose.ui.platform.LocalContext
import com.gosnow.app.ui.snowcircle.model.Post
import com.gosnow.app.util.getResizedImageUrl

@Composable
fun PostCard(
    post: Post,
    onClick: () -> Unit,
    onLikeClick: () -> Unit,
    onCommentClick: () -> Unit,
    onImageClick: (index: Int) -> Unit,
    // ✅ 新增回调参数
    onDeleteClick: () -> Unit,
    onReportClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    Column(
        modifier = modifier
            .fillMaxWidth()
            .clickable(onClick = onClick)
            .padding(horizontal = 16.dp, vertical = 12.dp)
    ) {
        // 将回调传给 Header
        PostHeader(
            post = post,
            onDeleteClick = onDeleteClick,
            onReportClick = onReportClick
        )
        Spacer(modifier = Modifier.height(8.dp))
        Text(
            text = post.content,
            style = MaterialTheme.typography.bodyLarge.copy(lineHeight = 22.sp),
            maxLines = 6,
            overflow = TextOverflow.Ellipsis
        )

        if (post.imageUrls.isNotEmpty()) {
            Spacer(modifier = Modifier.height(8.dp))
            ImageGrid(urls = post.imageUrls, onImageClick = onImageClick)
        }
        Spacer(modifier = Modifier.height(12.dp))
        Row(verticalAlignment = Alignment.CenterVertically) {
            post.resortName?.let { ResortTag(name = it) }
            Spacer(modifier = Modifier.weight(1f))

            ActionPill(
                icon = if (post.isLikedByMe) Icons.Filled.ThumbUp else Icons.Outlined.ThumbUp,
                count = post.likeCount,
                selected = post.isLikedByMe,
                onClick = onLikeClick
            )
            Spacer(modifier = Modifier.width(8.dp))
            ActionPill(
                icon = Icons.Outlined.Comment,
                count = post.commentCount,
                onClick = onCommentClick
            )
        }
        // 分割线移到外部 List 处理，这里不加
    }
}

@Composable
private fun PostHeader(
    post: Post,
    onDeleteClick: () -> Unit,
    onReportClick: () -> Unit
) {
    val context = LocalContext.current
    Row(verticalAlignment = Alignment.CenterVertically) {
        AsyncImage(
            model = ImageRequest.Builder(context)
                .data(getResizedImageUrl(post.author.avatarUrl, width = 100) ?: post.author.avatarUrl)
                .crossfade(true) // 优化 2: 开启淡入动画，消除闪烁感
                .placeholder(android.R.color.darker_gray) // 优化 3: 加载占位色
                .error(android.R.color.darker_gray)       // 错误占位
                .build(),
            contentDescription = null,
            modifier = Modifier
                .size(40.dp)
                .clip(CircleShape),
            contentScale = ContentScale.Crop
        )
        Spacer(modifier = Modifier.width(8.dp))
        Column(modifier = Modifier.weight(1f)) {
            Text(text = post.author.displayName, style = MaterialTheme.typography.titleMedium)
            Text(
                text = post.createdAt,
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }

        // ✅ 下拉菜单逻辑
        val expanded = remember { mutableStateOf(false) }
        Box {
            IconButton(onClick = { expanded.value = true }) {
                Icon(Icons.Filled.MoreVert, contentDescription = null)
            }
            DropdownMenu(
                expanded = expanded.value,
                onDismissRequest = { expanded.value = false }
            ) {
                DropdownMenuItem(
                    text = { Text("举报") },
                    onClick = {
                        expanded.value = false
                        onReportClick() // 触发回调
                    }
                )
                // 只有属于自己的帖子且允许删除时才显示删除选项
                if (post.canDelete) {
                    DropdownMenuItem(
                        text = { Text("删除", color = MaterialTheme.colorScheme.error) },
                        onClick = {
                            expanded.value = false
                            onDeleteClick() // 触发回调
                        }
                    )
                }
            }
        }
    }
}

// ... 剩余的 ImageGrid, ResortTag, ActionPill 等保持不变 (你可以保留你原来的，或者确保它们存在)
@Composable
fun ResortTag(name: String, modifier: Modifier = Modifier) {
    Box(
        modifier = modifier
            .clip(RoundedCornerShape(50))
            .background(Color(0xFFF0F0F0))
            .padding(horizontal = 10.dp, vertical = 4.dp)
    ) {
        Text(
            text = name,
            style = MaterialTheme.typography.bodySmall,
            color = MaterialTheme.colorScheme.onSurfaceVariant
        )
    }
}

@Composable
private fun ActionPill(
    icon: ImageVector,
    count: Int,
    selected: Boolean = false,
    onClick: () -> Unit
) {
    Row(
        modifier = Modifier
            .clip(RoundedCornerShape(999.dp))
            .clickable(onClick = onClick)
            .padding(horizontal = 10.dp, vertical = 6.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        Icon(
            imageVector = icon,
            contentDescription = null,
            tint = if (selected) MaterialTheme.colorScheme.primary
            else MaterialTheme.colorScheme.onSurfaceVariant,
            modifier = Modifier.size(18.dp)
        )
        Spacer(modifier = Modifier.width(6.dp))
        Text(
            text = count.toString(),
            style = MaterialTheme.typography.bodySmall,
            color = MaterialTheme.colorScheme.onSurfaceVariant
        )
    }
}

@Composable
fun ImageGrid(urls: List<String>, onImageClick: (Int) -> Unit) {
    // 简化版实现，防止依赖丢失，你可以用你之前的复杂版
    if (urls.isEmpty()) return
    val context = LocalContext.current
    // 我们只展示第一张图作为预览 (根据你之前的简化版逻辑)
    // 实际项目中如果是九宫格，对每张图都要应用这个逻辑
    val originalUrl = urls.first()
    // 列表显示时，请求 600px 宽度的图足够清晰了，体积却小很多
    val displayModel = ImageRequest.Builder(context)
        .data(getResizedImageUrl(originalUrl, width = 600) ?: originalUrl)
        .crossfade(true)
        .size(600, 600)
        .precision(coil.size.Precision.INEXACT)
        .placeholder(android.R.color.darker_gray) // 建议换成稍微好看点的灰色 Color(0xFFEEEEEE)
        .build()
    AsyncImage(
        model = displayModel,
        contentDescription = null,
        contentScale = ContentScale.Crop,
        modifier = Modifier
            .fillMaxWidth()
            .aspectRatio(16/9f)
            .clip(RoundedCornerShape(12.dp))
            .clickable { onImageClick(0) }
    )
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\ui\compose\ComposePostScreen.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.ui.compose

import android.net.Uri
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.PickVisualMediaRequest
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.ExperimentalFoundationApi
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.gestures.detectTapGestures
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.grid.GridCells
import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
import androidx.compose.foundation.lazy.grid.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Image
import androidx.compose.material.icons.filled.Search
import androidx.compose.material.icons.outlined.Image
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalFocusManager
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import androidx.navigation.NavController
import coil.compose.AsyncImage
import com.gosnow.app.datasupabase.SupabaseClientProvider
import com.gosnow.app.ui.snowcircle.data.PostRepository
import com.gosnow.app.ui.snowcircle.model.User
import io.github.jan.supabase.postgrest.from
import io.github.jan.supabase.postgrest.query.Columns
import io.github.jan.supabase.postgrest.query.Order
import kotlinx.coroutines.Job
import kotlinx.coroutines.delay
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable

private const val CONTENT_LIMIT = 500

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun ComposePostScreen(
    navController: NavController,
    viewModel: ComposePostViewModel,
    onPublished: () -> Unit // ✅ 新增回调参数
) {
    val uiState by viewModel.uiState.collectAsState()
    val scope = rememberCoroutineScope()

    val canPublish = uiState.content.isNotBlank() &&
            uiState.resortName.isNotBlank() &&
            !uiState.isPosting

    val focusManager = LocalFocusManager.current

    val picker = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.PickMultipleVisualMedia(maxItems = 4)
    ) { uris ->
        viewModel.onImagesSelected(uris)
    }

    Scaffold(
        topBar = {
            TopAppBar(
                title = {},
                navigationIcon = {
                    TextButton(
                        onClick = { navController.popBackStack() },
                        colors = ButtonDefaults.textButtonColors(
                            contentColor = MaterialTheme.colorScheme.onSurface
                        )
                    ) {
                        Text("取消")
                    }
                },
                actions = {
                    TextButton(
                        enabled = canPublish,
                        onClick = {
                            scope.launch {
                                // ✅ 调用发布，成功后执行回调
                                viewModel.publish {
                                    onPublished()
                                }
                            }
                        },
                        colors = ButtonDefaults.textButtonColors(
                            contentColor = if (canPublish)
                                MaterialTheme.colorScheme.primary
                            else
                                MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    ) {
                        Text(if (uiState.isPosting) "发布中" else "发布")
                    }
                }
            )
        }
    ) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .pointerInput(Unit) {
                    detectTapGestures(onTap = {
                        focusManager.clearFocus()
                        viewModel.hideResortSuggestions()
                    })
                }
                .padding(padding)
                .padding(horizontal = 16.dp, vertical = 12.dp)
        ) {
            // 雪场选择
            Row(verticalAlignment = Alignment.CenterVertically) {
                Spacer(modifier = Modifier.width(8.dp))
                Text(text = "选择雪场", style = MaterialTheme.typography.titleMedium)
            }
            Spacer(modifier = Modifier.height(8.dp))

            TextField(
                value = uiState.resortName,
                onValueChange = viewModel::onResortChange,
                modifier = Modifier.fillMaxWidth(),
                shape = CircleShape,
                leadingIcon = {
                    Icon(imageVector = Icons.Filled.Search, contentDescription = null)
                },
                placeholder = { Text("搜索雪场以发布") },
                singleLine = true,
                colors = TextFieldDefaults.colors(
                    focusedContainerColor = Color.White,
                    unfocusedContainerColor = Color.White,
                    disabledContainerColor = Color.White,
                    focusedIndicatorColor = Color.Transparent,
                    unfocusedIndicatorColor = Color.Transparent,
                    disabledIndicatorColor = Color.Transparent
                )
            )

            if (uiState.showResortSuggestions && (uiState.isSearchingResort || uiState.resortSuggestions.isNotEmpty())) {
                Spacer(modifier = Modifier.height(8.dp))
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .clip(RoundedCornerShape(12.dp))
                        .border(1.dp, MaterialTheme.colorScheme.outline, RoundedCornerShape(12.dp))
                        .background(Color.White)
                ) {
                    if (uiState.isSearchingResort) {
                        Text(
                            text = "搜索中…",
                            modifier = Modifier.padding(12.dp),
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    } else {
                        LazyColumn(modifier = Modifier.heightIn(max = 260.dp)) {
                            items(uiState.resortSuggestions.size) { idx ->
                                val item = uiState.resortSuggestions[idx]
                                Row(
                                    modifier = Modifier
                                        .fillMaxWidth()
                                        .clickable {
                                            viewModel.onResortSuggestionPicked(item.nameResort)
                                            focusManager.clearFocus()
                                        }
                                        .padding(horizontal = 12.dp, vertical = 10.dp),
                                    verticalAlignment = Alignment.CenterVertically
                                ) {
                                    Text(
                                        text = item.nameResort,
                                        fontWeight = FontWeight.Medium,
                                        color = MaterialTheme.colorScheme.onSurface
                                    )
                                }
                            }
                        }
                    }
                }
            }

            Spacer(modifier = Modifier.height(16.dp))

            // 正文
            Text(text = "正文", style = MaterialTheme.typography.titleMedium)
            Spacer(modifier = Modifier.height(8.dp))
            TextField(
                value = uiState.content,
                onValueChange = viewModel::onContentChange,
                modifier = Modifier
                    .fillMaxWidth()
                    .heightIn(min = 120.dp),
                placeholder = { Text("这里输入正文") },
                minLines = 4,
                maxLines = 8,
                colors = TextFieldDefaults.colors(
                    focusedContainerColor = Color.White,
                    unfocusedContainerColor = Color.White,
                    disabledContainerColor = Color.White,
                    focusedIndicatorColor = Color.Transparent,
                    unfocusedIndicatorColor = Color.Transparent,
                    disabledIndicatorColor = Color.Transparent,
                    cursorColor = MaterialTheme.colorScheme.primary
                )
            )
            Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.End) {
                Text(
                    text = "${uiState.content.length}/$CONTENT_LIMIT",
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }

            Spacer(modifier = Modifier.height(16.dp))

            // 图片
            Row(verticalAlignment = Alignment.CenterVertically) {
                Icon(imageVector = Icons.Filled.Image, contentDescription = null)
                Spacer(modifier = Modifier.width(8.dp))
                Text(text = "图片", style = MaterialTheme.typography.titleMedium)
            }
            Spacer(modifier = Modifier.height(8.dp))
            ImageSelector(
                images = uiState.selectedImages,
                onAddClick = {
                    picker.launch(PickVisualMediaRequest(ActivityResultContracts.PickVisualMedia.ImageOnly))
                },
                onRemove = viewModel::removeImage
            )

            uiState.errorMessage?.let {
                Spacer(modifier = Modifier.height(8.dp))
                Text(text = it, color = MaterialTheme.colorScheme.error)
            }
        }
    }
}

@OptIn(ExperimentalFoundationApi::class)
@Composable
private fun ImageSelector(
    images: List<Uri>,
    onAddClick: () -> Unit,
    onRemove: (Uri) -> Unit
) {
    LazyVerticalGrid(
        columns = GridCells.Fixed(2),
        modifier = Modifier.fillMaxWidth(),
        userScrollEnabled = false,
        horizontalArrangement = Arrangement.spacedBy(8.dp),
        verticalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        items(images) { uri ->
            Box(
                modifier = Modifier
                    .clip(RoundedCornerShape(10.dp))
                    .fillMaxWidth()
                    .aspectRatio(1f)
            ) {
                AsyncImage(
                    model = uri,
                    contentDescription = null,
                    modifier = Modifier.fillMaxSize(),
                    contentScale = ContentScale.Crop
                )
                Box(
                    modifier = Modifier
                        .align(Alignment.TopEnd)
                        .padding(6.dp)
                        .size(26.dp)
                        .clip(CircleShape)
                        .background(Color.Black.copy(alpha = 0.55f))
                        .clickable { onRemove(uri) },
                    contentAlignment = Alignment.Center
                ) {
                    Text(text = "×", color = Color.White, fontWeight = FontWeight.SemiBold)
                }
            }
        }

        if (images.size < 4) {
            item {
                Box(
                    modifier = Modifier
                        .clip(RoundedCornerShape(10.dp))
                        .border(1.dp, MaterialTheme.colorScheme.outline, RoundedCornerShape(10.dp))
                        .clickable(onClick = onAddClick)
                        .fillMaxWidth()
                        .aspectRatio(1f),
                    contentAlignment = Alignment.Center
                ) {
                    Column(horizontalAlignment = Alignment.CenterHorizontally) {
                        Icon(imageVector = Icons.Outlined.Image, contentDescription = null)
                        Text("添加图片", style = MaterialTheme.typography.bodySmall)
                    }
                }
            }
        }
    }
}

// ViewModel 和 data class 保持不变 (ComposePostViewModel, ComposePostUiState, ResortRow)
// ... (为了节省篇幅，请保留你原文件中这里的 ViewModel 代码)
@Serializable
data class ResortRow(
    val id: Long? = null,
    @SerialName("name_resort")
    val nameResort: String
)

data class ComposePostUiState(
    val resortName: String = "",
    val resortSuggestions: List<ResortRow> = emptyList(),
    val showResortSuggestions: Boolean = false,
    val isSearchingResort: Boolean = false,
    val content: String = "",
    val selectedImages: List<Uri> = emptyList(),
    val isPosting: Boolean = false,
    val errorMessage: String? = null
)

class ComposePostViewModel(
    private val postRepository: PostRepository,
    private val currentUser: User
) : ViewModel() {

    private val _uiState = MutableStateFlow(ComposePostUiState())
    val uiState: StateFlow<ComposePostUiState> = _uiState.asStateFlow()

    private var resortSearchJob: Job? = null

    fun onResortChange(value: String) {
        val trimmed = value.trimStart().take(50)
        _uiState.update {
            it.copy(
                resortName = trimmed,
                showResortSuggestions = trimmed.isNotBlank(),
                resortSuggestions = if (trimmed.isBlank()) emptyList() else it.resortSuggestions
            )
        }

        if (trimmed.isBlank()) {
            _uiState.update { it.copy(resortSuggestions = emptyList(), isSearchingResort = false, showResortSuggestions = false) }
            resortSearchJob?.cancel()
            return
        }

        resortSearchJob?.cancel()
        resortSearchJob = viewModelScope.launch {
            delay(250)
            searchResorts(trimmed)
        }
    }

    fun hideResortSuggestions() {
        _uiState.update { it.copy(showResortSuggestions = false) }
    }

    fun onResortSuggestionPicked(name: String) {
        _uiState.update {
            it.copy(
                resortName = name,
                showResortSuggestions = false,
                resortSuggestions = emptyList(),
                isSearchingResort = false
            )
        }
    }
    fun removeImage(uri: Uri) {
        _uiState.update { state ->
            state.copy(selectedImages = state.selectedImages.filterNot { it == uri })
        }
    }

    private suspend fun searchResorts(keyword: String) {
        _uiState.update { it.copy(isSearchingResort = true, showResortSuggestions = true) }

        runCatching {
            val supabase = SupabaseClientProvider.supabaseClient
            val rows: List<ResortRow> = supabase
                .from("Resorts_data")
                .select(columns = Columns.list("id", "name_resort")) {
                    filter { ilike("name_resort", "%$keyword%") }
                    order("name_resort", Order.ASCENDING)
                    limit(20)
                }
                .decodeList()
            rows
        }.onSuccess { list ->
            if (_uiState.value.resortName != keyword && !_uiState.value.resortName.contains(keyword, ignoreCase = true)) {
                _uiState.update { it.copy(isSearchingResort = false) }
                return
            }
            _uiState.update {
                it.copy(
                    isSearchingResort = false,
                    resortSuggestions = list,
                    showResortSuggestions = true,
                    errorMessage = null
                )
            }
        }.onFailure { e ->
            _uiState.update {
                it.copy(isSearchingResort = false, resortSuggestions = emptyList(), showResortSuggestions = true)
            }
        }
    }

    fun onContentChange(value: String) {
        _uiState.update { it.copy(content = value.take(CONTENT_LIMIT)) }
    }

    fun onImagesSelected(uris: List<Uri>) {
        _uiState.update { state ->
            val merged = (state.selectedImages + uris).distinct().take(4)
            state.copy(selectedImages = merged)
        }
    }

    fun publish(onSuccess: () -> Unit) {
        viewModelScope.launch {
            val state = _uiState.value
            if (state.content.isBlank() || state.resortName.isBlank()) return@launch

            _uiState.update { it.copy(isPosting = true, errorMessage = null) }

            runCatching {
                postRepository.createPost(
                    content = state.content,
                    resortName = state.resortName,
                    images = state.selectedImages.map { it.toString() },
                    currentUser = currentUser
                )
            }.onSuccess {
                _uiState.value = ComposePostUiState()
                onSuccess()
            }.onFailure { e ->
                _uiState.update {
                    it.copy(isPosting = false, errorMessage = e.message ?: "发布失败")
                }
            }
        }
    }
}

private inline fun <T> MutableStateFlow<T>.update(block: (T) -> T) {
    value = block(value)
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\ui\detail\PostDetailScreen.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.ui.detail

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.gestures.detectTapGestures
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.PaddingValues
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material.icons.filled.Send
import androidx.compose.material.icons.filled.ThumbUp
import androidx.compose.material.icons.outlined.Comment
import androidx.compose.material.icons.outlined.ThumbUp
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.CircularProgressIndicator
import androidx.compose.material3.Divider
import androidx.compose.material3.ExperimentalMaterial3Api
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Scaffold
import androidx.compose.material3.Text
import androidx.compose.material3.TextButton
import androidx.compose.material3.TextField
import androidx.compose.material3.TextFieldDefaults
import androidx.compose.material3.TopAppBar
import androidx.compose.runtime.Composable
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.focus.FocusRequester
import androidx.compose.ui.focus.focusRequester
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalFocusManager
import androidx.compose.ui.unit.dp
import androidx.navigation.NavController
import coil.compose.AsyncImage
import com.gosnow.app.ui.snowcircle.model.Comment
import com.gosnow.app.ui.snowcircle.model.Post
import com.gosnow.app.ui.snowcircle.ui.components.CommentRow
import com.gosnow.app.ui.snowcircle.ui.components.ImageGrid
import com.gosnow.app.ui.snowcircle.ui.components.ResortTag
import androidx.compose.material.icons.filled.SwapVert

private enum class CommentSortMode { HOT, TIME }

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun PostDetailScreen(
    viewModel: PostDetailViewModel,
    navController: NavController
) {
    val uiState = viewModel.uiState.collectAsState()
    val replyText = remember { mutableStateOf("") }
    val focusManager = LocalFocusManager.current
    val focusRequester = remember { FocusRequester() }

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("帖子") },
                navigationIcon = {
                    IconButton(onClick = { navController.popBackStack() }) {
                        Icon(Icons.Filled.ArrowBack, contentDescription = null)
                    }
                }
            )
        },
        bottomBar = {
            ReplyComposerBar(
                isReplyToPost = uiState.value.replyTarget == null,
                targetName = uiState.value.replyTarget?.author?.displayName,
                text = replyText.value,
                onTextChange = { replyText.value = it },
                onSend = {
                    if (replyText.value.isNotBlank()) {
                        val parentId = uiState.value.replyTarget?.id
                        viewModel.onSendComment(replyText.value, parentId)
                        replyText.value = ""
                    }
                },
                focusRequester = focusRequester
            )
        }
    ) { padding ->
        Box(
            modifier = Modifier
                .fillMaxSize()
                .pointerInput(Unit) { detectTapGestures(onTap = { focusManager.clearFocus() }) }
                .padding(padding)
        ) {
            when {
                uiState.value.isLoading -> Box(
                    modifier = Modifier.fillMaxSize(),
                    contentAlignment = Alignment.Center
                ) { CircularProgressIndicator() }

                uiState.value.errorMessage != null -> Box(
                    modifier = Modifier.fillMaxSize(),
                    contentAlignment = Alignment.Center
                ) {
                    Column(horizontalAlignment = Alignment.CenterHorizontally) {
                        Text(uiState.value.errorMessage!!)
                        TextButton(onClick = { viewModel.refresh() }) { Text("重试") }
                    }
                }

                uiState.value.post != null -> {
                    val post = uiState.value.post!!
                    PostDetailContent(
                        post = post,
                        comments = uiState.value.comments,
                        onImageClick = { index ->
                            navController.navigate("image_viewer/${post.id}/$index")
                        },
                        onLike = { viewModel.onTogglePostLike() },
                        onComment = {
                            viewModel.onReplyTargetSelected(null)
                            focusRequester.requestFocus()
                        },
                        onReplyComment = { comment ->
                            viewModel.onReplyTargetSelected(comment)
                            focusRequester.requestFocus()
                        },
                        onLikeComment = { comment -> viewModel.onToggleCommentLike(comment.id) },
                        onDeleteComment = { comment -> viewModel.onDeleteComment(comment.id) },
                        onReport = { }
                    )
                }
            }
        }
    }
}

@Composable
private fun PostDetailContent(
    post: Post,
    comments: CommentThreadUiState,
    onImageClick: (Int) -> Unit,
    onLike: () -> Unit,
    onComment: () -> Unit,
    onReplyComment: (Comment) -> Unit,
    onLikeComment: (Comment) -> Unit,
    onDeleteComment: (Comment) -> Unit,
    onReport: (Comment) -> Unit
) {
    // ✅ 默认热度；点按钮在 热度 <-> 时间 之间切换
    var sortMode by rememberSaveable { mutableStateOf(CommentSortMode.HOT) }

    // ✅ 只影响主评论（roots），楼中楼不排序
    val sortedRoots = remember(comments, sortMode) {
        when (sortMode) {
            CommentSortMode.TIME -> {
                // 时间：保持后端/仓库返回顺序（通常就是 created_at desc）
                comments.roots
            }
            CommentSortMode.HOT -> {
                comments.roots.sortedWith(
                    compareByDescending<Comment> { c ->
                        val replyCount = comments.children[c.id]?.size ?: 0
                        // 热度：点赞 + 回复数（你也可以再加权重）
                        c.likeCount + replyCount
                    }.thenByDescending { c ->
                        comments.children[c.id]?.size ?: 0
                    }
                )
            }
        }
    }

    LazyColumn(
        modifier = Modifier.fillMaxSize(),
        contentPadding = PaddingValues(bottom = 120.dp)
    ) {
        item {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(16.dp)
            ) {
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    AsyncImage(
                        model = post.author.avatarUrl,
                        contentDescription = null,
                        modifier = Modifier.size(40.dp).clip(CircleShape),
                        contentScale = ContentScale.Crop
                    )
                    Spacer(modifier = Modifier.width(10.dp))

                    Column(modifier = Modifier.weight(1f)) {
                        Text(text = post.author.displayName, style = MaterialTheme.typography.titleMedium)
                        Text(
                            text = post.createdAt,
                            style = MaterialTheme.typography.bodySmall,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }

                Spacer(modifier = Modifier.height(8.dp))
                Text(post.content, style = MaterialTheme.typography.bodyLarge)

                if (post.imageUrls.isNotEmpty()) {
                    Spacer(modifier = Modifier.height(8.dp))
                    ImageGrid(urls = post.imageUrls, onImageClick = onImageClick)
                }

                Spacer(modifier = Modifier.height(8.dp))
                post.resortName?.let { ResortTag(name = it) }

                Spacer(modifier = Modifier.height(8.dp))
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Spacer(modifier = Modifier.weight(1f))

                    Row(
                        verticalAlignment = Alignment.CenterVertically,
                        modifier = Modifier.clickableNoRipple { onLike() }
                    ) {
                        Icon(
                            imageVector = if (post.isLikedByMe) Icons.Filled.ThumbUp else Icons.Outlined.ThumbUp,
                            contentDescription = "赞",
                            tint = if (post.isLikedByMe) MaterialTheme.colorScheme.primary
                            else MaterialTheme.colorScheme.onSurfaceVariant
                        )
                        Spacer(modifier = Modifier.width(4.dp))
                        Text(text = "${post.likeCount}")
                    }

                    Spacer(modifier = Modifier.width(16.dp))

                    Row(
                        verticalAlignment = Alignment.CenterVertically,
                        modifier = Modifier.clickableNoRipple { onComment() }
                    ) {
                        Icon(
                            imageVector = Icons.Outlined.Comment,
                            contentDescription = "评论",
                            tint = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                        Spacer(modifier = Modifier.width(4.dp))
                        Text(text = "${post.commentCount}")
                    }
                }
            }

            Divider()

            // ✅ “评论”左侧标题 + 右侧一个排序按钮（点一下切换）
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(horizontal = 16.dp, vertical = 12.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text("评论", style = MaterialTheme.typography.titleMedium)
                Spacer(modifier = Modifier.weight(1f))

                SortToggle(
                    mode = sortMode,
                    onToggle = {
                        sortMode = if (sortMode == CommentSortMode.HOT) CommentSortMode.TIME else CommentSortMode.HOT
                    }
                )
            }
        }

        if (comments.roots.isEmpty()) {
            item {
                Text(
                    "暂无评论",
                    modifier = Modifier.padding(16.dp),
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        } else {
            items(sortedRoots, key = { it.id }) { root ->
                Column(modifier = Modifier.padding(horizontal = 12.dp)) {
                    CommentRow(
                        comment = root,
                        onReply = onReplyComment,
                        onLike = onLikeComment,
                        onDelete = onDeleteComment,
                        onReport = onReport
                    )

                    val replies = comments.children[root.id].orEmpty()

                    // ✅ 折叠楼中楼（不改变 replies 的顺序）
                    val previewCount = 2
                    var expanded by rememberSaveable(root.id) { mutableStateOf(false) }

                    Column(modifier = Modifier.padding(start = 32.dp)) {
                        val shownReplies = if (expanded) replies else replies.take(previewCount)

                        shownReplies.forEach { reply ->
                            CommentRow(
                                comment = reply,
                                onReply = onReplyComment,
                                onLike = onLikeComment,
                                onDelete = onDeleteComment,
                                onReport = onReport
                            )
                        }

                        if (replies.size > previewCount) {
                            TextButton(
                                onClick = { expanded = !expanded },
                                colors = ButtonDefaults.textButtonColors(
                                    contentColor = MaterialTheme.colorScheme.onSurfaceVariant
                                )
                            ) {
                                val hiddenCount = replies.size - previewCount
                                Text(text = if (expanded) "收起回复" else "展开更多回复（$hiddenCount）")
                            }
                        }
                    }

                    Spacer(modifier = Modifier.height(8.dp))
                }
            }
        }
    }
}
@Composable
private fun SortToggle(
    mode: CommentSortMode,
    onToggle: () -> Unit
) {
    Box(
        modifier = Modifier
            .clip(RoundedCornerShape(999.dp))
            .background(MaterialTheme.colorScheme.surfaceVariant)
            .clickable { onToggle() }
            .padding(horizontal = 10.dp, vertical = 6.dp),
        contentAlignment = Alignment.Center
    ) {
        Row(
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.spacedBy(6.dp)
        ) {
            Icon(
                imageVector = Icons.Filled.SwapVert,
                contentDescription = "切换排序",
                tint = MaterialTheme.colorScheme.onSurfaceVariant,
                modifier = Modifier.size(16.dp)
            )
            Text(
                text = if (mode == CommentSortMode.HOT) "按热度" else "按时间",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
    }
}


/** 比较简易的无水波 clickable，用来做点赞/评论区域 */
@Composable
private fun Modifier.clickableNoRipple(onClick: () -> Unit): Modifier =
    this.then(
        Modifier.clickable(
            indication = null,
            interactionSource = remember { androidx.compose.foundation.interaction.MutableInteractionSource() },
            onClick = onClick
        )
    )

@Composable
private fun ReplyComposerBar(
    isReplyToPost: Boolean,
    targetName: String?,
    text: String,
    onTextChange: (String) -> Unit,
    onSend: () -> Unit,
    focusRequester: FocusRequester
) {
    val focusManager = LocalFocusManager.current
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .padding(12.dp),
        verticalAlignment = Alignment.CenterVertically,
        horizontalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        Column(modifier = Modifier.weight(1f)) {
            Text(
                text = if (isReplyToPost) "发表评论" else "回复 $targetName",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
            TextField(
                value = text,
                onValueChange = onTextChange,
                modifier = Modifier
                    .fillMaxWidth()
                    .focusRequester(focusRequester),
                placeholder = { Text("写点什么…") },
                shape = CircleShape,
                colors = TextFieldDefaults.colors(
                    focusedContainerColor = Color.White,
                    unfocusedContainerColor = Color.White,
                    disabledContainerColor = Color.White,
                    focusedIndicatorColor = Color.Transparent,
                    unfocusedIndicatorColor = Color.Transparent,
                    disabledIndicatorColor = Color.Transparent,
                    cursorColor = MaterialTheme.colorScheme.primary
                )
            )
        }
        IconButton(
            onClick = {
                onSend()
                focusManager.clearFocus()
            }
        ) {
            Icon(Icons.Filled.Send, contentDescription = "发送")
        }
    }
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\ui\detail\PostDetailViewModel.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.ui.detail

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.gosnow.app.ui.snowcircle.data.CommentRepository
import com.gosnow.app.ui.snowcircle.data.PostRepository

import com.gosnow.app.ui.snowcircle.model.Comment
import com.gosnow.app.ui.snowcircle.model.Post
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch

data class CommentThreadUiState(
    val roots: List<Comment> = emptyList(),
    val children: Map<String, List<Comment>> = emptyMap()
)

data class PostDetailUiState(
    val isLoading: Boolean = false,
    val errorMessage: String? = null,
    val post: Post? = null,
    val comments: CommentThreadUiState = CommentThreadUiState(),
    val replyTarget: Comment? = null
)

class PostDetailViewModel(
    private val postId: String,
    private val postRepository: PostRepository,
    private val commentRepository: CommentRepository,
    private val currentUserId: String
) : ViewModel() {

    private val _uiState = MutableStateFlow(PostDetailUiState(isLoading = true))
    val uiState: StateFlow<PostDetailUiState> = _uiState.asStateFlow()

    init {
        refresh()
    }

    fun refresh() {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true, errorMessage = null) }
            val post = postRepository.getPostById(postId)
            val comments = commentRepository.getCommentsForPost(postId)
            if (post == null) {
                _uiState.update { it.copy(isLoading = false, errorMessage = "Post missing") }
            } else {
                _uiState.update {
                    it.copy(isLoading = false, post = post, comments = buildThread(comments))
                }
            }
        }
    }

    fun onTogglePostLike() {
        viewModelScope.launch {
            val updated = postRepository.toggleLike(postId, currentUserId)
            updated?.let { _uiState.update { state -> state.copy(post = it, comments = state.comments) } }
        }
    }

    fun onToggleCommentLike(commentId: String) {
        viewModelScope.launch {
            val updated = commentRepository.toggleCommentLike(commentId, currentUserId)
            updated?.let { comment ->
                val current = uiState.value.comments
                val newRoots = current.roots.map { if (it.id == comment.id) comment else it }
                val newChildren = current.children.mapValues { (parent, list) ->
                    if (parent == comment.parentId) list.map { if (it.id == comment.id) comment else it } else list
                }
                _uiState.update { it.copy(comments = current.copy(roots = newRoots, children = newChildren)) }
            }
        }
    }

    fun onSendComment(text: String, parentId: String?) {
        viewModelScope.launch {
            val me = com.gosnow.app.ui.snowcircle.model.User(
                id = currentUserId,
                displayName = "我",
                avatarUrl = null
            )
            val newComment = commentRepository.addComment(postId, text, parentId, me)

            val current = uiState.value.comments
            if (parentId == null) {
                _uiState.update { it.copy(comments = current.copy(roots = listOf(newComment) + current.roots)) }
            } else {
                val children = current.children.toMutableMap()
                val replies = children[parentId].orEmpty()
                children[parentId] = listOf(newComment) + replies
                _uiState.update { it.copy(comments = current.copy(children = children)) }
            }
            _uiState.update { it.copy(replyTarget = null) }
        }
    }


    fun onDeleteComment(commentId: String) {
        viewModelScope.launch {
            commentRepository.deleteComment(commentId, currentUserId)
            refresh()
        }
    }

    fun onReplyTargetSelected(comment: Comment?) {
        _uiState.update { it.copy(replyTarget = comment) }
    }

    private fun buildThread(comments: List<Comment>): CommentThreadUiState {

        fun isRoot(c: Comment): Boolean {
            val p = c.parentId?.trim()
            return p.isNullOrBlank() || p == "0" || p.equals("null", ignoreCase = true)
        }

        val roots = comments.filter { isRoot(it) }
        val children = comments
            .filterNot { isRoot(it) }
            .groupBy { it.parentId!!.trim() }

        return CommentThreadUiState(roots, children)
    }

}

private inline fun <T> MutableStateFlow<T>.update(block: (T) -> T) {
    value = block(value)
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\ui\feed\FeedScreen.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.ui.feed

import androidx.compose.foundation.background
import androidx.compose.foundation.gestures.detectTapGestures
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.itemsIndexed
import androidx.compose.foundation.lazy.rememberLazyListState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Add
import androidx.compose.material.icons.filled.Close
import androidx.compose.material.icons.filled.Notifications
import androidx.compose.material.icons.filled.Search
import androidx.compose.material.icons.outlined.Article
import androidx.compose.material3.*
import androidx.compose.material3.pulltorefresh.PullToRefreshBox // ✅ 现在可以使用了 (需 Material3 1.3.0+)
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.platform.LocalFocusManager
import androidx.compose.ui.unit.dp
import androidx.navigation.NavController
import com.gosnow.app.ui.snowcircle.ui.components.PostCard

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun FeedScreen(
    viewModel: FeedViewModel,
    navController: NavController
) {
    val uiState by viewModel.uiState.collectAsState()
    val listState = rememberLazyListState()
    val focusManager = LocalFocusManager.current
    val snackbarHostState = remember { SnackbarHostState() }

    // 监听自动刷新信号
    val currentBackStackEntry = navController.currentBackStackEntry
    val savedStateHandle = currentBackStackEntry?.savedStateHandle
    val refreshTriggerState = savedStateHandle?.getStateFlow("refresh_feed", false)
    val refreshTrigger by refreshTriggerState?.collectAsState() ?: mutableStateOf(false)

    LaunchedEffect(refreshTrigger) {
        if (refreshTrigger) {
            viewModel.refresh()
            savedStateHandle?.set("refresh_feed", false)
        }
    }

    // 监听用户提示消息 (删除/举报反馈)
    LaunchedEffect(uiState.userMessage) {
        uiState.userMessage?.let { msg ->
            snackbarHostState.showSnackbar(msg)
            viewModel.messageShown()
        }
    }

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("雪圈") },
                navigationIcon = {
                    Box {
                        IconButton(onClick = {
                            viewModel.onNotificationsViewed()
                            navController.navigate("notifications")
                        }) {
                            Icon(Icons.Filled.Notifications, contentDescription = "通知")
                        }
                        if (uiState.hasUnreadNotifications) {
                            Box(
                                modifier = Modifier
                                    .size(10.dp)
                                    .background(MaterialTheme.colorScheme.error, CircleShape)
                                    .align(Alignment.TopEnd)
                                    .padding(2.dp),
                            )
                        }
                    }
                },
                actions = {
                    IconButton(onClick = { navController.navigate("my_posts") }) {
                        Icon(Icons.Outlined.Article, contentDescription = "我的帖子")
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors()
            )
        },
        floatingActionButton = {
            FloatingActionButton(
                onClick = { navController.navigate("compose_post") },
                containerColor = Color.Black,
                contentColor = Color.White
            ) {
                Icon(Icons.Filled.Add, contentDescription = "发布")
            }
        },
        snackbarHost = { SnackbarHost(snackbarHostState) }
    ) { padding ->
        // ✅ 使用 PullToRefreshBox 实现原生下拉刷新
        PullToRefreshBox(
            isRefreshing = uiState.isLoading,
            onRefresh = { viewModel.refresh() },
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .background(MaterialTheme.colorScheme.background)
        ) {
            if (!uiState.isLoading && uiState.posts.isEmpty() && uiState.errorMessage == null) {
                // 空状态
                Box(
                    modifier = Modifier.fillMaxSize(),
                    contentAlignment = Alignment.Center
                ) {
                    val msg = if (uiState.selectedResort == null) "暂无帖子" else "该雪场暂无帖子"
                    Text(msg, color = MaterialTheme.colorScheme.onSurfaceVariant)
                }
            } else {
                LazyColumn(
                    state = listState,
                    contentPadding = PaddingValues(bottom = 80.dp),
                    modifier = Modifier.fillMaxSize()
                        .pointerInput(Unit) { detectTapGestures(onTap = { focusManager.clearFocus() }) }
                ) {
                    // 搜索栏
                    item {
                        Spacer(modifier = Modifier.height(8.dp))
                        SearchBar(
                            value = uiState.query,
                            onValueChange = viewModel::onQueryChange,
                            onClear = { viewModel.onQueryChange("") }
                        )
                        if (uiState.query.isNotBlank() && uiState.selectedResort == null) {
                            Row(
                                modifier = Modifier.fillMaxWidth().padding(horizontal = 16.dp),
                                verticalAlignment = Alignment.CenterVertically
                            ) {
                                uiState.resortSuggestions.forEach { resort ->
                                    AssistChip(
                                        onClick = { viewModel.onResortSelected(resort) },
                                        label = { Text(resort) },
                                        modifier = Modifier.padding(end = 8.dp)
                                    )
                                }
                            }
                        }
                        uiState.selectedResort?.let {
                            SelectedResortCard(resort = it, onClear = { viewModel.onResortSelected(null) })
                        }
                        Spacer(modifier = Modifier.height(8.dp))
                    }

                    // 帖子列表
                    itemsIndexed(uiState.posts.take(uiState.visibleCount), key = { _, item -> item.id }) { index, post ->
                        PostCard(
                            post = post,
                            onClick = { navController.navigate("post_detail/${post.id}") },
                            onLikeClick = { viewModel.onToggleLike(post.id) },
                            onCommentClick = { navController.navigate("post_detail/${post.id}") },
                            onImageClick = { idx -> navController.navigate("image_viewer/${post.id}/$idx") },
                            // ✅ 连接删除和举报逻辑
                            onDeleteClick = { viewModel.onDeletePost(post.id) },
                            onReportClick = { viewModel.onReportPost(post.id) }
                        )
                        if (index < uiState.posts.take(uiState.visibleCount).lastIndex) {
                            Divider(color = MaterialTheme.colorScheme.outlineVariant.copy(alpha = 0.5f))
                        }
                    }

                    // 加载更多
                    item {
                        if (uiState.visibleCount < uiState.posts.size) {
                            Box(
                                modifier = Modifier.fillMaxWidth().padding(vertical = 12.dp),
                                contentAlignment = Alignment.Center
                            ) {
                                TextButton(onClick = { viewModel.onLoadMore() }) { Text("加载更多") }
                            }
                        }
                    }
                }
            }

            // 错误重试按钮
            if (uiState.errorMessage != null && uiState.posts.isEmpty()) {
                Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
                    Column(horizontalAlignment = Alignment.CenterHorizontally) {
                        Text(uiState.errorMessage ?: "加载失败")
                        TextButton(onClick = { viewModel.refresh() }) { Text("重试") }
                    }
                }
            }
        }
    }
}

// SearchBar & SelectedResortCard 保持不变
@Composable
private fun SearchBar(value: String, onValueChange: (String) -> Unit, onClear: () -> Unit) {
    OutlinedTextField(
        value = value,
        onValueChange = onValueChange,
        modifier = Modifier.fillMaxWidth().padding(horizontal = 16.dp),
        placeholder = { Text("搜索帖子或雪场") },
        leadingIcon = { Icon(Icons.Filled.Search, null) },
        trailingIcon = { if (value.isNotEmpty()) IconButton(onClick = onClear) { Icon(Icons.Filled.Close, null) } },
        singleLine = true,
        shape = CircleShape,
        colors = TextFieldDefaults.colors(
            focusedContainerColor = Color.White, unfocusedContainerColor = Color.White,
            disabledContainerColor = Color.White, focusedIndicatorColor = Color.Transparent,
            unfocusedIndicatorColor = Color.Transparent, disabledIndicatorColor = Color.Transparent
        )
    )
}

@Composable
private fun SelectedResortCard(resort: String, onClear: () -> Unit) {
    Card(modifier = Modifier.fillMaxWidth().padding(16.dp), shape = RoundedCornerShape(12.dp)) {
        Row(modifier = Modifier.padding(12.dp), verticalAlignment = Alignment.CenterVertically) {
            Column(modifier = Modifier.weight(1f)) {
                Text("已选择雪场", style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant)
                Text(resort, style = MaterialTheme.typography.titleMedium)
            }
            IconButton(onClick = onClear) { Icon(Icons.Filled.Close, "移除雪场") }
        }
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\ui\feed\FeedViewModel.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.ui.feed

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.gosnow.app.ui.snowcircle.data.NotificationsRepository
import com.gosnow.app.ui.snowcircle.data.PostRepository
import com.gosnow.app.ui.snowcircle.model.Post
import kotlinx.coroutines.Job
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import kotlin.math.min

private const val PAGE_SIZE = 20
// 用于本地模拟筛选，实际应该靠数据库查询
private var fullFeed: List<Post> = emptyList()
private val resortList = listOf("Niseko", "Hakuba", "Whistler", "Zermatt", "Aspen", "Stowe")

data class FeedUiState(
    val isLoading: Boolean = false,
    val errorMessage: String? = null,
    val query: String = "",
    val selectedResort: String? = null,
    val posts: List<Post> = emptyList(),
    val resortSuggestions: List<String> = emptyList(),
    val hasUnreadNotifications: Boolean = false,
    val visibleCount: Int = PAGE_SIZE,
    // 新增：用于显示简单的提示信息 (如“举报成功”)
    val userMessage: String? = null
)

open class FeedViewModel(
    private val postRepository: PostRepository,
    private val notificationsRepository: NotificationsRepository,
    private val currentUserId: String
) : ViewModel() {

    private val _uiState = MutableStateFlow(FeedUiState(isLoading = true))
    val uiState: StateFlow<FeedUiState> = _uiState.asStateFlow()

    private var loadJob: Job? = null

    init {
        refresh()
        viewModelScope.launch {
            runCatching { notificationsRepository.getNotifications(currentUserId) }
                .onSuccess { items ->
                    _uiState.update { it.copy(hasUnreadNotifications = items.any { item -> !item.isRead }) }
                }
        }
    }

    open fun refresh() {
        loadJob?.cancel()
        loadJob = viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true, errorMessage = null) }
            runCatching {
                postRepository.getFeedPosts(_uiState.value.selectedResort)
            }.onSuccess { posts ->
                fullFeed = posts
                val filtered = filter(fullFeed)
                _uiState.update { state ->
                    state.copy(
                        isLoading = false,
                        posts = filtered,
                        visibleCount = min(PAGE_SIZE, filtered.size)
                    )
                }
            }.onFailure { error ->
                _uiState.update {
                    it.copy(
                        isLoading = false,
                        errorMessage = error.message ?: "Load failed"
                    )
                }
            }
        }
    }

    fun onQueryChange(text: String) {
        _uiState.update { state ->
            state.copy(
                query = text,
                selectedResort = state.selectedResort,
                resortSuggestions = if (text.isBlank()) emptyList() else resortList.filter { it.contains(text, ignoreCase = true) }
            )
        }
        if (!_uiState.value.isLoading) {
            val filtered = filter(fullFeed)
            _uiState.update { it.copy(posts = filtered, visibleCount = min(PAGE_SIZE, filtered.size)) }
        }
    }

    fun onResortSelected(resort: String?) {
        _uiState.update { it.copy(selectedResort = resort, query = "") }
        refresh()
    }

    fun onLoadMore() {
        _uiState.update { state ->
            val newCount = (state.visibleCount + PAGE_SIZE).coerceAtMost(state.posts.size)
            state.copy(visibleCount = newCount)
        }
    }

    fun onToggleLike(postId: String) {
        viewModelScope.launch {
            val updated = postRepository.toggleLike(postId, currentUserId)
            if (updated != null) {
                // 更新本地列表状态
                updatePostInList(updated)
            }
        }
    }

    // ✅ 新增：删除帖子逻辑
    fun onDeletePost(postId: String) {
        viewModelScope.launch {
            runCatching {
                postRepository.deletePost(postId, currentUserId)
            }.onSuccess {
                // 删除成功后，从本地列表中移除
                _uiState.update { state ->
                    val newPosts = state.posts.filter { it.id != postId }
                    fullFeed = fullFeed.filter { it.id != postId }
                    state.copy(posts = newPosts, userMessage = "帖子已删除")
                }
            }.onFailure {
                _uiState.update { it.copy(userMessage = "删除失败，请稍后重试") }
            }
        }
    }

    // ✅ 新增：举报帖子逻辑 (仅模拟)
    fun onReportPost(postId: String) {
        // 实际开发中这里应调用 postRepository.reportPost(postId)
        _uiState.update { it.copy(userMessage = "已举报，我们会尽快处理") }
    }

    fun onNotificationsViewed() {
        _uiState.update { it.copy(hasUnreadNotifications = false) }
    }

    // 清除一次性消息
    fun messageShown() {
        _uiState.update { it.copy(userMessage = null) }
    }

    private fun updatePostInList(updated: Post) {
        _uiState.update { state ->
            state.copy(posts = state.posts.map { if (it.id == updated.id) updated else it })
        }
        // 同时更新缓存源
        fullFeed = fullFeed.map { if (it.id == updated.id) updated else it }
    }

    private fun filter(posts: List<Post>): List<Post> {
        val query = _uiState.value.query
        if (query.isBlank()) return posts
        return posts.filter { post ->
            post.content.contains(query, true) ||
                    post.author.displayName.contains(query, true) ||
                    (post.resortName?.contains(query, true) == true)
        }
    }
}

private inline fun <T> MutableStateFlow<T>.update(block: (T) -> T) {
    this.value = block(this.value)
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\ui\myposts\MyPostsScreen.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.ui.myposts

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.PaddingValues
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.itemsIndexed
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material.icons.filled.Delete
import androidx.compose.material3.CircularProgressIndicator
import androidx.compose.material3.Divider
import androidx.compose.material3.ExperimentalMaterial3Api
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Scaffold
import androidx.compose.material3.SwipeToDismissBox
import androidx.compose.material3.SwipeToDismissBoxValue
import androidx.compose.material3.Text
import androidx.compose.material3.TextButton
import androidx.compose.material3.TopAppBar
import androidx.compose.material3.rememberSwipeToDismissBoxState
import androidx.compose.runtime.Composable
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import androidx.navigation.NavController
import com.gosnow.app.ui.snowcircle.ui.components.PostCard

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun MyPostsScreen(
    viewModel: MyPostsViewModel,
    navController: NavController
) {
    val uiState by viewModel.uiState.collectAsState()

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("我的帖子") },
                navigationIcon = {
                    IconButton(onClick = { navController.popBackStack() }) {
                        Icon(Icons.Filled.ArrowBack, contentDescription = null)
                    }
                }
            )
        }
    ) { padding ->
        when {
            uiState.isLoading -> Box(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding),
                contentAlignment = Alignment.Center
            ) {
                CircularProgressIndicator()
            }

            uiState.errorMessage != null -> Box(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding),
                contentAlignment = Alignment.Center
            ) {
                Column(horizontalAlignment = Alignment.CenterHorizontally) {
                    Text(uiState.errorMessage!!)
                    TextButton(onClick = { viewModel.refresh() }) {
                        Text("重试")
                    }
                }
            }

            uiState.posts.isEmpty() -> Box(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding),
                contentAlignment = Alignment.Center
            ) {
                Text("你还没有发布任何内容")
            }

            else -> {
                LazyColumn(
                    modifier = Modifier
                        .fillMaxSize()
                        .padding(padding),
                    contentPadding = PaddingValues(bottom = 80.dp)
                ) {
                    itemsIndexed(uiState.posts, key = { _, item -> item.id }) { index, post ->
                        val dismissState = rememberSwipeToDismissBoxState(
                            confirmValueChange = { value ->
                                if (value == SwipeToDismissBoxValue.StartToEnd ||
                                    value == SwipeToDismissBoxValue.EndToStart
                                ) {
                                    viewModel.deletePost(post.id)
                                    true
                                } else {
                                    false
                                }
                            }
                        )

                        SwipeToDismissBox(
                            state = dismissState,
                            backgroundContent = {
                                Box(
                                    modifier = Modifier
                                        .fillMaxSize()
                                        .background(MaterialTheme.colorScheme.surfaceVariant)
                                        .padding(horizontal = 20.dp),
                                    contentAlignment = Alignment.CenterEnd
                                ) {
                                    Icon(
                                        imageVector = Icons.Filled.Delete,
                                        contentDescription = null,
                                        tint = MaterialTheme.colorScheme.error
                                    )
                                }
                            },
                            content = {
                                PostCard(
                                    post = post,
                                    onClick = { navController.navigate("post_detail/${post.id}") },
                                    onLikeClick = {},
                                    onCommentClick = { navController.navigate("post_detail/${post.id}") },
                                    onImageClick = { index -> navController.navigate("image_viewer/${post.id}/$index") },
                                    // ✅ 修复：补充缺少的参数
                                    onDeleteClick = { viewModel.deletePost(post.id) },
                                    onReportClick = { /* 自己的帖子不举报 */ },
                                    modifier = Modifier
                                )
                            }
                        )
                        if (index < uiState.posts.lastIndex) {
                            Divider()
                        }
                    }
                }
            }
        }
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\ui\myposts\MyPostsViewModel.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.ui.myposts

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.gosnow.app.ui.snowcircle.data.PostRepository
import com.gosnow.app.ui.snowcircle.model.Post
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch

data class MyPostsUiState(
    val isLoading: Boolean = false,
    val errorMessage: String? = null,
    val posts: List<Post> = emptyList()
)

class MyPostsViewModel(
    private val postRepository: PostRepository,
    private val currentUserId: String
) : ViewModel() {

    private val _uiState = MutableStateFlow(MyPostsUiState(isLoading = true))
    val uiState: StateFlow<MyPostsUiState> = _uiState.asStateFlow()

    init {
        refresh()
    }

    fun refresh() {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true, errorMessage = null) }
            runCatching { postRepository.getMyPosts(currentUserId) }
                .onSuccess { posts -> _uiState.update { it.copy(isLoading = false, posts = posts) } }
                .onFailure { e -> _uiState.update { it.copy(isLoading = false, errorMessage = e.message) } }
        }
    }

    fun deletePost(postId: String) {
        viewModelScope.launch {
            _uiState.update { it.copy(posts = it.posts.filterNot { post -> post.id == postId }) }
            runCatching { postRepository.deletePost(postId, currentUserId) }
                .onFailure { refresh() }
        }
    }
}

private inline fun <T> MutableStateFlow<T>.update(block: (T) -> T) {
    value = block(value)
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\ui\notifications\NotificationsScreen.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.ui.notifications

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material3.CircularProgressIndicator
import androidx.compose.material3.Divider
import androidx.compose.material3.ExperimentalMaterial3Api
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Scaffold
import androidx.compose.material3.Text
import androidx.compose.material3.TextButton
import androidx.compose.material3.TopAppBar
import androidx.compose.runtime.Composable
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import androidx.navigation.NavController
import com.gosnow.app.ui.snowcircle.model.NotificationItem
import com.gosnow.app.ui.snowcircle.model.NotificationType
import kotlinx.coroutines.launch

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun NotificationsScreen(viewModel: NotificationsViewModel, navController: NavController) {
    val uiState by viewModel.uiState.collectAsState()
    val scope = rememberCoroutineScope()

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("通知") },
                actions = {
                    TextButton(onClick = { viewModel.markAllRead() }) { Text("全部标为已读") }
                },
                navigationIcon = {
                    IconButton(onClick = { navController.popBackStack() }) {
                        Icon(Icons.Filled.ArrowBack, contentDescription = null)
                    }
                }
            )
        }
    ) { padding ->
        when {
            uiState.isLoading -> Box(modifier = Modifier.fillMaxSize().padding(padding), contentAlignment = Alignment.Center) {
                CircularProgressIndicator()
            }

            uiState.errorMessage != null -> Box(modifier = Modifier.fillMaxSize().padding(padding), contentAlignment = Alignment.Center) {
                Column(horizontalAlignment = Alignment.CenterHorizontally) {
                    Text(uiState.errorMessage!!)
                    TextButton(onClick = { viewModel.refresh() }) { Text("重试") }
                }
            }

            uiState.notifications.isEmpty() -> Box(modifier = Modifier.fillMaxSize().padding(padding), contentAlignment = Alignment.Center) {
                Text("暂无通知")
            }

            else -> LazyColumn(modifier = Modifier.fillMaxSize().padding(padding)) {
                items(uiState.notifications, key = { it.id }) { item ->
                    NotificationRow(item = item, onClick = {
                        scope.launch {
                            val postId = viewModel.onNotificationTapped(item.id)
                            if (postId != null) {
                                navController.navigate("post_detail/$postId")
                            }
                        }
                    })
                    Divider()
                }
            }
        }
    }
}

@Composable
private fun NotificationRow(item: NotificationItem, onClick: () -> Unit) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .clickable { onClick() }
            .padding(horizontal = 16.dp, vertical = 12.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        Column(modifier = Modifier.weight(1f)) {
            Text(notificationText(item), style = MaterialTheme.typography.bodyLarge)
            Text(item.createdAt, style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant)
        }
        if (!item.isRead) {
            Box(
                modifier = Modifier
                    .size(8.dp)
                    .background(color = MaterialTheme.colorScheme.error, shape = CircleShape)
            )
        }
    }
}

private fun notificationText(item: NotificationItem): String = when (item.type) {
    NotificationType.LIKE_POST -> "${item.actor.displayName} 赞了你的帖子"
    NotificationType.LIKE_COMMENT -> "${item.actor.displayName} 赞了你的评论"
    NotificationType.COMMENT_POST -> "${item.actor.displayName} 评论了你的帖子"
    NotificationType.REPLY_COMMENT -> "${item.actor.displayName} 回复了你的评论"
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\ui\notifications\NotificationsViewModel.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.ui.notifications

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.gosnow.app.ui.snowcircle.data.NotificationsRepository
import com.gosnow.app.ui.snowcircle.model.NotificationItem
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch

data class NotificationsUiState(
    val isLoading: Boolean = false,
    val errorMessage: String? = null,
    val notifications: List<NotificationItem> = emptyList()
)

class NotificationsViewModel(
    private val notificationsRepository: NotificationsRepository,
    private val currentUserId: String
) : ViewModel() {

    private val _uiState = MutableStateFlow(NotificationsUiState(isLoading = true))
    val uiState: StateFlow<NotificationsUiState> = _uiState.asStateFlow()

    init { refresh() }

    fun refresh() {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true, errorMessage = null) }
            runCatching { notificationsRepository.getNotifications(currentUserId) }
                .onSuccess { items -> _uiState.update { it.copy(isLoading = false, notifications = items) } }
                .onFailure { e -> _uiState.update { it.copy(isLoading = false, errorMessage = e.message) } }
        }
    }

    fun markAllRead() {
        viewModelScope.launch {
            notificationsRepository.markAllRead(currentUserId)
            refresh()
        }
    }

    suspend fun onNotificationTapped(notificationId: Long): String? {
        notificationsRepository.markRead(notificationId)
        val notification = _uiState.value.notifications.find { it.id == notificationId }
        refresh()
        return notification?.postId
    }
}

private inline fun <T> MutableStateFlow<T>.update(block: (T) -> T) {
    value = block(value)
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\ui\theme\Color.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.ui.theme

import androidx.compose.ui.graphics.Color

val SnowPrimary = Color(0xFF2A79FF)
val SnowSecondary = Color(0xFF89CFF0)
val SnowSurface = Color(0xFFF4F6FB)
val SnowError = Color(0xFFB00020)


==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\ui\theme\Theme.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.ui.theme

import androidx.compose.foundation.isSystemInDarkTheme
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.darkColorScheme
import androidx.compose.material3.lightColorScheme
import androidx.compose.runtime.Composable
import androidx.compose.ui.graphics.Color

private val LightColors = lightColorScheme(
    primary = SnowPrimary,
    secondary = SnowSecondary,
    surface = SnowSurface,
    background = Color.White,
    error = SnowError
)

// 虽然定义了深色，但我们不再使用它
private val DarkColors = darkColorScheme(
    primary = SnowPrimary,
    secondary = SnowSecondary,
    surface = Color(0xFF1B1B1B),
    background = Color(0xFF101010),
    error = SnowError
)

@Composable
fun SnowTheme(content: @Composable () -> Unit) {
    // ✅ 修改：直接强制使用 LightColors，忽略系统设置
    // val colors = if (isSystemInDarkTheme()) DarkColors else LightColors
    val colors = LightColors

    MaterialTheme(
        colorScheme = colors,
        typography = androidx.compose.material3.Typography(),
        content = content
    )
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\snowcircle\ui\viewer\ImageViewerScreen.kt
--------------------------------------------------
package com.gosnow.app.ui.snowcircle.ui.viewer

import androidx.compose.foundation.ExperimentalFoundationApi
import androidx.compose.foundation.background
import androidx.compose.foundation.gestures.detectTapGestures
import androidx.compose.foundation.gestures.rememberTransformableState
import androidx.compose.foundation.gestures.transformable
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.pager.HorizontalPager
import androidx.compose.foundation.pager.rememberPagerState
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material3.ExperimentalMaterial3Api
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.Scaffold
import androidx.compose.material3.TopAppBar
import androidx.compose.material3.TopAppBarDefaults
import androidx.compose.runtime.Composable
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableFloatStateOf
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.graphicsLayer
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.layout.ContentScale
import coil.compose.AsyncImage

@OptIn(ExperimentalMaterial3Api::class, ExperimentalFoundationApi::class)
@Composable
fun ImageViewerScreen(urls: List<String>, startIndex: Int, onBack: () -> Unit) {
    if (urls.isEmpty()) {
        onBack()
        return
    }

    val safeIndex = startIndex.coerceIn(0, urls.lastIndex)
    val pagerState = rememberPagerState(initialPage = safeIndex, pageCount = { urls.size })

    Scaffold(
        topBar = {
            // 只有当没有处于缩放状态时，才显示返回按钮，或者一直显示
            TopAppBar(
                title = { },
                navigationIcon = {
                    IconButton(onClick = onBack) {
                        Icon(Icons.Filled.ArrowBack, contentDescription = null, tint = Color.White)
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(containerColor = Color.Transparent)
            )
        },
        containerColor = Color.Black
    ) { _ ->
        HorizontalPager(
            state = pagerState,
            modifier = Modifier.fillMaxSize(),
            userScrollEnabled = true // 允许左右滑动切图
        ) { page ->
            // 为每一页单独管理缩放状态
            ZoomableImage(
                imageUrl = urls[page],
                onTap = onBack // 单击退出
            )
        }
    }
}

@Composable
fun ZoomableImage(imageUrl: String, onTap: () -> Unit) {
    var scale by remember { mutableFloatStateOf(1f) }
    var offset by remember { mutableStateOf(Offset.Zero) }

    // 简单的双击缩放逻辑
    val state = rememberTransformableState { zoomChange, panChange, _ ->
        scale = (scale * zoomChange).coerceIn(1f, 3f) // 限制缩放倍数 1x - 3x

        // 只有放大时才允许拖动
        if (scale > 1f) {
            val extraWidth = (scale - 1) * 1000 // 简略估算边界
            val extraHeight = (scale - 1) * 1000
            offset += panChange
        } else {
            offset = Offset.Zero
        }
    }

    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(Color.Black)
            // 处理手势：双击放大，单击退出，捏合缩放
            .pointerInput(Unit) {
                detectTapGestures(
                    onDoubleTap = {
                        // 双击：如果在放大状态则还原，否则放大到 2 倍
                        if (scale > 1f) {
                            scale = 1f
                            offset = Offset.Zero
                        } else {
                            scale = 2f
                        }
                    },
                    onTap = {
                        onTap()
                    }
                )
            }
            .transformable(state = state),
        contentAlignment = Alignment.Center
    ) {
        AsyncImage(
            model = imageUrl,
            contentDescription = null,
            contentScale = ContentScale.Fit,
            modifier = Modifier
                .fillMaxSize()
                .graphicsLayer(
                    scaleX = scale,
                    scaleY = scale,
                    translationX = offset.x,
                    translationY = offset.y
                )
        )
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\stats\StatsScreen.kt
--------------------------------------------------
package com.gosnow.app.ui.stats

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Surface
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.runtime.collectAsState
import androidx.compose.ui.platform.LocalContext
import androidx.lifecycle.viewmodel.compose.viewModel

// 和 SwiftUI 对齐的概念
enum class StatsScope { WEEK, MONTH, SEASON }

// 只保留两个指标：滑行时间 / 滑行里程
enum class StatsMetric { DURATION, DISTANCE }

// 单个点（X 轴标签 + 数值）
data class StatsPoint(
    val label: String,
    val value: Float
)

// 概览数据（去掉雪天数）
data class StatsSummary(
    val totalDurationMin: Int,
    val totalDistanceKm: Float,
    val sessionsCount: Int
)

@Composable
fun StatsScreen(
    modifier: Modifier = Modifier
) {
    val context = LocalContext.current
    val vm: StatsViewModel = viewModel(factory = StatsViewModel.provideFactory(context))
    val ui by vm.uiState.collectAsState()

    Column(
        modifier = modifier
            .fillMaxSize()
            .padding(vertical = 16.dp),
        verticalArrangement = Arrangement.spacedBy(16.dp)
    ) {
        Text(
            text = "活动",
            style = MaterialTheme.typography.headlineMedium.copy(
                fontWeight = FontWeight.Bold
            ),
            modifier = Modifier.padding(horizontal = 16.dp)
        )

        ScopeSegmentedRow(
            scope = ui.scope,
            onScopeChange = { vm.setScope(it) },
            modifier = Modifier.padding(horizontal = 16.dp)
        )

        SimpleBarChart(
            points = ui.points,
            metric = ui.metric,
            modifier = Modifier
                .fillMaxWidth()
                .height(220.dp)
                .padding(horizontal = 8.dp)
        )

        SummaryRow(
            summary = ui.summary,
            metric = ui.metric,
            onMetricChange = { vm.setMetric(it) },
            modifier = Modifier.padding(horizontal = 16.dp)
        )

        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(
                text = "记录次数",
                style = MaterialTheme.typography.bodyMedium.copy(
                    color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.6f)
                )
            )
            Spacer(modifier = Modifier.weight(1f))
            Text(
                text = "${ui.summary.sessionsCount} 次",
                style = MaterialTheme.typography.bodyMedium
            )
        }

        Spacer(modifier = Modifier.height(12.dp))
    }
}
/* ---------------- 顶部「周 / 月 / 雪季」选择 ---------------- */

@Composable
private fun ScopeSegmentedRow(
    scope: StatsScope,
    onScopeChange: (StatsScope) -> Unit,
    modifier: Modifier = Modifier
) {
    val bg = MaterialTheme.colorScheme.surfaceVariant

    Row(
        modifier = modifier
            .fillMaxWidth()
            .clip(RoundedCornerShape(999.dp))
            .background(bg)
            .padding(4.dp),
        horizontalArrangement = Arrangement.spacedBy(4.dp)
    ) {
        ScopeChip(
            text = "周",
            value = StatsScope.WEEK,
            selected = scope == StatsScope.WEEK,
            onScopeChange = onScopeChange,
            modifier = Modifier.weight(1f)
        )
        ScopeChip(
            text = "月",
            value = StatsScope.MONTH,
            selected = scope == StatsScope.MONTH,
            onScopeChange = onScopeChange,
            modifier = Modifier.weight(1f)
        )
        ScopeChip(
            text = "雪季",
            value = StatsScope.SEASON,
            selected = scope == StatsScope.SEASON,
            onScopeChange = onScopeChange,
            modifier = Modifier.weight(1f)
        )
    }
}

@Composable
private fun ScopeChip(
    text: String,
    value: StatsScope,
    selected: Boolean,
    onScopeChange: (StatsScope) -> Unit,
    modifier: Modifier = Modifier
) {
    val selectedBg = MaterialTheme.colorScheme.primary
    val selectedFg = MaterialTheme.colorScheme.onPrimary
    val unselectedFg = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.7f)

    Box(
        modifier = modifier
            .clip(RoundedCornerShape(999.dp))
            .background(if (selected) selectedBg else Color.Transparent)
            .clickable { onScopeChange(value) }
            .padding(vertical = 8.dp),
        contentAlignment = Alignment.Center
    ) {
        Text(
            text = text,
            color = if (selected) selectedFg else unselectedFg,
            style = MaterialTheme.typography.bodyMedium.copy(fontWeight = FontWeight.Medium)
        )
    }
}

/* ---------------- 柱状图（滑行时间 / 滑行里程用） ---------------- */

@Composable
fun SimpleBarChart(
    points: List<StatsPoint>,
    metric: StatsMetric,
    modifier: Modifier = Modifier
) {
    val barColor = when (metric) {
        StatsMetric.DURATION -> Color(0xFFFF9800)   // 橙色：滑行时间
        StatsMetric.DISTANCE -> Color(0xFF4CAF50)   // 绿色：滑行里程
    }

    Column(
        modifier = modifier,
        verticalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        // Y 轴单位
        Text(
            text = when (metric) {
                StatsMetric.DURATION -> "单位：小时"
                StatsMetric.DISTANCE -> "单位：公里"
            },
            style = MaterialTheme.typography.bodySmall.copy(
                color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.6f)
            ),
            modifier = Modifier.padding(start = 16.dp)
        )

        if (points.isEmpty()) {
            Box(
                modifier = Modifier.fillMaxSize(),
                contentAlignment = Alignment.Center
            ) {
                Text(
                    text = "暂无数据",
                    color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.5f)
                )
            }
            return
        }

        // 自适应最大值，但给一个下限，避免全是很小的数时柱子太夸张
        val minMax = when (metric) {
            StatsMetric.DURATION -> 0.5f   // 至少按 0.5 小时来算
            StatsMetric.DISTANCE -> 1f     // 至少 1km
        }
        val max = points.maxOfOrNull { it.value }?.coerceAtLeast(minMax) ?: minMax

        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp)
                .height(180.dp),
            horizontalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            points.forEach { p ->
                Column(
                    modifier = Modifier
                        .weight(1f)
                        .fillMaxHeight(),
                    horizontalAlignment = Alignment.CenterHorizontally
                ) {
                    // 上半部分：柱子 + 数值
                    Box(
                        modifier = Modifier
                            .weight(1f)
                            .fillMaxWidth(),
                        contentAlignment = Alignment.BottomCenter
                    ) {
                        if (p.value > 0f) {
                            // 自适应比例 + 留一点顶部空隙（最多 85% 高度）
                            val rawFraction = p.value / max
                            val fraction = (rawFraction.coerceIn(0f, 1f)) * 0.85f

                            // 柱子
                            Box(
                                modifier = Modifier
                                    .fillMaxWidth(0.6f)
                                    .fillMaxHeight(fraction)
                                    .clip(RoundedCornerShape(6.dp))
                                    .background(barColor)
                            )

                            // 数值
                            val valueText = when (metric) {
                                StatsMetric.DURATION ->
                                    String.format("%.1f", p.value)   // 小时，一位小数
                                StatsMetric.DISTANCE ->
                                    p.value.toInt().toString()       // km
                            }

                            Text(
                                text = valueText,
                                fontSize = 11.sp,
                                color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.65f),
                                maxLines = 1,
                                overflow = TextOverflow.Clip,
                                modifier = Modifier
                                    .align(Alignment.TopCenter)
                                    .padding(bottom = 2.dp)
                            )
                        }
                    }

                    Spacer(modifier = Modifier.height(6.dp))

                    // 底部：X 轴标签
                    Text(
                        text = p.label,
                        fontSize = 11.sp,
                        maxLines = 1,
                        overflow = TextOverflow.Ellipsis
                    )
                }
            }
        }
    }
}

/* ---------------- 底部两张 Summary 卡片 ---------------- */

@Composable
private fun SummaryRow(
    summary: StatsSummary,
    metric: StatsMetric,
    onMetricChange: (StatsMetric) -> Unit,
    modifier: Modifier = Modifier
) {
    Row(
        modifier = modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.spacedBy(12.dp)
    ) {
        SummaryCard(
            title = "滑行时间",
            value = formatDuration(summary.totalDurationMin),
            selected = metric == StatsMetric.DURATION,
            color = Color(0xFFFF9800),
            onClick = { onMetricChange(StatsMetric.DURATION) },
            modifier = Modifier.weight(1f)
        )

        SummaryCard(
            title = "滑行里程",
            value = String.format("%.1f km", summary.totalDistanceKm),
            selected = metric == StatsMetric.DISTANCE,
            color = Color(0xFF4CAF50),
            onClick = { onMetricChange(StatsMetric.DISTANCE) },
            modifier = Modifier.weight(1f)
        )
    }
}

@Composable
private fun SummaryCard(
    title: String,
    value: String,
    selected: Boolean,
    color: Color,
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    val bg = if (selected) color else MaterialTheme.colorScheme.surfaceVariant
    val fg = if (selected) Color.White else MaterialTheme.colorScheme.onSurface

    Surface(
        modifier = modifier
            .defaultMinSize(minHeight = 84.dp)
            .shadow(if (selected) 10.dp else 0.dp, RoundedCornerShape(14.dp))
            .clip(RoundedCornerShape(14.dp))
            .clickable { onClick() },
        color = bg
    ) {
        Column(
            modifier = Modifier
                .padding(16.dp),
            verticalArrangement = Arrangement.spacedBy(6.dp),
            horizontalAlignment = Alignment.Start
        ) {
            Text(
                text = value,
                fontSize = 22.sp,
                fontWeight = FontWeight.SemiBold,
                color = fg,
                maxLines = 1,
                softWrap = false,
                overflow = TextOverflow.Clip
            )

            Text(
                text = title,
                fontSize = 12.sp,
                fontWeight = FontWeight.Medium,
                color = fg.copy(alpha = if (selected) 0.95f else 0.75f)
            )
        }
    }
}

/* ---------------- 小工具：分钟 -> “x小时y分” ---------------- */

private fun formatDuration(totalMin: Int): String {
    val h = totalMin / 60
    val m = totalMin % 60
    return if (h > 0) {
        "${h}小时${m}分"
    } else {
        "$m 分钟"
    }
}

/* ---------------- 预览 ---------------- */

@Preview(showBackground = true)
@Composable
private fun StatsScreenPreview() {
    MaterialTheme {
        StatsScreen()
    }
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\stats\StatsViewModel.kt
--------------------------------------------------
package com.gosnow.app.ui.stats

import android.content.Context
import androidx.lifecycle.ViewModel
import androidx.lifecycle.ViewModelProvider
import androidx.lifecycle.viewModelScope
import com.gosnow.app.ui.record.storage.FileSessionStore
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.update
import kotlinx.coroutines.launch
import java.time.DayOfWeek
import java.time.Instant
import java.time.LocalDate
import java.time.YearMonth
import java.time.ZoneId
import java.time.temporal.TemporalAdjusters

data class StatsUiState(
    val scope: StatsScope = StatsScope.WEEK,
    val metric: StatsMetric = StatsMetric.DURATION,
    val points: List<StatsPoint> = emptyList(),
    val summary: StatsSummary = StatsSummary(
        totalDurationMin = 0,
        totalDistanceKm = 0f,
        sessionsCount = 0
    )
)

class StatsViewModel(
    private val store: FileSessionStore
) : ViewModel() {

    private val _uiState = MutableStateFlow(StatsUiState())
    val uiState: StateFlow<StatsUiState> = _uiState

    init {
        refresh()
    }

    fun setScope(scope: StatsScope) {
        _uiState.update { it.copy(scope = scope) }
        refresh()
    }

    fun setMetric(metric: StatsMetric) {
        _uiState.update { it.copy(metric = metric) }
        refresh()
    }

    fun refresh() {
        viewModelScope.launch {
            val all = store.loadSessions()

            val zone = ZoneId.systemDefault()
            fun sessionDate(millis: Long): LocalDate =
                Instant.ofEpochMilli(millis).atZone(zone).toLocalDate()

            val today = LocalDate.now(zone)
            val scope = _uiState.value.scope
            val metric = _uiState.value.metric

            // 1) 先筛出当前 scope 的 sessions
            val scoped = when (scope) {
                StatsScope.WEEK -> {
                    val start = today.with(TemporalAdjusters.previousOrSame(DayOfWeek.MONDAY))
                    val end = start.plusDays(7)
                    all.filter {
                        val d = sessionDate(it.startAtMillis)
                        !d.isBefore(start) && d.isBefore(end)
                    }
                }

                StatsScope.MONTH -> {
                    val start = today.withDayOfMonth(1)
                    val end = start.plusMonths(1)
                    all.filter {
                        val d = sessionDate(it.startAtMillis)
                        !d.isBefore(start) && d.isBefore(end)
                    }
                }

                StatsScope.SEASON -> {
                    // 雪季：11 月 ~ 次年 4 月
                    val seasonStartYear = if (today.monthValue >= 11) today.year else today.year - 1
                    val start = LocalDate.of(seasonStartYear, 11, 1)
                    val end = LocalDate.of(seasonStartYear + 1, 5, 1) // 5月1日为开区间
                    all.filter {
                        val d = sessionDate(it.startAtMillis)
                        !d.isBefore(start) && d.isBefore(end)
                    }
                }
            }

            fun metricValueHoursOrKm(durationSec: Int, distanceKm: Double): Float {
                return when (metric) {
                    StatsMetric.DURATION -> (durationSec.toFloat() / 3600f) // 小时
                    StatsMetric.DISTANCE -> distanceKm.toFloat()            // 公里
                }
            }

            // 2) 生成 points
            val points = when (scope) {
                StatsScope.WEEK -> {
                    val start = today.with(TemporalAdjusters.previousOrSame(DayOfWeek.MONDAY))
                    val labels = listOf("一", "二", "三", "四", "五", "六", "日")
                    (0..6).map { i ->
                        val day = start.plusDays(i.toLong())
                        val v = scoped
                            .filter { sessionDate(it.startAtMillis) == day }
                            .sumOf { metricValueHoursOrKm(it.durationSec, it.distanceKm.toDouble()).toDouble() }
                            .toFloat()
                        StatsPoint(labels[i], v)
                    }
                }

                StatsScope.MONTH -> {
                    // 固定 4 段：1–7、8–14、15–21、22–月底
                    val ym = YearMonth.from(today)
                    val endDay = ym.lengthOfMonth()

                    fun bucket(day: Int): Int = when {
                        day in 1..7 -> 0
                        day in 8..14 -> 1
                        day in 15..21 -> 2
                        else -> 3
                    }

                    val sums = FloatArray(4)
                    scoped.forEach {
                        val d = sessionDate(it.startAtMillis)
                        val b = bucket(d.dayOfMonth)
                        sums[b] += metricValueHoursOrKm(it.durationSec, it.distanceKm.toDouble())
                    }

                    listOf(
                        StatsPoint("1-7日", sums[0]),
                        StatsPoint("8-14日", sums[1]),
                        StatsPoint("15-21日", sums[2]),
                        StatsPoint("22-月底", sums[3]),
                    )
                }

                StatsScope.SEASON -> {
                    val seasonStartYear = if (today.monthValue >= 11) today.year else today.year - 1
                    val months = listOf(
                        YearMonth.of(seasonStartYear, 11) to "11月",
                        YearMonth.of(seasonStartYear, 12) to "12月",
                        YearMonth.of(seasonStartYear + 1, 1) to "1月",
                        YearMonth.of(seasonStartYear + 1, 2) to "2月",
                        YearMonth.of(seasonStartYear + 1, 3) to "3月",
                        YearMonth.of(seasonStartYear + 1, 4) to "4月",
                    )

                    months.map { (ym, label) ->
                        val v = scoped
                            .filter { YearMonth.from(sessionDate(it.startAtMillis)) == ym }
                            .sumOf { metricValueHoursOrKm(it.durationSec, it.distanceKm.toDouble()).toDouble() }
                            .toFloat()
                        StatsPoint(label, v)
                    }
                }
            }

            // 3) Summary（跟随 scope）
            val totalDurationMin = scoped.sumOf { it.durationSec } / 60
            val totalDistanceKm = scoped.sumOf { it.distanceKm }.toFloat()
            val sessionsCount = scoped.size

            _uiState.update {
                it.copy(
                    points = points,
                    summary = StatsSummary(
                        totalDurationMin = totalDurationMin,
                        totalDistanceKm = totalDistanceKm,
                        sessionsCount = sessionsCount
                    )
                )
            }
        }
    }

    companion object {
        fun provideFactory(context: Context): ViewModelProvider.Factory =
            object : ViewModelProvider.Factory {
                @Suppress("UNCHECKED_CAST")
                override fun <T : ViewModel> create(modelClass: Class<T>): T {
                    return StatsViewModel(
                        store = FileSessionStore(context.applicationContext)
                    ) as T
                }
            }
    }
}




==================================================

File: app\src\main\java\com\gosnow\app\ui\theme\Color.kt
--------------------------------------------------
package com.gosnow.app.ui.theme

import androidx.compose.ui.graphics.Color

val Purple80 = Color(0xFFD0BCFF)
val PurpleGrey80 = Color(0xFFCCC2DC)
val Pink80 = Color(0xFFEFB8C8)

val Purple40 = Color(0xFF6650a4)
val PurpleGrey40 = Color(0xFF625b71)
val Pink40 = Color(0xFF7D5260)

==================================================

File: app\src\main\java\com\gosnow\app\ui\theme\Theme.kt
--------------------------------------------------
package com.gosnow.app.ui.theme

import android.os.Build
import androidx.compose.foundation.isSystemInDarkTheme
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.darkColorScheme
import androidx.compose.material3.dynamicDarkColorScheme
import androidx.compose.material3.dynamicLightColorScheme
import androidx.compose.material3.lightColorScheme
import androidx.compose.runtime.Composable
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext

private val DarkColorScheme = darkColorScheme(
    primary = Color(0xFF111111),
    onPrimary = Color.White,
    secondary = Color(0xFF444444),
    onSecondary = Color.White,
    background = Color.Black,
    onBackground = Color.White,
    surface = Color(0xFF121212),
    onSurface = Color.White
)

private val LightColorScheme = lightColorScheme(
    primary = Color(0xFF111111),
    onPrimary = Color.White,
    secondary = Color(0xFF4F4F4F),
    onSecondary = Color.White,
    background = Color(0xFFFDFDFD),
    onBackground = Color(0xFF0F172A),
    surface = Color(0xFFFFFFFF),
    onSurface = Color(0xFF0F172A)
)

@Composable
fun GosnowTheme(
    darkTheme: Boolean = false,
    dynamicColor: Boolean = true,
    content: @Composable () -> Unit
) {
    val colorScheme = when {
        dynamicColor && Build.VERSION.SDK_INT >= Build.VERSION_CODES.S -> {
            val context = LocalContext.current
            // 2. 即使开启动态取色，也强制使用 浅色(Light) 的动态色
            dynamicLightColorScheme(context)
        }

        darkTheme -> DarkColorScheme
        else -> LightColorScheme
    }

    MaterialTheme(
        colorScheme = colorScheme,
        typography = Typography,
        content = content
    )
}


==================================================

File: app\src\main\java\com\gosnow\app\ui\theme\Type.kt
--------------------------------------------------
package com.gosnow.app.ui.theme

import androidx.compose.material3.Typography
import androidx.compose.ui.text.TextStyle
import androidx.compose.ui.text.font.FontFamily
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.sp

// Set of Material typography styles to start with
val Typography = Typography(
    bodyLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Normal,
        fontSize = 16.sp,
        lineHeight = 24.sp,
        letterSpacing = 0.5.sp
    )
    /* Other default text styles to override
    titleLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Normal,
        fontSize = 22.sp,
        lineHeight = 28.sp,
        letterSpacing = 0.sp
    ),
    labelSmall = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Medium,
        fontSize = 11.sp,
        lineHeight = 16.sp,
        letterSpacing = 0.5.sp
    )
    */
)

==================================================

File: app\src\main\java\com\gosnow\app\ui\update\UpdateDialog.kt
--------------------------------------------------
package com.gosnow.app.ui.update

import android.content.Intent
import android.net.Uri
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.window.Dialog
import androidx.compose.ui.window.DialogProperties
import coil.compose.AsyncImage
import com.gosnow.app.data.update.AppUpdateNotice

@Composable
fun UpdateNoticeDialog(
    notice: AppUpdateNotice,
    onDismiss: () -> Unit
) {
    val context = LocalContext.current

    Dialog(
        onDismissRequest = {
            if (!notice.isForce) onDismiss()
        },
        properties = DialogProperties(
            dismissOnBackPress = !notice.isForce,
            dismissOnClickOutside = !notice.isForce
        )
    ) {
        Card(
            shape = RoundedCornerShape(24.dp),
            colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
            modifier = Modifier.fillMaxWidth()
        ) {
            Column {
                if (!notice.bannerUrl.isNullOrBlank()) {
                    AsyncImage(
                        model = notice.bannerUrl,
                        contentDescription = null,
                        contentScale = ContentScale.Crop,
                        modifier = Modifier.fillMaxWidth().height(140.dp)
                    )
                }

                Column(
                    modifier = Modifier.padding(24.dp),
                    horizontalAlignment = Alignment.CenterHorizontally
                ) {
                    Text(
                        text = notice.title,
                        style = MaterialTheme.typography.headlineSmall.copy(fontWeight = FontWeight.Bold)
                    )
                    Spacer(modifier = Modifier.height(12.dp))
                    Text(
                        text = notice.message,
                        style = MaterialTheme.typography.bodyMedium,
                        lineHeight = 24.sp
                    )
                    Spacer(modifier = Modifier.height(24.dp))

                    Button(
                        onClick = {
                            val intent = Intent(Intent.ACTION_VIEW, Uri.parse(notice.downloadUrl))
                            context.startActivity(intent)
                        },
                        modifier = Modifier.fillMaxWidth().height(48.dp)
                    ) {
                        Text("立即更新")
                    }

                    if (!notice.isForce) {
                        Spacer(modifier = Modifier.height(8.dp))
                        TextButton(onClick = onDismiss, modifier = Modifier.fillMaxWidth()) {
                            Text("稍后更新", color = MaterialTheme.colorScheme.onSurfaceVariant)
                        }
                    }
                }
            }
        }
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\update\UpdateViewModel.kt
--------------------------------------------------
package com.gosnow.app.ui.update

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.gosnow.app.BuildConfig
import com.gosnow.app.data.update.AppUpdateNotice
import com.gosnow.app.data.update.UpdateRepository
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch

class UpdateViewModel : ViewModel() {

    private val _updateNotice = MutableStateFlow<AppUpdateNotice?>(null)
    val updateNotice: StateFlow<AppUpdateNotice?> = _updateNotice.asStateFlow()

    private var hasChecked = false

    fun checkForUpdates() {
        if (hasChecked) return
        hasChecked = true

        viewModelScope.launch {
            val notice = UpdateRepository.checkUpdate() ?: return@launch

            // 获取当前 App 的版本号 (需要在 build.gradle 中配置 versionCode)
            val currentVersionCode = BuildConfig.VERSION_CODE
            val latestBuild = notice.latestBuild ?: 0

            // 只有当云端版本号 > 当前版本号时，才显示弹窗
            if (latestBuild > currentVersionCode) {
                _updateNotice.value = notice
            }
        }
    }

    fun dismissUpdate() {
        if (_updateNotice.value?.isForce == false) {
            _updateNotice.value = null
        }
    }
}

==================================================

File: app\src\main\java\com\gosnow\app\ui\welcome\WelcomeFlowScreen.kt
--------------------------------------------------
package com.gosnow.app.ui.welcome

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.DownhillSkiing
import androidx.compose.material.icons.filled.Explore
import androidx.compose.material.icons.filled.Map
import androidx.compose.material3.Button
import androidx.compose.material3.Icon
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Surface
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableIntStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp

@Composable
fun WelcomeFlowScreen(
    onFinished: () -> Unit
) {
    val pages = listOf(
        WelcomePageData(
            title = "雪场伙伴",
            description = "记录你的滑行足迹，结识更多滑雪同好。",
            icon = Icons.Filled.DownhillSkiing
        ),
        WelcomePageData(
            title = "探索雪圈",
            description = "发现雪场活动、攻略与失物招领信息。",
            icon = Icons.Filled.Explore
        ),
        WelcomePageData(
            title = "准备出发",
            description = "开启雪兔滑行，安全又有趣的滑雪体验即将开始。",
            icon = Icons.Filled.Map
        )
    )

    var currentPage by remember { mutableIntStateOf(0) }

    Surface(modifier = Modifier.fillMaxSize()) {
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(24.dp),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.SpaceBetween
        ) {
            Spacer(modifier = Modifier.height(12.dp))

            Column(
                modifier = Modifier.fillMaxWidth(),
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                Icon(
                    imageVector = pages[currentPage].icon,
                    contentDescription = null,
                    tint = MaterialTheme.colorScheme.primary,
                    modifier = Modifier
                        .padding(top = 48.dp)
                        .height(88.dp)
                )
                Spacer(modifier = Modifier.height(24.dp))
                Text(
                    text = pages[currentPage].title,
                    style = MaterialTheme.typography.headlineSmall.copy(fontWeight = FontWeight.Bold)
                )
                Spacer(modifier = Modifier.height(12.dp))
                Text(
                    text = pages[currentPage].description,
                    style = MaterialTheme.typography.bodyLarge,
                    textAlign = TextAlign.Center
                )
            }

            Column(
                modifier = Modifier.fillMaxWidth()
            ) {
                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(vertical = 12.dp),
                    horizontalArrangement = Arrangement.Center
                ) {
                    pages.forEachIndexed { index, _ ->
                        val isSelected = index == currentPage
                        Box(
                            modifier = Modifier
                                .padding(horizontal = 4.dp)
                                .height(10.dp)
                                .clip(CircleShape)
                                .background(
                                    if (isSelected) MaterialTheme.colorScheme.primary else Color(0xFFE5E7EB)
                                )
                                .weight(if (isSelected) 1.5f else 1f)
                        )
                    }
                }

                Button(
                    onClick = {
                        if (currentPage < pages.lastIndex) {
                            currentPage += 1
                        } else {
                            onFinished()
                        }
                    },
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(top = 8.dp)
                ) {
                    Text(
                        text = if (currentPage < pages.lastIndex) "下一步" else "开始使用雪兔滑行",
                        fontSize = 16.sp
                    )
                }
            }
        }
    }
}

private data class WelcomePageData(
    val title: String,
    val description: String,
    val icon: androidx.compose.ui.graphics.vector.ImageVector
)


==================================================

File: app\src\main\java\com\gosnow\app\ui\welcome\WelcomePages.kt
--------------------------------------------------
package com.gosnow.app.ui.welcome

import  androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.outlined.AutoAwesome
import androidx.compose.material.icons.outlined.Campaign
import androidx.compose.material.icons.outlined.Edit
import androidx.compose.material.icons.outlined.LocationOn
import androidx.compose.material.icons.outlined.Map
import androidx.compose.material.icons.outlined.MenuBook
import androidx.compose.material.icons.outlined.Search
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Icon
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableIntStateOf
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.foundation.layout.navigationBarsPadding
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.outlined.AcUnit
import androidx.compose.material.icons.outlined.ChatBubbleOutline
import androidx.compose.material.icons.outlined.DirectionsCar
import androidx.compose.material.icons.outlined.QueryStats

// -------- Welcome Page 1 --------

@Composable
fun WelcomePage1(
    modifier: Modifier = Modifier
) {
    Column(
        modifier = modifier
            .fillMaxSize()
            .padding(horizontal = 24.dp, vertical = 32.dp)
            .verticalScroll(rememberScrollState()),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center          // ✅ 关键：整体往中间靠
    ) {
        // 不要再加顶部 Spacer 了

        Text(
            text = "欢迎使用上雪",
            style = MaterialTheme.typography.headlineLarge.copy(
                fontWeight = FontWeight.Bold
            ),
            textAlign = TextAlign.Center
        )

        Spacer(modifier = Modifier.height(8.dp))

        Text(
            text = "上雪是一款专注滑雪场景的工具。",
            style = MaterialTheme.typography.bodyLarge.copy(
                fontWeight = FontWeight.Medium
            ),
            color = MaterialTheme.colorScheme.onBackground.copy(alpha = 0.8f),
            textAlign = TextAlign.Center,
            modifier = Modifier.padding(horizontal = 12.dp)
        )

        Spacer(modifier = Modifier.height(32.dp))

        Column(
            modifier = Modifier.fillMaxWidth(),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            BannerRow(
                icon = Icons.Outlined.AutoAwesome,
                iconBgColor = MaterialTheme.colorScheme.primary.copy(alpha = 0.12f),
                title = "轻量上手，回归工具本质",
                subtitle = "即开即用，没有复杂的流程和冗余内容。"
            )

            BannerRow(
                icon = Icons.Outlined.QueryStats,
                iconBgColor = MaterialTheme.colorScheme.secondary.copy(alpha = 0.12f),
                title = "数据记录，一目了然",
                subtitle = "用数字和图表展现你的生涯数据。"
            )

            BannerRow(
                icon = Icons.Outlined.Map,
                iconBgColor = MaterialTheme.colorScheme.tertiary.copy(alpha = 0.12f),
                title = "雪场雪况，一站浏览",
                subtitle = "结合雪友分享与基础信息，帮你快速选好雪场。"
            )
        }
    }
}




// -------- Welcome Page 2 --------

@Composable
fun WelcomePage2(
    modifier: Modifier = Modifier
) {
    Column(
        modifier = modifier
            .fillMaxSize()
            .padding(horizontal = 24.dp, vertical = 32.dp)
            .verticalScroll(rememberScrollState()),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center          // ✅ 同样居中
    ) {
        Text(
            text = "雪场的一天，都能用得上",
            style = MaterialTheme.typography.headlineLarge.copy(
                fontWeight = FontWeight.Bold
            ),
            textAlign = TextAlign.Center
        )

        Spacer(modifier = Modifier.height(8.dp))

        Text(
            text = "从出发到收板，上雪帮你解决更多细节。",
            style = MaterialTheme.typography.bodyLarge.copy(
                fontWeight = FontWeight.Medium
            ),
            color = MaterialTheme.colorScheme.onBackground.copy(alpha = 0.8f),
            textAlign = TextAlign.Center,
            modifier = Modifier.padding(horizontal = 12.dp)
        )

        Spacer(modifier = Modifier.height(32.dp))

        Column(
            modifier = Modifier.fillMaxWidth(),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            BannerRow(
                icon = Icons.Outlined.Search,
                iconBgColor = MaterialTheme.colorScheme.primary.copy(alpha = 0.12f),
                title = "失物招领，更快找回",
                subtitle = "在雪场发现或丢失物品时，快速发布与查找信息。"
            )

            BannerRow(
                icon = Icons.Outlined.ChatBubbleOutline,
                iconBgColor = MaterialTheme.colorScheme.secondary.copy(alpha = 0.12f),
                title = "雪圈社区，分享雪季生活",
                subtitle = "和雪友交流雪况、装备与出行经验。"
            )

            BannerRow(
                icon = Icons.Outlined.DirectionsCar,
                iconBgColor = MaterialTheme.colorScheme.tertiary.copy(alpha = 0.12f),
                title = "顺风车，目的地匹配",
                subtitle = "车找人、人找车"
            )
        }
    }
}




// -------- Welcome Page 3 --------

@Composable
fun WelcomePage3(
    modifier: Modifier = Modifier
) {
    Column(
        modifier = modifier
            .fillMaxSize()
            .padding(horizontal = 24.dp, vertical = 32.dp)
            .verticalScroll(rememberScrollState()),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center          // ✅ 也居中
    ) {
        Text(
            text = "上雪，和你一起完善",
            style = MaterialTheme.typography.headlineLarge.copy(
                fontWeight = FontWeight.Bold
            ),
            textAlign = TextAlign.Center
        )

        Spacer(modifier = Modifier.height(8.dp))

        Text(
            text = "你的一次补充，能帮到很多雪友。现在就开始吧！",
            style = MaterialTheme.typography.bodyLarge.copy(
                fontWeight = FontWeight.Medium
            ),
            color = MaterialTheme.colorScheme.onBackground.copy(alpha = 0.8f),
            textAlign = TextAlign.Center,
            modifier = Modifier.padding(horizontal = 12.dp)
        )

        Spacer(modifier = Modifier.height(32.dp))

        Column(
            modifier = Modifier.fillMaxWidth(),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            BannerRow(
                icon = Icons.Outlined.AcUnit,
                iconBgColor = MaterialTheme.colorScheme.primary.copy(alpha = 0.12f),
                title = "一起把滑雪信息做对、做全",
                subtitle = "开放更新、真实分享、共同完善。"
            )

            BannerRow(
                icon = Icons.Outlined.AutoAwesome,
                iconBgColor = MaterialTheme.colorScheme.secondary.copy(alpha = 0.12f),
                title = "持续更新 · 更多精彩",
                subtitle = "功能会不断上线，欢迎提出建议与反馈。"
            )

            BannerRow(
                icon = Icons.Outlined.ChatBubbleOutline,
                iconBgColor = MaterialTheme.colorScheme.tertiary.copy(alpha = 0.12f),
                title = "倾听体验，不断改进",
                subtitle = "我们会根据雪友的真实使用感受持续优化细节。"
            )
        }
    }
}




// -------- 复用的小行组件：图标 + 文本 --------

@Composable
private fun FeatureRow(
    icon: ImageVector,
    iconTint: Color,
    text: String
) {
    Row(
        modifier = Modifier.fillMaxWidth(),
        verticalAlignment = Alignment.Top
    ) {
        Icon(
            imageVector = icon,
            contentDescription = null,
            tint = iconTint,
            modifier = Modifier.size(28.dp)
        )

        Spacer(modifier = Modifier.width(16.dp))

        Text(
            text = text,
            style = MaterialTheme.typography.bodyLarge.copy(   // 放大一号
                fontWeight = FontWeight.Medium
            ),
            color = MaterialTheme.colorScheme.onBackground,
            modifier = Modifier.weight(1f)
        )
    }
}


// -------- 整个 Welcome Flow 容器（3 页，底部指示点 + 按钮） --------

@Composable
fun WelcomeFlowScreenWithIcons(
    onFinished: () -> Unit
) {
    var page by rememberSaveable { mutableIntStateOf(0) }
    val pageCount = 3

    Column(
        modifier = Modifier.fillMaxSize()
    ) {
        // 上方内容区域
        Box(
            modifier = Modifier
                .weight(1f)
                .fillMaxWidth()
        ) {
            when (page) {
                0 -> WelcomePage1()
                1 -> WelcomePage2()
                2 -> WelcomePage3()
            }
        }

        // 下方指示点 + 按钮
        Column(
            modifier = Modifier
                .fillMaxWidth()
                // 先把内容抬离系统导航栏
                .navigationBarsPadding()
                // 再额外加一点 bottom padding，让按钮整体更往上
                .padding(
                    start = 24.dp,
                    end = 24.dp,
                    top = 16.dp,
                    bottom = 32.dp   // 原来是 vertical = 16.dp，这里加大 bottom
                ),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            // 页指示点
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.Center,
                verticalAlignment = Alignment.CenterVertically
            ) {
                repeat(pageCount) { index ->
                    val selected = index == page
                    Box(
                        modifier = Modifier
                            .padding(horizontal = 4.dp)
                            .height(8.dp)
                            .width(if (selected) 18.dp else 8.dp)
                            .background(
                                color = if (selected)
                                    MaterialTheme.colorScheme.onBackground
                                else
                                    MaterialTheme.colorScheme.onBackground.copy(alpha = 0.3f),
                                shape = MaterialTheme.shapes.small
                            )
                    )
                }
            }

            Spacer(modifier = Modifier.height(16.dp))

            // 主按钮：改成黑色，并稍微抬高
            Button(
                onClick = {
                    if (page < pageCount - 1) {
                        page += 1
                    } else {
                        onFinished()
                    }
                },
                modifier = Modifier.fillMaxWidth(),
                colors = ButtonDefaults.buttonColors(
                    containerColor = Color.Black,   // 黑色按钮
                    contentColor = Color.White      // 白色文字
                ),
                shape = MaterialTheme.shapes.large
            ) {
                Text(
                    text = if (page < pageCount - 1) "下一步" else "开始使用"
                )
            }
        }
    }
}

@Composable
private fun BannerRow(
    icon: ImageVector,
    iconBgColor: Color,
    title: String,
    subtitle: String
) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .background(
                color = MaterialTheme.colorScheme.surfaceVariant.copy(alpha = 0.25f),
                shape = RoundedCornerShape(16.dp)
            )
            .padding(18.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        // 圆形图标背景
        Box(
            modifier = Modifier
                .size(44.dp)
                .background(iconBgColor, shape = CircleShape),
            contentAlignment = Alignment.Center
        ) {
            Icon(
                imageVector = icon,
                contentDescription = null,
                tint = MaterialTheme.colorScheme.onSurface
            )
        }

        Spacer(modifier = Modifier.width(16.dp))

        Column(
            verticalArrangement = Arrangement.spacedBy(6.dp),
            modifier = Modifier.weight(1f)
        ) {
            Text(
                text = title,
                style = MaterialTheme.typography.titleMedium.copy(
                    fontWeight = FontWeight.SemiBold
                )
            )
            Text(
                text = subtitle,
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
    }
}



==================================================

File: app\src\main\java\com\gosnow\app\util\ImageCompress.kt
--------------------------------------------------
package com.gosnow.app.util

import android.content.Context
import android.graphics.Bitmap
import android.graphics.BitmapFactory
import android.net.Uri
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
import java.io.ByteArrayOutputStream
import kotlin.math.max
import kotlin.math.min

/**
 * 头像压缩函数
 * 从 Uri 读取图片，并压缩到合适的分辨率 + 体积。
 *
 * 目标：
 * - 最长边不超过 maxSize（默认 512 px）
 * - 质量控制在 ~100～300KB 左右（视原图而定）
 */
suspend fun loadAndCompressImage(
    context: Context,
    uri: Uri,
    maxSize: Int = 512
): ByteArray = withContext(Dispatchers.IO) {

    // 1. 先只读取尺寸
    val options = BitmapFactory.Options().apply {
        inJustDecodeBounds = true
    }
    context.contentResolver.openInputStream(uri)?.use { input ->
        BitmapFactory.decodeStream(input, null, options)
    }

    val (origW, origH) = options.outWidth to options.outHeight
    if (origW <= 0 || origH <= 0) {
        throw IllegalArgumentException("无法读取图片尺寸")
    }

    // 2. 计算采样率，先粗缩一轮
    var sampleSize = 1
    val maxOrigSide = max(origW, origH)
    if (maxOrigSide > maxSize) {
        sampleSize = maxOrigSide / maxSize
    }
    if (sampleSize < 1) sampleSize = 1

    val decodeOptions = BitmapFactory.Options().apply {
        inSampleSize = sampleSize
        inPreferredConfig = Bitmap.Config.RGB_565 // 省内存
    }

    val decoded = context.contentResolver.openInputStream(uri)?.use { input ->
        BitmapFactory.decodeStream(input, null, decodeOptions)
    } ?: throw IllegalArgumentException("无法解码图片")

    // 3. 精细缩放到最长边 maxSize
    val scale = min(
        maxSize.toFloat() / decoded.width.toFloat(),
        maxSize.toFloat() / decoded.height.toFloat()
    ).coerceAtMost(1f)

    val targetW = (decoded.width * scale).toInt().coerceAtLeast(1)
    val targetH = (decoded.height * scale).toInt().coerceAtLeast(1)

    val scaled = if (scale < 1f) {
        Bitmap.createScaledBitmap(decoded, targetW, targetH, true)
    } else {
        decoded
    }

    // 4. 压缩为 JPEG
    val baos = ByteArrayOutputStream()
    var quality = 85
    scaled.compress(Bitmap.CompressFormat.JPEG, quality, baos)

    // 简单控制一下体积：>300KB 就再压一轮（最多两次）
    var bytes = baos.toByteArray()
    while (bytes.size > 300_000 && quality > 50) {
        baos.reset()
        quality -= 15
        scaled.compress(Bitmap.CompressFormat.JPEG, quality, baos)
        bytes = baos.toByteArray()
    }

    // 如果 decode 和 scaled 不是同一个对象，记得回收
    if (scaled !== decoded) {
        decoded.recycle()
    }

    bytes
}




==================================================

File: app\src\main\java\com\gosnow\app\util\ImageUtils.kt
--------------------------------------------------
package com.gosnow.app.util

/**
 * 优化 Supabase 图片 URL
 */
fun getResizedImageUrl(originalUrl: String?, width: Int, quality: Int = 75): String? {
    if (originalUrl.isNullOrBlank()) return null

    // 🔴 修复：暂时直接返回原图 URL
    // 原因：MemFire 可能未开启 render API，导致请求压缩图返回 404/灰色。
    // 我们依赖 Coil 在客户端进行采样和缓存，这虽然耗一点流量，但最稳妥。
    return originalUrl

    /*
    // --- 下面是之前的服务端压缩逻辑，先注释掉 ---
    if (!originalUrl.contains("supabase") && !originalUrl.contains("memfiredb")) {
        return originalUrl
    }
    return try {
        val baseUrl = originalUrl.substringBefore("/storage/v1/")
        val path = originalUrl.substringAfter("/public/")
        "$baseUrl/storage/v1/render/image/public/$path?width=$width&quality=$quality&resize=cover"
    } catch (e: Exception) {
        originalUrl
    }
    */
}

==================================================

File: app\src\main\res\drawable\ic_launcher_background.xml
--------------------------------------------------
<?xml version="1.0" encoding="utf-8"?>
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="108dp"
    android:height="108dp"
    android:viewportWidth="108"
    android:viewportHeight="108">
    <path
        android:fillColor="#3DDC84"
        android:pathData="M0,0h108v108h-108z" />
    <path
        android:fillColor="#00000000"
        android:pathData="M9,0L9,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,0L19,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M29,0L29,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M39,0L39,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M49,0L49,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M59,0L59,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M69,0L69,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M79,0L79,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M89,0L89,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M99,0L99,108"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,9L108,9"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,19L108,19"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,29L108,29"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,39L108,39"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,49L108,49"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,59L108,59"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,69L108,69"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,79L108,79"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,89L108,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M0,99L108,99"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,29L89,29"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,39L89,39"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,49L89,49"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,59L89,59"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,69L89,69"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M19,79L89,79"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M29,19L29,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M39,19L39,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M49,19L49,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M59,19L59,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M69,19L69,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
    <path
        android:fillColor="#00000000"
        android:pathData="M79,19L79,89"
        android:strokeWidth="0.8"
        android:strokeColor="#33FFFFFF" />
</vector>


==================================================

File: app\src\main\res\drawable\ic_launcher_foreground.xml
--------------------------------------------------
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:aapt="http://schemas.android.com/aapt"
    android:width="108dp"
    android:height="108dp"
    android:viewportWidth="108"
    android:viewportHeight="108">
    <path android:pathData="M31,63.928c0,0 6.4,-11 12.1,-13.1c7.2,-2.6 26,-1.4 26,-1.4l38.1,38.1L107,108.928l-32,-1L31,63.928z">
        <aapt:attr name="android:fillColor">
            <gradient
                android:endX="85.84757"
                android:endY="92.4963"
                android:startX="42.9492"
                android:startY="49.59793"
                android:type="linear">
                <item
                    android:color="#44000000"
                    android:offset="0.0" />
                <item
                    android:color="#00000000"
                    android:offset="1.0" />
            </gradient>
        </aapt:attr>
    </path>
    <path
        android:fillColor="#FFFFFF"
        android:fillType="nonZero"
        android:pathData="M65.3,45.828l3.8,-6.6c0.2,-0.4 0.1,-0.9 -0.3,-1.1c-0.4,-0.2 -0.9,-0.1 -1.1,0.3l-3.9,6.7c-6.3,-2.8 -13.4,-2.8 -19.7,0l-3.9,-6.7c-0.2,-0.4 -0.7,-0.5 -1.1,-0.3C38.8,38.328 38.7,38.828 38.9,39.228l3.8,6.6C36.2,49.428 31.7,56.028 31,63.928h46C76.3,56.028 71.8,49.428 65.3,45.828zM43.4,57.328c-0.8,0 -1.5,-0.5 -1.8,-1.2c-0.3,-0.7 -0.1,-1.5 0.4,-2.1c0.5,-0.5 1.4,-0.7 2.1,-0.4c0.7,0.3 1.2,1 1.2,1.8C45.3,56.528 44.5,57.328 43.4,57.328L43.4,57.328zM64.6,57.328c-0.8,0 -1.5,-0.5 -1.8,-1.2s-0.1,-1.5 0.4,-2.1c0.5,-0.5 1.4,-0.7 2.1,-0.4c0.7,0.3 1.2,1 1.2,1.8C66.5,56.528 65.6,57.328 64.6,57.328L64.6,57.328z"
        android:strokeWidth="1"
        android:strokeColor="#00000000" />
</vector>

==================================================

File: app\src\main\res\mipmap-anydpi-v26\ic_launcher.xml
--------------------------------------------------
<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@color/ic_launcher_background"/>
    <foreground android:drawable="@mipmap/ic_launcher_foreground"/>
</adaptive-icon>

==================================================

File: app\src\main\res\mipmap-anydpi-v26\ic_launcher_icon.xml
--------------------------------------------------
<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@color/ic_launcher_icon_background"/>
    <foreground android:drawable="@mipmap/ic_launcher_icon_foreground"/>
</adaptive-icon>

==================================================

File: app\src\main\res\mipmap-anydpi-v26\ic_launcher_icon_round.xml
--------------------------------------------------
<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@color/ic_launcher_icon_background"/>
    <foreground android:drawable="@mipmap/ic_launcher_icon_foreground"/>
</adaptive-icon>

==================================================

File: app\src\main\res\mipmap-anydpi-v26\ic_launcher_round.xml
--------------------------------------------------
<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@color/ic_launcher_background"/>
    <foreground android:drawable="@mipmap/ic_launcher_foreground"/>
</adaptive-icon>

==================================================

File: app\src\main\res\values\colors.xml
--------------------------------------------------
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <color name="purple_200">#FFBB86FC</color>
    <color name="purple_500">#FF6200EE</color>
    <color name="purple_700">#FF3700B3</color>
    <color name="teal_200">#FF03DAC5</color>
    <color name="teal_700">#FF018786</color>
    <color name="black">#FF000000</color>
    <color name="white">#FFFFFFFF</color>
</resources>

==================================================

File: app\src\main\res\values\ic_launcher_background.xml
--------------------------------------------------
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <color name="ic_launcher_background">#FFFFFF</color>
</resources>

==================================================

File: app\src\main\res\values\ic_launcher_icon_background.xml
--------------------------------------------------
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <color name="ic_launcher_icon_background">#FFFFFF</color>
</resources>

==================================================

File: app\src\main\res\values\mapbox_config.xml
--------------------------------------------------
<resources>
    <string name="mapbox_access_token">
        pk.eyJ1IjoiZ29zbm93IiwiYSI6ImNtaWp2a3l2OTA2OGszZXNkN3oxY2p4bjcifQ.JhHi_H65UPCQ13owwnk5AQ
    </string>
</resources>


==================================================

File: app\src\main\res\values\strings.xml
--------------------------------------------------
<resources>
    <string name="app_name">上雪</string>
</resources>

==================================================

File: app\src\main\res\values\themes.xml
--------------------------------------------------
<?xml version="1.0" encoding="utf-8"?>
<resources>

    <style name="Theme.Gosnow" parent="android:Theme.Material.Light.NoActionBar" />
</resources>

==================================================

File: app\src\main\res\xml\backup_rules.xml
--------------------------------------------------
<?xml version="1.0" encoding="utf-8"?><!--
   Sample backup rules file; uncomment and customize as necessary.
   See https://developer.android.com/guide/topics/data/autobackup
   for details.
   Note: This file is ignored for devices older than API 31
   See https://developer.android.com/about/versions/12/backup-restore
-->
<full-backup-content>
    <!--
   <include domain="sharedpref" path="."/>
   <exclude domain="sharedpref" path="device.xml"/>
-->
</full-backup-content>

==================================================

File: app\src\main\res\xml\data_extraction_rules.xml
--------------------------------------------------
<?xml version="1.0" encoding="utf-8"?><!--
   Sample data extraction rules file; uncomment and customize as necessary.
   See https://developer.android.com/about/versions/12/backup-restore#xml-changes
   for details.
-->
<data-extraction-rules>
    <cloud-backup>
        <!-- TODO: Use <include> and <exclude> to control what is backed up.
        <include .../>
        <exclude .../>
        -->
    </cloud-backup>
    <!--
    <device-transfer>
        <include .../>
        <exclude .../>
    </device-transfer>
    -->
</data-extraction-rules>

==================================================

File: app\src\test\java\com\gosnow\app\ExampleUnitTest.kt
--------------------------------------------------
package com.gosnow.app

import org.junit.Test

import org.junit.Assert.*

/**
 * Example local unit test, which will execute on the development machine (host).
 *
 * See [testing documentation](http://d.android.com/tools/testing).
 */
class ExampleUnitTest {
    @Test
    fun addition_isCorrect() {
        assertEquals(4, 2 + 2)
    }
}

==================================================

File: docs\android-auth-flow.md
--------------------------------------------------
# Android 认证流程说明

本说明对应 Kotlin + Jetpack Compose 的登录/注册体验，尽量与 iOS 端对齐。

## 导航入口
- **WelcomeAuthIntroScreen**：未登录启动 App 时的起始页面（`welcome_auth` 路由）。主按钮文案为“使用手机号以继续”。
- **PhoneLoginScreen**：手机号 + 验证码登录/注册页面（`phone_login` 路由）。
- **TermsScreen**：用户协议与隐私政策内容页（`terms` 路由）。从欢迎页或登录页的文案点击进入。
- 登录成功后跳转到主框架 `GoSnowMainApp`（首页/雪圈/发现 Tab）。

## 状态与持久化
- `LoginViewModel` 暴露 `LoginUiState`，包含手机号、验证码、发送/验证状态、错误信息、登录态与 `isCheckingSession` 标记。
- `AuthRepository` 负责调用 `AuthApiService` 与 `AuthPreferences`，将 Supabase 返回的 `AuthSession` 写入 DataStore 持久化（access token、refresh token、userId、email）。
- 启动时 `AuthPreferences.session` 会被收集以判断是否已登录，决定导航起点。

## 主要交互
- WelcomeAuthIntroScreen：主按钮进入手机号登录；卡片文案可点击查看条款。
- PhoneLoginScreen：
  - 输入手机号 → 发送验证码（首次视为注册，后续视为登录）。
  - 输入验证码 → 触发 `verifyCodeAndLogin()` 登录并持久化会话。
  - 底部文案的“用户协议/隐私政策”可点击，进入 TermsScreen。
- TermsScreen：滚动展示“用户协议”和“隐私政策”两段内容，顶部提供返回按钮。
- 退出登录：`GoSnowMainApp` 接收 `onLogout` 回调，调用 `LoginViewModel.logout()` 清除 DataStore，并将导航回 `welcome_auth`。

## Supabase/Memfire 配置
- 构建时从 `local.properties` 或环境变量读取 `SUPABASE_URL` 与 `SUPABASE_ANON_KEY`，并注入到 `BuildConfig`。
- 相关代码：`app/build.gradle.kts` 中的 `buildConfigField`，`AuthApiService.ensureSupabaseConfigured()` 负责缺失配置的报错提示。

## 本地调试步骤
1. 在项目根目录创建 `local.properties`（或导出环境变量）：
   ```properties
   SUPABASE_URL=https://your-project.supabase.co
   SUPABASE_ANON_KEY=your-anon-key
   ```
2. 运行 `./gradlew assembleDebug` 或直接在 Android Studio 运行应用。
3. App 启动后依次体验：欢迎页 → "使用手机号以继续" → 输入手机号并发送验证码 → 输入验证码 → 登录成功跳转主界面。
4. 在欢迎页或登录页点击“用户协议/隐私政策”可以查看 TermsScreen。


==================================================

File: docs\android-login.md
--------------------------------------------------
# GoSnow Android 登录说明

## 登录入口
- `MainActivity` 入口会加载 `GoSnowApp`，根据是否存在本地会话决定展示登录页还是直接进入主界面。对应实现位于 `app/src/main/java/com/gosnow/app/ui/app/GoSnowApp.kt`。

## 主要类与文件
- **UI 层**：`LoginScreen`（`ui/login/LoginScreen.kt`）负责展示输入框、错误提示与按钮；`GoSnowMainApp`（`ui/app/GoSnowApp.kt`）承载 Home/Feed/Discover Tab，并在 Profile 页提供退出按钮。
- **状态管理**：`LoginViewModel`（`ui/login/LoginViewModel.kt`）负责表单校验、调用登录与登出，并监听本地会话变化。
- **数据层**：`AuthApiService` 调用 Supabase/Memfire GoTrue 密码登录接口；`AuthRepository` 组合网络与存储；`AuthPreferences` 基于 DataStore 持久化 access token / refresh token / userId。

## 登录状态存储与判断
- 登录成功后会将 `accessToken`、`refreshToken`（如果返回）、`userId` 与 `email` 写入 DataStore（`data/auth/AuthPreferences.kt`）。
- App 启动时 `LoginViewModel` 会订阅 DataStore，会话存在即视为已登录并跳转主界面；缺失则停留在登录页。
- 退出登录会清除上述 DataStore 条目，并重置页面到登录视图。

## 调试与配置
- Supabase/Memfire 配置通过 **`SUPABASE_URL`** 与 **`SUPABASE_ANON_KEY`** 注入，可在 `local.properties` 或环境变量中提供：
  ```properties
  SUPABASE_URL=https://your-project.supabase.co
  SUPABASE_ANON_KEY=your-anon-key
  ```
- 未配置时会直接提示错误，避免误调用。
- 登录流程使用 OkHttp 直接请求 `/auth/v1/token?grant_type=password`，确保后端配置一致即可在模拟器运行并调试。


==================================================

File: gradle\libs.versions.toml
--------------------------------------------------
[versions]
agp = "8.7.3"
kotlin = "2.1.0"
mapbox = "11.2.0" # 建议使用 v11 的较新版本
junit = "4.13.2"
junitVersion = "1.1.5"
espressoCore = "3.5.1"
lifecycleRuntimeKtx = "2.6.1"
activityCompose = "1.8.0"
composeBom = "2024.09.00"
coroutines = "1.9.0"
okhttp = "4.12.0"
datastore = "1.1.1"
lifecycleCompose = "2.6.1"
foundationLayout = "1.9.5"
foundation = "1.10.0"
composeMaterial3 = "1.5.6"
playServicesAuth = "21.4.0"
roomKtx = "2.8.4"
foundationLayoutVersion = "1.10.0"

[libraries]
# ✅ 修正：strictly 后面必须直接跟版本号字符串
androidx-core-ktx = { group = "androidx.core", name = "core-ktx", version = { strictly = "1.15.0" } }
androidx-core = { group = "androidx.core", name = "core", version = { strictly = "1.15.0" } }
junit = { group = "junit", name = "junit", version.ref = "junit" }
androidx-junit = { group = "androidx.test.ext", name = "junit", version.ref = "junitVersion" }
androidx-espresso-core = { group = "androidx.test.espresso", name = "espresso-core", version.ref = "espressoCore" }
androidx-lifecycle-runtime-ktx = { group = "androidx.lifecycle", name = "lifecycle-runtime-ktx", version.ref = "lifecycleRuntimeKtx" }
androidx-activity-compose = { group = "androidx.activity", name = "activity-compose", version.ref = "activityCompose" }
androidx-compose-bom = { group = "androidx.compose", name = "compose-bom", version.ref = "composeBom" }
androidx-compose-ui = { group = "androidx.compose.ui", name = "ui" }
androidx-compose-ui-graphics = { group = "androidx.compose.ui", name = "ui-graphics" }
androidx-compose-ui-tooling = { group = "androidx.compose.ui", name = "ui-tooling" }
androidx-compose-ui-tooling-preview = { group = "androidx.compose.ui", name = "ui-tooling-preview" }
androidx-compose-ui-test-manifest = { group = "androidx.compose.ui", name = "ui-test-manifest" }
androidx-compose-ui-test-junit4 = { group = "androidx.compose.ui", name = "ui-test-junit4" }
androidx-compose-material3 = { group = "androidx.compose.material3", name = "material3" }
androidx-lifecycle-viewmodel-compose = { group = "androidx.lifecycle", name = "lifecycle-viewmodel-compose", version.ref = "lifecycleCompose" }
androidx-lifecycle-runtime-compose = { group = "androidx.lifecycle", name = "lifecycle-runtime-compose", version.ref = "lifecycleCompose" }
kotlinx-coroutines-android = { group = "org.jetbrains.kotlinx", name = "kotlinx-coroutines-android", version.ref = "coroutines" }
okhttp = { group = "com.squareup.okhttp3", name = "okhttp", version.ref = "okhttp" }
androidx-datastore-preferences = { group = "androidx.datastore", name = "datastore-preferences", version.ref = "datastore" }
androidx-compose-foundation-layout = { group = "androidx.compose.foundation", name = "foundation-layout", version.ref = "foundationLayout" }
androidx-compose-foundation = { group = "androidx.compose.foundation", name = "foundation", version.ref = "foundation" }
compose-material3 = { group = "androidx.wear.compose", name = "compose-material3", version.ref = "composeMaterial3" }
play-services-auth = { group = "com.google.android.gms", name = "play-services-auth", version.ref = "playServicesAuth" }
androidx-room-ktx = { group = "androidx.room", name = "room-ktx", version.ref = "roomKtx" }
androidx-foundation-layout = { group = "androidx.compose.foundation", name = "foundation-layout", version.ref = "foundationLayoutVersion" }
mapbox-android = { group = "com.mapbox.maps", name = "android", version.ref = "mapbox" }
# Mapbox View Annotation 扩展通常包含在 android 核心包中，但有时为了确保 DSL 扩展可用，显式引入 extension 是个好习惯
mapbox-extension-style = { group = "com.mapbox.extension", name = "maps-style", version.ref = "mapbox" }

[plugins]
# 在 [plugins] 块中添加下面这一行，为序列化插件定义别名
kotlin-serialization = { id = "org.jetbrains.kotlin.plugin.serialization", version.ref = "kotlin" }
# 请确保已有的插件也使用了上面的版本引用
android-application = { id = "com.android.application", version.ref = "agp" }
kotlin-android = { id = "org.jetbrains.kotlin.android", version.ref = "kotlin" }
kotlin-compose = { id = "org.jetbrains.kotlin.plugin.compose", version.ref = "kotlin" }



==================================================

